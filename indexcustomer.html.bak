<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warkop Santai - Menuu Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C3AED',
                        accent: '#8B5CF6',
                        surface: '#1E1B4B',
                        dark: '#0F0A1F'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0F0A1F 0%, #1E1B4B 50%, #0F0A1F 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(30, 27, 75, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6B21A8 0%, #1E40AF 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(107, 33, 168, 0.4);
        }

        .input-field {
            background: rgba(15, 10, 31, 0.6);
            border: 1px solid rgba(139, 92, 246, 0.3);
            transition: all 0.2s ease;
        }

        .input-field:focus {
            border-color: #8B5CF6;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
            outline: none;
        }

        .category-btn.active {
            background: linear-gradient(135deg, #6B21A8 0%, #1E40AF 100%) !important;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(107, 33, 168, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.3s ease-out;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="text-white pb-24">
    <!-- Header -->
    <header class="glass sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="headerLogo"
                        class="w-12 h-12 bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl flex items-center justify-center overflow-hidden">
                        <span class="text-2xl">‚òï</span>
                    </div>
                    <div>
                        <h1 id="businessName" class="text-xl font-bold text-white">Warkop Santai</h1>
                        <p id="businessTagline" class="text-xs text-gray-400">Ngopi Enak, Harga Merakyat</p>
                    </div>
                </div>
                <a href="/backend/public/admin/index.html"
                    class="px-4 py-2 rounded-lg bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 text-sm">
                    üîê Login Staff
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- Welcome Section -->
        <section class="text-center mb-8">
            <h2
                class="text-3xl md:text-4xl font-bold mb-4 bg-gradient-to-r from-purple-400 to-blue-400 text-transparent bg-clip-text">
                Selamat Datang!
            </h2>
            <p class="text-gray-400">Pilih menu favorit Anda dan pesan langsung dari meja</p>
        </section>

        <!-- Category Filter -->
        <section class="mb-6">
            <div id="categoryContainer" class="flex gap-3 overflow-x-auto pb-2">
                <button class="category-btn active px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap"
                    data-cat="all" onclick="filterCategory('all')">üçΩÔ∏è Semua</button>
            </div>
        </section>

        <!-- Menu Grid -->
        <section id="menuGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Loading placeholders -->
            <div class="glass rounded-2xl p-4 text-center animate-pulse">
                <div class="w-full aspect-square bg-gray-700/50 rounded-xl mb-3"></div>
                <div class="h-4 bg-gray-700/50 rounded mb-2"></div>
                <div class="h-6 bg-gray-700/50 rounded w-1/2 mx-auto"></div>
            </div>
        </section>

        <!-- Empty State -->
        <div id="emptyMenu" class="hidden text-center py-12">
            <div class="text-6xl mb-4">üìã</div>
            <p class="text-gray-400">Belum ada menu tersedia</p>
        </div>
    </main>

    <!-- Floating Cart Button -->
    <div id="cartFloating" class="fixed bottom-6 right-6 z-40 hidden">
        <button onclick="showCheckoutModal()"
            class="btn-primary px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3">
            <span class="text-xl">üõí</span>
            <div class="text-left">
                <p class="text-xs opacity-75">Keranjang</p>
                <p class="font-bold"><span id="cartCount">0</span> item ‚Ä¢ <span id="cartTotal">Rp 0</span></p>
            </div>
        </button>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeCheckoutModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none overflow-auto">
            <div
                class="glass rounded-2xl p-6 w-full max-w-lg animate-fade pointer-events-auto my-4 max-h-[90vh] overflow-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold">üõí Checkout</h3>
                    <button onclick="closeCheckoutModal()"
                        class="w-8 h-8 rounded-full bg-surface hover:bg-red-500/20 flex items-center justify-center">‚úï</button>
                </div>

                <!-- Cart Items -->
                <div id="checkoutItems" class="space-y-3 max-h-48 overflow-auto mb-4">
                    <!-- Items will be rendered here -->
                </div>

                <!-- Subtotal -->
                <div class="flex justify-between items-center p-3 bg-surface/50 rounded-lg mb-4">
                    <span class="font-medium">Total:</span>
                    <span id="checkoutTotal" class="text-xl font-bold text-green-400">Rp 0</span>
                </div>

                <!-- Customer Form -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Nama Pelanggan *</label>
                        <input type="text" id="customerName" class="input-field w-full px-4 py-3 rounded-lg text-white"
                            placeholder="Nama Anda">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">No. WhatsApp *</label>
                        <input type="tel" id="customerPhone" class="input-field w-full px-4 py-3 rounded-lg text-white"
                            placeholder="+628xxxxxxxxxx" required pattern="^\+62[0-9]+$"
                            oninput="this.value = this.value.replace(/^0/, '+62').replace(/[^0-9+]/g, '')">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Nomor Meja *</label>
                        <select id="tableNumber" class="input-field w-full px-4 py-3 rounded-lg text-white">
                            <option value="">Pilih Meja</option>
                            <option value="1">Meja 1</option>
                            <option value="2">Meja 2</option>
                            <option value="3">Meja 3</option>
                            <option value="4">Meja 4</option>
                            <option value="5">Meja 5</option>
                            <option value="6">Meja 6</option>
                            <option value="7">Meja 7</option>
                            <option value="8">Meja 8</option>
                            <option value="Takeaway">üì¶ Takeaway</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Metode Pembayaran *</label>
                        <select id="paymentMethod" class="input-field w-full px-4 py-3 rounded-lg text-white"
                            onchange="onPaymentMethodChange()">
                            <option value="">Pilih Metode</option>
                            <option value="cash">üíµ Tunai</option>
                            <option value="qris">üì± QRIS</option>
                            <option value="bank">üè¶ Transfer Bank</option>
                            <option value="ewallet">üì≤ E-Wallet</option>
                        </select>
                    </div>

                    <!-- Cash Message -->
                    <div id="cashMessage" class="hidden p-4 bg-yellow-500/20 border border-yellow-500/30 rounded-lg">
                        <p class="text-yellow-400 font-medium">üíµ Pembayaran Tunai</p>
                        <p class="text-sm text-yellow-300/80 mt-1">Pesanan akan diproses setelah Anda membayar di Kasir.
                        </p>
                    </div>

                    <!-- Payment Info Section (for non-cash) -->
                    <div id="paymentInfoSection" class="hidden space-y-3">
                        <!-- Bank Transfer Info -->
                        <div id="paymentBankInfo"
                            class="hidden p-4 bg-blue-500/20 border border-blue-500/30 rounded-lg">
                            <p class="text-blue-400 font-medium mb-2">üè¶ Transfer ke Rekening:</p>
                            <p id="paymentBankName" class="font-bold text-white"></p>
                            <p id="paymentBankAccount"
                                class="text-lg font-mono bg-black/30 px-3 py-2 rounded mt-1 text-blue-300"></p>
                        </div>

                        <!-- QRIS Info -->
                        <div id="paymentQrisInfo"
                            class="hidden p-4 bg-purple-500/20 border border-purple-500/30 rounded-lg text-center">
                            <p class="text-purple-400 font-medium mb-3">üì± Scan QRIS:</p>
                            <img id="paymentQrisImage" class="max-w-[200px] mx-auto rounded-lg bg-white p-2" alt="QRIS">
                        </div>

                        <!-- E-Wallet Info -->
                        <div id="paymentEwalletInfo"
                            class="hidden p-4 bg-green-500/20 border border-green-500/30 rounded-lg">
                            <p class="text-green-400 font-medium mb-2">üì≤ Transfer ke E-Wallet:</p>
                            <p id="paymentEwalletType" class="font-bold text-white"></p>
                            <p id="paymentEwalletNumber"
                                class="text-lg font-mono bg-black/30 px-3 py-2 rounded mt-1 text-green-300"></p>
                        </div>

                        <!-- Upload Proof (Required) -->
                        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                            <label class="block text-sm text-red-400 font-medium mb-2">üì∑ Upload Bukti Pembayaran
                                *</label>
                            <input type="file" id="paymentProofFile" accept="image/*"
                                class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white hover:file:bg-purple-700"
                                onchange="previewPaymentProof(this)">
                            <img id="paymentProofPreview"
                                class="hidden mt-3 max-h-32 rounded-lg mx-auto border border-white/20">
                            <p class="text-xs text-gray-500 mt-2">Wajib upload bukti transfer sebelum mengirim pesanan
                            </p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Catatan (Opsional)</label>
                        <textarea id="orderNotes" class="input-field w-full px-4 py-3 rounded-lg text-white" rows="2"
                            placeholder="Catatan khusus..."></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="submitOrderBtn" onclick="submitOrder()"
                    class="btn-primary w-full py-4 rounded-xl font-bold text-lg mt-6">
                    üöÄ Pesan Sekarang
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none overflow-auto">
            <div id="receiptCard"
                class="bg-white text-gray-800 rounded-2xl p-6 w-full max-w-sm animate-fade pointer-events-auto shadow-2xl my-4">
                <!-- Receipt Header -->
                <div class="text-center border-b border-dashed border-gray-300 pb-4 mb-4">
                    <div class="text-4xl mb-2">‚òï</div>
                    <h2 id="receiptShopName" class="text-xl font-bold">Warkop Santai</h2>
                    <p id="receiptTagline" class="text-sm text-gray-500">Ngopi Enak, Harga Merakyat</p>
                </div>

                <!-- Order Info -->
                <div class="text-sm space-y-1 mb-4">
                    <div class="flex justify-between"><span class="text-gray-500">Order ID:</span><span
                            id="receiptOrderId" class="font-bold">#-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Tanggal:</span><span
                            id="receiptDate">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Waktu:</span><span
                            id="receiptTime">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Pelanggan:</span><span
                            id="receiptCustomer">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Meja:</span><span
                            id="receiptTable">-</span></div>
                </div>

                <!-- Items -->
                <div class="border-t border-b border-dashed border-gray-300 py-3 mb-4">
                    <div id="receiptItems" class="space-y-2 text-sm">
                        <!-- Items rendered here -->
                    </div>
                </div>

                <!-- Total -->
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-bold">TOTAL:</span>
                    <span id="receiptTotal" class="text-2xl font-bold text-purple-600">Rp 0</span>
                </div>

                <!-- Payment Method -->
                <div id="receiptPaymentInfo"
                    class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-center">
                    <p class="text-sm text-yellow-800">üíµ Pembayaran: <strong>Tunai</strong></p>
                    <p class="text-xs text-yellow-600 mt-1">Silakan menuju kasir untuk pembayaran</p>
                </div>

                <!-- WiFi Info -->
                <div class="bg-purple-50 rounded-lg p-3 mb-4 text-center">
                    <p class="text-xs text-purple-600 mb-1">üì∂ WiFi Gratis</p>
                    <p class="font-bold text-purple-800" id="receiptWifi">WarkopSantai</p>
                    <p class="text-sm text-purple-600">Password: <span id="receiptWifiPass"
                            class="font-mono">12345678</span></p>
                </div>

                <!-- Thank You -->
                <div class="text-center text-gray-500 text-sm mb-4">
                    <p>Terima kasih telah berkunjung! üôè</p>
                </div>

                <!-- Actions -->
                <div class="flex gap-3">
                    <button onclick="saveReceipt()"
                        class="flex-1 py-3 rounded-lg bg-purple-600 text-white font-medium hover:bg-purple-700">
                        üì∏ Simpan Gambar
                    </button>
                    <button onclick="closeReceiptModal()"
                        class="flex-1 py-3 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300">
                        ‚úì Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Footer -->
    <footer class="glass py-6">
        <div class="max-w-6xl mx-auto px-4 text-center text-gray-400 text-sm">
            <p>¬© 2026 Warkop Santai - Ngopi Enak, Harga Merakyat</p>
        </div>
    </footer>

    <script>
        // ===== CONFIGURATION =====
        // Auto-detect API base. 
        // If served from backend (port 3000) or HTTPS (production), use current origin.
        // If served from Live Server (port 5500 etc), assume backend is on same host but port 3000.
        const protocol = window.location.protocol;
        const host = window.location.hostname;
        const port = window.location.port;

        const API_BASE = (port === '3000' || port === '' || protocol === 'https:')
            ? window.location.origin
            : `${protocol}//${host}:3000`;

        console.log('API_BASE set to:', API_BASE);

        // ===== STATE =====
        let menuItems = [];
        let categories = [];
        let cart = [];
        let businessSettings = { wifiName: 'WarkopSantai', wifiPassword: '12345678' };
        let currentCategory = 'all';

        // ===== UTILITIES =====
        function formatCurrency(amount) {
            return 'Rp ' + (amount || 0).toLocaleString('id-ID');
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
        }

        function getCurrentDate() {
            return new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }

        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-purple-500'
            };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type] || colors.info} text-white px-6 py-3 rounded-xl shadow-xl`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function setButtonLoading(btn, loadingText = '‚è≥ Memproses...') {
            if (!btn) return () => { };
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = loadingText;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            return function restore() {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            };
        }

        // ===== MENU LOADING =====
        async function loadMenu() {
            try {
                // Add timestamp to prevent caching
                const res = await fetch(`${API_BASE}/api/menu?t=${Date.now()}`);
                menuItems = await res.json();
                console.log('Menu loaded:', menuItems.length, 'items');
                // DEBUG: Check active status
                console.log('Inactive Items (is_active === false):', menuItems.filter(m => m.is_active === false).map(m => m.name));
                console.log('Active Items (is_active !== false):', menuItems.filter(m => m.is_active !== false).map(m => m.name));

                // Extract categories from active items
                const cats = [...new Set(menuItems
                    .filter(m => m.is_active !== false)
                    .map(m => m.category)
                    .filter(Boolean)
                )];
                categories = cats;
                renderCategories();
                renderMenu();
            } catch (err) {
                console.warn('Failed to load menu:', err);
                showToast('Gagal memuat menu', 'error');
            }
        }

        async function loadSettings() {
            try {
                const res = await fetch(`${API_BASE}/api/settings`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.name) document.getElementById('businessName').textContent = data.name;
                    if (data.tagline) document.getElementById('businessTagline').textContent = data.tagline;
                    if (data.wifiName) businessSettings.wifiName = data.wifiName;
                    if (data.wifiPassword) businessSettings.wifiPassword = data.wifiPassword;
                    if (data.logo && data.logo !== 'default') {
                        const logoEl = document.getElementById('headerLogo');
                        logoEl.innerHTML = `<img src="${data.logo}" class="w-full h-full object-cover">`;
                    }
                    // Store payment settings for checkout display
                    if (data.bankName) businessSettings.bankName = data.bankName;
                    if (data.bankAccount) businessSettings.bankAccount = data.bankAccount;
                    if (data.ewalletType) businessSettings.ewalletType = data.ewalletType;
                    if (data.ewalletNumber) businessSettings.ewalletNumber = data.ewalletNumber;
                    if (data.qrisImage) businessSettings.qrisImage = data.qrisImage;
                }
            } catch (e) {
                console.warn('Failed to load settings:', e);
            }
        }

        // ===== CATEGORY RENDERING =====
        function renderCategories() {
            const container = document.getElementById('categoryContainer');
            const catEmoji = { kopi: '‚òï', minuman: 'üßã', makanan: 'üçú', snack: 'üçø' };

            let html = `<button class="category-btn ${currentCategory === 'all' ? 'active' : ''} px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap" onclick="filterCategory('all')">üçΩÔ∏è Semua</button>`;

            categories.forEach(cat => {
                const emoji = catEmoji[cat.toLowerCase()] || 'üìã';
                html += `<button class="category-btn ${currentCategory === cat ? 'active' : ''} px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap capitalize" onclick="filterCategory('${cat}')">${emoji} ${cat}</button>`;
            });

            container.innerHTML = html;
        }

        function filterCategory(cat) {
            currentCategory = cat;
            renderCategories();
            renderMenu();
        }

        // ===== MENU RENDERING =====
        function renderMenu() {
            const grid = document.getElementById('menuGrid');
            const empty = document.getElementById('emptyMenu');

            // NOTE: We do NOT filter out inactive items anymore. 
            // We show them as dimmed/disabled.
            let filtered = menuItems;
            if (currentCategory !== 'all') {
                filtered = filtered.filter(m => m.category === currentCategory);
            }

            if (filtered.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            grid.innerHTML = filtered.map(item => {
                const isAvailable = item.available !== false;
                const isActive = item.is_active !== false;

                let statusBadge = '';
                let buttonHtml = '';
                let cardClasses = 'glass rounded-2xl overflow-hidden card-hover transition-all duration-300';

                if (!isActive) {
                    // NON-ACTIVE STATE (Admin disabled)
                    cardClasses += ' opacity-50 grayscale cursor-not-allowed';
                    statusBadge = '<div class="absolute inset-0 bg-black/70 flex items-center justify-center"><span class="text-white font-bold text-sm border border-white/50 px-3 py-1 rounded">TIDAK TERSEDIA</span></div>';
                    buttonHtml = '<button disabled class="w-full h-8 rounded-full bg-gray-800 text-gray-500 text-xs font-bold cursor-not-allowed border border-gray-700">TIDAK TERSEDIA</button>';
                } else if (!isAvailable) {
                    // SOLD OUT STATE (Stock logic)
                    cardClasses += ' opacity-90 grayscale';
                    statusBadge = '<div class="absolute inset-0 bg-black/60 flex items-center justify-center"><span class="text-white font-bold text-xl border-2 border-white px-4 py-1 rounded-lg transform -rotate-12">HABIS</span></div>';
                    buttonHtml = '<button disabled class="w-16 h-8 rounded-full bg-gray-700 text-gray-400 text-xs font-bold cursor-not-allowed">HABIS</button>';
                } else {
                    // ACTIVE & AVAILABLE
                    buttonHtml = `<button onclick="addToCart('${item.id}')" class="w-8 h-8 rounded-full bg-purple-600 hover:bg-purple-500 flex items-center justify-center text-white text-lg shadow-lg transform active:scale-95 transition-transform">+</button>`;
                }

                return `
            <div class="${cardClasses}">
              <div class="aspect-square bg-gradient-to-br from-purple-900/50 to-blue-900/50 flex items-center justify-center overflow-hidden relative">
                ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<span class="text-6xl opacity-50">‚òï</span>`}
                ${statusBadge}
              </div>
              <div class="p-4">
                <h3 class="font-bold text-sm mb-1 truncate">${item.name}</h3>
                <p class="text-xs text-gray-400 capitalize mb-2">${item.category || 'Menu'}</p>
                <div class="flex items-center justify-between">
                  <span class="text-green-400 font-bold">${formatCurrency(item.price)}</span>
                  ${buttonHtml}
                </div>
              </div>
            </div>
          `}).join('');
        }

        // ===== CART LOGIC =====
        function addToCart(itemId) {
            const item = menuItems.find(m => m.id === itemId);
            if (!item) return;

            const existing = cart.find(c => c.id === itemId);

            // Critical Check: is_active
            if (item.is_active === false) {
                showToast(`Menu "${item.name}" sedang tidak tersedia`, 'error');
                return;
            }

            // Stock check (optimistic)
            if (item.available === false) {
                showToast(`Menu "${item.name}" sudah habis`, 'error');
                return;
            }

            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }

            updateCartUI();
            showToast(`${item.name} ditambahkan ke keranjang`, 'success');
        }

        function removeFromCart(itemId) {
            const idx = cart.findIndex(c => c.id === itemId);
            if (idx > -1) {
                if (cart[idx].quantity > 1) {
                    cart[idx].quantity--;
                } else {
                    cart.splice(idx, 1);
                }
            }
            updateCartUI();
            renderCheckoutItems();
        }

        function updateCartUI() {
            const floating = document.getElementById('cartFloating');
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartTotal').textContent = formatCurrency(total);

            if (count > 0) {
                floating.classList.remove('hidden');
            } else {
                floating.classList.add('hidden');
            }
        }

        // ===== CHECKOUT MODAL =====
        function showCheckoutModal() {
            if (cart.length === 0) {
                showToast('Keranjang masih kosong!', 'warning');
                return;
            }
            renderCheckoutItems();
            document.getElementById('checkoutModal').classList.remove('hidden');
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.add('hidden');
        }

        function renderCheckoutItems() {
            const container = document.getElementById('checkoutItems');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            container.innerHTML = cart.map(item => `
        <div class="flex items-center justify-between p-3 bg-surface/50 rounded-lg">
          <div class="flex-1">
            <p class="font-medium text-sm">${item.name}</p>
            <p class="text-xs text-gray-400">${formatCurrency(item.price)} x ${item.quantity}</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-green-400">${formatCurrency(item.price * item.quantity)}</span>
            <button onclick="removeFromCart('${item.id}')" class="w-6 h-6 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500/30 flex items-center justify-center text-sm">‚àí</button>
          </div>
        </div>
      `).join('');

            document.getElementById('checkoutTotal').textContent = formatCurrency(total);
        }

        // ===== ORDER SUBMISSION =====
        async function submitOrder() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const table = document.getElementById('tableNumber').value;
            const payment = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('orderNotes').value.trim();
            const paymentProofFile = document.getElementById('paymentProofFile')?.files[0];

            // Basic Validation
            if (!name) { showToast('Nama pelanggan harus diisi!', 'warning'); return; }
            if (!phone) { showToast('Nomor WhatsApp harus diisi!', 'warning'); return; }
            if (!phone.startsWith('+62')) { showToast('Nomor WhatsApp harus diawali +62', 'warning'); return; }
            if (!table) { showToast('Pilih nomor meja!', 'warning'); return; }
            if (!payment) { showToast('Pilih metode pembayaran!', 'warning'); return; }
            if (cart.length === 0) { showToast('Keranjang kosong!', 'warning'); return; }

            // Payment proof validation for non-cash
            const nonCashMethods = ['bank', 'ewallet', 'qris'];
            if (nonCashMethods.includes(payment) && !paymentProofFile) {
                showToast('Upload bukti pembayaran terlebih dahulu!', 'warning');
                return;
            }

            // Loading state
            const btn = document.getElementById('submitOrderBtn');
            const restoreBtn = setButtonLoading(btn, '‚è≥ Mengirim Pesanan...');

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderId = 'ORD-' + generateId().toUpperCase();

            const orderData = {
                id: orderId,
                customerName: name,
                customerPhone: phone,
                tableNumber: table,
                paymentMethod: payment,
                notes: notes,
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                total: total,
                status: 'new',
                date: getCurrentDate(),
                time: getCurrentTime(),
                createdAt: new Date().toISOString()
            };

            try {
                // Use FormData for multipart upload
                const formData = new FormData();
                formData.append('orderData', JSON.stringify(orderData));

                if (paymentProofFile) {
                    formData.append('paymentProof', paymentProofFile);
                }

                const res = await fetch(`${API_BASE}/api/orders`, {
                    method: 'POST',
                    body: formData  // No Content-Type header for FormData
                });

                if (res.ok) {
                    const savedOrder = await res.json();
                    showToast('Pesanan berhasil dikirim!', 'success');
                    closeCheckoutModal();
                    showReceipt({ ...orderData, paymentProofImage: savedOrder.paymentProofImage });

                    // Clear cart and form
                    cart = [];
                    updateCartUI();
                    resetCheckoutForm();
                } else {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || 'Gagal mengirim pesanan');
                }
            } catch (err) {
                restoreBtn();
                console.error('Order error:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }

        function resetCheckoutForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('tableNumber').value = '';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('orderNotes').value = '';

            // Reset payment fields
            const proofInput = document.getElementById('paymentProofFile');
            if (proofInput) proofInput.value = '';
            const preview = document.getElementById('paymentProofPreview');
            if (preview) preview.classList.add('hidden');

            // Hide all payment sections
            document.getElementById('cashMessage')?.classList.add('hidden');
            document.getElementById('paymentInfoSection')?.classList.add('hidden');
        }

        // ===== PAYMENT METHOD HANDLING =====
        function onPaymentMethodChange() {
            const method = document.getElementById('paymentMethod').value;

            // Hide all sections first
            document.getElementById('cashMessage').classList.add('hidden');
            document.getElementById('paymentInfoSection').classList.add('hidden');
            document.getElementById('paymentBankInfo').classList.add('hidden');
            document.getElementById('paymentQrisInfo').classList.add('hidden');
            document.getElementById('paymentEwalletInfo').classList.add('hidden');

            // Reset file input
            const proofInput = document.getElementById('paymentProofFile');
            if (proofInput) proofInput.value = '';
            document.getElementById('paymentProofPreview').classList.add('hidden');

            if (!method) return;

            if (method === 'cash') {
                document.getElementById('cashMessage').classList.remove('hidden');
            } else {
                document.getElementById('paymentInfoSection').classList.remove('hidden');

                if (method === 'bank') {
                    document.getElementById('paymentBankInfo').classList.remove('hidden');
                    document.getElementById('paymentBankName').textContent = businessSettings.bankName || 'BCA - Admin';
                    document.getElementById('paymentBankAccount').textContent = businessSettings.bankAccount || '1234567890';
                } else if (method === 'qris') {
                    document.getElementById('paymentQrisInfo').classList.remove('hidden');
                    const qrisImg = document.getElementById('paymentQrisImage');
                    if (businessSettings.qrisImage) {
                        qrisImg.src = businessSettings.qrisImage;
                    } else {
                        qrisImg.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" x="50" text-anchor="middle" font-size="12">QRIS</text></svg>';
                    }
                } else if (method === 'ewallet') {
                    document.getElementById('paymentEwalletInfo').classList.remove('hidden');
                    document.getElementById('paymentEwalletType').textContent = businessSettings.ewalletType || 'OVO/Dana/GoPay';
                    document.getElementById('paymentEwalletNumber').textContent = businessSettings.ewalletNumber || '081234567890';
                }
            }
        }

        function previewPaymentProof(input) {
            const preview = document.getElementById('paymentProofPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.classList.add('hidden');
            }
        }

        // ===== RECEIPT =====
        function showReceipt(order) {
            document.getElementById('receiptShopName').textContent = document.getElementById('businessName').textContent;
            document.getElementById('receiptTagline').textContent = document.getElementById('businessTagline').textContent;
            document.getElementById('receiptOrderId').textContent = '#' + order.id;
            document.getElementById('receiptDate').textContent = order.date;
            document.getElementById('receiptTime').textContent = order.time;
            document.getElementById('receiptCustomer').textContent = order.customerName;
            document.getElementById('receiptTable').textContent = order.tableNumber === 'Takeaway' ? 'üì¶ Takeaway' : 'Meja ' + order.tableNumber;
            document.getElementById('receiptTotal').textContent = formatCurrency(order.total);
            document.getElementById('receiptWifi').textContent = businessSettings.wifiName;
            document.getElementById('receiptWifiPass').textContent = businessSettings.wifiPassword;

            // Items
            const itemsContainer = document.getElementById('receiptItems');
            itemsContainer.innerHTML = order.items.map(item => `
        <div class="flex justify-between">
          <span>${item.name} x${item.quantity}</span>
          <span class="font-medium">${formatCurrency(item.price * item.quantity)}</span>
        </div>
      `).join('');

            // Payment info
            const paymentInfo = document.getElementById('receiptPaymentInfo');
            const paymentLabels = { cash: 'Tunai', qris: 'QRIS', bank: 'Transfer Bank', ewallet: 'E-Wallet' };
            const paymentEmoji = { cash: 'üíµ', qris: 'üì±', bank: 'üè¶', ewallet: 'üì≤' };

            if (order.paymentMethod === 'cash') {
                paymentInfo.innerHTML = `
          <p class="text-sm text-yellow-800">${paymentEmoji[order.paymentMethod]} Pembayaran: <strong>${paymentLabels[order.paymentMethod]}</strong></p>
          <p class="text-xs text-yellow-600 mt-1">Silakan menuju kasir untuk pembayaran</p>
        `;
                paymentInfo.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-center';
            } else {
                paymentInfo.innerHTML = `
          <p class="text-sm text-green-800">${paymentEmoji[order.paymentMethod]} Pembayaran: <strong>${paymentLabels[order.paymentMethod]}</strong></p>
          <p class="text-xs text-green-600 mt-1">Tunggu konfirmasi dari kasir</p>
        `;
                paymentInfo.className = 'bg-green-50 border border-green-200 rounded-lg p-3 mb-4 text-center';
            }

            document.getElementById('receiptModal').classList.remove('hidden');
        }

        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.add('hidden');
        }

        async function saveReceipt() {
            try {
                const card = document.getElementById('receiptCard');
                const canvas = await html2canvas(card, { backgroundColor: '#ffffff', scale: 2 });
                const link = document.createElement('a');
                link.download = `nota-${document.getElementById('receiptOrderId').textContent.replace('#', '')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('Nota berhasil disimpan!', 'success');
            } catch (err) {
                console.error('Save receipt error:', err);
                showToast('Gagal menyimpan nota', 'error');
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSettings();
            await loadMenu();
        });
    </script>
</body>

</html>