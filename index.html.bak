<!doctype html>
<html lang="id" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warkop Management System - UPDATED</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6B21A8',
            secondary: '#1E40AF',
            accent: '#8B5CF6',
            surface: '#1E1B4B',
            dark: '#0F0A1F'
          },
          fontFamily: {
            poppins: ['Poppins', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    * {
      font-family: 'Poppins', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #1E1B4B;
    }

    ::-webkit-scrollbar-thumb {
      background: #6B21A8;
      border-radius: 3px;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #1E1B4B 0%, #0F0A1F 50%, #1E1B4B 100%);
    }

    .glass {
      background: rgba(30, 27, 75, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(107, 33, 168, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, #6B21A8 0%, #1E40AF 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(107, 33, 168, 0.4);
    }

    .sidebar-item {
      transition: all 0.2s ease;
    }

    .sidebar-item:hover,
    .sidebar-item.active {
      background: linear-gradient(90deg, rgba(107, 33, 168, 0.3) 0%, transparent 100%);
      border-left: 3px solid #8B5CF6;
    }

    .input-field {
      background: rgba(15, 10, 31, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.3);
      transition: all 0.2s ease;
    }

    .input-field:focus {
      border-color: #8B5CF6;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      outline: none;
    }

    .menu-card {
      background: linear-gradient(145deg, rgba(30, 27, 75, 0.9) 0%, rgba(15, 10, 31, 0.9) 100%);
    }

    .status-badge {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade {
      animation: fadeIn 0.3s ease-out;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes bounce-short {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .animate-bounce-short {
      animation: bounce-short 0.5s ease-in-out 1;
    }

    .category-btn.active {
      background: linear-gradient(135deg, #6B21A8 0%, #1E40AF 100%) !important;
    }

    /* Sidebar Protection - ensure sidebar stays visible during modal operations */
    #sidebar {
      z-index: 45 !important;
      /* Higher than general content, lower than modals (z-50) */
    }

    /* Ensure sidebar is never hidden by accident */
    #sidebar:not(.hidden) {
      display: flex !important;
      visibility: visible !important;
    }

    /* Modal backdrop should not affect sidebar on desktop */
    @media (min-width: 768px) {

      /* Modal overlays with position fixed - offset from sidebar */
      body>.fixed[class*="inset-0"][class*="bg-black"] {
        left: 16rem;
        /* Account for sidebar width on desktop */
      }
    }

    /* ===== MOBILE MINI SIDEBAR ===== */
    @media (max-width: 767px) {

      /* Sidebar: Always visible, mini mode (icon only) */
      #sidebar {
        width: 60px !important;
        min-width: 60px !important;
        transform: translateX(0) !important;
        left: 0 !important;
        position: fixed !important;
      }

      /* Hide sidebar header text (keep logo) */
      #sidebar>div:first-child>div>div:last-child {
        display: none !important;
      }

      /* Hide all text labels in sidebar items */
      .sidebar-item>span.text-sm,
      .sidebar-item>span:not(.text-lg) {
        display: none !important;
      }

      /* Center icons in sidebar items */
      .sidebar-item {
        justify-content: center !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        gap: 0 !important;
      }

      /* Make icon larger on mobile for touch */
      .sidebar-item>span.text-lg {
        font-size: 1.5rem !important;
      }

      /* Hide logout text, keep icon */
      #sidebar>div:last-child button>span.text-sm {
        display: none !important;
      }

      #sidebar>div:last-child button {
        justify-content: center !important;
        gap: 0 !important;
      }

      /* Adjust nav padding */
      #sidebar nav .space-y-1 {
        padding-left: 0.25rem !important;
        padding-right: 0.25rem !important;
      }

      /* Main content: shift right by sidebar width */
      #adminPage>.flex>main {
        margin-left: 60px !important;
      }

      /* Hide mobile hamburger header (sidebar always visible now) */
      .md\:hidden.glass.sticky {
        display: none !important;
      }
    }
  </style>

  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
</head>

<body class="h-full gradient-bg text-white overflow-auto">
  <div id="app" class="h-full w-full">
    <!-- CUSTOMER PAGE - HIDDEN ON ADMIN PAGE -->
    <div id="customerPage" class="min-h-full hidden">
      <!-- Header -->
      <header class="glass sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div id="customerHeaderLogo"
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center overflow-hidden">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" />
                </svg>
              </div>
              <div>
                <h1 id="businessNameDisplay"
                  class="text-xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                  Warkop Santai</h1>
                <p id="taglineDisplay" class="text-xs text-gray-400">Ngopi Enak, Harga Merakyat</p>
              </div>
            </div>
            <button onclick="showLoginModal()"
              class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg> Login Pegawai
            </button>
          </div>
        </div>
      </header>

      <!-- Category Filter -->
      <div class="max-w-7xl mx-auto px-4 py-6">
        <div id="categoryContainer" class="flex gap-3 overflow-x-auto pb-2">
          <button class="category-btn active px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap"
            data-cat="all">ğŸ½ï¸ Semua Menu</button>
          <button class="category-btn px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap"
            data-cat="kopi">â˜• Kopi</button>
          <button class="category-btn px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap"
            data-cat="minuman">ğŸ¥¤ Minuman</button>
          <button class="category-btn px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap"
            data-cat="makanan">ğŸœ Makanan</button>
          <button class="category-btn px-5 py-2 rounded-full glass text-sm font-medium whitespace-nowrap"
            data-cat="snack">ğŸ¿ Snack</button>
        </div>
      </div>

      <!-- Menu Grid -->
      <div class="max-w-7xl mx-auto px-4 pb-6">
        <div id="menuGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          <!-- Menu items will be rendered here -->
        </div>
        <div id="emptyMenu" class="hidden text-center py-12">
          <div class="text-6xl mb-4">ğŸ“‹</div>
          <p class="text-gray-400">Belum ada menu tersedia</p>
        </div>
      </div>

      <!-- Cart Floating Button -->
      <div id="cartFloating" class="fixed bottom-6 right-6 z-40 hidden">
        <button onclick="showOrderForm()"
          class="btn-primary w-14 h-14 rounded-full shadow-2xl flex items-center justify-center relative">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span id="cartCount"
            class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center font-bold">0</span>
        </button>
      </div>
    </div>

    <!-- LOGIN PAGE - Main view for admin panel -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
      <div class="glass rounded-2xl p-8 w-full max-w-md animate-fade">
        <div class="text-center mb-8">
          <div
            class="w-20 h-20 rounded-2xl bg-gradient-to-br from-primary to-secondary mx-auto flex items-center justify-center mb-4">
            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
            Warkop Santai</h1>
          <p class="text-sm text-gray-400 mt-1">Admin Panel</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">Username</label>
            <input type="text" id="mainLoginUsername" class="input-field w-full px-4 py-3 rounded-xl text-white text-lg"
              placeholder="Masukkan username" autofocus>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-2">Password / PIN</label>
            <input type="password" id="mainLoginPassword"
              class="input-field w-full px-4 py-3 rounded-xl text-white text-lg" placeholder="Password atau PIN 6 digit"
              onkeypress="if(event.key==='Enter')doMainLogin()">
          </div>
          <div id="mainLoginError" class="text-red-400 text-sm hidden text-center py-2"></div>
          <button onclick="doMainLogin()" id="mainLoginBtn"
            class="btn-primary w-full py-4 rounded-xl font-bold text-lg mt-4">
            ğŸš€ Masuk ke Dashboard
          </button>
        </div>
        <div class="mt-6 pt-4 border-t border-purple-500/20 text-center">
          <p class="text-xs text-gray-500">Admin: password | Kasir: PIN 6 digit</p>
          <a href="/" class="text-xs text-purple-400 hover:text-purple-300 mt-2 inline-block">â† Kembali ke Menu
            Pelanggan</a>
        </div>
      </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminPage" class="h-full hidden">
      <div class="flex h-full">
        <!-- Sidebar -->
        <aside id="sidebar"
          class="w-64 glass border-r border-purple-500/20 flex flex-col fixed h-full z-40 -translate-x-full md:translate-x-0 transition-transform">
          <div class="p-4 border-b border-purple-500/20">
            <div class="flex items-center gap-3">
              <div id="adminSidebarLogo"
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center overflow-hidden">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" />
                </svg>
              </div>
              <div>
                <h1 class="font-bold text-sm">Admin Panel</h1>
                <p class="text-xs text-gray-400">Warkop Santai</p>
              </div>
            </div>
          </div>
          <nav class="flex-1 overflow-auto py-4">
            <div class="space-y-1 px-2">
              <button onclick="showSection('dashboard')"
                class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="dashboard">
                <span class="text-lg">ğŸ“Š</span><span class="text-sm">Dashboard</span>
              </button>
              <button onclick="showSection('menu')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="menu">
                <span class="text-lg">ğŸ½ï¸</span><span class="text-sm">Manajemen Menu</span>
              </button>
              <button onclick="showSection('pos')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="pos">
                <span class="text-lg">ğŸ§¾</span><span class="text-sm">Kasir (POS)</span>
              </button>
              <button onclick="showSection('gramasi')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="gramasi">
                <span class="text-lg">âš–ï¸</span><span class="text-sm">Gramasi &amp; HPP</span>
              </button>
              <button onclick="showSection('inventory')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="inventory">
                <span class="text-lg">ğŸ“¦</span><span class="text-sm">Inventaris</span>
              </button>
              <button onclick="showSection('finance')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="finance">
                <span class="text-lg">ğŸ’°</span><span class="text-sm">Keuangan &amp; Kas</span>
              </button>
              <button onclick="showSection('employee')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="employee">
                <span class="text-lg">ğŸ‘¥</span><span class="text-sm">Pegawai</span>
              </button>
              <button onclick="showSection('table')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="table">
                <span class="text-lg">ğŸª‘</span><span class="text-sm">Meja &amp; Reservasi</span>
              </button>
              <button onclick="showSection('report')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="report">
                <span class="text-lg">ğŸ“ˆ</span><span class="text-sm">Laporan &amp; Analitik</span>
              </button>
              <button onclick="showSection('shiftReport')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="shiftReport">
                <span class="text-lg">ğŸ”</span><span class="text-sm">Laporan Shift</span>
              </button>
              <button onclick="showSection('customer')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="customer">
                <span class="text-lg">â¤ï¸</span><span class="text-sm">Pelanggan &amp; Loyalti</span>
              </button>
              <button onclick="showSection('settings')"
                class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left"
                data-section="settings">
                <span class="text-lg">âš™ï¸</span><span class="text-sm">Pengaturan</span>
              </button>
            </div>
          </nav>
          <div class="p-4 border-t border-purple-500/20">
            <button onclick="logout()"
              class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-400 hover:bg-red-500/10 transition-colors">
              <span class="text-lg">ğŸšª</span><span class="text-sm">Keluar</span>
            </button>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 overflow-auto">
          <!-- Mobile Header -->
          <div class="md:hidden glass sticky top-0 z-30 p-4 flex items-center justify-between">
            <button onclick="toggleSidebar()"
              class="w-10 h-10 rounded-lg bg-surface flex items-center justify-center">â˜°</button>
            <span class="font-bold">Admin Panel</span>
            <button onclick="logout()"
              class="w-10 h-10 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center">ğŸšª</button>
          </div>

          <!-- Dashboard Section -->
          <section id="dashboardSection" class="p-4 md:p-6 space-y-6">
            <h2 class="text-2xl font-bold">ğŸ“Š Dashboard</h2>
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="glass rounded-xl p-4 card-hover">
                <div class="flex items-center justify-between mb-2"><span class="text-2xl">ğŸ’°</span> <span
                    class="text-xs text-green-400 bg-green-500/20 px-2 py-1 rounded-full">+12%</span></div>
                <p class="text-2xl font-bold" id="statRevenue">Rp 0</p>
                <p class="text-xs text-gray-400">Pendapatan Hari Ini</p>
              </div>
              <div class="glass rounded-xl p-4 card-hover">
                <div class="flex items-center justify-between mb-2"><span class="text-2xl">ğŸ“‹</span> <span
                    class="text-xs text-blue-400 bg-blue-500/20 px-2 py-1 rounded-full">Live</span></div>
                <p class="text-2xl font-bold" id="statOrders">0</p>
                <p class="text-xs text-gray-400">Total Pesanan</p>
              </div>
              <div class="glass rounded-xl p-4 card-hover">
                <div class="flex items-center justify-between mb-2"><span class="text-2xl">ğŸª‘</span></div>
                <p class="text-2xl font-bold" id="statTables">0/0</p>
                <p class="text-xs text-gray-400">Meja Terisi</p>
              </div>
              <div class="glass rounded-xl p-4 card-hover">
                <div class="flex items-center justify-between mb-2"><span class="text-2xl">ğŸ‘¥</span></div>
                <p class="text-2xl font-bold" id="statCustomers">0</p>
                <p class="text-xs text-gray-400">Pelanggan</p>
              </div>
            </div>
            <!-- Charts -->
            <!-- Charts & Ops Widgets -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- Left: Hourly Traffic Chart (2/3 width) -->
              <div class="glass rounded-xl p-4 lg:col-span-2">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold">ğŸ“Š Traffic Jam Sibuk (Hari Ini)</h3>
                  <div class="text-xs text-gray-400">00:00 - 23:00</div>
                </div>
                <!-- Updated ID for specific chart logic -->
                <div id="hourlySalesChart" class="h-64 flex items-end justify-around gap-2 pb-2"></div>
              </div>

              <!-- Right: Operational Widgets (1/3 width) -->
              <div class="space-y-6">

                <!-- Widget A: Top 5 Menu -->
                <div class="glass rounded-xl p-4">
                  <h3 class="font-bold mb-3 flex items-center gap-2">ğŸ† Top Menu Laris <span
                      class="text-xs text-gray-400 font-normal">(Hari Ini)</span></h3>
                  <div id="topMenuWidget" class="space-y-3">
                    <!-- Populated by JS -->
                    <div class="text-center text-gray-500 text-sm py-4">Belum ada data</div>
                  </div>
                </div>

                <!-- Widget B: Low Stock Alert -->
                <div class="glass rounded-xl p-4 border border-red-500/10">
                  <h3 class="font-bold mb-3 flex items-center gap-2 text-red-300">âš ï¸ Stok Menipis</h3>
                  <div id="lowStockWidget" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    <!-- Populated by JS -->
                    <div class="text-center text-gray-500 text-sm py-4">Stok aman</div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Bottom: Transaction History (New) -->
            <div class="glass rounded-xl p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold">ğŸ“œ Riwayat Transaksi Hari Ini</h3>
                <input type="text" id="historySearch" onkeyup="filterTransactionHistory()"
                  placeholder="ğŸ” Cari Nama / Meja..."
                  class="bg-surface/50 border border-gray-700/50 rounded-lg px-3 py-1 text-sm text-white focus:ring-2 focus:ring-purple-500 outline-none">
              </div>

              <div class="overflow-x-auto">
                <div class="max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                  <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-[#1a1625] z-10 shadow-sm shadow-black/20">
                      <tr class="text-gray-400 text-xs uppercase border-b border-gray-700/50">
                        <th class="py-3 px-2">Waktu</th>
                        <th class="py-3 px-2">Pelanggan</th>
                        <th class="py-3 px-2">Tipe</th>
                        <th class="py-3 px-2">Menu</th>
                        <th class="py-3 px-2 text-right">Total</th>
                        <th class="py-3 px-2 text-center">Metode</th>
                        <th class="py-3 px-2 text-center">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="todayTransactionTable" class="text-sm divide-y divide-gray-700/30">
                      <!-- Populated by JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Table Status (Keep existing) -->
            <div class="glass rounded-xl p-4">
              <h3 class="font-bold mb-4">ğŸª‘ Status Meja</h3>
              <div id="tableStatusGrid" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3"></div>
            </div>
          </section>

          <!-- Menu Management Section -->
          <section id="menuSection" class="p-4 md:p-6 space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold">ğŸ½ï¸ Manajemen Menu</h2>
              <div class="flex items-center gap-2">
                <button onclick="syncToCloud()" class="px-3 py-2 rounded-lg bg-yellow-500/20 text-yellow-300 text-sm">â˜ï¸
                  Sync to Cloud</button>
                <button onclick="showAddMenuModal()"
                  class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                  <span>â•</span> Tambah Menu
                </button>
              </div>
            </div>
            <!-- Categories -->
            <div class="glass rounded-xl p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold">ğŸ“ Kategori</h3>
                <button onclick="showAddCategoryModal()"
                  class="px-3 py-1 rounded-lg bg-primary/50 hover:bg-primary text-xs font-medium flex items-center gap-1">
                  <span>â•</span> Tambah
                </button>
              </div>
              <div id="categoryList" class="flex flex-wrap gap-2"></div>
            </div>
            <!-- Menu List -->
            <div class="glass rounded-xl overflow-hidden">
              <div class="p-4 border-b border-purple-500/20">
                <input type="text" id="menuSearch" class="input-field w-full px-4 py-2 rounded-lg text-white"
                  placeholder="ğŸ” Cari menu..." oninput="searchMenu()">
              </div>
              <div id="adminMenuList" class="divide-y divide-purple-500/10"></div>
            </div>
          </section>

          <!-- POS Section - KDS Style Layout -->
          <section id="posSection" class="hidden [&:not(.hidden)]:flex [&:not(.hidden)]:flex-col h-[calc(100vh-80px)]">
            <!-- Header Bar -->
            <div class="flex items-center justify-between p-4 border-b border-purple-500/20 bg-surface/50">
              <div class="flex items-center gap-4">
                <h2 class="text-2xl font-bold">ğŸ§¾ Kasir (POS)</h2>
                <!-- Status Filter Pills -->
                <div class="flex gap-2">
                  <button onclick="filterPOSOrders('all')"
                    class="pos-filter-btn active px-3 py-1 rounded-full text-sm bg-purple-500/20 text-purple-400"
                    data-filter="all">
                    Semua
                  </button>
                  <button onclick="filterPOSOrders('new')"
                    class="pos-filter-btn px-3 py-1 rounded-full text-sm bg-yellow-500/10 text-yellow-400 hover:bg-yellow-500/20"
                    data-filter="new">
                    ğŸŸ¡ Baru <span id="posNewCount" class="ml-1 font-bold">0</span>
                  </button>
                  <button onclick="filterPOSOrders('process')"
                    class="pos-filter-btn px-3 py-1 rounded-full text-sm bg-blue-500/10 text-blue-400 hover:bg-blue-500/20"
                    data-filter="process">
                    ğŸ”µ Diproses <span id="posProcessCount" class="ml-1 font-bold">0</span>
                  </button>
                  <button onclick="filterPOSOrders('done')"
                    class="pos-filter-btn px-3 py-1 rounded-full text-sm bg-green-500/10 text-green-400 hover:bg-green-500/20"
                    data-filter="done">
                    ğŸŸ¢ Selesai <span id="posDoneCount" class="ml-1 font-bold">0</span>
                  </button>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button id="btnAktifkanSuara" onclick="activateSoundNotification()"
                  class="px-3 py-2 rounded-lg bg-surface text-sm flex items-center gap-2 hover:bg-surface/80 border border-purple-500/30">
                  <span id="soundBtnIcon">ğŸ”‡</span> <span id="soundBtnText" class="hidden md:inline">Notifikasi</span>
                </button>
                <!-- + Pesanan Baru Button -->
                <button onclick="showManualOrderModal()"
                  class="btn-primary px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg">
                  <span class="text-xl">â•</span> Buat Pesanan Baru
                </button>
              </div>
            </div>

            <!-- Main Order Grid - Full Height -->
            <div class="flex-1 overflow-auto p-4"
              style="background: linear-gradient(180deg, rgba(139,92,246,0.02) 0%, transparent 100%);">
              <div id="posOrdersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Order cards will be rendered here -->
                <div class="col-span-full text-center py-20 text-gray-500">
                  <div class="text-6xl mb-4">ğŸ“‹</div>
                  <p class="text-xl">Belum ada pesanan aktif</p>
                  <p class="text-sm mt-2">Klik "Buat Pesanan Baru" untuk memulai</p>
                </div>
              </div>
            </div>

            <!-- Hidden legacy elements for backwards compatibility -->
            <div id="posOrdersList" class="hidden"></div>
            <span id="posNew" class="hidden">0</span>
            <span id="posProcess" class="hidden">0</span>
            <span id="posDone" class="hidden">0</span>

            <!-- DIGITAL CASH DRAWER WIDGET (Floating) -->
            <div id="cashDrawerWidget"
              class="fixed bottom-4 right-4 z-40 glass rounded-xl p-4 border border-purple-500/30 shadow-2xl min-w-[280px] hidden">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold text-sm flex items-center gap-2">
                  ğŸ’° Laci Kas Digital
                </h4>
                <button onclick="toggleCashDrawerWidget()" class="text-gray-400 hover:text-white text-xs">âœ•</button>
              </div>

              <!-- Kasir Info -->
              <div class="text-xs text-gray-400 mb-3" id="cashDrawerKasir">Kasir: -</div>

              <!-- Balance Cards -->
              <div class="space-y-2">
                <!-- Modal Awal -->
                <div class="flex justify-between items-center p-2 rounded-lg bg-surface/50">
                  <span class="text-xs text-gray-400">ğŸ“¥ Modal Awal</span>
                  <span class="font-bold text-blue-400" id="cdOpeningCash">Rp 0</span>
                </div>

                <!-- Saldo Tunai -->
                <div
                  class="flex justify-between items-center p-2 rounded-lg bg-green-500/10 border border-green-500/20">
                  <span class="text-xs text-green-400">ğŸ’µ Saldo Tunai</span>
                  <span class="font-bold text-green-400 text-lg" id="cdTotalCash">Rp 0</span>
                </div>

                <!-- Non-Tunai -->
                <div
                  class="flex justify-between items-center p-2 rounded-lg bg-purple-500/10 border border-purple-500/20">
                  <span class="text-xs text-purple-400">ğŸ’³ Non-Tunai</span>
                  <span class="font-bold text-purple-400" id="cdNonCash">Rp 0</span>
                </div>

                <!-- Adjustment (Admin only) -->
                <div id="cdAdjustmentRow" class="hidden">
                  <div class="flex justify-between items-center p-2 rounded-lg bg-yellow-500/10">
                    <span class="text-xs text-yellow-400">âš¡ Penyesuaian</span>
                    <span class="font-medium text-yellow-400" id="cdAdjustment">Rp 0</span>
                  </div>
                </div>
              </div>

              <!-- Admin Actions -->
              <div id="cdAdminActions" class="hidden mt-3 pt-3 border-t border-purple-500/20">
                <button onclick="showCashAdjustmentModal()"
                  class="w-full px-3 py-2 rounded-lg bg-purple-500/20 text-purple-400 text-sm hover:bg-purple-500/30">
                  âš™ï¸ Penyesuaian Kas
                </button>
              </div>

              <!-- Last Update -->
              <div class="mt-3 pt-2 border-t border-white/10 text-xs text-gray-500 text-center" id="cdLastUpdate">
                Update: -
              </div>
            </div>

            <!-- Toggle Button (Always visible) -->
            <button id="cashDrawerToggle" onclick="toggleCashDrawerWidget()"
              class="fixed bottom-4 right-4 z-30 p-3 rounded-xl bg-green-500 text-white shadow-lg hover:bg-green-600 flex items-center gap-2">
              <span class="text-xl">ğŸ’°</span>
              <span class="font-bold" id="cdQuickBalance">Rp 0</span>
            </button>
          </section>

          <!-- Manual Order Modal (Popup) -->
          <div id="manualOrderModal"
            class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="glass rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-auto animate-fade">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">â• Buat Pesanan Baru</h3>
                <button onclick="closeManualOrderModal()"
                  class="w-8 h-8 rounded-full bg-surface hover:bg-red-500/20 flex items-center justify-center text-gray-400 hover:text-red-400">âœ•</button>
              </div>

              <div class="space-y-4">
                <!-- Customer Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <label class="block text-sm text-gray-400 mb-1">Nama Pelanggan</label>
                    <input type="text" id="posCustomerName" class="input-field w-full px-4 py-2 rounded-lg text-white"
                      placeholder="Nama pelanggan">
                  </div>
                  <div>
                    <label class="block text-sm text-gray-400 mb-1">No. Meja</label>
                    <select id="posTableNumber" class="input-field w-full px-4 py-2 rounded-lg text-white"></select>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-400 mb-1">Tipe Pesanan</label>
                    <select id="posOrderType" class="input-field w-full px-4 py-2 rounded-lg text-white">
                      <option value="dine-in">ğŸ½ï¸ Dine In</option>
                      <option value="take-away">ğŸ¥¡ Take Away</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-400 mb-1">Metode Pembayaran</label>
                    <select id="posPaymentMethod" class="input-field w-full px-4 py-2 rounded-lg text-white">
                      <option value="cash">ğŸ’µ Tunai</option>
                      <option value="qris">ğŸ“± QRIS</option>
                      <option value="bank">ğŸ¦ Transfer Bank</option>
                      <option value="ewallet">ğŸ“² E-Wallet</option>
                    </select>
                  </div>
                </div>

                <!-- Menu Selection -->
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Pilih Menu</label>
                  <div id="posMenuSelect"
                    class="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-64 overflow-auto p-2 bg-surface/30 rounded-lg">
                  </div>
                </div>

                <!-- Selected Items Preview -->
                <div id="posSelectedItems" class="hidden">
                  <label class="block text-sm text-gray-400 mb-2">Item Dipilih</label>
                  <div id="posCartPreview" class="space-y-2 bg-surface/30 rounded-lg p-3"></div>
                </div>

                <!-- Notes -->
                <div>
                  <label class="block text-sm text-gray-400 mb-1">Catatan</label>
                  <textarea id="posNote" class="input-field w-full px-4 py-2 rounded-lg text-white" rows="2"
                    placeholder="Catatan untuk dapur..."></textarea>
                </div>

                <!-- Total & Submit -->
                <div class="flex items-center justify-between pt-4 border-t border-purple-500/20">
                  <div>
                    <p class="text-sm text-gray-400">Total:</p>
                    <p class="text-2xl font-bold text-green-400" id="posOrderTotal">Rp 0</p>
                  </div>
                  <button onclick="createManualOrder()" class="btn-primary px-8 py-3 rounded-xl font-bold text-lg">
                    ğŸš€ Buat Pesanan
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Gramasi Section -->
          <section id="gramasiSection" class="p-4 md:p-6 space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold">âš–ï¸ Gramasi &amp; HPP</h2>
              <button onclick="showAddGramasiModal()"
                class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <span>â•</span> Tambah Gramasi
              </button>
            </div>
            <!-- Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Total HPP</p>
                <p class="text-xl font-bold text-red-400" id="totalHpp">Rp 0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Total Harga Jual</p>
                <p class="text-xl font-bold text-green-400" id="totalSellingPrice">Rp 0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Total Keuntungan</p>
                <p class="text-xl font-bold text-purple-400" id="totalProfit">Rp 0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Avg Margin</p>
                <p class="text-xl font-bold text-blue-400" id="avgMargin">0%</p>
              </div>
            </div>
            <!-- Gramasi Table -->
            <div class="glass rounded-xl overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-surface/50">
                    <tr>
                      <th class="px-4 py-3 text-left">Nama Produk</th>
                      <th class="px-4 py-3 text-right">Total HPP</th>
                      <th class="px-4 py-3 text-right">Harga Jual</th>
                      <th class="px-4 py-3 text-right">PPN (11%)</th>
                      <th class="px-4 py-3 text-right">Net Profit</th>
                      <th class="px-4 py-3 text-right">Margin %</th>
                      <th class="px-4 py-3 text-center">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="gramasiTable" class="divide-y divide-purple-500/10"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Inventory Section -->
          <section id="inventorySection" class="p-4 md:p-6 space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold">ğŸ“¦ Inventaris</h2>
              <div class="flex gap-2">
                <button onclick="showAddUnitModal()"
                  class="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 bg-surface hover:bg-surface/80 border border-purple-500/30">
                  <span>ğŸ“</span> Tambah Satuan
                </button>
                <button onclick="showAddIngredientModal()"
                  class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                  <span>â•</span> Tambah Bahan
                </button>
              </div>
            </div>
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Total Bahan</p>
                <p class="text-xl font-bold" id="invTotalItems">0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Stok Rendah</p>
                <p class="text-xl font-bold text-red-400" id="invLowStock">0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Nilai Aset Stok</p>
                <p class="text-xl font-bold text-green-400" id="invAssetValue">Rp 0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Nilai + PPN</p>
                <p class="text-xl font-bold text-purple-400" id="invAssetPPN">Rp 0</p>
              </div>
            </div>
            <!-- Tab Navigation -->
            <div class="flex gap-2">
              <button onclick="showInventoryTab('bahan')"
                class="inv-tab-btn active px-4 py-2 rounded-lg text-sm bg-primary" data-tab="bahan">ğŸ“‹ Master
                Bahan</button>
              <button onclick="showInventoryTab('opname')" class="inv-tab-btn px-4 py-2 rounded-lg text-sm bg-surface"
                data-tab="opname">ğŸ“ Stock Opname</button>
              <button onclick="showInventoryTab('riwayat')" class="inv-tab-btn px-4 py-2 rounded-lg text-sm bg-surface"
                data-tab="riwayat">ğŸ“œ Riwayat Stok</button>
            </div>
            <!-- Tab: Master Bahan Baku -->
            <div id="invTabBahan" class="inv-tab-content">
              <div class="glass rounded-xl overflow-hidden">
                <div class="p-4 border-b border-purple-500/20">
                  <input type="text" id="ingredientSearch" class="input-field w-full px-4 py-2 rounded-lg text-white"
                    placeholder="ğŸ” Cari bahan..." oninput="searchIngredients()">
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-surface/50">
                      <tr>
                        <th class="px-4 py-3 text-left">Nama Bahan</th>
                        <th class="px-4 py-3 text-right">Stok</th>
                        <th class="px-4 py-3 text-right">Harga Beli</th>
                        <th class="px-4 py-3 text-right">Modal/Unit</th>
                        <th class="px-4 py-3 text-right">Nilai Stok</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-center">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="ingredientTable" class="divide-y divide-purple-500/10"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <!-- Tab: Stock Opname -->
            <div id="invTabOpname" class="inv-tab-content hidden">
              <div class="glass rounded-xl p-4">
                <h3 class="font-bold mb-4">ğŸ“ Rekonsiliasi Stok</h3>
                <p class="text-sm text-gray-400 mb-4">Bandingkan stok sistem dengan stok fisik. Selisih akan dicatat dan
                  disesuaikan.</p>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-surface/50">
                      <tr>
                        <th class="px-4 py-3 text-left">Nama Bahan</th>
                        <th class="px-4 py-3 text-right">Stok Sistem</th>
                        <th class="px-4 py-3 text-right">Stok Fisik</th>
                        <th class="px-4 py-3 text-right">Selisih</th>
                        <th class="px-4 py-3 text-right">Nilai Selisih (Rp)</th>
                      </tr>
                    </thead>
                    <tbody id="opnameTable" class="divide-y divide-purple-500/10"></tbody>
                  </table>
                </div>
                <button onclick="saveStockOpname()" class="btn-primary mt-4 px-6 py-2 rounded-lg">ğŸ’¾ Simpan
                  Opname</button>
              </div>
            </div>
            <!-- Tab: Riwayat Stok -->
            <div id="invTabRiwayat" class="inv-tab-content hidden">
              <div class="glass rounded-xl overflow-hidden">
                <div class="p-4 border-b border-purple-500/20 flex items-center justify-between">
                  <h3 class="font-bold">ğŸ“œ Riwayat Pergerakan Stok</h3>
                  <select id="stockHistoryFilter" class="input-field px-3 py-1 rounded-lg text-sm"
                    onchange="filterStockHistory()">
                    <option value="all">Semua</option>
                    <option value="in">Masuk</option>
                    <option value="out">Keluar</option>
                    <option value="opname">Opname</option>
                  </select>
                </div>
                <div id="stockHistoryList" class="divide-y divide-purple-500/10 max-h-96 overflow-auto"></div>
              </div>
            </div>
          </section>

          <!-- Finance Section -->
          <section id="financeSection" class="p-4 md:p-6 space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold">ğŸ’° Keuangan &amp; Kas</h2>
              <button onclick="showAddCashModal()"
                class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <span>â•</span> Tambah Transaksi
              </button>
            </div>
            <!-- Balance Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="glass rounded-xl p-6 card-hover">
                <div class="flex items-center gap-4">
                  <div class="w-14 h-14 rounded-xl bg-green-500/20 flex items-center justify-center"><span
                      class="text-2xl">ğŸ“¥</span></div>
                  <div>
                    <p class="text-sm text-gray-400">Kas Masuk</p>
                    <p class="text-2xl font-bold text-green-400" id="financeCashIn">Rp 0</p>
                  </div>
                </div>
              </div>
              <div class="glass rounded-xl p-6 card-hover">
                <div class="flex items-center gap-4">
                  <div class="w-14 h-14 rounded-xl bg-red-500/20 flex items-center justify-center"><span
                      class="text-2xl">ğŸ“¤</span></div>
                  <div>
                    <p class="text-sm text-gray-400">Kas Keluar</p>
                    <p class="text-2xl font-bold text-red-400" id="financeCashOut">Rp 0</p>
                  </div>
                </div>
              </div>
              <div class="glass rounded-xl p-6 card-hover">
                <div class="flex items-center gap-4">
                  <div class="w-14 h-14 rounded-xl bg-purple-500/20 flex items-center justify-center"><span
                      class="text-2xl">ğŸ’°</span></div>
                  <div>
                    <p class="text-sm text-gray-400">Saldo</p>
                    <p class="text-2xl font-bold text-purple-400" id="financeBalance">Rp 0</p>
                  </div>
                </div>
              </div>
            </div>
            <!-- Transaction List -->
            <div class="glass rounded-xl overflow-hidden">
              <div class="p-4 border-b border-purple-500/20 flex items-center justify-between">
                <h3 class="font-bold">ğŸ“‹ Riwayat Transaksi</h3>
                <select id="financeFilter" class="input-field px-3 py-1 rounded-lg text-sm"
                  onchange="filterFinanceList()">
                  <option value="all">Semua</option>
                  <option value="in">Kas Masuk</option>
                  <option value="out">Kas Keluar</option>
                </select>
              </div>
              <div id="financeList" class="divide-y divide-purple-500/10 max-h-96 overflow-auto"></div>
            </div>
          </section>

          <!-- Employee Section -->
          <section id="employeeSection" class="p-4 md:p-6 space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold">ğŸ‘¥ Manajemen Pegawai</h2>
              <button onclick="showAddEmployeeModal()"
                class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <span>â•</span> Tambah Pegawai
              </button>
            </div>
            <div id="employeeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </section>

          <!-- Table Section -->
          <section id="tableSection" class="p-4 md:p-6 space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold">ğŸª‘ Meja &amp; Reservasi</h2>
              <button onclick="showAddTableModal()"
                class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <span>â•</span> Tambah Meja
              </button>
            </div>
            <!-- Table Grid -->
            <div class="glass rounded-xl p-4">
              <h3 class="font-bold mb-4">Status Meja</h3>
              <div id="adminTableGrid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-8 gap-4"></div>
            </div>
            <!-- Reservations -->
            <div class="glass rounded-xl overflow-hidden">
              <div class="p-4 border-b border-purple-500/20">
                <h3 class="font-bold">ğŸ“… Reservasi</h3>
              </div>
              <div id="reservationList" class="divide-y divide-purple-500/10 max-h-64 overflow-auto">
                <div class="p-4 text-center text-gray-400">Belum ada reservasi</div>
              </div>
            </div>
          </section>

          <!-- Report Section -->
          <section id="reportSection" class="p-4 md:p-6 space-y-6 hidden">
            <h2 class="text-2xl font-bold">ğŸ“ˆ Laporan &amp; Analitik</h2>
            <!-- Period Filter -->
            <div class="flex gap-2 flex-wrap">
              <button onclick="setReportPeriod('daily')"
                class="report-period-btn active px-4 py-2 rounded-lg text-sm bg-primary">Harian</button>
              <button onclick="setReportPeriod('weekly')"
                class="report-period-btn px-4 py-2 rounded-lg text-sm bg-surface">Mingguan</button>
              <button onclick="setReportPeriod('monthly')"
                class="report-period-btn px-4 py-2 rounded-lg text-sm bg-surface">Bulanan</button>
              <button onclick="setReportPeriod('yearly')"
                class="report-period-btn px-4 py-2 rounded-lg text-sm bg-surface">Tahunan</button>
            </div>
            <!-- Report Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Total Pendapatan</p>
                <p class="text-xl font-bold text-green-400" id="reportRevenue">Rp 0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Total Pesanan</p>
                <p class="text-xl font-bold text-blue-400" id="reportOrders">0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Pelanggan Pria</p>
                <p class="text-xl font-bold text-purple-400" id="reportMale">0</p>
              </div>
              <div class="glass rounded-xl p-4">
                <p class="text-xs text-gray-400">Pelanggan Wanita</p>
                <p class="text-xl font-bold text-pink-400" id="reportFemale">0</p>
              </div>
            </div>
            <!-- Profit Analysis -->
            <div class="glass rounded-xl p-4">
              <h3 class="font-bold mb-4">âš–ï¸ Analisis Profitabilitas dari Pesanan</h3>
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <p class="text-xs text-gray-400">Total HPP Pesanan</p>
                  <p class="text-xl font-bold text-red-400" id="reportTotalHPP">Rp 0</p>
                </div>
                <div>
                  <p class="text-xs text-gray-400">Total Profit</p>
                  <p class="text-xl font-bold text-green-400" id="reportTotalProfit">Rp 0</p>
                </div>
                <div>
                  <p class="text-xs text-gray-400">Rata-rata Margin</p>
                  <p class="text-xl font-bold text-purple-400" id="reportAvgMargin">0%</p>
                </div>
                <div>
                  <p class="text-xs text-gray-400">Pesanan Terintegrasi</p>
                  <p class="text-xl font-bold text-blue-400" id="reportIntegratedOrders">0</p>
                </div>
              </div>
            </div>
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="glass rounded-xl p-4">
                <h3 class="font-bold mb-4">ğŸ† Menu Terlaris</h3>
                <div id="topMenuChart" class="space-y-3"></div>
              </div>
              <div class="glass rounded-xl p-4">
                <h3 class="font-bold mb-4">â° Jam Ramai</h3>
                <div id="peakHoursChart" class="h-48 flex items-end justify-around gap-1"></div>
              </div>
            </div>
            <!-- Shift History Section -->
            <div class="glass rounded-xl overflow-hidden">
              <div class="p-4 border-b border-purple-500/20 flex items-center justify-between">
                <h3 class="font-bold">ğŸ“‹ Riwayat Shift Kasir</h3>
                <div class="flex gap-2">
                  <button onclick="exportShiftReport()"
                    class="px-3 py-2 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 text-sm flex items-center gap-1">
                    ğŸ“¥ Excel Shift
                  </button>
                  <button onclick="exportTransactionsReport()"
                    class="px-3 py-2 rounded-lg bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 text-sm flex items-center gap-1">
                    ğŸ“¥ Excel Transaksi
                  </button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-purple-500/10">
                    <tr>
                      <th class="px-4 py-3 text-left">Tanggal</th>
                      <th class="px-4 py-3 text-left">Kasir</th>
                      <th class="px-4 py-3 text-right">Modal Awal</th>
                      <th class="px-4 py-3 text-right">Total Omzet</th>
                      <th class="px-4 py-3 text-right">Uang Fisik</th>
                      <th class="px-4 py-3 text-right">Selisih</th>
                      <th class="px-4 py-3 text-center">Status</th>
                    </tr>
                  </thead>
                  <tbody id="shiftHistoryTable"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Customer Section - CRM Dashboard -->
          <section id="customerSection" class="p-4 md:p-6 space-y-6 hidden">
            <!-- Header -->
            <div class="flex items-center justify-between flex-wrap gap-4">
              <h2 class="text-2xl font-bold">â¤ï¸ Pelanggan & CRM</h2>
              <button onclick="showAddCustomerModal()"
                class="btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <span>â•</span> Tambah Pelanggan
              </button>
            </div>

            <!-- 4 Tabs -->
            <div class="flex flex-wrap gap-2">
              <button onclick="switchCRMTab('data')"
                class="crm-tab-btn px-4 py-2 rounded-lg bg-purple-600 font-medium text-sm" data-tab="data">ğŸ“‹ Data
                Pelanggan</button>
              <button onclick="switchCRMTab('leaderboard')"
                class="crm-tab-btn px-4 py-2 rounded-lg bg-surface font-medium text-sm" data-tab="leaderboard">ğŸ†
                Leaderboard</button>
              <button onclick="switchCRMTab('churn')"
                class="crm-tab-btn px-4 py-2 rounded-lg bg-surface font-medium text-sm" data-tab="churn">âš ï¸ Churn
                Alert</button>
              <button onclick="switchCRMTab('settings')"
                class="crm-tab-btn px-4 py-2 rounded-lg bg-surface font-medium text-sm" data-tab="settings">âš™ï¸
                Pengaturan</button>
            </div>

            <!-- TAB 1: Data Pelanggan -->
            <div id="crmTabData" class="crm-tab-content space-y-4">
              <!-- Search -->
              <div class="glass rounded-xl p-4">
                <input type="text" id="crmSearchInput" class="input-field w-full px-4 py-2 rounded-lg text-white"
                  placeholder="ğŸ” Cari pelanggan (nama/HP)..." oninput="renderCRMDataTable()">
              </div>

              <!-- Table -->
              <div class="glass rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-surface/50">
                      <tr class="text-left text-gray-400">
                        <th class="px-4 py-3">Nama</th>
                        <th class="px-4 py-3">No HP</th>
                        <th class="px-4 py-3">Tier</th>
                        <th class="px-4 py-3 text-right">Poin</th>
                        <th class="px-4 py-3 text-right">Total Belanja</th>
                        <th class="px-4 py-3 text-center">Status</th>
                      </tr>
                    </thead>
                    <tbody id="crmDataTable" class="divide-y divide-white/5">
                      <tr>
                        <td colspan="6" class="p-8 text-center text-gray-400">Klik tab untuk memuat data...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- TAB 2: Leaderboard -->
            <div id="crmTabLeaderboard" class="crm-tab-content hidden space-y-4">
              <!-- Filters -->
              <div class="glass rounded-xl p-4 flex flex-wrap gap-4 items-center">
                <div class="flex gap-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="leaderboardBy" value="spending" checked onchange="loadLeaderboard()"
                      class="accent-purple-500">
                    <span class="text-sm">ğŸ’° Spending (Sultan)</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="leaderboardBy" value="frequency" onchange="loadLeaderboard()"
                      class="accent-purple-500">
                    <span class="text-sm">ğŸ”„ Frequency (Anak Nongkrong)</span>
                  </label>
                </div>
                <div class="ml-auto flex gap-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="leaderboardPeriod" value="month" onchange="loadLeaderboard()"
                      class="accent-purple-500">
                    <span class="text-sm">Bulan Ini</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="leaderboardPeriod" value="alltime" checked onchange="loadLeaderboard()"
                      class="accent-purple-500">
                    <span class="text-sm">All-Time</span>
                  </label>
                </div>
              </div>

              <!-- Table -->
              <div class="glass rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-surface/50">
                      <tr class="text-left text-gray-400">
                        <th class="px-4 py-3 text-center w-16">Rank</th>
                        <th class="px-4 py-3">Nama</th>
                        <th class="px-4 py-3">Tier</th>
                        <th class="px-4 py-3 text-right">Value</th>
                        <th class="px-4 py-3 text-right">No HP</th>
                      </tr>
                    </thead>
                    <tbody id="crmLeaderboardTable" class="divide-y divide-white/5">
                      <tr>
                        <td colspan="5" class="p-8 text-center text-gray-400">Memuat leaderboard...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- TAB 3: Churn Alert -->
            <div id="crmTabChurn" class="crm-tab-content hidden space-y-4">
              <div class="glass rounded-xl p-4 bg-red-500/10 border border-red-500/20">
                <p class="text-red-400 font-medium">âš ï¸ Pelanggan Berisiko Hilang</p>
                <p class="text-sm text-gray-400">Pelanggan dengan >3 kunjungan yang tidak order >30 hari</p>
              </div>

              <div class="glass rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-surface/50">
                      <tr class="text-left text-gray-400">
                        <th class="px-4 py-3">Nama</th>
                        <th class="px-4 py-3">No HP</th>
                        <th class="px-4 py-3">Terakhir Order</th>
                        <th class="px-4 py-3 text-center">Total Visit</th>
                        <th class="px-4 py-3">Action</th>
                      </tr>
                    </thead>
                    <tbody id="crmChurnTable" class="divide-y divide-white/5">
                      <tr>
                        <td colspan="5" class="p-8 text-center text-gray-400">Memuat data...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- TAB 4: Pengaturan Loyalty -->
            <div id="crmTabSettings" class="crm-tab-content hidden space-y-4">
              <div class="glass rounded-xl p-6">
                <h3 class="font-bold text-lg mb-4">âš™ï¸ Pengaturan Program Loyalty</h3>

                <div class="space-y-6">
                  <!-- Enable Toggle -->
                  <div class="flex items-center justify-between p-4 bg-surface/50 rounded-xl">
                    <div>
                      <p class="font-medium">Aktifkan Program Loyalty</p>
                      <p class="text-sm text-gray-400">Pelanggan mendapat poin setiap transaksi</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="loyaltyEnabled" class="sr-only peer" checked>
                      <div
                        class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-purple-600 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full">
                      </div>
                    </label>
                  </div>

                  <!-- Point Ratio -->
                  <div>
                    <label class="block text-sm text-gray-400 mb-2">Rasio Poin (Rp per 1 Poin)</label>
                    <div class="flex items-center gap-2">
                      <span class="text-gray-400">Rp</span>
                      <input type="number" id="loyaltyPointRatio"
                        class="input-field flex-1 px-4 py-2 rounded-lg text-white" value="10000">
                      <span class="text-gray-400">= 1 Poin</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Contoh: Transaksi Rp 50.000 â†’ 5 Poin</p>
                  </div>

                  <!-- Tier Thresholds -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm text-gray-400 mb-2">ğŸ¥ˆ Batas Silver (Total Spending)</label>
                      <div class="flex items-center gap-2">
                        <span class="text-gray-400">Rp</span>
                        <input type="number" id="loyaltySilverThreshold"
                          class="input-field flex-1 px-4 py-2 rounded-lg text-white" value="500000">
                      </div>
                    </div>
                    <div>
                      <label class="block text-sm text-gray-400 mb-2">ğŸ¥‡ Batas Gold (Total Spending)</label>
                      <div class="flex items-center gap-2">
                        <span class="text-gray-400">Rp</span>
                        <input type="number" id="loyaltyGoldThreshold"
                          class="input-field flex-1 px-4 py-2 rounded-lg text-white" value="2000000">
                      </div>
                    </div>
                  </div>

                  <!-- Save Button -->
                  <button onclick="saveLoyaltySettings()" class="btn-primary w-full py-3 rounded-xl font-bold">
                    ğŸ’¾ Simpan Pengaturan
                  </button>
                </div>
              </div>
            </div>
          </section>

          <!-- Shift Report Section (Admin Only) -->
          <section id="shiftReportSection" class="p-4 md:p-6 space-y-6 hidden">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold">ğŸ” Laporan Shift & Audit Kas</h2>
              <button onclick="loadShiftReport()"
                class="px-4 py-2 rounded-lg bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 flex items-center gap-2">
                ğŸ”„ Refresh
              </button>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="glass rounded-xl p-4">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">ğŸ”“</div>
                  <div>
                    <p class="text-xs text-gray-400">Shift Aktif</p>
                    <p id="activeShiftCount" class="text-xl font-bold text-blue-400">-</p>
                  </div>
                </div>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">âœ…</div>
                  <div>
                    <p class="text-xs text-gray-400">Selesai (Klop)</p>
                    <p id="closedKlopCount" class="text-xl font-bold text-green-400">-</p>
                  </div>
                </div>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">âš ï¸</div>
                  <div>
                    <p class="text-xs text-gray-400">Ada Selisih</p>
                    <p id="discrepancyCount" class="text-xl font-bold text-red-400">-</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Alert Banner -->
            <div id="shiftAlertBanner" class="hidden bg-red-500/10 border border-red-500/30 rounded-xl p-4">
              <div class="flex items-center gap-3">
                <span class="text-2xl">ğŸš¨</span>
                <div>
                  <p class="font-bold text-red-400">Perhatian: Ada Shift dengan Selisih Kas</p>
                  <p class="text-sm text-gray-400">Shift dengan warna merah memiliki selisih melebihi toleransi Rp 5.000
                  </p>
                </div>
              </div>
            </div>

            <!-- Shift History Table -->
            <div class="glass rounded-xl overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-surface/50">
                    <tr class="text-left text-gray-400 text-sm">
                      <th class="px-4 py-3">Mulai</th>
                      <th class="px-4 py-3">Selesai</th>
                      <th class="px-4 py-3">Kasir</th>
                      <th class="px-4 py-3 text-right">Modal</th>
                      <th class="px-4 py-3 text-right">+ Penjualan</th>
                      <th class="px-4 py-3 text-right">- Kas Keluar</th>
                      <th class="px-4 py-3 text-right">Expected</th>
                      <th class="px-4 py-3 text-right">Selisih</th>
                      <th class="px-4 py-3 text-center">Status</th>
                    </tr>
                  </thead>
                  <tbody id="shiftReportTableBody">
                    <tr>
                      <td colspan="9" class="p-8 text-center text-gray-400">Memuat data shift...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap gap-4 text-xs text-gray-400">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded bg-green-500/50"></span>
                <span>KLOP = Uang pas</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded bg-yellow-500/50"></span>
                <span>TOLERANSI = Selisih Â±Rp 5.000</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded bg-red-500/50"></span>
                <span>SELISIH = Melebihi toleransi (Perlu ditinjau)</span>
              </div>
            </div>
          </section>

          <!-- Settings Section -->
          <section id="settingsSection" class="p-4 md:p-6 space-y-6 hidden">
            <h2 class="text-2xl font-bold">âš™ï¸ Pengaturan</h2>
            <!-- Business Profile -->
            <div class="glass rounded-xl p-4">
              <h3 class="font-bold mb-4">ğŸª Profil Usaha</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                  <label class="block text-sm text-gray-400 mb-1">Logo Usaha</label>
                  <div class="flex items-center gap-4">
                    <div id="logoPreviewContainer"
                      class="w-20 h-20 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center overflow-hidden">
                      <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
                        <path
                          d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" />
                      </svg>
                    </div>
                    <div class="flex-1">
                      <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="uploadLogo()">
                      <button onclick="document.getElementById('logoInput').click()"
                        class="btn-primary px-4 py-2 rounded-lg text-sm">ğŸ“· Upload Logo</button>
                      <p class="text-xs text-gray-400 mt-1">Ukuran rekomendasi: 200x200px (PNG/JPG)</p>
                      <p id="logoStatus" class="text-xs text-purple-400 mt-1"></p>
                    </div>
                  </div>
                </div>
                <div><label class="block text-sm text-gray-400 mb-1">Nama Usaha</label> <input type="text"
                    id="settingBusinessName" class="input-field w-full px-4 py-2 rounded-lg text-white"
                    value="Warkop Santai"></div>
                <div><label class="block text-sm text-gray-400 mb-1">Tagline</label> <input type="text"
                    id="settingTagline" class="input-field w-full px-4 py-2 rounded-lg text-white"
                    value="Ngopi Enak, Harga Merakyat"></div>
                <div>
                  <label class="block text-sm text-gray-400 mb-1">No. WhatsApp Pemilik *</label>
                  <div class="flex items-center gap-2">
                    <span class="input-field px-3 py-2 rounded-lg text-gray-400 bg-surface/80">+62</span>
                    <input type="tel" id="settingPhone" class="input-field flex-1 px-4 py-2 rounded-lg text-white"
                      placeholder="81234567890">
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Tanpa 0 di awal (contoh: 81234567890)</p>
                </div>
                <div><label class="block text-sm text-gray-400 mb-1">Alamat</label> <input type="text"
                    id="settingAddress" class="input-field w-full px-4 py-2 rounded-lg text-white"></div>
              </div>
            </div>
            <!-- Operational -->
            <div class="glass rounded-xl p-4">
              <h3 class="font-bold mb-4">â° Jam Operasional</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm text-gray-400 mb-1">Jam Buka</label> <input type="time"
                    id="settingOpenTime" class="input-field w-full px-4 py-2 rounded-lg text-white" value="08:00"></div>
                <div><label class="block text-sm text-gray-400 mb-1">Jam Tutup</label> <input type="time"
                    id="settingCloseTime" class="input-field w-full px-4 py-2 rounded-lg text-white" value="22:00">
                </div>
              </div>
            </div>
            <!-- WiFi -->
            <div class="glass rounded-xl p-4">
              <h3 class="font-bold mb-4">ğŸ“¶ WiFi</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm text-gray-400 mb-1">Nama WiFi</label> <input type="text"
                    id="settingWifiName" class="input-field w-full px-4 py-2 rounded-lg text-white"></div>
                <div><label class="block text-sm text-gray-400 mb-1">Password WiFi</label> <input type="text"
                    id="settingWifiPassword" class="input-field w-full px-4 py-2 rounded-lg text-white"></div>
              </div>
            </div>
            <!-- Tax & Payment -->
            <div class="glass rounded-xl p-4">
              <h3 class="font-bold mb-4">ğŸ’³ Pajak &amp; Pembayaran</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label class="block text-sm text-gray-400 mb-1">PPN (%)</label> <input type="number"
                    id="settingTax" class="input-field w-full px-4 py-2 rounded-lg text-white" value="11"></div>
                <div><label class="block text-sm text-gray-400 mb-1">Service Charge (%)</label> <input type="number"
                    id="settingService" class="input-field w-full px-4 py-2 rounded-lg text-white" value="5"></div>
                <div><label class="block text-sm text-gray-400 mb-1">Bank Transfer</label> <input type="text"
                    id="settingBank" class="input-field w-full px-4 py-2 rounded-lg text-white"
                    placeholder="BCA 1234567890"></div>
              </div>
              <div class="mt-4">
                <label class="block text-sm text-gray-400 mb-1">Upload QRIS</label>
                <div class="flex items-center gap-4">
                  <input type="file" id="qrisInput" accept="image/*" class="hidden" onchange="uploadQRIS()">
                  <button onclick="document.getElementById('qrisInput').click()"
                    class="btn-primary px-4 py-2 rounded-lg text-sm">ğŸ“· Upload QRIS</button>
                  <img id="qrisPreview" class="h-20 rounded-lg hidden">
                </div>
              </div>
              <!-- Bank Transfer Details -->
              <div class="mt-4 glass rounded-lg p-3 bg-blue-500/10 border border-blue-500/30">
                <p class="font-medium text-blue-300 mb-3">ğŸ¦ Detail Transfer Bank</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div><label class="block text-sm text-gray-400 mb-1">Nama Bank / Pemilik</label>
                    <input type="text" id="settingBankName" class="input-field w-full px-4 py-2 rounded-lg text-white"
                      placeholder="BCA - John Doe">
                  </div>
                  <div><label class="block text-sm text-gray-400 mb-1">Nomor Rekening</label>
                    <input type="text" id="settingBankAccount"
                      class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="1234567890">
                  </div>
                </div>
              </div>
              <!-- e-Wallet Details -->
              <div class="mt-4 glass rounded-lg p-3 bg-green-500/10 border border-green-500/30">
                <p class="font-medium text-green-300 mb-3">ğŸ“± Detail e-Wallet</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div><label class="block text-sm text-gray-400 mb-1">Jenis e-Wallet</label>
                    <input type="text" id="settingEwalletType"
                      class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="OVO / Dana / GoPay">
                  </div>
                  <div><label class="block text-sm text-gray-400 mb-1">Nomor e-Wallet</label>
                    <input type="text" id="settingEwalletNumber"
                      class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="081234567890">
                  </div>
                </div>
              </div>

              <!-- Backend Database -->
              <div class="glass rounded-xl p-4">
                <h3 class="font-bold mb-4">ğŸ”— Database Backend</h3>
                <div class="flex items-center gap-4">
                  <label class="flex items-center gap-2">
                    <input id="useRemoteDbCheckbox" type="checkbox" class="h-4 w-4" onchange="toggleUseRemoteDB()">
                    <span class="text-sm text-gray-400">Gunakan MongoDB Remote (backend)</span>
                  </label>
                  <button onclick="migrateLocalToRemote()" class="px-3 py-2 rounded-lg bg-primary/50 text-xs">â¬†ï¸ Migrasi
                    Local â†’ Remote</button>
                </div>
                <div class="mt-3">
                  <label class="block text-sm text-gray-400 mb-1">API Key (jika backend dilindungi)</label>
                  <div class="flex gap-2">
                    <input id="settingApiKey" type="text" class="input-field w-full px-4 py-2 rounded-lg text-white"
                      placeholder="Masukkan API key (x-api-key)">
                    <button onclick="saveApiKeyToLocal()" class="px-3 py-2 rounded-lg bg-secondary/60 text-sm">ğŸ”’ Simpan
                      Kunci</button>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Isi API key jika backend menggunakan API_KEY atau jika Anda
                    ingin menyertakan kunci saat sinkronisasi.</p>
                </div>
                <p class="text-xs text-gray-500 mt-2">Pastikan backend berjalan di <code>http://localhost:3000</code>
                  dan variabel <code>MONGODB_URI</code> sudah terpasang.</p>
              </div>

              <!-- Notifikasi Suara -->
              <div class="glass rounded-xl p-4">
                <h3 class="font-bold mb-4">ğŸ”” Notifikasi Suara Pesanan Baru</h3>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm text-gray-400 mb-1">Upload Suara Notifikasi (.mp3/.wav)</label>
                    <input type="file" id="notifSoundInput" accept="audio/mp3,audio/wav,audio/*" class="hidden"
                      onchange="uploadNotifSound(event)">
                    <div class="flex gap-2 flex-wrap">
                      <button onclick="document.getElementById('notifSoundInput').click()"
                        class="px-4 py-2 rounded-lg bg-surface hover:bg-surface/80 text-sm flex items-center gap-2">
                        ğŸ“ Pilih File Audio
                      </button>
                      <button onclick="testNotifSound()"
                        class="px-4 py-2 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 text-sm flex items-center gap-2">
                        ğŸ”Š Test Suara
                      </button>
                      <button onclick="removeNotifSound()"
                        class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 text-sm flex items-center gap-2">
                        ğŸ—‘ï¸ Hapus
                      </button>
                    </div>
                  </div>
                  <p id="notifSoundStatus" class="text-xs text-gray-500">Status: Belum ada suara dikonfigurasi (akan
                    menggunakan suara default)</p>
                  <p class="text-xs text-gray-500">ğŸ’¡ Tip: Suara akan berbunyi di halaman Kasir (POS) saat ada pesanan
                    baru. Admin harus klik "Aktifkan Notifikasi Suara" sekali di POS untuk mengaktifkan.</p>
                </div>
              </div>

              <!-- DANGER ZONE (Admin Only) -->
              <div class="glass rounded-xl p-4 border-2 border-red-500/50 mt-6">
                <div class="flex items-center gap-2 mb-4">
                  <span class="text-2xl">âš ï¸</span>
                  <h3 class="font-bold text-red-400">Danger Zone</h3>
                </div>
                <p class="text-sm text-gray-400 mb-4">Fitur ini berbahaya dan tidak bisa di-undo. Pastikan Anda sudah
                  backup data sebelum menggunakan.</p>

                <div class="space-y-3">
                  <!-- Reset All -->
                  <button onclick="showResetConfirmModal()"
                    class="w-full px-4 py-3 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 border border-red-500/30 flex items-center justify-center gap-2 font-bold">
                    ğŸ—‘ï¸ RESET SEMUA DATA (Hapus Database)
                  </button>

                  <!-- Individual Deletes -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="deleteCollectionConfirm('orders')"
                      class="px-3 py-2 rounded-lg bg-surface text-red-300 hover:bg-red-500/20 text-xs">Hapus
                      Pesanan</button>
                    <button onclick="deleteCollectionConfirm('menu')"
                      class="px-3 py-2 rounded-lg bg-surface text-red-300 hover:bg-red-500/20 text-xs">Hapus
                      Menu</button>
                    <button onclick="deleteCollectionConfirm('ingredients')"
                      class="px-3 py-2 rounded-lg bg-surface text-red-300 hover:bg-red-500/20 text-xs">Hapus
                      Bahan</button>
                    <button onclick="deleteCollectionConfirm('shifts')"
                      class="px-3 py-2 rounded-lg bg-surface text-red-300 hover:bg-red-500/20 text-xs">Hapus
                      Shift</button>
                  </div>
                </div>
              </div>

              <button onclick="saveSettings()" class="btn-primary px-6 py-3 rounded-xl font-bold">ğŸ’¾ Simpan
                Pengaturan</button>
          </section>
        </main>
      </div>
    </div>

    <!-- MODALS -->
    <!-- Order Form Modal -->
    <div id="orderModal" class="fixed inset-0 z-50 hidden" style="pointer-events: none;">
      <div class="absolute inset-0 bg-black/70" style="z-index: 1; pointer-events: auto;" onclick="closeOrderModal()">
      </div>
      <div class="absolute inset-4 md:inset-10 lg:inset-20 glass rounded-2xl overflow-hidden flex flex-col animate-fade"
        style="z-index: 10; pointer-events: auto;">
        <div class="p-4 border-b border-purple-500/20 flex items-center justify-between">
          <h2 class="text-lg font-bold">ğŸ›’ Form Pesanan</h2>
          <button onclick="closeOrderModal()"
            class="w-8 h-8 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500/40">âœ•</button>
        </div>
        <div class="flex-1 overflow-auto p-4">
          <div class="space-y-4">
            <!-- Cart Items -->
            <div id="cartItems" class="space-y-3"></div>
            <!-- Customer Info Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="block text-sm text-gray-400 mb-1">Nama Pelanggan *</label> <input type="text"
                  id="customerName" class="input-field w-full px-4 py-2 rounded-lg text-white"
                  placeholder="Masukkan nama"></div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">No. WhatsApp *</label>
                <div class="flex items-center gap-2">
                  <span class="input-field px-3 py-2 rounded-lg text-gray-400 bg-surface/80">+62</span>
                  <input type="tel" id="customerPhone" class="input-field flex-1 px-4 py-2 rounded-lg text-white"
                    placeholder="81234567890">
                </div>
              </div>
              <div><label class="block text-sm text-gray-400 mb-1">No. Meja *</label> <select id="customerTable"
                  class="input-field w-full px-4 py-2 rounded-lg text-white">
                  <option value="">Pilih Meja</option>
                </select></div>
              <div><label class="block text-sm text-gray-400 mb-1">Area *</label> <select id="customerRoom"
                  class="input-field w-full px-4 py-2 rounded-lg text-white">
                  <option value="">Pilih Area</option>
                  <option value="smoking">ğŸš¬ Area Smoking</option>
                  <option value="no-smoking">ğŸš­ Area No Smoking</option>
                </select></div>
              <div class="md:col-span-2"><label class="block text-sm text-gray-400 mb-1">Metode Pembayaran *</label>
                <select id="paymentMethod" class="input-field w-full px-4 py-2 rounded-lg text-white"
                  onchange="onPaymentMethodChange()">
                  <option value="">Pilih Metode</option>
                  <option value="cash">ğŸ’µ Tunai</option>
                  <option value="bank">ğŸ¦ Transfer Bank</option>
                  <option value="ewallet">ğŸ“± e-Wallet (OVO/Dana/GoPay)</option>
                  <option value="qris">ğŸ“² QRIS</option>
                </select>
              </div>
              <div class="md:col-span-2"><label class="block text-sm text-gray-400 mb-1">Catatan Pesanan</label>
                <textarea id="orderNotes" class="input-field w-full px-4 py-2 rounded-lg text-white" rows="2"
                  placeholder="Es dikit, Gula pisah, dll..."></textarea>
              </div>
            </div>

            <!-- Payment Info Section (Conditional) -->
            <div id="paymentInfoSection" class="hidden">
              <!-- Cash Info -->
              <div id="cashInfo" class="hidden glass rounded-xl p-4 bg-yellow-500/10 border border-yellow-500/30">
                <p class="text-yellow-300 font-medium">ğŸ’µ Pembayaran Tunai</p>
                <p class="text-sm text-gray-400 mt-1">Pesanan akan diproses setelah Anda membayar di Kasir.</p>
              </div>
              <!-- Bank Info -->
              <div id="bankInfo" class="hidden glass rounded-xl p-4 bg-blue-500/10 border border-blue-500/30">
                <p class="text-blue-300 font-medium">ğŸ¦ Transfer Bank</p>
                <p class="text-sm text-gray-400 mt-1">Silakan transfer ke:</p>
                <p id="bankDetailDisplay" class="text-white font-bold mt-2">-</p>
              </div>
              <!-- e-Wallet Info -->
              <div id="ewalletInfo" class="hidden glass rounded-xl p-4 bg-green-500/10 border border-green-500/30">
                <p class="text-green-300 font-medium">ğŸ“± e-Wallet</p>
                <p class="text-sm text-gray-400 mt-1">Silakan transfer ke:</p>
                <p id="ewalletDetailDisplay" class="text-white font-bold mt-2">-</p>
              </div>
              <!-- QRIS Info -->
              <div id="qrisInfo" class="hidden glass rounded-xl p-4 bg-purple-500/10 border border-purple-500/30">
                <p class="text-purple-300 font-medium">ğŸ“² QRIS</p>
                <p class="text-sm text-gray-400 mt-1">Scan QRIS berikut:</p>
                <img id="qrisImageDisplay" class="mt-2 max-w-[200px] rounded-lg mx-auto" src="" alt="QRIS">
              </div>
              <!-- Upload Payment Proof (for non-cash) -->
              <div id="paymentProofSection" class="hidden mt-4">
                <label class="block text-sm text-gray-400 mb-1">ğŸ“· Upload Bukti Pembayaran *</label>
                <input type="file" id="paymentProofInput" accept="image/*" class="hidden"
                  onchange="previewPaymentProof(event)">
                <div onclick="document.getElementById('paymentProofInput').click()"
                  class="input-field w-full px-4 py-4 rounded-lg text-center cursor-pointer hover:bg-surface/50 border-2 border-dashed border-purple-500/30">
                  <span id="paymentProofLabel" class="text-gray-400">Klik untuk pilih foto bukti transfer</span>
                </div>
                <img id="paymentProofPreview" class="hidden mt-2 max-h-32 rounded-lg mx-auto" src="" alt="Preview">
              </div>
            </div>

            <div class="bg-surface/50 rounded-xl p-4">
              <div class="flex justify-between items-center text-lg font-bold">
                <span>Total</span>
                <span id="orderTotal" class="text-purple-400">Rp 0</span>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t border-purple-500/20 relative z-10">
          <button onclick="submitOrder()"
            class="btn-primary w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 pointer-events-auto"
            style="pointer-events: auto !important; position: relative; z-index: 100;">
            ğŸ“¤ Kirim Pesanan
          </button>
        </div>
      </div>
    </div>

    <!-- Digital Receipt Modal (Nota Digital) -->
    <div id="receiptModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/70" onclick="closeReceiptModal()"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4 overflow-auto">
        <div class="glass rounded-2xl p-6 w-full max-w-md animate-fade max-h-[90vh] overflow-auto">
          <div id="receiptContent" class="bg-white text-gray-800 rounded-xl p-6">
            <!-- Receipt Header -->
            <div class="text-center border-b border-gray-300 pb-4 mb-4">
              <div id="receiptLogo"
                class="w-16 h-16 mx-auto mb-2 rounded-xl bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center overflow-hidden">
                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" />
                </svg>
              </div>
              <h2 id="receiptShopName" class="text-xl font-bold text-gray-900">Warkop Santai</h2>
              <p id="receiptTagline" class="text-xs text-gray-500">Ngopi Enak, Harga Merakyat</p>
            </div>
            <!-- Customer Info -->
            <div class="border-b border-dashed border-gray-300 pb-3 mb-3 text-sm">
              <div class="flex justify-between"><span class="text-gray-500">Tanggal:</span><span id="receiptDate"
                  class="font-medium">-</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Waktu:</span><span id="receiptTime"
                  class="font-medium">-</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Nama:</span><span id="receiptCustomer"
                  class="font-medium">-</span></div>
              <div class="flex justify-between"><span class="text-gray-500">No. Telp:</span><span id="receiptPhone"
                  class="font-medium">-</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Meja:</span><span id="receiptTable"
                  class="font-medium">-</span></div>
            </div>
            <!-- Order Items -->
            <div class="border-b border-dashed border-gray-300 pb-3 mb-3">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-gray-500 text-xs">
                    <th class="text-left py-1">Item</th>
                    <th class="text-center">Qty</th>
                    <th class="text-right">Harga</th>
                    <th class="text-right">Subtotal</th>
                  </tr>
                </thead>
                <tbody id="receiptItems"></tbody>
              </table>
            </div>
            <!-- Total -->
            <div class="border-b border-gray-300 pb-3 mb-3">
              <div class="flex justify-between text-lg font-bold">
                <span>TOTAL</span>
                <span id="receiptTotal" class="text-purple-600">Rp 0</span>
              </div>
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>Metode Bayar:</span>
                <span id="receiptPayment" class="font-medium">-</span>
              </div>
            </div>
            <!-- WiFi Info -->
            <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-3 mb-4">
              <p class="text-xs text-gray-600 mb-1 font-medium">ğŸ“¶ Info WiFi Gratis:</p>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">SSID:</span>
                <span id="receiptWifiName" class="font-bold text-purple-700">-</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Password:</span>
                <span id="receiptWifiPassword" class="font-bold text-purple-700">-</span>
              </div>
            </div>
            <!-- Footer -->
            <div class="text-center text-xs text-gray-400">
              <p>Terima kasih atas kunjungan Anda! ğŸ™</p>
              <p id="receiptOrderId" class="font-mono mt-1">-</p>
            </div>
          </div>
          <!-- Actions -->
          <div class="flex gap-2 mt-4">
            <button onclick="downloadReceipt()"
              class="flex-1 btn-primary px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
              ğŸ“¥ Download Nota
            </button>
            <button onclick="closeReceiptModal()"
              class="flex-1 px-4 py-3 rounded-xl bg-surface hover:bg-surface/80 font-bold">
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Login Modal -->

    <!-- Single Gate Login Modal - For both Admin and Kasir -->
    <div id="loginModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/70" onclick="closeLoginModal()"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="glass rounded-2xl p-6 w-full max-w-md animate-fade pointer-events-auto"
          style="pointer-events: auto !important;">
          <div class="text-center mb-6">
            <div
              class="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-secondary mx-auto flex items-center justify-center mb-4">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <h2 class="text-xl font-bold">Login Pegawai</h2>
            <p class="text-sm text-gray-400">Masukkan Username & Password/PIN Anda</p>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Username</label>
              <input type="text" id="loginUsername" class="input-field w-full px-4 py-3 rounded-lg text-white"
                placeholder="Masukkan username" style="pointer-events: auto;">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Password / PIN</label>
              <input type="password" id="loginPassword" class="input-field w-full px-4 py-3 rounded-lg text-white"
                placeholder="Password (Admin) atau PIN 6 digit (Kasir)" style="pointer-events: auto;">
            </div>
            <div id="loginError" class="text-red-400 text-sm hidden text-center"></div>
            <button onclick="doLogin()" class="btn-primary w-full py-3 rounded-xl font-bold"
              style="pointer-events: auto;">ğŸš€ Masuk</button>
          </div>
          <p class="text-xs text-gray-500 text-center mt-4">Admin: password | Kasir: PIN 6 digit</p>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>
  </div>

  <!-- FULL JAVASCRIPT LOGIC -->
  <script>
    // ===== GLOBAL STATE =====
    let currentUser = null;
    let currentShift = null; // Shift data for active cashier
    let currentSection = 'dashboard';
    let currentFilter = 'all';
    let cart = [];

    // âœ… FORCE CLEANUP: Remove corrupted localStorage data immediately on load
    try { localStorage.removeItem('warkopData'); console.log('Storage cleaned'); } catch (e) { }

    // Early global definitions (ensure inline onclick handlers can call these even during parsing)
    window.showLoginModal = window.showLoginModal || function () {
      console.log('showLoginModal called (early)');
      const modal = document.getElementById('loginModal');
      if (!modal) { console.warn('showLoginModal: #loginModal not found (early)'); return; }
      modal.style.pointerEvents = 'auto';
      modal.classList.remove('hidden');
    };

    window.filterCategory = window.filterCategory || function (cat) {
      console.log('filterCategory called (early):', cat);
      currentFilter = cat;
      document.querySelectorAll('.category-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.cat === cat));
      renderMenuGrid();
    };
    // Remote DB toggle: set true to use backend at http://localhost:3000
    let USE_REMOTE_DB = true;
    // Default API key read from backend/.env at edit time (embedded by the tool)
    const DEFAULT_API_KEY = 'warkop_testkey_9f8b7a6c5d4e3f2a1b0c9d8e7f6a5b4c'; // value taken from backend/.env API_KEY
    const API_BASE = (function () {
      // âš ï¸ IMPORTANT: API_BASE should NOT include /api suffix
      // The endpoint paths like /api/employees will be appended manually
      if (typeof window === 'undefined') return 'http://localhost:3000';
      // If opened as file:// or on localhost/127.0.0.1, point to local backend
      if (window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') return 'http://localhost:3000';
      // Otherwise try origin, fallback to localhost
      try { return window.location.origin; } catch (e) { return 'http://localhost:3000'; }
    })();

    // Default credentials
    const DEFAULT_USERNAME = 'admin';
    const DEFAULT_PASSWORD = 'admin123';

    // ===== POS SECURITY SYSTEM =====
    // Session Management
    const SESSION_KEY = 'warkop_session';
    const LAST_ACTIVITY_KEY = 'warkop_last_activity';
    const IDLE_TIMEOUT = 10 * 60 * 1000;  // 10 minutes
    const IDLE_WARNING = 9 * 60 * 1000;   // Warning at 9 minutes (1 min before lock)

    let currentSession = null;
    let idleTimer = null;
    let warningTimer = null;
    let isSessionLocked = false;

    // Data Storage
    let menuItems = [];
    let categories = ['kopi', 'minuman', 'makanan', 'snack'];
    let orders = [];
    let tables = [];
    let employees = [];
    let cashTransactions = [];
    let customers = [];
    let gramasiData = [];
    let ingredients = []; // Master bahan baku
    let recipes = {};     // Menu ID -> ingredients mapping { "menuId": [{ ing_id, jumlah }] }
    let stockHistory = []; // Stock movement log
    let customUnits = ['gram', 'ml', 'pcs', 'ekor', 'buah', 'ikat', 'kg', 'liter', 'box', 'kaleng']; // Dynamic units

    // NEW: Shift records for accountability
    let shifts = [];

    // NEW: Deleted orders audit trail (Zero-Trust)
    let deletedOrders = [];

    // NEW: Cash drawer logs
    let cashDrawerLogs = [];

    // NEW: Security settings
    let securitySettings = {
      masterPin: '123456',  // Default Master PIN (6-digit)
      requirePinForDelete: true,
      requirePinForReports: true,
      autoLockEnabled: true,
      autoLockMinutes: 10
    };

    let businessSettings = {
      name: 'Warkop Santai',
      tagline: 'Ngopi Enak, Harga Merakyat',
      phone: '',
      address: '',
      openTime: '08:00',
      closeTime: '22:00',
      wifiName: '',
      wifiPassword: '',
      tax: 11,
      service: 5,
      bank: '',
      logo: '',
      qris: '',
      // Payment Settings
      bankAccount: '',
      bankName: '',
      ewalletNumber: '',
      ewalletType: '',
      qrisImage: ''
    };

    // ===== INITIALIZATION =====
    async function init() {
      console.time('init');

      // âœ… CLEANUP: If data is too large, strip heavy Base64 images but KEEP the data
      // This prevents QuotaExceededError while preserving menu items
      try {
        const oldData = localStorage.getItem('warkopData');
        if (oldData && oldData.length > 2000000) { // > 2MB - may cause issues
          console.warn('warkopData is too large, stripping Base64 images to reduce size');
          try {
            const parsed = JSON.parse(oldData);
            // Strip large Base64 images from menuItems
            if (parsed.menuItems && Array.isArray(parsed.menuItems)) {
              parsed.menuItems = parsed.menuItems.map(item => ({
                ...item,
                image: item.image && item.image.length > 10000 ? '' : (item.image || '')
              }));
            }
            // Strip logo
            if (parsed.businessSettings) {
              parsed.businessSettings.logo = '';
              parsed.businessSettings.qrisImage = '';
            }
            // Save cleaned version back
            localStorage.setItem('warkopData', JSON.stringify(parsed));
            console.log('Cleaned localStorage data, new size:', localStorage.getItem('warkopData')?.length);
          } catch (parseErr) {
            console.error('Error parsing/cleaning localStorage:', parseErr);
            // Don't remove data completely, keep as is
          }
        }
      } catch (e) {
        console.error('Error checking localStorage size:', e);
        // Don't remove data on error
      }

      console.time('loadFromStorage');
      await loadFromStorage();
      console.timeEnd('loadFromStorage');

      // If a default API key was embedded from backend/.env, persist locally so requests include it
      try {
        if (DEFAULT_API_KEY && !localStorage.getItem('warkop_api_key')) {
          localStorage.setItem('warkop_api_key', DEFAULT_API_KEY);
          showToast('API key default diambil dari lingkungan dan disimpan (lokal)', 'info');
        }
      } catch (e) { /* ignore */ }

      console.time('initRender');
      renderCustomerPage();
      initializeTables();
      updateAllStats();
      initEventListeners();
      console.timeEnd('initRender');

      // Try to restore session - if logged in, show admin dashboard
      if (loadSession() && currentUser) {
        console.log('Session restored for user:', currentUser?.username);
        // Show admin page, hide login
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('adminPage').classList.remove('hidden');
        updateUIPermissions();
        renderDashboard();

        // Check shift for kasir
        if (currentUser.role === 'kasir') {
          checkShiftRequired();
        }
      } else {
        // Not logged in - loginPage is already visible by default
        console.log('No session found, showing login page');
      }

      // Set default logo if not exists
      if (!businessSettings.logo) {
        businessSettings.logo = 'default';
      }

      console.timeEnd('init');

      // Start auto-refresh polling for real-time order updates
      startOrderPolling();
    }

    // ===== AUTO-REFRESH POLLING FOR REAL-TIME ORDERS =====
    let orderPollingInterval = null;

    function startOrderPolling() {
      // Only poll if remote DB is enabled
      if (!USE_REMOTE_DB) return;

      // Clear existing interval if any
      if (orderPollingInterval) clearInterval(orderPollingInterval);

      // Poll every 15 seconds for new orders
      orderPollingInterval = setInterval(async () => {
        try {
          const res = await fetch(`${API_BASE}/api/orders`, { headers: getAuthHeaders() });
          if (res.ok) {
            const freshOrders = await res.json();

            // Check if there are new orders
            const oldCount = orders.length;
            const newCount = freshOrders.length;

            if (newCount > oldCount) {
              // New orders detected!
              const diff = newCount - oldCount;
              orders = freshOrders;

              // Notify and refresh UI if on admin page
              if (!document.getElementById('adminPage')?.classList.contains('hidden')) {
                showToast(`ğŸ“¦ ${diff} pesanan baru masuk!`, 'success');

                // Refresh current section if it shows orders
                if (currentSection === 'dashboard') renderDashboard();
                if (currentSection === 'pos') renderPOSOrders?.();

                // Play notification sound if available
                playNotificationSound?.();
              }
            } else {
              // Update orders silently (in case of status changes)
              orders = freshOrders;
            }
          }
        } catch (e) {
          // Silently fail - don't spam errors
          console.debug('Order polling failed:', e.message);
        }
      }, 15000); // 15 seconds

      console.log('âœ… Order polling started (every 15s)');
    }

    function stopOrderPolling() {
      if (orderPollingInterval) {
        clearInterval(orderPollingInterval);
        orderPollingInterval = null;
        console.log('â¹ï¸ Order polling stopped');
      }
    }

    // ===== DATA LOAD / SAVE =====
    async function loadFromStorage() {
      // Try remote API first (if enabled), otherwise fall back to localStorage
      if (USE_REMOTE_DB) {
        try {
          const res = await fetch(`${API_BASE}/api/data`, { headers: getAuthHeaders() });
          if (res.ok) {
            const doc = await res.json();
            // If API returns an empty object, fall back
            if (doc && Object.keys(doc).length > 0) {
              // If server stores API key in the AppData document, save it locally for subsequent requests
              try {
                if (doc.apiKey && !localStorage.getItem('warkop_api_key')) {
                  localStorage.setItem('warkop_api_key', doc.apiKey);
                  showToast('API key diterima dari server dan disimpan (lokal)', 'info');
                }
              } catch (e) { /* ignore */ }

              menuItems = doc.menuItems || [];
              categories = doc.categories && doc.categories.length ? doc.categories : ['kopi', 'minuman', 'makanan', 'snack'];
              orders = doc.orders || [];
              tables = doc.tables || [];
              employees = doc.employees || [];
              cashTransactions = doc.cashTransactions || [];
              customers = doc.customers || [];
              gramasiData = doc.gramasiData || [];
              ingredients = doc.ingredients || [];
              recipes = doc.recipes || {};
              stockHistory = doc.stockHistory || [];
              if (doc.customUnits && doc.customUnits.length) customUnits = doc.customUnits;
              businessSettings = { ...businessSettings, ...(doc.businessSettings || {}) };
              showToast('Data dimuat dari server', 'success');
              return; // loaded from remote
            } else {
              showToast('Server tidak mengembalikan data, menggunakan data lokal jika ada', 'info');
              // If local data exists, offer to sync to cloud
              const stored = localStorage.getItem('warkopData');
              if (stored) {
                try {
                  const local = JSON.parse(stored);
                  const hasLocal = (local.menuItems && local.menuItems.length > 0) || (local.orders && local.orders.length > 0);
                  if (hasLocal) {
                    // Show non-blocking notification instead of confirm dialog
                    showToast('ğŸ’¡ Tidak ada data di server. Gunakan tombol "Sinkronisasi" di Pengaturan untuk upload data lokal.', 'info');
                  }
                } catch (e) { /* ignore JSON parse errors */ }
              }
            }
          } else {
            showToast('Server merespon dengan status ' + res.status + ', menggunakan data lokal', 'warning');
          }
        } catch (err) {
          console.warn('Remote DB not available, falling back to localStorage:', err);
          showToast('Tidak dapat menghubungi backend, menggunakan data lokal', 'warning');
        }
      }

      // Fallback to localStorage
      const stored = localStorage.getItem('warkopData');
      if (stored) {
        try {
          const data = JSON.parse(stored);
          menuItems = data.menuItems || [];
          categories = data.categories || ['kopi', 'minuman', 'makanan', 'snack'];
          orders = data.orders || [];
          tables = data.tables || [];
          employees = data.employees || [];
          cashTransactions = data.cashTransactions || [];
          customers = data.customers || [];
          gramasiData = data.gramasiData || [];
          ingredients = data.ingredients || [];
          recipes = data.recipes || {};
          stockHistory = data.stockHistory || [];
          if (data.customUnits && data.customUnits.length) customUnits = data.customUnits;
          businessSettings = { ...businessSettings, ...(data.businessSettings || {}) };
          // NEW: Load POS Security data
          shifts = data.shifts || [];
          deletedOrders = data.deletedOrders || [];
          cashDrawerLogs = data.cashDrawerLogs || [];
          if (data.securitySettings) securitySettings = { ...securitySettings, ...data.securitySettings };
          showToast('Data dimuat dari localStorage', 'info');
        } catch (e) {
          console.error('Error loading data from localStorage:', e);
          showToast('Error membaca data lokal: ' + e.message, 'error');
        }
      }
    }

    async function saveToStorage() {
      // âš ï¸ IMPORTANT: Exclude employees from localStorage to avoid QuotaExceededError
      // Employees contain heavy Base64 photo/KTP data - stored on server only
      const lightData = {
        menuItems,
        categories,
        orders: orders.map(o => ({ ...o, paymentProof: '' })), // Strip payment proofs
        tables,
        // employees EXCLUDED - use server storage only
        cashTransactions,
        customers,
        gramasiData,
        ingredients,
        recipes,
        stockHistory,
        customUnits,
        businessSettings: { ...businessSettings, logo: '' }, // Strip logo to save space
        // POS Security data (lightweight)
        shifts,
        deletedOrders,
        cashDrawerLogs,
        securitySettings
      };

      // Always save lightweight data locally (for offline safety)
      try {
        localStorage.setItem('warkopData', JSON.stringify(lightData));
        // Don't show toast for every save - too noisy
      } catch (e) {
        console.error('Error saving to localStorage:', e);
        // If still failing, clear and retry
        try {
          localStorage.removeItem('warkopData');
          localStorage.setItem('warkopData', JSON.stringify(lightData));
        } catch (e2) {
          showToast('âš ï¸ LocalStorage penuh! Data hanya disimpan ke server.', 'warning');
        }
      }

      // If remote enabled, push to backend (blocking). Include JWT if available.
      if (USE_REMOTE_DB) {
        try {
          const headers = getAuthHeaders();

          // For backend, send FULL data including images (logo, menu photos)
          // lightData already has menuItems, but we override businessSettings to include logo
          const fullData = {
            ...lightData,
            menuItems: menuItems, // Ensure full menuItems with images are sent
            businessSettings: businessSettings // Include full settings with logo
          };

          const res = await fetch(`${API_BASE}/api/data`, {
            method: 'POST',
            headers,
            body: JSON.stringify(fullData)
          });
          if (res.ok) {
            // Sync local state with server's stored document if provided
            const doc = await res.json();
            if (doc && Object.keys(doc).length > 0) {
              menuItems = doc.menuItems || menuItems;
              categories = doc.categories || categories;
              orders = doc.orders || orders;
              tables = doc.tables || tables;
              employees = doc.employees || employees;
              cashTransactions = doc.cashTransactions || cashTransactions;
              customers = doc.customers || customers;
              gramasiData = doc.gramasiData || gramasiData;
              businessSettings = { ...businessSettings, ...(doc.businessSettings || {}) };
              try { localStorage.setItem('warkopData', JSON.stringify({ menuItems, categories, orders, tables, employees, cashTransactions, customers, gramasiData, businessSettings })); } catch (e) { /* ignore */ }
              showToast('Data disimpan ke server dan disinkronkan', 'success');
              return; // remote saved successfully
            } else {
              showToast('Data dikirim ke server', 'success');
              return; // server accepted but didn't return doc
            }
          } else {
            const text = await res.text();
            console.warn('Failed to save to remote DB:', res.status, text);
            // If authentication error, prompt for API key and retry once
            if (res.status === 401 || res.status === 403) {
              const userKey = prompt('Server returned 401/403 (Invalid API key). Masukkan API key untuk mencoba lagi:');
              if (userKey) {
                try {
                  localStorage.setItem('warkop_api_key', userKey);
                  const headers2 = getAuthHeaders();
                  const res2 = await fetch(`${API_BASE}/api/data`, { method: 'POST', headers: headers2, body: JSON.stringify(data) });
                  if (res2.ok) {
                    const doc2 = await res2.json();
                    if (doc2 && Object.keys(doc2).length > 0) {
                      menuItems = doc2.menuItems || menuItems;
                      categories = doc2.categories || categories;
                      orders = doc2.orders || orders;
                      tables = doc2.tables || tables;
                      employees = doc2.employees || employees;
                      cashTransactions = doc2.cashTransactions || cashTransactions;
                      customers = doc2.customers || customers;
                      gramasiData = doc2.gramasiData || gramasiData;
                      businessSettings = { ...businessSettings, ...(doc2.businessSettings || {}) };
                      try { localStorage.setItem('warkopData', JSON.stringify({ menuItems, categories, orders, tables, employees, cashTransactions, customers, gramasiData, businessSettings })); } catch (e) { /* ignore */ }
                    }
                    showToast('Data tersimpan setelah memasukkan API key', 'success');
                    return;
                  } else {
                    const t2 = await res2.text();
                    throw new Error('Gagal menyimpan ke server setelah memasukkan API key: ' + res2.status + ' ' + (t2 || ''));
                  }
                } catch (e) {
                  console.error('Retry saving with user API key failed:', e);
                  throw e;
                }
              } else {
                throw new Error('Operasi dibatalkan: API key tidak dimasukkan');
              }
            }
            throw new Error('Gagal menyimpan ke server: ' + res.status + ' ' + (text || ''));
          }
        } catch (err) {
          console.warn('Error saving to remote DB:', err);
          // bubble up error so callers can handle it
          throw err;
        }
      }

      // If we get here, either remote disabled or remote not used; resolve silently
      return;
    }

    // Helper: build auth headers (JWT or API key from localStorage)
    function getAuthHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('warkop_token');
      const apiKey = localStorage.getItem('warkop_api_key');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      if (apiKey) headers['x-api-key'] = apiKey; else if (DEFAULT_API_KEY) headers['x-api-key'] = DEFAULT_API_KEY;
      return headers;
    }

    // ===== API HELPERS =====
    // Generic API call wrapper
    async function apiCall(endpoint, method = 'GET', data = null) {
      if (!USE_REMOTE_DB) return null;
      try {
        const options = { method, headers: getAuthHeaders() };
        if (data && method !== 'GET') options.body = JSON.stringify(data);
        const res = await fetch(`${API_BASE}${endpoint}`, options);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`API Error ${res.status}: ${text}`);
        }
        return await res.json();
      } catch (err) {
        console.error('API call failed:', endpoint, err);
        throw err;
      }
    }

    // Menu API
    async function apiCreateMenu(item) { return apiCall('/api/menu', 'POST', item); }
    async function apiUpdateMenu(id, item) { return apiCall(`/api/menu/${id}`, 'PUT', item); }
    async function apiDeleteMenu(id) { return apiCall(`/api/menu/${id}`, 'DELETE'); }

    // Category API
    async function apiCreateCategory(item) { return apiCall('/api/categories', 'POST', item); }
    async function apiDeleteCategory(id) {
      console.log(`[DEBUG] Deleting Category: ID/Name=${id}, URL=${API_BASE}/api/categories/${id}`);
      return apiCall(`/api/categories/${id}`, 'DELETE');
    }

    // Order API
    async function apiCreateOrder(item) { return apiCall('/api/orders', 'POST', item); }
    async function apiUpdateOrder(id, item) { return apiCall(`/api/orders/${id}`, 'PUT', item); }
    async function apiDeleteOrder(id) { return apiCall(`/api/orders/${id}`, 'DELETE'); }

    // Table API
    async function apiCreateTable(item) { return apiCall('/api/tables', 'POST', item); }
    async function apiUpdateTable(id, item) { return apiCall(`/api/tables/${id}`, 'PUT', item); }
    async function apiDeleteTable(id) { return apiCall(`/api/tables/${id}`, 'DELETE'); }

    // Employee API
    async function apiCreateEmployee(item) { return apiCall('/api/employees', 'POST', item); }
    async function apiUpdateEmployee(id, item) { return apiCall(`/api/employees/${id}`, 'PUT', item); }
    async function apiDeleteEmployee(id) { return apiCall(`/api/employees/${id}`, 'DELETE'); }

    // Cash Transaction API
    async function apiCreateCash(item) { return apiCall('/api/cash', 'POST', item); }
    async function apiDeleteCash(id) { return apiCall(`/api/cash/${id}`, 'DELETE'); }

    // Customer API
    async function apiCreateCustomer(item) { return apiCall('/api/customers', 'POST', item); }
    async function apiUpdateCustomer(id, item) { return apiCall(`/api/customers/${id}`, 'PUT', item); }
    async function apiDeleteCustomer(id) { return apiCall(`/api/customers/${id}`, 'DELETE'); }

    // Ingredient API
    // Ingredient API
    async function apiCreateIngredient(item) { return apiCall('/api/ingredients', 'POST', item); }
    async function apiUpdateIngredient(id, item) { return apiCall(`/api/ingredients/${id}`, 'PUT', item); }
    async function apiDeleteIngredient(id) { return apiCall(`/api/ingredients/${id}`, 'DELETE'); }

    // Gramasi API
    async function apiCreateGramasi(item) { return apiCall('/api/gramasi', 'POST', item); }
    async function apiCreateGramasiBulk(items) { return apiCall('/api/gramasi/bulk', 'POST', items); }
    async function apiDeleteGramasi(id) { return apiCall(`/api/gramasi/${id}`, 'DELETE'); }

    // Recipe API
    async function apiSaveRecipe(menuId, ingredients) { return apiCall('/api/recipes', 'POST', { menuId, ingredients }); }

    // Stock History API
    async function apiCreateStockHistory(item) { return apiCall('/api/stockhistory', 'POST', item); }

    // Settings API
    async function apiUpdateSettings(settings) { return apiCall('/api/settings', 'PUT', settings); }

    // Shift API
    async function apiCheckShiftStatus(employeeId) {
      return apiCall(`/api/shifts/current/${employeeId}`, 'GET');
    }
    async function apiOpenShift(data) { return apiCall('/api/shifts/open', 'POST', data); }
    async function apiCloseShift(data) { return apiCall('/api/shifts/close', 'POST', data); }

    // ===== AUTHENTICATION =====
    window.showLoginModal = function () {
      console.log('showLoginModal called');
      const modal = document.getElementById('loginModal');
      if (!modal) { console.warn('showLoginModal: #loginModal not found'); return; }
      // Ensure overlay is interactive and not blocking other elements
      modal.style.pointerEvents = 'auto';
      modal.classList.remove('hidden');
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // Main Login Page function (centered login, not popup)
    async function doMainLogin() {
      const username = document.getElementById('mainLoginUsername').value?.trim();
      const password = document.getElementById('mainLoginPassword').value;
      const errorEl = document.getElementById('mainLoginError');
      const btn = document.getElementById('mainLoginBtn');

      // Clear previous error
      if (errorEl) errorEl.classList.add('hidden');

      if (!username) {
        if (errorEl) { errorEl.textContent = 'Username harus diisi!'; errorEl.classList.remove('hidden'); }
        return;
      }
      if (!password) {
        if (errorEl) { errorEl.textContent = 'Password/PIN harus diisi!'; errorEl.classList.remove('hidden'); }
        return;
      }

      // Loading state
      const restoreBtn = setButtonLoading(btn, 'â³ Memverifikasi...');

      try {
        const res = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const json = await res.json();

        if (res.ok) {
          localStorage.setItem('warkop_token', json.token);
          currentUser = {
            id: json.user?.id || json.user?.username,
            username,
            role: json.user?.role || 'kasir',
            name: json.user?.name || username
          };
          localStorage.setItem('warkop_user', JSON.stringify(currentUser));
          localStorage.setItem('userRole', currentUser.role);

          // Hide login page, show admin dashboard
          document.getElementById('loginPage').classList.add('hidden');
          document.getElementById('adminPage').classList.remove('hidden');

          showToast(`Selamat datang, ${currentUser.name}!`, 'success');
          updateUIPermissions();
          renderDashboard();

          // Check shift for kasir
          if (currentUser.role === 'kasir') {
            checkShiftRequired();
          }
        } else {
          restoreBtn();
          if (errorEl) {
            errorEl.textContent = json.error || 'Login gagal!';
            errorEl.classList.remove('hidden');
          }
        }
      } catch (err) {
        restoreBtn();
        console.error('Login error:', err);
        if (errorEl) {
          errorEl.textContent = 'Gagal terhubung ke server!';
          errorEl.classList.remove('hidden');
        }
      }
    }


    async function doLogin() {
      const username = document.getElementById('loginUsername').value?.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');

      // Clear previous error
      if (errorEl) errorEl.classList.add('hidden');

      if (!username) {
        if (errorEl) { errorEl.textContent = 'Username harus diisi!'; errorEl.classList.remove('hidden'); }
        return;
      }
      if (!password) {
        if (errorEl) { errorEl.textContent = 'Password/PIN harus diisi!'; errorEl.classList.remove('hidden'); }
        return;
      }

      console.log('Attempting login with:', { username, passwordLength: password.length });

      // Try backend login
      if (USE_REMOTE_DB && API_BASE) {
        try {
          console.log('Sending login request to:', `${API_BASE}/api/login`);
          const res = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const json = await res.json();
          console.log('Login response:', res.status, json);

          if (res.ok) {
            localStorage.setItem('warkop_token', json.token);
            // Ensure ID is captured. If backend returns incomplete user, fallback to username.
            currentUser = {
              id: json.user?.id || json.user?.username, // Capture ID for Shift API
              username,
              role: json.user?.role || 'kasir',
              name: json.user?.name || username
            };
            localStorage.setItem('warkop_user', JSON.stringify(currentUser)); // Persist user logic
            localStorage.setItem('userRole', currentUser.role); // Store role for shift checks

            closeLoginModal();

            // CHECK SHIFT STATUS FOR KASIR
            if (currentUser.role === 'kasir') {
              showToast('Memeriksa status shift...', 'info');
              try {
                const shiftStatus = await apiCheckShiftStatus(currentUser.id);
                if (shiftStatus.hasOpenShift) {
                  currentShift = shiftStatus.shift;
                  showToast(`Melanjutkan Shift (Mulai: ${new Date(currentShift.startTime).toLocaleTimeString()})`, 'success');
                  // Hide Admin sections?
                  // showSection('pos'); // Go directly to POS

                  // Force UI to POS mode for Kasir
                  showAdminPage(); // Show page first
                  showSection('pos');
                  return;
                } else {
                  // No open shift -> Show Open Shift Modal
                  // But first show Admin Page (hidden) so modals work? 
                  // Actually modals are direct children of body usually.
                  showAdminPage();
                  // Hide other sections?
                  showSection('pos'); // Default to POS area background

                  // Show Modal
                  document.getElementById('openShiftModal').classList.remove('hidden');
                  return;
                }
              } catch (err) {
                console.error('Shift check error:', err);
                showToast('Gagal memeriksa shift: ' + err.message, 'error');
                // Fallback to allowed access? Or block?
                // Allow access for now to avoid lockout during bugs
                showAdminPage();
                return;
              }
            }

            showAdminPage();
            showToast(`Login berhasil! Selamat datang ${json.user?.name || username}`, 'success');
            return;
          } else {
            // Show server error message
            const errMsg = json.error || 'Login gagal';
            if (errorEl) { errorEl.textContent = errMsg; errorEl.classList.remove('hidden'); }
            showToast(errMsg, 'error');
            return;
          }
        } catch (err) {
          console.error('Login network error:', err);
          if (errorEl) { errorEl.textContent = 'Tidak dapat terhubung ke server!'; errorEl.classList.remove('hidden'); }
          showToast('Server tidak tersedia, gunakan admin/admin123', 'warning');
          // Don't return - fall through to local login
        }
      }

      // Fallback to local default credentials
      if (username.toLowerCase() === DEFAULT_USERNAME && password === DEFAULT_PASSWORD) {
        currentUser = { id: 'local_admin', username, role: 'admin', name: 'Administrator' };
        localStorage.setItem('userRole', currentUser.role); // Store role for shift checks
        closeLoginModal();
        showAdminPage();
        showToast('Login berhasil (lokal)! Selamat datang ' + username, 'success');
      } else {
        if (errorEl) { errorEl.textContent = 'Username atau password salah!'; errorEl.classList.remove('hidden'); }
        showToast('Username atau password salah!', 'error');
      }
    }

    function logout() {
      // If Kasir has open shift, show Close Shift Modal instead of immediate logout
      if (currentUser && currentUser.role === 'kasir') {
        // Check if we have shift data loaded (optional, or just show modal)
        // We'll show the modal and let them calculate
        updateShiftModalUI();
        document.getElementById('closeShiftModal').classList.remove('hidden');
        return;
      }

      // Clear all session state
      currentUser = null;
      localStorage.removeItem('userRole');
      localStorage.removeItem('warkop_user');
      localStorage.removeItem('warkop_token');
      activeShift = null;
      shiftCheckedThisSession = false;

      // Show login page instead of customer page
      document.getElementById('adminPage').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');

      // Clear login form
      document.getElementById('mainLoginUsername').value = '';
      document.getElementById('mainLoginPassword').value = '';
      document.getElementById('mainLoginError').classList.add('hidden');

      showToast('Logout berhasil', 'success');
    }

    // ===== SHIFT LOGIC =====
    async function doOpenShift() {
      const startCash = document.getElementById('shiftStartCash').value;
      if (!startCash || startCash < 0) {
        showToast('Masukkan modal awal yang valid', 'error');
        return;
      }

      // We need the employee's PIN again? 
      // The API requires it. But we just logged in with it.
      // Ideally we ask for it or cache it temporarily? 
      // For UX, we can assume the session token is enough auth, BUT the API route explicitly asks for PIN in body.
      // Let's modify the API to NOT require PIN if authorized via Token? 
      // OR, simpler: We ask for PIN in the Open Shift Modal?
      // Since `currentUser` doesn't store the PIN (security), we might need to ask again.
      // However, `doLogin` verified the PIN.

      // Let's assume we need to prompt or we change the backend to use the logged-in user context.
      // Checking backend: `app.post('/api/shifts/open', checkApiKey...`
      // It expects `pin` in body.

      // OPTION: We'll modify the backend later to leverage `req.user` if we used JWT. 
      // Current system uses simple Token or Basic Auth? 
      // `doLogin` stores `warkop_token`. 
      // Backend `checkApiKey` doesn't decode JWT to user? 
      // Let's check `checkApiKey`.

      // FALLBACK: Use a simple recursive Prompt for PIN if needed, OR just assume the user knows it.
      // Actually, since we just logged in, asking again is annoying.
      // Let's try to send the password from the Login field if it's still there? No, cleared.

      // WORKAROUND: For now, I'll prompt for PIN in `doOpenShift` if checking fails, 
      // OR I will rely on the fact that I can't get the PIN easily.
      // Wait, let's look at `doOpenShift` in backend. It Validates `emp.pin === pin`.
      // I will add a PIN input to the Open Shift Modal.

      // Wait, I already wrote the HTML for Open Modal and it DOES NOT have a PIN input.
      // I should add it. 
      // OR I can modify the backend to NOT require PIN if the user is already authenticated (Shift is created for `employeeId`).

      // Let's modify the Backend to be smarter? No, I want to minimize backend changes now.
      // I'll add a PIN input to the Open Shift Modal via JS or modify HTML.
      // Actually, I can allow the user to enter PIN in the modal.

      // Let's use `prompt` for PIN for now to save HTML editing?
      // "Masukkan PIN untuk konfirmasi Buka Shift"

      // No, better: The backend `api/shifts/open` requires `employeeId` and `pin`.
      // We can get `employeeId` from `currentUser.id` (if available? `currentUser` object has `username`).
      // We need to fetch the full employee object or store ID in `currentUser`.
      // `doLogin` sets `currentUser = { username, role, name }`. It misses ID!
      // I need to update `doLogin` to store ID too.

      // Plan:
      // 1. Update `doLogin` to store `id`.
      // 2. Prompt PIN in `doOpenShift`.

      const pin = prompt('Masukkan PIN untuk konfirmasi:');
      if (!pin) return;

      try {
        const res = await apiOpenShift({
          employeeId: currentUser.id, // Need to ensure this exists
          pin: pin,
          startCash: Number(startCash)
        });

        document.getElementById('openShiftModal').classList.add('hidden');
        showToast('Shift Dibuka! Selamat Bekerja. â˜•', 'success');

        // Redirect to POS
        showAdminPage(); // Refresh view
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function doCloseShift() {
      const actualCash = document.getElementById('shiftActualCash').value;
      const notes = document.getElementById('shiftCloseNotes').value;

      if (!actualCash) { showToast('Masukkan jumlah uang fisik!', 'error'); return; }

      // We need shiftId.
      // We should have fetched it on login or via `apiCheckShiftStatus`.
      // Let's store `currentShift` globally.

      if (!currentShift || !currentShift._id) {
        showToast('Data shift tidak ditemukan. Coba refresh.', 'error');
        return;
      }

      try {
        console.log('Closing Shift...');

        // 0. STOP DASHBOARD UPDATES
        if (typeof dashboardInterval !== 'undefined') clearInterval(dashboardInterval);

        // Validation
        const actualCashEl = document.getElementById('shiftActualCash');
        const notesEl = document.getElementById('shiftCloseNotes');
        if (!actualCashEl) throw new Error('Input uang tidak ditemukan on Close!');

        const actualCash = Number(actualCashEl.value);
        const notes = notesEl ? notesEl.value : '';

        // 1. Archive Active Orders (Critical)
        const closeRes = await fetch(API_BASE + '/api/orders/close-shift', {
          method: 'POST',
          headers: getAuthHeaders()
        });
        if (!closeRes.ok) throw new Error('Gagal mengarsipkan order: ' + closeRes.status);

        // 2. Submit Financials (Critical)
        await apiCloseShift({
          shiftId: currentShift._id,
          actualCash: actualCash,
          notes: notes
        });

        // 3. UI Updates (Non-Critical)
        try {
          const modal = document.getElementById('closeShiftModal');
          if (modal) modal.classList.add('hidden');
          showToast('Shift Ditutup. Logout...', 'success');
        } catch (ignore) { }

        // 4. Logout (Critical)
        currentUser = null;
        currentShift = null;
        setTimeout(() => window.location.reload(), 500);

      } catch (err) {
        console.error('Close Shift Error:', err);
        // Force reload if we suspect partial success or critical failure state
        if (err.message && err.message.includes('innerHTML')) {
          window.location.reload();
        } else {
          const msg = err.message || 'Gagal menutup shift';
          try { showToast(msg, 'error'); } catch (e) { alert(msg); }
        }
      }
    }

    // Live calculation for Close Shift
    function calculateShiftVariance() {
      const system = currentShift ? (currentShift.startCash + calculateSessionSales()) : 0;
      const actual = Number(document.getElementById('shiftActualCash').value) || 0;
      const variance = actual - system;

      const el = document.getElementById('shiftVarianceAmount');
      const container = document.getElementById('shiftVarianceContainer');

      container.classList.remove('hidden');
      el.textContent = formatCurrency(variance);
      el.classList.toggle('text-red-400', variance < 0);
      el.classList.toggle('text-green-400', variance >= 0);
    }

    function calculateSessionSales() {
      // Approximate sales for current session from local orders (since login?)
      // Ideally fetch from backend, but for responsive UI we can estimate or fetch.
      // For now return 0 or implement a check.
      // Let's fetch `apiCheckShiftStatus` again to get fresh data? The endpoint doesn't return total sales.
      // We'll rely on the backend's final calculation for the record, 
      // but for UI "Total Tunai (Sistem)", we need to know it.

      // Temporary: simple filter of loaded orders
      if (!currentShift) return 0;
      const shiftStart = new Date(currentShift.startTime).getTime();
      const sessionOrders = orders.filter(o => o.paymentMethod === 'cash' && o.timestamp >= shiftStart);
      return sessionOrders.reduce((sum, o) => sum + (o.total || 0), 0);
    }

    async function updateShiftModalUI() {
      // Refresh shift data
      try {
        const res = await apiCheckShiftStatus(currentUser.id);
        if (res.hasOpenShift) {
          currentShift = res.shift;

          // Update System Cash Display
          const sales = calculateSessionSales();
          const totalSystem = currentShift.startCash + sales;
          document.getElementById('shiftSystemCash').textContent = formatCurrency(totalSystem);
        }
      } catch (e) { console.warn('Shift check failed', e); }
    }

    // ===== PAGE NAVIGATION =====
    function showAdminPage() {
      document.getElementById('customerPage').classList.add('hidden');
      document.getElementById('adminPage').classList.remove('hidden');

      updateUIPermissions();

      // Default section based on role
      if (currentUser && currentUser.role === 'kasir') {
        // showSection('pos'); // Handled in doLogin, but good fallback
      } else {
        showSection('dashboard');
      }

      updateAllStats();
    }

    function updateUIPermissions() {
      if (!currentUser) return;

      const role = currentUser.role;
      const isKasir = role === 'kasir';

      // Sidebar Items to Hide for Kasir
      const restrictedSections = ['dashboard', 'menu', 'gramasi', 'inventory', 'finance', 'employee', 'report', 'settings'];

      document.querySelectorAll('.sidebar-item').forEach(item => {
        const section = item.dataset.section;
        if (isKasir && restrictedSections.includes(section)) {
          item.classList.add('hidden');
        } else {
          item.classList.remove('hidden');
        }
      });

      // Also hide "Sync to Cloud" and other admin buttons if needed
      if (isKasir) {
        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
      } else {
        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
      }

      // Update User Info in Sidebar
      const userEl = document.getElementById('sidebarUserInfo');
      if (userEl) {
        userEl.innerHTML = `
           <div class="font-bold">${currentUser.name}</div>
           <div class="text-xs text-gray-400 capitalize">${currentUser.role}</div>
         `;
      }

      // âœ… ADMIN ONLY: Floating Cash Drawer Toggle
      const drawerToggle = document.getElementById('cashDrawerToggle');
      const drawerWidget = document.getElementById('cashDrawerWidget');

      if (isKasir) {
        // Hide for Kasir
        if (drawerToggle) drawerToggle.classList.add('hidden', '!hidden'); // Force hide
        if (drawerWidget) {
          drawerWidget.classList.add('hidden');
          cashDrawerVisible = false; // Sync state
        }
      } else {
        // Show for Admin (restore default state - usually toggle is visible, widget hidden initially)
        if (drawerToggle && !cashDrawerVisible) drawerToggle.classList.remove('hidden', '!hidden');
        if (drawerWidget && cashDrawerVisible) drawerWidget.classList.remove('hidden');
      }
    }

    function showCustomerPage() {
      closeAllModals();
      document.getElementById('adminPage').classList.add('hidden');
      document.getElementById('customerPage').classList.remove('hidden');
      renderCustomerPage();
    }

    function showSection(section) {
      // Close any open modals/confirmations first
      closeAllModals();

      // Hide all sections
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));

      // Show selected section
      const sectionMap = {
        dashboard: 'dashboardSection',
        menu: 'menuSection',
        pos: 'posSection',
        gramasi: 'gramasiSection',
        inventory: 'inventorySection',
        finance: 'financeSection',
        employee: 'employeeSection',
        table: 'tableSection',
        report: 'reportSection',
        customer: 'customerSection',
        settings: 'settingsSection'
      };

      document.getElementById(sectionMap[section])?.classList.remove('hidden');

      // Update sidebar active state
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.section === section) {
          item.classList.add('active');
        }
      });

      currentSection = section;

      // Render section content
      switch (section) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'menu':
          renderMenuManagement();
          break;
        case 'pos':
          renderPOS();
          break;
        case 'gramasi':
          renderGramasi();
          break;
        case 'inventory':
          renderInventory();
          break;
        case 'finance':
          renderFinance();
          break;
        case 'employee':
          renderEmployees();
          break;
        case 'table':
          renderTables();
          break;
        case 'report':
          renderReports();
          break;
        case 'customer':
          renderCustomers();
          break;
        case 'settings':
          renderSettings();
          break;
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('-translate-x-full');
    }

    // ===== TOAST NOTIFICATIONS =====
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');

      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
      };

      const icons = {
        success: 'âœ“',
        error: 'âœ•',
        info: 'â„¹',
        warning: 'âš '
      };

      toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-3`;
      toast.innerHTML = `
        <span class="text-xl">${icons[type]}</span>
        <span>${message}</span>
      `;

      if (container) {
        container.appendChild(toast);
      } else {
        console.warn('showToast: #toastContainer not found, appending to body');
        document.body.appendChild(toast);
      }

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ===== UTILITY FUNCTIONS =====
    function formatCurrency(amount) {
      return 'Rp ' + amount.toLocaleString('id-ID');
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ===== LOADING STATE HELPER =====
    // Usage: const restore = setButtonLoading(btn); ... restore();
    function setButtonLoading(btn, loadingText = 'â³ Menyimpan...') {
      if (!btn) return () => { };
      const originalHTML = btn.innerHTML;
      const originalDisabled = btn.disabled;

      btn.disabled = true;
      btn.innerHTML = loadingText;
      btn.classList.add('opacity-50', 'cursor-not-allowed');

      return function restore() {
        btn.disabled = originalDisabled;
        btn.innerHTML = originalHTML;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      };
    }

    // Safe setter for innerHTML; accepts an element or an id string.
    function safeSet(target, html) {
      const el = (typeof target === 'string') ? document.getElementById(target) : target;
      if (!el) { console.warn('safeSet: target not found', target); return; }
      el.innerHTML = html;
    }

    // ===== GLOBAL MODAL UTILITIES =====
    // Close all modal overlays (for cleanup)
    function closeAllModals() {
      try {
        const hardcodedModals = [
          'sidebar', 'adminPage', 'customerPage', 'manualOrderModal',
          'orderModal', 'receiptModal', 'loginModal', 'openShiftModal',
          'closeShiftModal', 'imageModal'
        ];

        // Remove all fixed position modals (our custom modals)
        document.querySelectorAll('.fixed.inset-0').forEach(modal => {
          // Don't remove whitelisted modals
          if (hardcodedModals.includes(modal.id)) {
            modal.classList.add('hidden');
            return;
          }
          modal.remove();
        });

        // Remove any leftover modal backdrops
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        // Ensure body scroll is restored
        document.body.style.overflow = '';
        document.body.classList.remove('modal-open');

        // Ensure sidebar is visible
        ensureSidebarVisible();
      } catch (e) {
        console.warn('Error closing modals:', e);
      }
    }

    // Close specific modal by ID or element
    function closeModal(modalIdOrElement) {
      try {
        let modal;
        if (typeof modalIdOrElement === 'string') {
          modal = document.getElementById(modalIdOrElement);
        } else if (modalIdOrElement instanceof Element) {
          modal = modalIdOrElement;
        } else if (modalIdOrElement?.closest) {
          // If it's an event target, find parent modal
          modal = modalIdOrElement.closest('.fixed.inset-0');
        }

        if (modal) {
          modal.remove();
        } else {
          // Fallback: try to remove the first visible modal
          const firstModal = document.querySelector('.fixed.inset-0.bg-black\\/50, .fixed.inset-0[class*="bg-black"]');
          if (firstModal) firstModal.remove();
        }

        // Always ensure sidebar is visible after closing modal
        ensureSidebarVisible();
      } catch (e) {
        console.warn('Error closing modal:', e);
      }
    }

    // Ensure sidebar stays visible - call this after any UI operation
    function ensureSidebarVisible() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) return;

      // Don't show sidebar if on customer page
      const adminPage = document.getElementById('adminPage');
      if (adminPage?.classList.contains('hidden')) return;

      // Ensure sidebar has correct visibility on desktop
      if (window.innerWidth >= 768) {
        sidebar.classList.remove('hidden', '-translate-x-full');
        sidebar.style.display = 'flex';
        sidebar.style.visibility = 'visible';
      }
    }

    // Safe wrapper for async save operations with modal
    async function safeModalSave(saveFunction, modalElement = null) {
      // Close modal FIRST for better UX
      if (modalElement) {
        closeModal(modalElement);
      } else {
        // Try to close any open modal
        const openModal = document.querySelector('.fixed.inset-0[class*="bg-black"]');
        if (openModal) openModal.remove();
      }

      try {
        await saveFunction();
      } catch (err) {
        console.error('Save error:', err);
        showToast('Terjadi kesalahan: ' + err.message, 'error');
      } finally {
        // Ensure sidebar is always visible after operation
        ensureSidebarVisible();
      }
    }

    // ===== POS SESSION MANAGEMENT =====

    // Load session from localStorage
    function loadSession() {
      try {
        const token = localStorage.getItem('warkop_token');
        if (token) {
          // We have a token, but do we have user info?
          // Ideally we verify token with backend.
          // For now, let's assume if token exists, we are logged in.
          // BUT we lost `currentUser` object.
          // We need to fetch user profile or store it in localStorage.

          // Let's store user info in localStorage on login too?
          const storedUser = localStorage.getItem('warkop_user');
          if (storedUser) {
            currentUser = JSON.parse(storedUser);
            updateLastActivity();
            return true;
          }
        }
      } catch (e) {
        console.warn('Error loading session:', e);
      }
      return false;
    }

    // Save session to localStorage
    function saveSession() {
      if (currentSession) {
        try {
          localStorage.setItem(SESSION_KEY, JSON.stringify(currentSession));
        } catch (e) {
          console.warn('Error saving session:', e);
        }
      }
    }

    // Clear session
    function clearSession() {
      currentSession = null;
      isSessionLocked = false;
      localStorage.removeItem(SESSION_KEY);
      localStorage.removeItem(LAST_ACTIVITY_KEY);
      stopIdleTimer();
    }

    // Update last activity time
    function updateLastActivity() {
      localStorage.setItem(LAST_ACTIVITY_KEY, Date.now().toString());
      // Reset idle timer
      startIdleTimer();
    }

    // Start idle timer with warning
    function startIdleTimer() {
      stopIdleTimer();

      if (!securitySettings.autoLockEnabled || !currentSession) return;

      // Warning timer (1 minute before lock)
      warningTimer = setTimeout(() => {
        if (currentSession && !isSessionLocked) {
          showIdleWarning();
        }
      }, IDLE_WARNING);

      // Lock timer
      idleTimer = setTimeout(() => {
        if (currentSession && !isSessionLocked) {
          lockSession();
        }
      }, IDLE_TIMEOUT);
    }

    // Stop idle timer
    function stopIdleTimer() {
      if (idleTimer) { clearTimeout(idleTimer); idleTimer = null; }
      if (warningTimer) { clearTimeout(warningTimer); warningTimer = null; }
    }

    // Show idle warning (1 minute before lock)
    function showIdleWarning() {
      const existing = document.getElementById('idleWarningToast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'idleWarningToast';
      toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-yellow-500 text-black px-6 py-3 rounded-lg shadow-lg animate-fade font-bold';
      toast.innerHTML = `âš ï¸ Sesi akan terkunci dalam 1 menit! <button onclick="updateLastActivity(); this.parentElement.remove();" class="ml-4 px-2 py-1 bg-black text-white rounded">Tetap Aktif</button>`;
      document.body.appendChild(toast);
    }

    // Lock session (auto-lock after idle)
    function lockSession() {
      isSessionLocked = true;
      document.getElementById('idleWarningToast')?.remove();
      showPinUnlockModal();
    }

    // Check if session is valid
    function checkSession() {
      if (!currentSession) return false;

      // Check if idle timeout exceeded
      const lastActivity = parseInt(localStorage.getItem(LAST_ACTIVITY_KEY) || '0');
      if (Date.now() - lastActivity > IDLE_TIMEOUT) {
        lockSession();
        return false;
      }

      return !isSessionLocked;
    }

    // ===== SINGLE GATE LOGIN SYSTEM =====

    // Show unified login modal for all users (admin & employees)
    function showLoginModal() {
      closeAllModals();

      const modal = document.createElement('div');
      modal.id = 'loginModal';
      // Outer container: allow clicks to pass through backdrop for closing
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60]';
      modal.innerHTML = `
        <!-- Form card: MUST have pointer-events-auto and z-50 to be clickable -->
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade relative pointer-events-auto z-50" style="pointer-events: auto !important;">
          <!-- Close Button -->
          <button onclick="closeAllModals()" 
            class="absolute top-4 right-4 w-8 h-8 rounded-full bg-surface/50 hover:bg-surface flex items-center justify-center text-gray-400 hover:text-white z-50" style="pointer-events: auto;">
            âœ•
          </button>
          
          <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full bg-purple-500/20 mx-auto flex items-center justify-center mb-4">
              <span class="text-3xl">ğŸ”</span>
            </div>
            <h3 class="text-xl font-bold mb-1">Login Pegawai</h3>
            <p class="text-gray-400 text-sm">Masukkan Username & Password/PIN Anda</p>
          </div>
          
          <div class="space-y-4 mb-6">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Username</label>
              <input type="text" id="loginUsername" 
                class="input-field w-full px-4 py-3 rounded-lg text-white"
                placeholder="Masukkan username Anda" style="pointer-events: auto;">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Password / PIN</label>
              <input type="password" id="loginPassword" 
                class="input-field w-full px-4 py-3 rounded-lg text-white"
                placeholder="Masukkan password atau PIN 6 digit" style="pointer-events: auto;">
            </div>
          </div>
          
          <div id="loginError" class="text-red-400 text-sm mb-4 hidden text-center"></div>
          
          <button onclick="validateLogin()" class="w-full btn-primary py-4 rounded-lg font-bold text-lg" style="pointer-events: auto;">
            ğŸš€ Masuk
          </button>
          
          <p class="text-xs text-gray-500 text-center mt-4">
            Admin: gunakan password | Kasir: gunakan PIN 6 digit
          </p>
        </div>
      `;
      document.body.appendChild(modal);

      // Auto focus
      setTimeout(() => document.getElementById('loginUsername')?.focus(), 100);

      // Enter key handlers
      document.getElementById('loginUsername')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('loginPassword')?.focus();
      });
      document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') validateLogin();
      });
    }

    // Alias for backwards compatibility
    function showPinLoginModal() { showLoginModal(); }

    // Single Gate validation: detects role and validates accordingly
    function validateLogin() {
      const username = document.getElementById('loginUsername')?.value?.trim()?.toLowerCase();
      const password = document.getElementById('loginPassword')?.value;
      const errorEl = document.getElementById('loginError');

      // Clear previous error
      if (errorEl) errorEl.classList.add('hidden');

      if (!username) {
        if (errorEl) { errorEl.textContent = 'Username harus diisi!'; errorEl.classList.remove('hidden'); }
        return;
      }

      if (!password) {
        if (errorEl) { errorEl.textContent = 'Password/PIN harus diisi!'; errorEl.classList.remove('hidden'); }
        return;
      }

      // STEP 1: Check if username is master admin
      if (username === 'admin') {
        // Admin login - validate against password (or masterPin for backwards compat)
        if (password === DEFAULT_PASSWORD || password === securitySettings.masterPin) {
          // Master admin login
          currentSession = {
            id: generateId(),
            cashierId: 'admin',
            cashierName: 'Administrator',
            username: 'admin',
            role: 'admin',
            shiftId: null,
            openingCash: 0,
            loginTime: new Date().toISOString()
          };

          saveSession();
          updateLastActivity();
          closeAllModals();

          showToast('Selamat datang, Administrator!', 'success');
          showSection('dashboard');
          return;
        } else {
          if (errorEl) { errorEl.textContent = 'Password admin salah!'; errorEl.classList.remove('hidden'); }
          document.getElementById('loginPassword').value = '';
          return;
        }
      }

      // STEP 2: Find employee by username
      const employee = employees.find(e => e.username?.toLowerCase() === username && e.isActive !== false);

      if (!employee) {
        if (errorEl) { errorEl.textContent = 'Username tidak ditemukan!'; errorEl.classList.remove('hidden'); }
        return;
      }

      // STEP 3: Validate based on role
      let isValid = false;

      if (employee.role === 'admin') {
        // Admin employee - can use either password or PIN
        isValid = (employee.password && password === employee.password) ||
          (employee.pin && password === employee.pin);
      } else {
        // Kasir - validate PIN only (6 digits)
        isValid = employee.pin && password === employee.pin;
      }

      if (!isValid) {
        const hint = employee.role === 'admin' ? 'Password/PIN salah!' : 'PIN salah! (Harus 6 digit)';
        if (errorEl) { errorEl.textContent = hint; errorEl.classList.remove('hidden'); }
        document.getElementById('loginPassword').value = '';
        return;
      }

      // SUCCESS: Create session
      currentSession = {
        id: generateId(),
        cashierId: employee.id,
        cashierName: employee.name,
        username: employee.username,
        role: employee.role || 'kasir',
        shiftId: null,
        openingCash: 0,
        loginTime: new Date().toISOString()
      };

      saveSession();
      updateLastActivity();
      closeAllModals();

      showToast(`Selamat datang, ${employee.name}!`, 'success');

      // Role-based redirect
      if (employee.role === 'admin') {
        showSection('dashboard');
      } else {
        // Show opening cash modal for kasir to start shift
        showOpeningCashModal();
      }
    }

    // Show PIN unlock modal (after idle lock)
    function showPinUnlockModal() {
      closeAllModals();

      const modal = document.createElement('div');
      modal.id = 'pinUnlockModal';
      modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-[70]';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-8 max-w-sm w-full animate-fade text-center">
          <div class="w-20 h-20 rounded-full bg-yellow-500/20 mx-auto flex items-center justify-center mb-4">
            <span class="text-4xl">â°</span>
          </div>
          <h3 class="text-2xl font-bold mb-2">Sesi Terkunci</h3>
          <p class="text-gray-400 text-sm mb-2">Halo, ${currentSession?.cashierName || 'Kasir'}</p>
          <p class="text-gray-500 text-xs mb-6">Masukkan PIN untuk melanjutkan</p>
          
          <div class="mb-6">
            <input type="password" id="unlockPinInput" maxlength="6" 
              class="input-field w-full text-center text-3xl tracking-[0.5em] px-4 py-4 rounded-lg"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" oninput="this.value = this.value.replace(/\\D/g,'')">
          </div>
          
          <div id="unlockPinError" class="text-red-400 text-sm mb-4 hidden">PIN salah!</div>
          
          <button onclick="validatePinUnlock()" class="w-full btn-primary py-3 rounded-lg font-bold text-lg mb-3">
            ğŸ”“ Buka Kunci
          </button>
          
          <button onclick="endShiftFromLock()" class="text-sm text-red-400 hover:text-red-300">
            ğŸšª Keluar & Tutup Shift
          </button>
        </div>
      `;
      document.body.appendChild(modal);

      setTimeout(() => document.getElementById('unlockPinInput')?.focus(), 100);
      document.getElementById('unlockPinInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') validatePinUnlock();
      });
    }

    // Validate unlock PIN
    function validatePinUnlock() {
      const pin = document.getElementById('unlockPinInput')?.value;
      const errorEl = document.getElementById('unlockPinError');

      if (!pin || pin.length !== 6) {
        if (errorEl) { errorEl.textContent = 'PIN harus 6 digit!'; errorEl.classList.remove('hidden'); }
        return;
      }

      // Check if PIN matches current session's employee
      const employee = employees.find(e => e.id === currentSession?.cashierId);

      if (!employee || employee.pin !== pin) {
        if (errorEl) { errorEl.textContent = 'PIN tidak cocok!'; errorEl.classList.remove('hidden'); }
        document.getElementById('unlockPinInput').value = '';
        return;
      }

      // Unlock session
      isSessionLocked = false;
      updateLastActivity();
      closeAllModals();
      showToast('Sesi dibuka kembali!', 'success');
    }

    // End shift from lock screen
    function endShiftFromLock() {
      isSessionLocked = false;
      closeAllModals();
      showCloseShiftModal();
    }

    // ===== MASTER PIN VALIDATION =====

    // Show Master PIN modal for sensitive operations
    function requireMasterPin(action, callback) {
      const modal = document.createElement('div');
      modal.id = 'masterPinModal';
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[80]';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade">
          <div class="text-center mb-4">
            <div class="w-16 h-16 rounded-full bg-red-500/20 mx-auto flex items-center justify-center mb-4">
              <span class="text-3xl">ğŸ”’</span>
            </div>
            <h3 class="text-xl font-bold mb-2">Otorisasi Diperlukan</h3>
            <p class="text-gray-400 text-sm">Masukkan Master PIN untuk melanjutkan</p>
            <p class="text-xs text-gray-500 mt-1">Aksi: ${getActionLabel(action)}</p>
          </div>
          
          <div class="mb-4">
            <input type="password" id="masterPinInput" maxlength="6" 
              class="input-field w-full text-center text-2xl tracking-[0.5em] px-4 py-3 rounded-lg"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" oninput="this.value = this.value.replace(/\\D/g,'')">
          </div>
          
          <div id="masterPinError" class="text-red-400 text-sm mb-4 hidden text-center">Master PIN salah!</div>
          
          <div class="flex gap-2">
            <button onclick="document.getElementById('masterPinModal').remove()" 
              class="flex-1 px-4 py-3 rounded-lg bg-surface hover:bg-surface/80 font-medium">
              Batal
            </button>
            <button onclick="validateMasterPinAction('${action}')" 
              class="flex-1 px-4 py-3 rounded-lg bg-red-500 hover:bg-red-600 font-medium">
              âœ“ Konfirmasi
            </button>
          </div>
        </div>
      `;

      // Store callback
      window._masterPinCallback = callback;

      document.body.appendChild(modal);
      setTimeout(() => document.getElementById('masterPinInput')?.focus(), 100);

      document.getElementById('masterPinInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') validateMasterPinAction(action);
      });
    }

    // Get action label for display
    function getActionLabel(action) {
      const labels = {
        'delete_order': 'Hapus Pesanan',
        'access_reports': 'Akses Laporan',
        'access_finance': 'Akses Keuangan',
        'access_settings': 'Akses Pengaturan',
        'open_drawer': 'Buka Laci Kas',
        'void_transaction': 'Batalkan Transaksi'
      };
      return labels[action] || action;
    }

    // Validate Master PIN
    function validateMasterPinAction(action) {
      const pin = document.getElementById('masterPinInput')?.value;
      const errorEl = document.getElementById('masterPinError');

      if (!pin || pin.length !== 6) {
        if (errorEl) { errorEl.textContent = 'PIN harus 6 digit!'; errorEl.classList.remove('hidden'); }
        return;
      }

      if (pin !== securitySettings.masterPin) {
        if (errorEl) { errorEl.textContent = 'Master PIN salah!'; errorEl.classList.remove('hidden'); }
        document.getElementById('masterPinInput').value = '';
        // Log failed attempt
        console.warn('Failed Master PIN attempt for action:', action);
        return;
      }

      // Success - close modal and execute callback
      document.getElementById('masterPinModal')?.remove();

      if (window._masterPinCallback) {
        window._masterPinCallback(true);
        window._masterPinCallback = null;
      }
    }

    // ===== SHIFT MANAGEMENT =====

    // Show opening cash modal
    function showOpeningCashModal() {
      const modal = document.createElement('div');
      modal.id = 'openingCashModal';
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60]';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade">
          <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full bg-green-500/20 mx-auto flex items-center justify-center mb-4">
              <span class="text-3xl">ğŸ’°</span>
            </div>
            <h3 class="text-xl font-bold mb-2">Buka Shift Baru</h3>
            <p class="text-gray-400 text-sm">Kasir: ${currentSession?.cashierName || '-'}</p>
            <p class="text-xs text-gray-500">${new Date().toLocaleString('id-ID')}</p>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Modal Awal (Rp) *</label>
              <input type="number" id="openingCashInput" 
                class="input-field w-full text-center text-2xl px-4 py-4 rounded-lg font-bold"
                placeholder="0" value="0">
              <p class="text-xs text-gray-500 mt-1">Hitung uang di laci kas sebelum mulai</p>
            </div>
          </div>
          
          <button onclick="saveOpeningCash()" class="w-full btn-primary py-4 rounded-lg font-bold text-lg mt-6">
            âœ… Mulai Shift
          </button>
        </div>
      `;
      document.body.appendChild(modal);

      setTimeout(() => {
        const input = document.getElementById('openingCashInput');
        if (input) { input.focus(); input.select(); }
      }, 100);
    }

    // Save opening cash and start shift
    function saveOpeningCash() {
      const amount = parseFloat(document.getElementById('openingCashInput')?.value) || 0;

      // Create new shift
      const newShift = {
        id: generateId(),
        cashierId: currentSession?.cashierId,
        cashierName: currentSession?.cashierName,
        openingTime: new Date().toISOString(),
        closingTime: null,
        openingCash: amount,
        expectedCash: amount,
        actualCash: 0,
        cashSales: 0,
        nonCashSales: 0,
        discrepancy: 0,
        discrepancyNote: '',
        status: 'open'
      };

      shifts.push(newShift);

      // Update session
      if (currentSession) {
        currentSession.shiftId = newShift.id;
        currentSession.openingCash = amount;
        saveSession();
      }

      saveToStorage();
      closeAllModals();

      showToast(`Shift dibuka dengan modal Rp ${amount.toLocaleString('id-ID')}`, 'success');

      // Refresh UI
      showSection('pos');
    }

    // Show close shift modal with reconciliation
    async function showCloseShiftModal() {
      const activeShift = shifts.find(s => s.id === currentSession?.shiftId && s.status === 'open');
      if (!activeShift) {
        showToast('Tidak ada shift aktif!', 'warning');
        clearSession();
        showPinLoginModal();
        return;
      }

      // âœ… FETCH FRESH ORDERS FROM BACKEND to include customer page orders
      showToast('Memuat data pesanan terbaru...', 'info');
      if (USE_REMOTE_DB) {
        try {
          const res = await fetch(`${API_BASE}/api/orders`, { headers: getAuthHeaders() });
          if (res.ok) {
            const freshOrders = await res.json();
            orders = freshOrders; // Update local orders with fresh data
            console.log(`âœ… Fetched ${freshOrders.length} orders from backend for shift calculation`);
          }
        } catch (e) {
          console.warn('Failed to fetch fresh orders, using local data:', e);
        }
      }

      // Calculate totals from ALL orders during this shift (now includes customer page orders)
      const shiftOrders = orders.filter(o => {
        const orderTime = new Date(o.timestamp || o.date).getTime();
        const shiftStart = new Date(activeShift.openingTime).getTime();
        return orderTime >= shiftStart && o.status !== 'cancelled';
      });

      const cashSales = shiftOrders.filter(o => o.paymentMethod === 'cash' || !o.paymentMethod)
        .reduce((sum, o) => sum + (o.total || 0), 0);
      const nonCashSales = shiftOrders.filter(o => o.paymentMethod && o.paymentMethod !== 'cash')
        .reduce((sum, o) => sum + (o.total || 0), 0);
      const expectedCash = activeShift.openingCash + cashSales;

      const modal = document.createElement('div');
      modal.id = 'closeShiftModal';
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60] overflow-auto';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-lg w-full animate-fade my-4">
          <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full bg-red-500/20 mx-auto flex items-center justify-center mb-4">
              <span class="text-3xl">ğŸ”’</span>
            </div>
            <h3 class="text-xl font-bold mb-2">Tutup Shift</h3>
            <p class="text-gray-400 text-sm">Kasir: ${currentSession?.cashierName || '-'}</p>
          </div>
          
          <!-- Summary -->
          <div class="glass rounded-xl p-4 mb-4 space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-400">Modal Awal:</span>
              <span class="font-bold">${formatCurrency(activeShift.openingCash)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Penjualan Tunai:</span>
              <span class="font-bold text-green-400">+ ${formatCurrency(cashSales)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Penjualan Non-Tunai:</span>
              <span class="text-purple-400">${formatCurrency(nonCashSales)}</span>
            </div>
            <hr class="border-purple-500/20">
            <div class="flex justify-between text-lg">
              <span class="font-bold">Hitungan Sistem:</span>
              <span class="font-bold text-yellow-400">${formatCurrency(expectedCash)}</span>
            </div>
          </div>
          
          <!-- Physical Cash Input -->
          <div class="space-y-4 mb-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Uang Fisik di Laci (Rp) *</label>
              <input type="number" id="actualCashInput" 
                class="input-field w-full text-center text-2xl px-4 py-4 rounded-lg font-bold"
                placeholder="0" onchange="calculateDiscrepancy(${expectedCash})">
            </div>
            
            <div id="discrepancyDisplay" class="hidden glass rounded-lg p-3 text-center">
              <p class="text-sm text-gray-400">Selisih:</p>
              <p id="discrepancyAmount" class="text-2xl font-bold"></p>
            </div>
            
            <div id="discrepancyNoteSection" class="hidden">
              <label class="block text-sm text-red-400 mb-1">âš ï¸ Catatan Selisih (Wajib) *</label>
              <textarea id="discrepancyNote" rows="2" 
                class="input-field w-full px-4 py-2 rounded-lg text-white"
                placeholder="Jelaskan penyebab selisih..."></textarea>
            </div>
          </div>
          
          <input type="hidden" id="expectedCashHidden" value="${expectedCash}">
          <input type="hidden" id="cashSalesHidden" value="${cashSales}">
          <input type="hidden" id="nonCashSalesHidden" value="${nonCashSales}">
          
          <div class="flex gap-2">
            <button onclick="closeAllModals()" class="flex-1 px-4 py-3 rounded-lg bg-surface hover:bg-surface/80">
              Batal
            </button>
            <button onclick="finalizeShiftClose()" class="flex-1 btn-primary py-3 rounded-lg font-bold">
              ğŸ”’ Tutup Shift
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Calculate discrepancy when actual cash is entered
    function calculateDiscrepancy(expectedCash) {
      const actualCash = parseFloat(document.getElementById('actualCashInput')?.value) || 0;
      const discrepancy = actualCash - expectedCash;

      const displayEl = document.getElementById('discrepancyDisplay');
      const amountEl = document.getElementById('discrepancyAmount');
      const noteSection = document.getElementById('discrepancyNoteSection');

      if (displayEl && amountEl) {
        displayEl.classList.remove('hidden');

        if (discrepancy === 0) {
          amountEl.textContent = 'âœ… Pas!';
          amountEl.className = 'text-2xl font-bold text-green-400';
          noteSection?.classList.add('hidden');
        } else if (discrepancy > 0) {
          amountEl.textContent = `+${formatCurrency(discrepancy)} (Lebih)`;
          amountEl.className = 'text-2xl font-bold text-yellow-400';
          noteSection?.classList.remove('hidden');
        } else {
          amountEl.textContent = `${formatCurrency(discrepancy)} (Kurang)`;
          amountEl.className = 'text-2xl font-bold text-red-400';
          noteSection?.classList.remove('hidden');
        }
      }
    }

    // Finalize shift close
    async function finalizeShiftClose() {
      const actualCash = parseFloat(document.getElementById('actualCashInput')?.value) || 0;
      const expectedCash = parseFloat(document.getElementById('expectedCashHidden')?.value) || 0;
      const cashSales = parseFloat(document.getElementById('cashSalesHidden')?.value) || 0;
      const nonCashSales = parseFloat(document.getElementById('nonCashSalesHidden')?.value) || 0;
      const discrepancy = actualCash - expectedCash;
      const note = document.getElementById('discrepancyNote')?.value?.trim() || '';

      // Validate note required if discrepancy
      if (discrepancy !== 0 && !note) {
        showToast('Catatan selisih wajib diisi!', 'warning');
        return;
      }

      // Find and update active shift
      const activeShift = shifts.find(s => s.id === currentSession?.shiftId);
      if (activeShift) {
        activeShift.closingTime = new Date().toISOString();
        activeShift.expectedCash = expectedCash;
        activeShift.actualCash = actualCash;
        activeShift.cashSales = cashSales;
        activeShift.nonCashSales = nonCashSales;
        activeShift.discrepancy = discrepancy;
        activeShift.discrepancyNote = note;
        activeShift.status = 'closed';
      }

      try {
        await saveToStorage();
        closeAllModals();
        clearSession();

        showToast('Shift berhasil ditutup!', 'success');

        // Show login for next cashier
        setTimeout(() => showPinLoginModal(), 500);
      } catch (err) {
        console.error('Error closing shift:', err);
        showToast('Gagal menutup shift: ' + err.message, 'error');
      }
    }

    // ===== CASH ddDRAWER =====

    // Open cash drawer with logging
    function openCashDrawer() {
      if (currentSession?.role !== 'admin') {
        requireMasterPin('open_drawer', (valid) => {
          if (valid) executeOpenDrawer();
        });
      } else {
        executeOpenDrawer();
      }
    }

    function executeOpenDrawer() {
      // Log the drawer open
      cashDrawerLogs.push({
        id: generateId(),
        shiftId: currentSession?.shiftId,
        cashierId: currentSession?.cashierId,
        cashierName: currentSession?.cashierName,
        action: 'open',
        timestamp: new Date().toISOString(),
        reason: 'Manual open'
      });

      saveToStorage();
      showToast('Laci kas dibuka ğŸ—ƒï¸', 'info');

      // Here you would send command to actual cash drawer hardware if connected
      // For now, just show visual feedback
    }

    // ===== ROLE-BASED ACCESS =====

    // Check if current user can access section
    function canAccessSection(section) {
      if (!currentSession) return false;
      if (currentSession.role === 'admin') return true;

      // Restricted sections for kasir
      const restrictedForKasir = ['dashboard', 'menu', 'inventory', 'finance', 'employees', 'reports', 'customers', 'settings'];

      return !restrictedForKasir.includes(section);
    }

    // Fallback to admin login
    function showAdminLoginFallback() {
      closeAllModals();
      showLoginModal();
    }

    // Initialize / re-attach event listeners that may be removed when we re-render via safeSet
    function initEventListeners() {
      // âš ï¸ DISABLED: fixPotentialBlockers was blocking login modal inputs
      // fixPotentialBlockers();

      // Global delegated click handler attached to body (single place to detect clicks)
      if (!document.body._globalClickAttached) {
        document.body.addEventListener('click', (e) => {
          const target = e.target;
          console.log('Tombol diklik:', target.id || target.className || (target.dataset && target.dataset.cat) || target);

          // Check for fullscreen overlays that may block clicks
          const overlays = Array.from(document.querySelectorAll('div')).filter(el => {
            try {
              const cs = getComputedStyle(el);
              if (!(cs.position === 'fixed' || cs.position === 'absolute')) return false;
              if (cs.pointerEvents === 'none' || cs.visibility === 'hidden' || cs.display === 'none') return false;
              const rect = el.getBoundingClientRect();
              if (rect.width >= window.innerWidth - 2 && rect.height >= window.innerHeight - 2) return true;
            } catch (err) {
              return false;
            }
            return false;
          });
          if (overlays.length) console.warn('Potential overlay(s) blocking click:', overlays);

          // Category button via delegation
          const catBtn = e.target.closest('.category-btn');
          if (catBtn) {
            e.preventDefault();
            const cat = catBtn.dataset.cat;
            filterCategory(cat);
            return;
          }

          // Admin button via delegation (supports #admin-btn and .admin-btn)
          const adminBtn = e.target.closest('#admin-btn, .admin-btn');
          if (adminBtn) {
            e.preventDefault();
            showLoginModal();
            return;
          }

          // Menu grid delegated handler (map inline onclick patterns to functions)
          // DISABLING THIS BLOCK because inline onclick handlers already fire natively.
          // This block causes double-execution (adding 2 items instead of 1).
          /*
          const btn = e.target.closest('button');
          if (btn) {
            const onclick = btn.getAttribute('onclick') || '';
            let m = onclick.match(/addToCart\('([^']+)'\)/);
            if (m) { addToCart(m[1]); return; }
            m = onclick.match(/editMenu\('([^']+)'\)/);
            if (m) { editMenu(m[1]); return; }
            m = onclick.match(/removeFromCart\('([^']+)'\)/);
            if (m) { removeFromCart(m[1]); return; }
            m = onclick.match(/deleteMenu\('([^']+)'\)/);
            if (m) { deleteMenu(m[1]); return; }
          }
          */
        });
        document.body._globalClickAttached = true;
      }

      // Keep the earlier per-container listeners as gentle fallbacks (no-op if already attached)
      const catContainer = document.getElementById('categoryContainer');
      if (catContainer && !catContainer._listenerAttached) {
        catContainer._listenerAttached = true; // handled by global delegation
      }

      // No explicit adminButton listener needed now (global handles it)

      // Keep menuGrid marker so we don't rebind heavy listeners
      const menuGrid = document.getElementById('menuGrid');
      if (menuGrid && !menuGrid._listenerAttached) {
        menuGrid._listenerAttached = true; // global handles clicks
      }
    }

    // Detect and fix potential transparent/fullscreen elements that incorrectly block clicks
    function fixPotentialBlockers() {
      try {
        const candidates = Array.from(document.querySelectorAll('div')).filter(el => {
          const cs = getComputedStyle(el);
          if (cs.display === 'none' || cs.visibility === 'hidden') return false;
          if (!(cs.position === 'fixed' || cs.position === 'absolute')) return false;
          const rect = el.getBoundingClientRect();
          if (rect.width < window.innerWidth * 0.9 || rect.height < window.innerHeight * 0.9) return false;
          // Transparent or very low opacity overlays
          const bg = cs.backgroundColor || '';
          const opacity = parseFloat(cs.opacity || '1');
          return (opacity < 0.15) || bg.includes('rgba(0, 0, 0, 0)') || bg === 'transparent';
        });

        candidates.forEach(el => {
          // If overlay is actually hidden via a class, ensure pointer-events disabled
          if (el.classList.contains('hidden')) {
            el.style.pointerEvents = 'none';
            console.log('fixPotentialBlockers: disabled pointer-events on hidden overlay', el);
          } else {
            // If visible and transparent, aggressively disable pointer events to restore clickability
            el.style.pointerEvents = 'none';
            console.warn('fixPotentialBlockers: disabled pointer-events on transparent overlay', el);
          }
        });
      } catch (err) {
        console.warn('fixPotentialBlockers error', err);
      }
    }

    function getCurrentDate() {
      return new Date().toISOString().split('T')[0];
    }

    function getCurrentTime() {
      return new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function getHourFromTime(timeString) {
      return parseInt(timeString.split(':')[0]);
    }

    // ===== CUSTOMER PAGE RENDERING =====
    function renderCustomerPage() {
      updateBusinessInfo();
      renderMenuGrid();
      updateCartFloating();
    }

    function updateBusinessInfo() {
      // Update all instances of business name and tagline
      const nameElements = ['businessNameDisplay'];
      const taglineElements = ['taglineDisplay'];

      nameElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = businessSettings.name;
      });

      taglineElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = businessSettings.tagline;
      });

      // Update logos
      updateLogoDisplay();
    }

    function updateLogoDisplay() {
      const logoContainers = ['customerHeaderLogo', 'adminSidebarLogo', 'logoPreviewContainer'];

      logoContainers.forEach(id => {
        const container = document.getElementById(id);
        if (!container) return;

        if (businessSettings.logo && businessSettings.logo !== 'default') {
          container.innerHTML = `<img src="${businessSettings.logo}" class="w-full h-full object-cover">`;
        } else {
          container.innerHTML = `
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
              <path d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z"/>
            </svg>
          `;
        }
      });
    }

    window.filterCategory = function (category) {
      console.log('filterCategory called:', category);
      currentFilter = category;

      // Update button states
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.cat === category) {
          btn.classList.add('active');
        }
      });

      renderMenuGrid();
    }

    function renderMenuGrid() {
      const grid = document.getElementById('menuGrid');
      const empty = document.getElementById('emptyMenu');

      if (!grid) { console.warn('renderMenuGrid: #menuGrid not found'); return; }
      if (!empty) { console.warn('renderMenuGrid: #emptyMenu not found'); }

      let filteredMenu = menuItems;
      if (currentFilter !== 'all') {
        filteredMenu = menuItems.filter(item => item.category === currentFilter);
      }

      if (filteredMenu.length === 0) {
        if (grid && grid.classList) grid.classList.add('hidden');
        if (empty && empty.classList) empty.classList.remove('hidden');
        return;
      }

      if (grid && grid.classList) grid.classList.remove('hidden');
      if (empty && empty.classList) empty.classList.add('hidden');

      if (grid) {
        safeSet(grid, filteredMenu.map(item => `
          <div class="menu-card rounded-xl overflow-hidden card-hover border border-purple-500/20">
            <div class="aspect-square bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center text-6xl overflow-hidden">
              ${item.image ?
            `<img src="${item.image}" class="w-full h-full object-cover hover:scale-110 transition-transform duration-500">` :
            getCategoryEmoji(item.category)
          }
            </div>
            <div class="p-3">
              <h3 class="font-bold text-sm mb-1">${item.name}</h3>
              <p class="text-xs text-gray-400 mb-2">${item.category}</p>
              <div class="flex items-center justify-between">
                <span class="text-purple-400 font-bold text-sm">${formatCurrency(item.price)}</span>
                <button onclick="addToCart('${item.id}')" class="w-8 h-8 rounded-lg bg-primary hover:bg-primary/80 flex items-center justify-center text-sm">
                  â•
                </button>
              </div>
            </div>
          </div>
        `).join(''));
        initEventListeners();
      }
    }

    function getCategoryEmoji(category) {
      const emojis = {
        kopi: 'â˜•',
        minuman: 'ğŸ¥¤',
        makanan: 'ğŸœ',
        snack: 'ğŸ¿'
      };
      return emojis[category] || 'ğŸ½ï¸';
    }

    // ===== CART MANAGEMENT =====
    function addToCart(itemId) {
      const item = menuItems.find(m => m.id === itemId);
      if (!item) return;

      const existingItem = cart.find(c => c.id === itemId);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ ...item, quantity: 1 });
      }

      updateCartFloating();
      showToast(`${item.name} ditambahkan ke keranjang`, 'success');
    }

    function updateCartFloating() {
      const floating = document.getElementById('cartFloating');
      const count = document.getElementById('cartCount');

      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      if (count) count.textContent = totalItems;

      if (floating && floating.classList) {
        if (totalItems > 0) {
          floating.classList.remove('hidden');
        } else {
          floating.classList.add('hidden');
        }
      }
    }

    function showOrderForm() {
      if (cart.length === 0) {
        showToast('Keranjang kosong!', 'warning');
        return;
      }

      const modal = document.getElementById('orderModal');
      if (!modal) {
        // If orderModal doesn't exist (customer page), show customer order modal instead
        showCustomerOrderModal?.() || showToast('Modal order tidak tersedia', 'warning');
        return;
      }

      modal.classList.remove('hidden');
      renderCartItems();
      populateTableSelect();
      calculateOrderSummary();
    }

    function closeOrderModal() {
      const modal = document.getElementById('orderModal');
      if (modal) modal.classList.add('hidden');
    }

    function renderCartItems() {
      const container = document.getElementById('cartItems');
      if (!container) { console.warn('renderCartItems: #cartItems not found'); return; }
      safeSet(container, cart.map(item => `
        <div class="bg-surface/50 rounded-xl p-4 flex items-center gap-4">
          <div class="text-3xl">${getCategoryEmoji(item.category)}</div>
          <div class="flex-1">
            <p class="font-bold text-sm">${item.name}</p>
            <p class="text-xs text-gray-400">${formatCurrency(item.price)}</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="updateCartQuantity('${item.id}', -1)" class="w-8 h-8 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500/40">âˆ’</button>
            <span class="w-8 text-center font-bold">${item.quantity}</span>
            <button onclick="updateCartQuantity('${item.id}', 1)" class="w-8 h-8 rounded-lg bg-green-500/20 text-green-400 flex items-center justify-center hover:bg-green-500/40">+</button>
          </div>
          <button onclick="removeFromCart('${item.id}')" class="w-8 h-8 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500/40">ğŸ—‘ï¸</button>
        </div>
      `).join(''));
      initEventListeners();
    }

    function updateCartQuantity(itemId, delta) {
      const item = cart.find(c => c.id === itemId);
      if (!item) return;

      item.quantity += delta;

      if (item.quantity <= 0) {
        removeFromCart(itemId);
        return;
      }

      renderCartItems();
      calculateOrderSummary();
      updateCartFloating();
    }

    function removeFromCart(itemId) {
      cart = cart.filter(c => c.id !== itemId);
      renderCartItems();
      calculateOrderSummary();
      updateCartFloating();

      if (cart.length === 0) {
        closeOrderModal();
      }
    }

    function populateTableSelect() {
      const select = document.getElementById('customerTable');
      if (!select) { console.warn('populateTableSelect: #customerTable not found'); return; }
      const availableTables = tables.filter(t => t.status === 'available');

      safeSet(select, '<option value="">Pilih Meja</option>' +
        availableTables.map(t => `<option value="${t.number}">Meja ${t.number}</option>`).join(''));
      initEventListeners();
    }

    function calculateOrderSummary() {
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      document.getElementById('orderTotal').textContent = formatCurrency(total);

      // Calculate gramasi summary if available
      calculateGramasiSummary();
    }

    function calculateGramasiSummary() {
      let totalHPP = 0;
      let hasGramasi = false;

      cart.forEach(cartItem => {
        const itemGramasi = gramasiData.filter(g => g.productName === cartItem.name);
        if (itemGramasi.length > 0) {
          hasGramasi = true;
          const itemTotalHPP = itemGramasi.reduce((sum, g) => sum + (g.hpp || 0), 0);
          totalHPP += itemTotalHPP * cartItem.quantity;
        }
      });

      const summaryDiv = document.getElementById('gramasiSummary');
      if (!summaryDiv) return;

      if (hasGramasi) {
        summaryDiv.classList.remove('hidden');
        const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const profit = totalPrice - totalHPP;
        const margin = totalPrice > 0 ? ((profit / totalPrice) * 100).toFixed(1) : 0;

        document.getElementById('orderHPP').textContent = formatCurrency(totalHPP);
        document.getElementById('orderProfit').textContent = formatCurrency(profit);
        document.getElementById('orderMargin').textContent = margin + '%';
      } else {
        summaryDiv.classList.add('hidden');
      }
    }

    // ===== PAYMENT CONDITIONAL LOGIC =====
    let currentPaymentProof = null; // Base64 image
    let currentPaymentProofFile = null; // File object for upload

    function onPaymentMethodChange() {
      const method = document.getElementById('paymentMethod')?.value;
      const infoSection = document.getElementById('paymentInfoSection');
      const cashInfo = document.getElementById('cashInfo');
      const bankInfo = document.getElementById('bankInfo');
      const ewalletInfo = document.getElementById('ewalletInfo');
      const qrisInfo = document.getElementById('qrisInfo');
      const proofSection = document.getElementById('paymentProofSection');

      // Hide all first
      [cashInfo, bankInfo, ewalletInfo, qrisInfo, proofSection].forEach(el => el?.classList.add('hidden'));

      if (!method) {
        infoSection?.classList.add('hidden');
        return;
      }

      infoSection?.classList.remove('hidden');

      if (method === 'cash') {
        cashInfo?.classList.remove('hidden');
      } else if (method === 'bank') {
        bankInfo?.classList.remove('hidden');
        const bankDetail = `${businessSettings.bankName || 'Belum diatur'}\n${businessSettings.bankAccount || '-'}`;
        document.getElementById('bankDetailDisplay').textContent = bankDetail;
        proofSection?.classList.remove('hidden');
      } else if (method === 'ewallet') {
        ewalletInfo?.classList.remove('hidden');
        const ewalletDetail = `${businessSettings.ewalletType || 'e-Wallet'}: ${businessSettings.ewalletNumber || 'Belum diatur'}`;
        document.getElementById('ewalletDetailDisplay').textContent = ewalletDetail;
        proofSection?.classList.remove('hidden');
      } else if (method === 'qris') {
        qrisInfo?.classList.remove('hidden');
        const qrisImg = document.getElementById('qrisImageDisplay');
        if (qrisImg) {
          qrisImg.src = businessSettings.qrisImage || '';
          qrisImg.style.display = businessSettings.qrisImage ? 'block' : 'none';
        }
        proofSection?.classList.remove('hidden');
      }
    }

    function previewPaymentProof(event) {
      const file = event.target.files[0];
      if (!file) return;
      currentPaymentProofFile = file;

      const reader = new FileReader();
      reader.onload = function (e) {
        currentPaymentProof = e.target.result;
        const preview = document.getElementById('paymentProofPreview');
        const label = document.getElementById('paymentProofLabel');
        if (preview) {
          preview.src = currentPaymentProof;
          preview.classList.remove('hidden');
        }
        if (label) {
          label.textContent = 'âœ… Bukti pembayaran sudah dipilih';
          label.classList.add('text-green-400');
          label.classList.remove('text-gray-400');
        }
      };
      reader.readAsDataURL(file);
    }

    async function submitOrder() {
      const customerName = document.getElementById('customerName').value;
      const customerPhone = document.getElementById('customerPhone').value;
      const tableNumber = document.getElementById('customerTable').value;
      const area = document.getElementById('customerRoom').value;
      const paymentMethod = document.getElementById('paymentMethod').value;
      const notes = document.getElementById('orderNotes')?.value || '';

      if (!customerName.trim()) {
        showToast('Nama pelanggan harus diisi!', 'warning');
        return;
      }

      if (!customerPhone.trim()) {
        showToast('Nomor WhatsApp harus diisi!', 'warning');
        return;
      }

      if (!tableNumber) {
        showToast('Pilih nomor meja!', 'warning');
        return;
      }

      if (!paymentMethod) {
        showToast('Pilih metode pembayaran!', 'warning');
        return;
      }

      // Validate payment proof for non-cash methods
      if (paymentMethod !== 'cash' && !currentPaymentProof) {
        showToast('Upload bukti pembayaran terlebih dahulu!', 'warning');
        return;
      }

      // === LOADING STATE: Disable button ===
      const submitBtn = document.querySelector('#orderModal button[onclick="submitOrder()"]');
      const restoreBtn = setButtonLoading(submitBtn, 'â³ Mengirim...');

      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      // Calculate HPP and profit if gramasi data exists
      let totalHPP = 0;
      let hasGramasi = false;
      cart.forEach(cartItem => {
        const itemGramasi = gramasiData.filter(g => g.productName === cartItem.name);
        if (itemGramasi.length > 0) {
          hasGramasi = true;
          const itemTotalHPP = itemGramasi.reduce((sum, g) => sum + (g.hpp || 0), 0);
          totalHPP += itemTotalHPP * cartItem.quantity;
        }
      });

      // Upload payment proof if exists
      let uploadedProofUrl = '';
      if (currentPaymentProofFile && paymentMethod !== 'cash') {
        try {
          const formData = new FormData();
          formData.append('paymentProof', currentPaymentProofFile);

          showToast('Mengupload bukti pembayaran...', 'info');
          const uploadRes = await fetch(`${API_BASE}/api/upload/payment-proof`, {
            method: 'POST',
            body: formData
          });

          if (uploadRes.ok) {
            const uploadData = await uploadRes.json();
            uploadedProofUrl = uploadData.url;
            console.log('Payment proof uploaded:', uploadedProofUrl);
          } else {
            console.warn('Failed to upload payment proof, falling back to Base64');
          }
        } catch (e) {
          console.error('Upload error:', e);
        }
      }

      const order = {
        id: generateId(),
        customerName,
        phone: '+62' + customerPhone,
        tableNumber,
        area,
        orderType: 'dine-in',
        items: [...cart],
        total,
        totalHPP: hasGramasi ? totalHPP : null,
        profit: hasGramasi ? (total - totalHPP) : null,
        margin: hasGramasi && total > 0 ? ((total - totalHPP) / total * 100) : null,
        notes,
        paymentMethod,
        paymentProof: paymentMethod !== 'cash' ? currentPaymentProof : null,
        paymentProofImage: uploadedProofUrl || null, // Store server URL
        status: 'new',
        date: getCurrentDate(),
        time: getCurrentTime(),
        timestamp: Date.now()
      };

      // Send to server (Single Order API - Public)
      if (USE_REMOTE_DB) {
        try {
          const res = await fetch(`${API_BASE}/api/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(order)
          });
          if (res.ok) {
            console.log('Order synced to server');
          } else {
            console.warn('Failed to sync order to server:', res.status);
            // Fallback: saveToStorage will try later, or data stays local
          }
        } catch (e) {
          console.error('Sync error:', e);
        }
      }

      orders.push(order);

      // Update table status
      if (order.orderType === 'dine-in' && tableNumber) {
        const table = tables.find(t => t.number === tableNumber);
        if (table) {
          table.status = 'occupied';
          table.orderId = order.id;
        }
      }

      // Add to cash transactions
      cashTransactions.push({
        id: generateId(),
        type: 'in',
        amount: total,
        description: `Pesanan ${customerName} - ${order.id}`,
        date: getCurrentDate(),
        time: getCurrentTime(),
        category: 'sales'
      });

      try {
        await saveToStorage();
        showToast('Pesanan berhasil dibuat! Terima kasih ğŸ‰', 'success');
      } catch (err) {
        console.error('Error saving order:', err);
        showToast('Pesanan dibuat tapi gagal disimpan ke server: ' + (err && err.message ? err.message : err), 'warning');
      }

      cart = [];
      posManualDraft = {}; // Also clear POS draft just in case
      closeOrderModal();
      updateCartFloating();

      // Clear form
      document.getElementById('customerName').value = '';
      document.getElementById('customerTable').value = '';
      try { document.getElementById('customerGender').value = 'male'; } catch (e) { }
      try { document.getElementById('orderType').value = 'dine-in'; } catch (e) { }
      try { document.getElementById('customerNotes').value = ''; } catch (e) { }
      document.getElementById('customerPhone').value = '';
      document.getElementById('paymentMethod').value = '';
      currentPaymentProof = null;

      updateAllStats();

      // Show digital receipt - with delay to ensure order modal is closed first
      setTimeout(() => {
        console.log('Triggering showDigitalReceipt for order:', order.id);
        showDigitalReceipt(order);
      }, 300);
    }

    // ===== MENU MANAGEMENT =====
    function renderMenuManagement() {
      renderCategoryList();
      renderAdminMenuList();
    }

    function renderCategoryList() {
      const container = document.getElementById('categoryList');
      if (!container) { console.warn('renderCategoryList: #categoryList not found'); return; }
      container.innerHTML = categories.map(cat => `
        <span class="px-4 py-2 rounded-lg bg-surface border border-purple-500/20 text-sm capitalize flex items-center gap-2">
          ${getCategoryEmoji(cat)} ${cat}
          <button onclick="deleteCategory('${cat}')" class="text-red-400 hover:text-red-300 ml-2">âœ•</button>
        </span>
      `).join('');
    }

    function showAddCategoryModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">ğŸ“ Tambah Kategori Baru</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Kategori</label>
              <input type="text" id="newCategoryName" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Contoh: minuman, makanan, snack">
            </div>
            <div class="glass rounded-lg p-3 max-h-32 overflow-auto">
              <p class="text-xs text-gray-400 mb-2">Kategori yang ada:</p>
              <div class="flex flex-wrap gap-1">
                ${categories.map(c => `<span class="px-2 py-1 rounded bg-purple-500/20 text-xs">${c}</span>`).join('')}
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveNewCategory()" class="flex-1 btn-primary px-4 py-2 rounded-lg">Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('newCategoryName')?.focus();
    }

    async function saveNewCategory() {
      const input = document.getElementById('newCategoryName');
      const categoryName = input?.value?.trim();

      if (!categoryName) {
        showToast('Nama kategori harus diisi!', 'warning');
        return;
      }

      const newCat = categoryName.toLowerCase();
      if (categories.includes(newCat)) {
        showToast('Kategori sudah ada!', 'warning');
        return;
      }

      // === LOADING STATE ===
      const btn = document.querySelector('.fixed button[onclick="saveNewCategory()"]');
      const restoreBtn = setButtonLoading(btn);

      categories.push(newCat);
      try {
        await saveToStorage();
        document.querySelector('.fixed')?.remove();
        renderCategoryList();
        showToast('Kategori berhasil ditambahkan!', 'success');
      } catch (err) {
        restoreBtn(); // Re-enable on error
        console.error('Error saving category:', err);
        showToast('Kategori ditambahkan lokal, tapi gagal disimpan ke server: ' + (err?.message || err), 'warning');
        document.querySelector('.fixed')?.remove();
        renderCategoryList();
      }
    }

    function showDeleteCategoryModal(category) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade border border-red-500/20">
          <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4">
              <span class="text-3xl">ğŸ—‘ï¸</span>
            </div>
            <h3 class="text-xl font-bold mb-2">Hapus Kategori?</h3>
            <p class="text-gray-400 text-sm">
              Apakah Anda yakin ingin menghapus kategori <span class="text-white font-bold">"${category}"</span>? 
              <br><br>
              Semua menu dalam kategori ini akan kehilangan kategorinya (menjadi "Uncategorized").
            </p>
          </div>
          <div class="flex gap-3">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80 text-gray-300">Batal</button>
            <button onclick="confirmDeleteCategory('${category}')" class="flex-1 px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold shadow-lg shadow-red-500/20">Ya, Hapus</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteCategory(category) {
      document.querySelector('.fixed')?.remove(); // Close modal

      try {
        // 1. Remove from local array
        categories = categories.filter(c => c !== category);

        // 2. Update menu items (remove category)
        menuItems.forEach(item => {
          if (item.category === category) {
            item.category = ''; // Or 'Uncategorized' if preferred, but existing code might handle empty string
          }
        });

        // 3. Save to storage (monolithic)
        await saveToStorage();

        // 4. API Call if remote (Granular check)
        if (USE_REMOTE_DB) {
          await apiDeleteCategory(category);
        }

        renderCategoryList();
        showToast('Kategori berhasil dihapus dan menu telah diperbarui', 'success');
      } catch (err) {
        console.error('Error deleting category:', err);
        showToast('Gagal menghapus kategori: ' + err.message, 'error');
        // Revert local changes if critical failure? 
        // For now, assume saveToStorage failure is non-fatal for local state till refresh
        renderCategoryList();
      }
    }

    async function apiDeleteCategory(name) {
      const headers = getAuthHeaders();
      const res = await fetch(`${API_BASE}/categories/${encodeURIComponent(name)}`, {
        method: 'DELETE',
        headers
      });
      if (!res.ok) throw new Error('API Error: ' + res.status);
    }

    function deleteCategory(category) {
      showDeleteCategoryModal(category);
    }


    function renderAdminMenuList() {
      const container = document.getElementById('adminMenuList');
      if (!container) { console.warn('renderAdminMenuList: #adminMenuList not found'); return; }

      if (menuItems.length === 0) {
        safeSet(container, '<div class="p-8 text-center text-gray-400">Belum ada menu. Tambahkan menu baru!</div>');
        initEventListeners();
        return;
      }

      safeSet(container, menuItems.map(item => {
        const gramasi = gramasiData.filter(g => g.productName === item.name);
        const hasGramasi = gramasi.length > 0;
        const totalHPP = hasGramasi ? gramasi.reduce((sum, g) => sum + (g.hpp || 0), 0) : 0;
        const profit = hasGramasi ? item.price - totalHPP : 0;
        const margin = hasGramasi && item.price > 0 ? ((profit / item.price) * 100).toFixed(1) : 0;

        return `
        <div class="p-4 flex items-center gap-4 hover:bg-surface/30">
          <div class="w-16 h-16 rounded-lg bg-surface flex items-center justify-center overflow-hidden shrink-0">
             ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<span class="text-4xl">${getCategoryEmoji(item.category)}</span>`}
          </div>
          <div class="flex-1">
            <h4 class="font-bold">${item.name}</h4>
            <p class="text-xs text-gray-400 capitalize">${item.category}</p>
            <p class="text-sm text-purple-400 font-bold mt-1">${formatCurrency(item.price)}</p>
            <!-- INDIKATOR STOK (PENGGANTI HPP) -->
            ${!item.use_stock_check ?
            '<div class="mt-1"><span class="px-2 py-0.5 rounded bg-gray-600 text-[10px] text-gray-200">â™¾ï¸ Stok Unlimited (Bypass)</span></div>'
            :
            (item.available_qty > 0 ?
              `<div class="text-xs text-green-400 mt-1 font-bold">
                        <i class="fas fa-check-circle"></i> Estimasi: Bisa buat <b>${item.available_qty}</b> Porsi
                     </div>`
              :
              `<div class="text-xs text-red-400 mt-1 font-bold">
                        <i class="fas fa-exclamation-triangle"></i> Bahan tidak mencukupi
                     </div>`
            )
          }
          </div>
          <div class="flex gap-2 items-center">
            <!-- Power Button -->
            <button onclick="toggleActive('${item.id}', ${item.is_active !== false})" 
                    class="w-10 h-10 rounded-lg flex items-center justify-center transition-colors ${item.is_active !== false ? 'bg-blue-500/20 text-blue-400 hover:bg-blue-500/30' : 'bg-red-500/20 text-red-400 hover:bg-red-500/30'}"
                    title="${item.is_active !== false ? 'Matikan Menu (Stop Jual)' : 'Aktifkan Menu (Jual)'}">
              <span class="text-lg">âš¡</span>
            </button>
            <!-- Stock Toggle Button -->
            <button onclick="toggleStockCheck('${item.id}', ${item.use_stock_check !== false})" 
                    class="w-10 h-10 rounded-lg flex items-center justify-center transition-colors ${item.use_stock_check !== false ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30' : 'bg-gray-700 text-gray-400 hover:bg-gray-600'}"
                    title="${item.use_stock_check !== false ? 'Matikan Cek Stok (Unlimited)' : 'Aktifkan Cek Stok'}">
              ${item.use_stock_check !== false ? 'ğŸ“¦' : 'â™¾ï¸'}
            </button>
            <button onclick="editMenu('${item.id}')" class="px-3 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 text-sm">
              âœï¸ Edit
            </button>
            <button onclick="deleteMenu('${item.id}')" class="px-3 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 text-sm">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      `}).join(''));
      initEventListeners();
    }

    function searchMenu() {
      const queryEl = document.getElementById('menuSearch');
      const query = (queryEl && queryEl.value) ? queryEl.value.toLowerCase() : '';
      const container = document.getElementById('adminMenuList');
      if (!container) { console.warn('searchMenu: #adminMenuList not found'); return; }

      const filtered = menuItems.filter(item =>
        item.name.toLowerCase().includes(query) ||
        item.category.toLowerCase().includes(query)
      );

      if (filtered.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">Tidak ada menu yang ditemukan</div>';
        return;
      }

      container.innerHTML = filtered.map(item => `
        <div class="p-4 flex items-center gap-4 hover:bg-surface/30">
          <div class="w-16 h-16 rounded-lg bg-surface flex items-center justify-center overflow-hidden shrink-0">
             ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<span class="text-4xl">${getCategoryEmoji(item.category)}</span>`}
          </div>
          <div class="flex-1">
            <h4 class="font-bold">${item.name}</h4>
            <p class="text-xs text-gray-400 capitalize">${item.category}</p>
            <p class="text-sm text-purple-400 font-bold mt-1">${formatCurrency(item.price)}</p>
            <div class="mt-1">
               ${!item.use_stock_check
          ? '<small class="text-muted" style="font-style: italic;">Mode: Bypass Stok</small>'
          : (item.available_qty > 0
            ? `<small class="text-success" style="font-weight: 500;"><i class="fas fa-box"></i> Estimasi: Bisa buat <b>${item.available_qty}</b> Porsi</small>`
            : `<small class="text-danger" style="font-weight: bold;"><i class="fas fa-exclamation-triangle"></i> Bahan tidak mencukupi</small>`
          )
        }
            </div>
          </div>
          <div class="flex gap-2 items-center">
            <!-- Power Button -->
            <button onclick="toggleActive('${item.id}', ${item.is_active !== false})" 
                    class="w-10 h-10 rounded-lg flex items-center justify-center transition-colors ${item.is_active !== false ? 'bg-blue-500/20 text-blue-400 hover:bg-blue-500/30' : 'bg-red-500/20 text-red-400 hover:bg-red-500/30'}"
                    title="${item.is_active !== false ? 'Matikan Menu (Stop Jual)' : 'Aktifkan Menu (Jual)'}">
              <span class="text-lg">âš¡</span>
            </button>
            <!-- Stock Toggle Button (Search) -->
            <button onclick="toggleStockCheck('${item.id}', ${item.use_stock_check !== false})" 
                    class="w-10 h-10 rounded-lg flex items-center justify-center transition-colors ${item.use_stock_check !== false ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30' : 'bg-gray-700 text-gray-400 hover:bg-gray-600'}"
                    title="${item.use_stock_check !== false ? 'Matikan Cek Stok (Unlimited)' : 'Aktifkan Cek Stok'}">
              ${item.use_stock_check !== false ? 'ğŸ“¦' : 'â™¾ï¸'}
            </button>
            <button onclick="editMenu('${item.id}')" class="px-3 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 text-sm">
              âœï¸ Edit
            </button>
            <button onclick="deleteMenu('${item.id}')" class="px-3 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 text-sm">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      `).join('');
    }

    function showAddMenuModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">â• Tambah Menu Baru</h3>
          <div class="space-y-4">
            <!-- Image Upload -->
            <div>
              <label class="block text-sm text-gray-400 mb-2">Foto Menu</label>
              <div class="relative w-full h-40 border-2 border-dashed border-purple-500/30 rounded-xl hover:border-purple-500/60 transition-colors bg-surface/30 flex flex-col items-center justify-center group cursor-pointer overflow-hidden" onclick="document.getElementById('newMenuImage').click()">
                <div id="imagePreviewContainer" class="absolute inset-0 hidden">
                   <img id="imagePreview" class="w-full h-full object-cover">
                   <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                     <span class="text-white text-sm">Ganti Foto</span>
                   </div>
                </div>
                <div id="uploadPlaceholder" class="flex flex-col items-center text-gray-400 group-hover:text-purple-300 transition-colors">
                  <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-xs">Klik untuk upload foto</span>
                </div>
                <input type="file" id="newMenuImage" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
              </div>
            </div>

            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Menu</label>
              <input type="text" id="newMenuName" class="input-field w-full px-4 py-2 rounded-lg text-white">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Kategori</label>
              <select id="newMenuCategory" class="input-field w-full px-4 py-2 rounded-lg text-white">
                ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Harga</label>
              <input type="number" id="newMenuPrice" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="0">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">
              Batal
            </button>
            <button onclick="saveNewMenu()" class="flex-1 btn-primary px-4 py-2 rounded-lg">
              Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function handleImagePreview(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('imagePreview');
          const container = document.getElementById('imagePreviewContainer');
          const placeholder = document.getElementById('uploadPlaceholder');

          if (preview && container && placeholder) {
            preview.src = e.target.result;
            container.classList.remove('hidden');
            placeholder.classList.add('hidden');
          }
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function saveNewMenu() {
      const name = document.getElementById('newMenuName').value;
      const category = document.getElementById('newMenuCategory').value;
      const price = parseInt(document.getElementById('newMenuPrice').value) || 0;
      const imageInput = document.getElementById('newMenuImage');

      if (!name.trim()) {
        showToast('Nama menu harus diisi!', 'warning');
        return;
      }

      if (price <= 0) {
        showToast('Harga harus lebih dari 0!', 'warning');
        return;
      }

      let imageData = '';
      if (imageInput.files && imageInput.files[0]) {
        // Wait for file reading if not already done (though preview handles it, we need the data here)
        // Since we didn't store it in a global, let's read it again or grab from preview src
        const preview = document.getElementById('imagePreview');
        if (preview && preview.src && preview.src.startsWith('data:image')) {
          imageData = preview.src;
        } else {
          // Fallback/Safety: read carefully if needed, but the preview logic usually sets src synchronously-ish after onload
          // For simplicity, we can wrap this in a promise if we want to be 100% sure, but the user likely saw the preview.
        }
      }

      const newMenu = {
        id: generateId(),
        name: name.trim(),
        category,
        price,
        image: imageData || null
      };

      // === LOADING STATE ===
      // Robust selector for the specific modal button
      const btn = document.querySelector('.fixed.z-50 button[onclick="saveNewMenu()"]') || document.querySelector('.fixed button[onclick="saveNewMenu()"]');
      const restoreBtn = setButtonLoading(btn);

      try {
        menuItems.push(newMenu);
        // Call API to save to MongoDB
        if (USE_REMOTE_DB) {
          await apiCreateMenu(newMenu);
        }
        await saveToStorage();

        // REFRESH UI
        renderMenuManagement();
        renderAdminMenuList(); // Explicit call to refresh table
        renderCustomerPage();

        // ğŸ›‘ KILL SWITCH: Close Modal
        // Find the modal wrapper (parent of the button's container's container, or just by class)
        const modal = document.querySelector('.fixed.inset-0.z-50');
        if (modal) {
          modal.remove();
        } else {
          // Fallback
          document.querySelector('.fixed')?.remove();
        }

        showToast('Menu berhasil ditambahkan!', 'success');
      } catch (err) {
        restoreBtn(); // Re-enable on error
        // Rollback
        const idx = menuItems.findIndex(m => m.id === newMenu.id);
        if (idx > -1) menuItems.splice(idx, 1);
        console.error('Error saving new menu:', err);
        showToast('Gagal menyimpan menu: ' + (err && err.message ? err.message : err), 'error');
      }
    }

    function editMenu(id) {
      const item = menuItems.find(m => m.id === id);
      if (!item) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">âœï¸ Edit Menu</h3>
          <div class="space-y-4">
             <!-- Image Upload (Edit) -->
            <div>
              <label class="block text-sm text-gray-400 mb-2">Foto Menu</label>
              <div class="relative w-full h-40 border-2 border-dashed border-purple-500/30 rounded-xl hover:border-purple-500/60 transition-colors bg-surface/30 flex flex-col items-center justify-center group cursor-pointer overflow-hidden" onclick="document.getElementById('editMenuImage').click()">
                <div id="editImagePreviewContainer" class="absolute inset-0 ${item.image ? '' : 'hidden'}">
                   <img id="editImagePreview" class="w-full h-full object-cover" src="${item.image || ''}">
                   <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                     <span class="text-white text-sm">Ganti Foto</span>
                   </div>
                </div>
                <div id="editUploadPlaceholder" class="flex flex-col items-center text-gray-400 group-hover:text-purple-300 transition-colors ${item.image ? 'hidden' : ''}">
                  <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-xs">Klik untuk upload foto</span>
                </div>
                <input type="file" id="editMenuImage" accept="image/*" class="hidden" onchange="handleEditImagePreview(this)">
              </div>
            </div>

            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Menu</label>
              <input type="text" id="editMenuName" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${item.name}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Kategori</label>
              <select id="editMenuCategory" class="input-field w-full px-4 py-2 rounded-lg text-white">
                ${categories.map(cat => `<option value="${cat}" ${cat === item.category ? 'selected' : ''}>${cat}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Harga</label>
              <input type="number" id="editMenuPrice" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${item.price}">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">
              Batal
            </button>
            <button onclick="updateMenu('${id}')" class="flex-1 btn-primary px-4 py-2 rounded-lg">
              Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function handleEditImagePreview(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('editImagePreview');
          const container = document.getElementById('editImagePreviewContainer');
          const placeholder = document.getElementById('editUploadPlaceholder');

          if (preview && container && placeholder) {
            preview.src = e.target.result;
            container.classList.remove('hidden');
            placeholder.classList.add('hidden');
          }
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function updateMenu(id) {
      const name = document.getElementById('editMenuName').value;
      const category = document.getElementById('editMenuCategory').value;
      const price = parseInt(document.getElementById('editMenuPrice').value) || 0;
      const imageInput = document.getElementById('editMenuImage');

      if (!name.trim() || price <= 0) {
        showToast('Data tidak valid!', 'warning');
        return;
      }

      const item = menuItems.find(m => m.id === id);
      if (!item) {
        showToast('Menu tidak ditemukan!', 'error');
        return;
      }

      // âœ… CLOSE MODAL FIRST for better UX
      closeAllModals();
      showToast('Menyimpan perubahan...', 'info');

      const oldName = item.name;
      item.name = name.trim();
      item.category = category;
      item.price = price;

      // Check for new image
      if (imageInput?.files?.[0]) {
        const preview = document.getElementById('editImagePreview');
        if (preview?.src?.startsWith('data:image')) {
          item.image = preview.src;
        }
      }

      // Update gramasi data if menu name changed
      if (oldName !== item.name) {
        gramasiData.forEach(g => {
          if (g.productName === oldName) g.productName = item.name;
        });
      }

      try {
        await saveToStorage();
        renderMenuManagement();
        renderCustomerPage();
        showToast('Menu berhasil diupdate!', 'success');
      } catch (err) {
        console.error('Error updating menu:', err);
        showToast('Gagal menyimpan perubahan: ' + err.message, 'error');
      } finally {
        ensureSidebarVisible();
      }
    }

    async function deleteMenu(id) {
      const item = menuItems.find(m => m.id === id);
      if (!item) { showToast('Menu tidak ditemukan', 'error'); return; }

      showConfirmModal({
        title: 'Hapus Menu?',
        message: `Apakah Anda yakin ingin menghapus menu <b>${item.name}</b>? Data yang sudah dihapus tidak dapat dikembalikan.`,
        confirmText: 'Hapus',
        type: 'danger',
        onConfirm: async () => {
          try {
            // Delete from local array first
            menuItems = menuItems.filter(m => m.id !== id);

            // Delete related gramasi data
            gramasiData = gramasiData.filter(g => g.productName !== item.name);

            // Call API
            if (USE_REMOTE_DB) {
              await apiDeleteMenu(id);
            }

            await saveToStorage();
            renderMenuManagement();
            renderCustomerPage();
            showToast('Menu berhasil dihapus!', 'success');
          } catch (err) {
            console.error('Error deleting menu:', err);
            showToast('Gagal menghapus menu: ' + (err && err.message ? err.message : err), 'error');
          }
        }
      });
    }

    async function toggleStockCheck(id, currentStatus) {
      const newStatus = !currentStatus; // Toggle

      // Update local state first for instant feedback (optimistic UI)
      const item = menuItems.find(m => m.id === id);
      if (item) {
        item.use_stock_check = newStatus;
        renderAdminMenuList(); // Re-render to show new icon

        try {
          // Save to server
          if (USE_REMOTE_DB) {
            const headers = getAuthHeaders();
            await fetch(`${API_BASE}/api/menu/${id}`, {
              method: 'PUT',
              headers,
              body: JSON.stringify({ use_stock_check: newStatus })
            });
          }
          await saveToStorage(); // Save local
          showToast("Status menu berhasil diperbarui", 'success');
        } catch (err) {
          console.error('Failed to toggle stock:', err);
          showToast('Gagal mengubah status stok', 'error');
          // Revert on error
          item.use_stock_check = currentStatus;
          renderAdminMenuList();
        }
      }
    }

    // Helper for Custom Confirm Modal
    function showConfirmModal({ title, message, confirmText = 'Ya', cancelText = 'Batal', onConfirm, type = 'danger' }) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[60] animate-fade';

      const isDanger = type === 'danger';
      const icon = isDanger ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      const iconBg = isDanger ? 'bg-red-500/20 text-red-400' : type === 'success' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400';
      const btnClass = isDanger
        ? 'bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 shadow-red-900/50'
        : type === 'success'
          ? 'bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 shadow-green-900/50'
          : 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 shadow-blue-900/50';

      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full shadow-2xl border border-white/10 transform scale-100 transition-all">
          <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full ${iconBg} flex items-center justify-center mx-auto mb-4 text-3xl animate-bounce-short">
              ${icon}
            </div>
            <h3 class="text-xl font-bold mb-2 text-white">${title}</h3>
            <p class="text-gray-400 text-sm leading-relaxed">${message}</p>
          </div>
          <div class="flex gap-3">
            <button id="modalCancelBtn" class="flex-1 px-4 py-3 rounded-xl bg-surface hover:bg-surface/80 text-gray-400 font-medium transition-colors">
              ${cancelText}
            </button>
            <button id="modalConfirmBtn" class="flex-1 px-4 py-3 rounded-xl ${btnClass} text-white font-bold shadow-lg transition-all hover:scale-[1.02] active:scale-95">
              ${confirmText}
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      const close = () => {
        const dialog = modal.querySelector('.glass') || modal.firstElementChild;
        if (dialog) dialog.classList.add('scale-95', 'opacity-0');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.remove(), 200);
      };

      modal.querySelector('#modalCancelBtn').onclick = (e) => {
        e.stopPropagation();
        close();
      };

      modal.querySelector('#modalConfirmBtn').onclick = (e) => {
        e.stopPropagation();
        if (onConfirm) onConfirm();
        close();
      };

      modal.onclick = (e) => {
        if (e.target === modal) close();
      };
    }

    async function toggleActive(id, currentStatus) {
      const item = menuItems.find(m => m.id === id);
      if (!item) return;

      const isTurningOff = currentStatus; // If true, we are turning it off

      showConfirmModal({
        title: isTurningOff ? 'Nonaktifkan Menu?' : 'Aktifkan Menu?',
        message: isTurningOff
          ? `Apakah Anda yakin ingin menyembunyikan menu <b>${item.name}</b> dari pelanggan?`
          : `Apakah Anda yakin ingin menampilkan kembali menu <b>${item.name}</b> untuk dijual?`,
        confirmText: isTurningOff ? 'Nonaktifkan' : 'Aktifkan',
        type: isTurningOff ? 'danger' : 'success',
        onConfirm: async () => {
          const newStatus = !currentStatus;

          // Optimistic Update
          item.is_active = newStatus;
          renderAdminMenuList();
          if (typeof searchMenu === 'function' && document.getElementById('menuSearch')?.value) searchMenu();

          try {
            // Save to server
            if (USE_REMOTE_DB) {
              const headers = getAuthHeaders();
              await fetch(`${API_BASE}/api/menu/${id}`, {
                method: 'PUT',
                headers,
                body: JSON.stringify({ is_active: newStatus })
              });
            }
            await saveToStorage(); // Save local
            showToast("Status menu berhasil diperbarui", 'success');
          } catch (err) {
            console.error('Failed to toggle active:', err);
            showToast('Gagal mengubah status menu', 'error');
            // Revert on error
            item.is_active = currentStatus;
            renderAdminMenuList();
          }
        }
      });
    }

    // ===== POS SECTION =====

    // Modal controls for manual order input
    function showManualOrderModal() {
      const modal = document.getElementById('manualOrderModal');
      if (modal) {
        // RESET DRAFT START - Clear any leftover items
        posManualDraft = {};

        // INJECTION: Add Phone Input if missing (Critical for CRM Sync)
        const custNameInput = document.getElementById('posCustomerName');
        if (custNameInput && !document.getElementById('posCustomerPhone')) {
          const wrapper = document.createElement('div');
          wrapper.className = 'mb-3';
          wrapper.innerHTML = `
            <label class="block text-sm text-gray-400 mb-1">No. HP (CRM & Poin)</label>
            <input type="tel" id="posCustomerPhone" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="08xxxxxxxxxx">
          `;
          // Insert after the name input container
          custNameInput.parentNode.parentNode.insertBefore(wrapper, custNameInput.parentNode.nextSibling);
        }

        modal.classList.remove('hidden');
        renderPOSMenuSelect();
        populatePOSTableSelect();
        updatePOSTotal();

        // Clear previous inputs
        document.getElementById('posCustomerName').value = '';
        if (document.getElementById('posCustomerPhone')) {
          document.getElementById('posCustomerPhone').value = '';
        }
        document.getElementById('posPaymentMethod').value = 'cash';
        document.getElementById('posNote').value = '';

        // Reset legacy checkboxes if any
        document.querySelectorAll('.pos-menu-check').forEach(cb => cb.checked = false);
      }
    }

    function closeManualOrderModal() {
      const modal = document.getElementById('manualOrderModal');
      if (modal) modal.classList.add('hidden');

      // Reset draft
      posManualDraft = {};
      renderPOSMenuSelect();
      updatePOSTotal();
    }

    function renderPOS() {
      updatePOSStats();
      renderPOSMenuSelect();
      renderPOSOrdersGrid();
      populatePOSTableSelect();
      refreshCashDrawerBalance(); // âœ… Auto-refresh cash drawer widget
    }

    // ===== DIGITAL CASH DRAWER WIDGET =====
    let cashDrawerVisible = false;

    function toggleCashDrawerWidget() {
      const widget = document.getElementById('cashDrawerWidget');
      const toggle = document.getElementById('cashDrawerToggle');

      if (!widget || !toggle) return;

      cashDrawerVisible = !cashDrawerVisible;

      if (cashDrawerVisible) {
        widget.classList.remove('hidden');
        toggle.classList.add('hidden');
        refreshCashDrawerBalance();
      } else {
        widget.classList.add('hidden');
        toggle.classList.remove('hidden');
      }
    }

    async function refreshCashDrawerBalance() {
      if (!USE_REMOTE_DB) return;

      try {
        const res = await fetch(`${API_BASE}/api/shift/current-balance`, {
          headers: getAuthHeaders()
        });

        if (!res.ok) return;

        const data = await res.json();

        // Update widget elements
        const elKasir = document.getElementById('cashDrawerKasir');
        const elOpening = document.getElementById('cdOpeningCash');
        const elTotalCash = document.getElementById('cdTotalCash');
        const elNonCash = document.getElementById('cdNonCash');
        const elQuickBalance = document.getElementById('cdQuickBalance');
        const elAdjustment = document.getElementById('cdAdjustment');
        const elAdjRow = document.getElementById('cdAdjustmentRow');
        const elAdminActions = document.getElementById('cdAdminActions');
        const elLastUpdate = document.getElementById('cdLastUpdate');

        if (data.success) {
          if (elKasir) elKasir.textContent = `Kasir: ${data.employeeName || '-'}`;
          if (elOpening) elOpening.textContent = formatCurrency(data.openingCash || 0);
          if (elTotalCash) elTotalCash.textContent = formatCurrency(data.totalCash || 0);
          if (elNonCash) elNonCash.textContent = formatCurrency(data.nonCashSales || 0);
          if (elQuickBalance) elQuickBalance.textContent = formatCurrency(data.totalCash || 0);

          // Show adjustments if any
          if (data.adjustmentTotal && data.adjustmentTotal !== 0) {
            if (elAdjRow) elAdjRow.classList.remove('hidden');
            if (elAdjustment) elAdjustment.textContent = formatCurrency(data.adjustmentTotal);
          } else {
            if (elAdjRow) elAdjRow.classList.add('hidden');
          }

          // Show admin actions if user is admin
          const isAdmin = currentSession?.role === 'admin' || currentUser?.username === 'admin';
          if (elAdminActions) {
            if (isAdmin) elAdminActions.classList.remove('hidden');
            else elAdminActions.classList.add('hidden');
          }
        } else {
          // No active shift
          if (elKasir) elKasir.textContent = 'Kasir: Tidak ada shift aktif';
          if (elOpening) elOpening.textContent = 'Rp 0';
          if (elTotalCash) elTotalCash.textContent = 'Rp 0';
          if (elNonCash) elNonCash.textContent = 'Rp 0';
          if (elQuickBalance) elQuickBalance.textContent = 'Rp 0';
        }

        // Update timestamp
        if (elLastUpdate) {
          elLastUpdate.textContent = `Update: ${new Date().toLocaleTimeString('id-ID')}`;
        }

      } catch (err) {
        console.warn('Error refreshing cash drawer balance:', err);
      }
    }

    function showCashAdjustmentModal() {
      // Only admin can adjust
      const isAdmin = currentSession?.role === 'admin' || currentUser?.username === 'admin';
      if (!isAdmin) {
        showToast('Hanya Admin yang bisa melakukan penyesuaian kas!', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">âš™ï¸ Penyesuaian Kas</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Jenis</label>
              <select id="adjustType" class="input-field w-full px-4 py-2 rounded-lg text-white" onchange="updateAdjustmentSign()">
                <option value="in">ğŸ“¥ Cash In (Tambah)</option>
                <option value="out">ğŸ“¤ Cash Out (Kurang)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Jumlah (Rp)</label>
              <input type="number" id="adjustAmount" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="0" min="0">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Catatan</label>
              <input type="text" id="adjustNote" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Contoh: Ambil uang receh">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="submitCashAdjustment()" class="flex-1 btn-primary px-4 py-2 rounded-lg">Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function submitCashAdjustment() {
      const type = document.getElementById('adjustType')?.value;
      const amount = parseFloat(document.getElementById('adjustAmount')?.value) || 0;
      const note = document.getElementById('adjustNote')?.value || '';

      if (amount <= 0) {
        showToast('Jumlah harus lebih dari 0!', 'warning');
        return;
      }

      const finalAmount = type === 'out' ? -amount : amount;

      try {
        const res = await fetch(`${API_BASE}/api/shift/adjustment`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            amount: finalAmount,
            note: note,
            adjustedBy: currentUser?.username || currentSession?.name || 'Admin'
          })
        });

        const data = await res.json();

        if (data.success) {
          document.querySelector('.fixed')?.remove();
          showToast(data.message, 'success');
          refreshCashDrawerBalance();
        } else {
          showToast(data.error || 'Gagal menyimpan penyesuaian', 'error');
        }
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    function updatePOSStats() {
      const newOrders = orders.filter(o => o.status === 'new').length;
      const processOrders = orders.filter(o => o.status === 'process').length;
      const doneOrders = orders.filter(o => o.status === 'done').length;

      // Update legacy hidden spans
      const elNew = document.getElementById('posNew'); if (elNew) elNew.textContent = newOrders;
      const elProcess = document.getElementById('posProcess'); if (elProcess) elProcess.textContent = processOrders;
      const elDone = document.getElementById('posDone'); if (elDone) elDone.textContent = doneOrders;

      // Update new filter pill counts
      const elNewCount = document.getElementById('posNewCount'); if (elNewCount) elNewCount.textContent = newOrders;
      const elProcessCount = document.getElementById('posProcessCount'); if (elProcessCount) elProcessCount.textContent = processOrders;
      const elDoneCount = document.getElementById('posDoneCount'); if (elDoneCount) elDoneCount.textContent = doneOrders;
    }

    function populatePOSTableSelect() {
      const select = document.getElementById('posTableNumber');
      if (!select) { console.warn('populatePOSTableSelect: #posTableNumber not found'); return; }
      const availableTables = tables.filter(t => t.status === 'available');

      safeSet(select, '<option value="">Pilih Meja</option>' +
        availableTables.map(t => `<option value="${t.number}">Meja ${t.number}</option>`).join(''));
    }

    let posManualDraft = {}; // { itemId: quantity }

    function updatePOSMenuQuantity(itemId, change) {
      const current = posManualDraft[itemId] || 0;
      const newQty = Math.max(0, current + change);

      if (newQty === 0) {
        delete posManualDraft[itemId];
      } else {
        posManualDraft[itemId] = newQty;
      }

      renderPOSMenuSelect(); // Re-render to show updates
      updatePOSTotal();
    }

    function renderPOSMenuSelect() {
      const container = document.getElementById('posMenuSelect');
      if (!container) { console.warn('renderPOSMenuSelect: #posMenuSelect not found'); return; }

      safeSet(container, menuItems.map(item => {
        const qty = posManualDraft[item.id] || 0;
        const isSelected = qty > 0;

        return `
        <div class="flex items-center justify-between p-3 bg-surface/50 rounded-lg border transition-colors ${isSelected ? 'border-purple-500 bg-purple-500/10' : 'border-transparent hover:bg-surface'}">
          <div class="flex-1">
            <div class="font-medium text-sm ${isSelected ? 'text-white' : 'text-gray-300'}">${item.name}</div>
            <div class="text-xs text-purple-400">${formatCurrency(item.price)}</div>
          </div>
          <div class="flex items-center gap-3 bg-black/20 rounded-lg p-1">
            <button onclick="updatePOSMenuQuantity('${item.id}', -1)" class="w-7 h-7 rounded bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white flex items-center justify-center transition-colors">
              â–
            </button>
            <span class="text-sm font-mono w-6 text-center font-bold ${isSelected ? 'text-white' : 'text-gray-500'}">${qty}</span>
            <button onclick="updatePOSMenuQuantity('${item.id}', 1)" class="w-7 h-7 rounded bg-purple-500 hover:bg-purple-600 text-white flex items-center justify-center shadow-lg shadow-purple-500/20 transition-all">
              â•
            </button>
          </div>
        </div>
        `;
      }).join(''));
    }

    // Update POS order total in real-time
    function updatePOSTotal() {
      let total = 0;
      Object.entries(posManualDraft).forEach(([itemId, qty]) => {
        const item = menuItems.find(m => m.id === itemId);
        if (item) {
          total += item.price * qty;
        }
      });

      // Update total display
      const totalEl = document.getElementById('posOrderTotal');
      if (totalEl) {
        totalEl.textContent = formatCurrency(total);
        totalEl.classList.toggle('text-green-400', total > 0);
        totalEl.classList.toggle('text-gray-400', total === 0);
      }

      // Disable/enable submit button based on total
      const submitBtn = document.querySelector('#manualOrderModal button[onclick*="createManualOrder"]');
      if (submitBtn) {
        if (total === 0) {
          submitBtn.disabled = true;
          submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
          submitBtn.classList.remove('hover:bg-purple-600');
        } else {
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          submitBtn.classList.add('hover:bg-purple-600');
        }
      }
    }

    function createManualOrder() {
      const customerName = document.getElementById('posCustomerName').value;
      const phone = document.getElementById('posCustomerPhone')?.value || '';
      const tableNumber = document.getElementById('posTableNumber').value;
      const orderType = document.getElementById('posOrderType').value;
      const paymentMethod = document.getElementById('posPaymentMethod').value;
      const notes = document.getElementById('posNote').value;

      if (!customerName.trim()) {
        showToast('Nama pelanggan harus diisi!', 'warning');
        return;
      }

      const selectedMenus = [];
      Object.entries(posManualDraft).forEach(([itemId, qty]) => {
        // Only include items with quantity > 0 (paranoid check)
        if (qty > 0) {
          const menuItem = menuItems.find(m => m.id === itemId);
          if (menuItem) {
            selectedMenus.push({ ...menuItem, quantity: qty });
          }
        }
      });

      if (selectedMenus.length === 0) {
        showToast('Pilih minimal 1 menu!', 'warning');
        return;
      }

      if (orderType === 'dine-in' && !tableNumber) {
        showToast('Pilih nomor meja!', 'warning');
        return;
      }

      const total = selectedMenus.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      // Calculate HPP if gramasi exists
      let totalHPP = 0;
      let hasGramasi = false;
      selectedMenus.forEach(item => {
        const itemGramasi = gramasiData.filter(g => g.productName === item.name);
        if (itemGramasi.length > 0) {
          hasGramasi = true;
          const itemUnitHPP = itemGramasi.reduce((sum, g) => sum + (g.hpp || 0), 0);
          totalHPP += itemUnitHPP * item.quantity;
        }
      });

      const order = {
        id: generateId(),
        customerName,
        phone,
        gender: 'male',
        tableNumber: orderType === 'dine-in' ? tableNumber : null,
        orderType,
        items: selectedMenus,
        total,
        totalHPP: hasGramasi ? totalHPP : null,
        profit: hasGramasi ? (total - totalHPP) : null,
        margin: hasGramasi && total > 0 ? ((total - totalHPP) / total * 100) : null,
        notes,
        paymentMethod,
        status: 'new',
        date: getCurrentDate(),
        time: getCurrentTime(),
        timestamp: Date.now()
      };

      // Send to server (Single Order API)
      if (USE_REMOTE_DB) {
        // Use fetch properly
        fetch(`${API_BASE}/api/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        }).catch(err => console.error('Auto-sync POS order error:', err));
      }

      orders.push(order);

      if (orderType === 'dine-in' && tableNumber) {
        const table = tables.find(t => t.number === tableNumber);
        if (table) {
          table.status = 'occupied';
          table.orderId = order.id;
        }
      }

      cashTransactions.push({
        id: generateId(),
        type: 'in',
        amount: total,
        description: `Pesanan ${customerName} - ${order.id}`,
        date: getCurrentDate(),
        time: getCurrentTime(),
        category: 'sales'
      });

      saveToStorage();
      showToast('Pesanan berhasil dibuat!', 'success');

      // Close modal and reset form
      posManualDraft = {};
      closeManualOrderModal();
      document.getElementById('posCustomerName').value = '';
      document.getElementById('posTableNumber').value = '';
      document.getElementById('posNote').value = '';

      renderPOS();
      updateAllStats();

      // âœ… Show Digital Receipt automatically - with delay to ensure modal is closed first
      setTimeout(() => {
        console.log('Triggering showDigitalReceipt for POS order:', order.id);
        showDigitalReceipt(order);
      }, 300);
    }

    let currentPOSFilter = 'all';

    function filterPOSOrders(status) {
      currentPOSFilter = status;
      // Update filter button active state
      document.querySelectorAll('.pos-filter-btn').forEach(btn => {
        if (btn.dataset.filter === status) {
          btn.classList.add('ring-2', 'ring-purple-400');
        } else {
          btn.classList.remove('ring-2', 'ring-purple-400');
        }
      });
      renderPOSOrdersGrid();
    }

    function filterPOSOrdersList() {
      const filter = document.getElementById('posFilter')?.value || 'all';
      currentPOSFilter = filter;
      renderPOSOrdersGrid();
    }

    // KDS-style grid rendering
    function renderPOSOrdersGrid() {
      const container = document.getElementById('posOrdersGrid');
      if (!container) {
        // Fallback to old list renderer
        renderPOSOrders(currentPOSFilter);
        return;
      }

      let filteredOrders = orders;
      if (currentPOSFilter !== 'all') {
        filteredOrders = orders.filter(o => o.status === currentPOSFilter);
      }

      // Sort: new first, then by timestamp, cancelled last
      filteredOrders.sort((a, b) => {
        const statusOrder = { new: 0, process: 1, done: 2, cancelled: 3 };
        if (statusOrder[a.status] !== statusOrder[b.status]) {
          return statusOrder[a.status] - statusOrder[b.status];
        }
        return b.timestamp - a.timestamp;
      });

      if (filteredOrders.length === 0) {
        safeSet(container, `
          <div class="col-span-full text-center py-20 text-gray-500">
            <div class="text-6xl mb-4">ğŸ“‹</div>
            <p class="text-xl">${currentPOSFilter === 'all' ? 'Belum ada pesanan aktif' : 'Tidak ada pesanan ' + currentPOSFilter}</p>
            <p class="text-sm mt-2">Klik "Buat Pesanan Baru" untuk memulai</p>
          </div>
        `);
        return;
      }

      const statusConfig = {
        new: { bg: 'border-yellow-500/50 bg-yellow-500/5', badge: 'bg-yellow-500/20 text-yellow-400', icon: 'ğŸŸ¡', label: 'Baru' },
        process: { bg: 'border-blue-500/50 bg-blue-500/5', badge: 'bg-blue-500/20 text-blue-400', icon: 'ğŸ”µ', label: 'Diproses' },
        done: { bg: 'border-green-500/50 bg-green-500/5', badge: 'bg-green-500/20 text-green-400', icon: 'ğŸŸ¢', label: 'Selesai' },
        cancelled: { bg: 'border-red-500/50 bg-red-500/5', badge: 'bg-red-500/20 text-red-400', icon: 'ğŸ”´', label: 'Dibatalkan' }
      };

      safeSet(container, filteredOrders.map(order => {
        const config = statusConfig[order.status] || statusConfig.new;
        const itemsHtml = order.items.map(item => `
          <div class="flex justify-between text-sm py-1 border-b border-white/5">
            <span>${item.name}</span>
            <span class="font-bold">Ã—${item.quantity}</span>
          </div>
        `).join('');

        return `
          <div class="glass rounded-xl overflow-hidden border-2 ${config.bg} transition-all hover:scale-[1.02]">
            <!-- Card Header -->
            <div class="p-3 border-b border-white/10 flex items-center justify-between">
              <div>
                <h4 class="font-bold text-lg">${order.customerName || 'Pelanggan'}</h4>
                <p class="text-xs text-gray-400">${order.date} â€¢ ${order.time}</p>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-bold ${config.badge}">${config.icon} ${config.label}</span>
            </div>
            
            <!-- Order Info -->
            <div class="p-3 flex gap-4 text-sm border-b border-white/10">
              ${order.tableNumber ? `<span class="text-purple-400">ğŸª‘ Meja ${order.tableNumber}</span>` : ''}
              <span class="text-gray-400">${order.type === 'take-away' ? 'ğŸ¥¡ Take Away' : 'ğŸ½ï¸ Dine In'}</span>
            </div>
            
            <!-- Items List -->
            <div class="p-3 max-h-32 overflow-auto">
              ${itemsHtml}
            </div>
            
            <!-- Notes -->
            ${order.notes ? `<div class="p-3 bg-surface/30 text-sm text-gray-400 border-t border-white/10">ğŸ“ ${order.notes}</div>` : ''}
            
            <!-- Footer -->
            <div class="p-3 border-t border-white/10 flex items-center justify-between">
              <div>
                <span class="font-bold text-lg text-green-400 block">${formatCurrency(order.total)}</span>
                <div class="flex items-center gap-1 mt-1">
                   <span class="text-xs px-2 py-0.5 rounded ${order.paymentMethod === 'cash' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}">
                     ${order.paymentMethod === 'cash' ? 'ğŸ’µ Tunai' : (order.paymentMethod === 'qris' ? 'ğŸ“± QRIS' : (order.paymentMethod === 'bank' ? 'ğŸ¦ Bank' : 'ğŸ“² ' + (order.paymentMethod || 'Non-Tunai').toUpperCase()))}
                   </span>

                </div>
              </div>
              <div class="flex gap-2 h-full items-end">
                ${order.status === 'new' ? `<button onclick="updateOrderStatus('${order.id}', 'process')" class="px-4 py-2 rounded-lg bg-blue-500 text-white font-bold text-sm hover:bg-blue-600">â–¶ Proses</button>` : ''}
                ${order.status === 'process' ? `<button onclick="updateOrderStatus('${order.id}', 'done')" class="px-4 py-2 rounded-lg bg-green-500 text-white font-bold text-sm hover:bg-green-600">âœ“ Selesai</button>` : ''}
                ${order.status !== 'done' && order.status !== 'cancelled' ? `<button onclick="cancelOrder('${order.id}')" class="px-3 py-2 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30" title="Batalkan Pesanan">âœ•</button>` : ''}
                <button onclick="viewOrderDetail('${order.id}')" class="px-3 py-2 rounded-lg bg-purple-500/20 text-purple-400 text-sm hover:bg-purple-500/30">ğŸ‘</button>
              </div>
            </div>
          </div>
        `;
      }).join(''));
    }



    // View Payment Proof Modal
    function viewPaymentProof(imageUrl) {
      if (!imageUrl) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-4 z-[100] animate-fade';
      modal.onclick = function (e) { if (e.target === modal) modal.remove(); };

      // Use API_BASE if URL is relative path
      const fullUrl = imageUrl.startsWith('http') || imageUrl.startsWith('data:') ? imageUrl : `${API_BASE}${imageUrl}`;

      modal.innerHTML = `
        <div class="glass rounded-xl p-2 max-w-4xl max-h-[90vh] flex flex-col relative shadow-2xl border border-white/10">
          <div class="flex justify-between items-center p-2 mb-2">
            <h3 class="font-bold text-white flex items-center gap-2">ğŸ“¸ Bukti Pembayaran</h3>
            <div class="flex gap-2">
               <a href="${fullUrl}" target="_blank" download class="px-3 py-1 rounded bg-blue-500/20 text-blue-400 text-sm hover:bg-blue-500/30">â¬‡ï¸ Download</a>
               <button onclick="this.closest('.fixed').remove()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20">âœ•</button>
            </div>
          </div>
          <div class="flex-1 overflow-auto flex items-center justify-center bg-black/50 rounded-lg">
            <img src="${fullUrl}" class="max-w-full max-h-[80vh] object-contain" alt="Bukti Bayar">
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ==========================================
    // ğŸ“Š NEW DASHBOARD LOGIC (Cashier Ops Center)
    // ==========================================

    let dashboardInterval = null;

    function renderDashboard() {
      console.log('Rendering Dashboard (Cashier Ops Center)...');
      // Clear previous interval if any
      if (dashboardInterval) clearInterval(dashboardInterval);

      // Update Stats immediately
      updateDashboardWidgets();

      // Auto-refresh every 30 seconds
      dashboardInterval = setInterval(updateDashboardWidgets, 30000);
    }

    function updateDashboardWidgets() {
      const today = getCurrentDate(); // "YYYY-MM-DD"

      // 1. Calculate Today's Stats
      const todaysOrders = orders.filter(o => o.date === today && o.status !== 'cancelled');
      const revenue = todaysOrders.reduce((sum, o) => sum + (o.total || 0), 0);
      const customers = new Set(todaysOrders.map(o => o.customerName)).size;

      // Update Scorecards
      safeSetText('statRevenue', formatCurrency(revenue));
      safeSetText('statOrders', todaysOrders.length);
      safeSetText('statCustomers', customers);

      // Update Table Status Count
      const occupied = tables.filter(t => t.status === 'occupied').length;
      safeSetText('statTables', `${occupied}/${tables.length}`);

      // 2. Render Widgets
      try { renderHourlyChart(todaysOrders); } catch (e) { console.warn('Widget Error (Hourly):', e); }
      try { renderTopMenuWidget(todaysOrders); } catch (e) { console.warn('Widget Error (TopMenu):', e); }
      try { renderLowStockWidget(); } catch (e) { console.warn('Widget Error (LowStock):', e); }
      try { renderTransactionHistory(todaysOrders); } catch (e) { console.warn('Widget Error (History):', e); }

      // Existing function might be fragile or missing
      if (typeof renderTableStatus === 'function') {
        try { renderTableStatus(); } catch (e) { console.warn('Widget Error (TableStatus):', e); }
      }
    }

    // Safe Stub for renderTableStatus in case it's missing (Fix for potential TableStatus error)
    function renderTableStatus() {
      const statusContainer = document.getElementById('tableStatusWidget');
      if (statusContainer) {
        // If we had logic here, it would go here. For now, just ensure it doesn't crash.
        // Or try to implement basic count if needed.
        const occupied = tables.filter(t => t.status === 'occupied').length;
        statusContainer.innerHTML = `<div class="text-center"><span class="text-2xl font-bold">${occupied}/${tables.length}</span><span class="text-xs block text-gray-400">Meja Terisi</span></div>`;
      }
    }

    // --- Widget A: Hourly Traffic Chart ---
    function renderHourlyChart(todaysOrders) {
      const ctx = document.getElementById('hourlySalesChart');
      if (!ctx) return;

      // Bucket by hour (00-23)
      const buckets = new Array(24).fill(0);
      todaysOrders.forEach(o => {
        const hour = parseInt(o.time.split(':')[0]);
        if (hour >= 0 && hour < 24) buckets[hour]++;
      });

      // Find max for scaling
      const max = Math.max(...buckets, 5); // Min scale 5

      // Render simple bar chart HTML
      let html = '';
      // Only show active hours (e.g. 08:00 - 22:00) or all? Let's show all for now or compressed.
      // Let's show active range + padding
      const startHour = 8;
      const endHour = 23;

      for (let i = startHour; i <= endHour; i++) {
        const count = buckets[i];
        const height = Math.max((count / max) * 100, 5); // Min 5% height
        const isPeak = count === max && count > 0;
        const colorClass = isPeak ? 'bg-purple-500' : 'bg-purple-500/30';

        html += `
                <div class="flex-1 flex flex-col items-center gap-1 group relative">
                    <div class="w-full ${colorClass} rounded-t-sm transition-all duration-500 group-hover:bg-purple-400" style="height: ${height}%"></div>
                    <span class="text-[10px] text-gray-500 transform -rotate-0">${i}</span>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full mb-1 hidden group-hover:block bg-black/80 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                        Jam ${i}:00 â€¢ ${count} Order
                    </div>
                </div>
            `;
      }
      ctx.innerHTML = html;
    }

    // --- Widget B: Top 5 Menu Laris ---
    function renderTopMenuWidget(todaysOrders) {
      const container = document.getElementById('topMenuWidget');
      if (!container) return;

      const itemMap = {};
      todaysOrders.forEach(o => {
        o.items.forEach(item => {
          const name = item.name;
          itemMap[name] = (itemMap[name] || 0) + (item.quantity || 1);
        });
      });

      const sorted = Object.entries(itemMap)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 5); // Top 5

      if (sorted.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">Belum ada penjualan hari ini</div>';
        return;
      }

      container.innerHTML = sorted.map(([name, qty], index) => {
        const rank = index + 1;
        const medal = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : `#${rank}`));
        return `
                <div class="flex items-center justify-between p-2 rounded-lg bg-surface/30 hover:bg-surface/50 transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg w-8 text-center">${medal}</span>
                        <span class="text-sm font-medium text-gray-200 truncate max-w-[150px]">${name}</span>
                    </div>
                    <span class="text-xs font-bold bg-purple-500/20 text-purple-300 px-2 py-1 rounded-full">${qty} Terjual</span>
                </div>
            `;
      }).join('');
    }

    // --- Widget C: Low Stock Alert ---
    function renderLowStockWidget() {
      const container = document.getElementById('lowStockWidget');
      if (!container) return;

      // Filter ingredients < min_stock
      const lowStockItems = ingredients.filter(i => {
        const stok = parseFloat(i.stok) || 0;
        const min = parseFloat(i.stok_min) || 10; // Default 10 if not set
        return stok < min;
      }).sort((a, b) => (a.stok || 0) - (b.stok || 0)); // Most critical first

      if (lowStockItems.length === 0) {
        container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-4 text-green-400">
                    <span class="text-2xl mb-1">âœ“</span>
                    <span class="text-sm">Stok Aman</span>
                </div>`;
        return;
      }

      container.innerHTML = lowStockItems.slice(0, 5).map(i => `
            <div class="flex items-center justify-between p-2 rounded bg-red-500/10 border-l-2 border-red-500">
                <span class="text-sm text-gray-300 truncate max-w-[120px]">${i.nama}</span>
                <span class="text-xs font-bold text-red-400">${(i.stok || 0).toLocaleString()} ${i.satuan_beli || 'Unit'}</span>
            </div>
        `).join('') + (lowStockItems.length > 5 ? `<div class="text-center text-xs text-red-400 mt-1 cursor-pointer" onclick="showSection('inventory')">+ ${lowStockItems.length - 5} lainnya</div>` : '');
    }

    // --- Widget D: Transaction History Panel ---
    let currentHistoryFilter = '';
    function filterTransactionHistory() {
      const input = document.getElementById('historySearch');
      currentHistoryFilter = input ? input.value.trim().toLowerCase() : '';
      // Re-render
      const today = getCurrentDate();
      const todaysOrders = orders.filter(o => o.date === today && o.status !== 'cancelled');
      renderTransactionHistory(todaysOrders);
    }

    function renderTransactionHistory(todaysOrders) {
      const container = document.getElementById('todayTransactionTable');
      if (!container) return;

      let data = [...todaysOrders].sort((a, b) => b.timestamp - a.timestamp); // Newest first

      if (currentHistoryFilter) {
        data = data.filter(o =>
          (o.customerName || '').toLowerCase().includes(currentHistoryFilter) ||
          (o.tableNumber || '').toString().includes(currentHistoryFilter)
        );
      }

      if (data.length === 0) {
        container.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">Tidak ada transaksi${currentHistoryFilter ? ' yang cocok' : ''}</td></tr>`;
        return;
      }

      container.innerHTML = data.map(o => {
        const itemsSummary = o.items.map(i => i.name).join(', ');
        const itemsTruncated = itemsSummary.length > 30 ? itemsSummary.substring(0, 30) + '...' : itemsSummary;

        const badgeClass = o.orderType === 'take-away' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400';
        const typeLabel = o.orderType === 'take-away' ? 'ğŸ¥¡ Take Away' : 'ğŸ½ï¸ Dine In';

        return `
                <tr class="hover:bg-surface/50 group transition-colors">
                    <td class="px-2 py-3 text-gray-300 font-mono text-xs">${o.time}</td>
                    <td class="px-2 py-3 font-medium text-white">
                        ${o.customerName}
                        ${o.tableNumber ? `<span class="text-xs text-gray-500 block">Meja ${o.tableNumber}</span>` : ''}
                    </td>
                    <td class="px-2 py-3">
                        <span class="px-2 py-0.5 rounded text-[10px] ${badgeClass}">${typeLabel}</span>
                    </td>
                    <td class="px-2 py-3 text-gray-400 text-xs" title="${itemsSummary}">
                        ${itemsTruncated}
                        <div class="text-[10px] text-gray-600">${o.items.length} items</div>
                    </td>
                    <td class="px-2 py-3 text-right font-bold text-green-400">${formatCurrency(o.total)}</td>
                    <td class="px-2 py-3 text-center text-xs text-gray-400 capitalize">${o.paymentMethod || '-'}</td>
                    <td class="px-2 py-3 text-center">
                        <button onclick="printReceipt('${o.id}')" class="p-1.5 rounded bg-gray-700/50 hover:bg-purple-500 text-gray-400 hover:text-white transition-all shadow-sm" title="Print Struk">
                            ğŸ–¨ï¸
                        </button>
                    </td>
                </tr>
            `;
      }).join('');
    }

    function safeSetText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    // Legacy list renderer (for backwards compatibility)
    function renderPOSOrders(filter = 'all') {
      const container = document.getElementById('posOrdersList');
      if (!container) { console.warn('renderPOSOrders: #posOrdersList not found'); return; }

      // Filter Active Orders Only (Close Shift Feature)
      let filteredOrders = orders.filter(o => !o.is_archived_from_pos);

      if (filter !== 'all') {
        filteredOrders = filteredOrders.filter(o => o.status === filter);
      }

      filteredOrders.sort((a, b) => b.timestamp - a.timestamp);

      if (filteredOrders.length === 0) {
        safeSet(container, '<div class="p-8 text-center text-gray-400">Tidak ada pesanan</div>');
        return;
      }

      safeSet(container, filteredOrders.map(order => {
        const statusColors = {
          new: 'bg-yellow-500/20 text-yellow-400',
          process: 'bg-blue-500/20 text-blue-400',
          done: 'bg-green-500/20 text-green-400',
          cancelled: 'bg-red-500/20 text-red-400'
        };
        const statusLabels = {
          new: 'ğŸ†• Baru',
          process: 'â³ Diproses',
          done: 'âœ… Selesai',
          cancelled: 'âŒ Dibatalkan'
        };

        return `
        <div class="p-4">
          <div class="flex items-start justify-between mb-2">
            <div>
              <h4 class="font-bold">${order.customerName}</h4>
              <p class="text-xs text-gray-400">${order.date} â€¢ ${order.time}</p>
              ${order.tableNumber ? `<p class="text-xs text-purple-400">ğŸª‘ Meja ${order.tableNumber}</p>` : ''}
            </div>
            <span class="px-3 py-1 rounded-full text-xs ${statusColors[order.status]}">${statusLabels[order.status]}</span>
          </div>
          <div class="text-sm text-gray-300 mb-2">
            ${order.items.map(item => `${item.name} (${item.quantity}x)`).join(', ')}
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold text-purple-400">${formatCurrency(order.total)}</span>
            <div class="flex gap-2">
              ${order.status === 'new' ? `<button onclick="updateOrderStatus('${order.id}', 'process')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 text-xs">Proses</button>` : ''}
              ${order.status === 'process' ? `<button onclick="updateOrderStatus('${order.id}', 'done')" class="px-3 py-1 rounded-lg bg-green-500/20 text-green-400 text-xs">Selesai</button>` : ''}
              ${order.status !== 'done' && order.status !== 'cancelled' ? `<button onclick="cancelOrder('${order.id}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 text-xs">Batalkan</button>` : ''}
              <button onclick="viewOrderDetail('${order.id}')" class="px-3 py-1 rounded-lg bg-purple-500/20 text-purple-400 text-xs">Detail</button>
            </div>
          </div>
        </div>
      `}).join(''));
    }

    function updateOrderStatus(orderId, newStatus) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      const oldStatus = order.status;
      order.status = newStatus;

      // âœ… WA NOTIFICATION: ORDER PROCESSED
      if (newStatus === 'process' && oldStatus !== 'process') {
        const phone = order.customerPhone || order.phone;
        if (phone) {
          // Construct Receipt Link (assuming customer app handles query param)
          const origin = window.location.origin;
          const receiptLink = `${origin}/customer/index.html?orderId=${order.id}`; // Deep link simulation

          const businessName = businessSettings.name || 'Warkop Santai';
          const message = `Halo ${order.customerName}, pesanan Anda (${order.id}) sedang kami PROSES. Mohon ditunggu di Meja ${order.tableNumber || '-'}.\n\nLihat Nota Digital Anda di sini:\n${receiptLink}\n\nTerima kasih! - ${businessName}`;

          // Format phone (ensure no + or 0 prefix issues)
          const fmtPhone = phone.replace(/\D/g, '').replace(/^0/, '62');

          // Open WA
          window.open(`https://wa.me/${fmtPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }
      }

      // Auto-deplete stock when order is completed
      if (newStatus === 'done' && oldStatus !== 'done') {
        depleteStockForOrder(order);

        // âœ… DIGITAL CASH DRAWER: Add sale to shift balance
        if (USE_REMOTE_DB && activeShift) {
          const employeeId = currentSession?.employeeId || currentUser?.id || 'default';
          fetch(`${API_BASE}/api/shift/add-sale`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY
            },
            body: JSON.stringify({
              employeeId: employeeId,
              shiftId: activeShift?._id,
              orderId: order.id,
              amount: order.total,
              paymentMethod: order.paymentMethod || 'cash'
            })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                console.log('âœ… Sale added to shift:', data);
                // Update local activeShift state
                if (activeShift && data.newTotalCashSales !== undefined) {
                  activeShift.totalCashSales = data.newTotalCashSales;
                }
                if (activeShift && data.newTotalNonCashSales !== undefined) {
                  activeShift.totalNonCashSales = data.newTotalNonCashSales;
                }
                refreshCashDrawerBalance && refreshCashDrawerBalance(); // Update widget if exists
              } else {
                console.warn('Failed to add sale:', data.error);
              }
            })
            .catch(err => console.warn('Failed to add sale to shift:', err));
        }

        // âœ… CRM SYNC: Auto-create/update customer from order
        if (USE_REMOTE_DB) {
          fetch(`${API_BASE}/api/customers/sync-from-order`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY
            },
            body: JSON.stringify({
              orderId: order.id,
              customerName: order.customerName,
              phone: order.phone,
              orderTotal: order.total
            })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                console.log('âœ… Customer synced:', data);
                // Update local order with customerId
                order.customerId = data.customer?.id;

                if (data.isNewCustomer) {
                  showToast(`ğŸ‘¤ Pelanggan baru: ${data.customer.name}`, 'info');
                }
                if (data.pointsEarned > 0) {
                  showToast(`ğŸ +${data.pointsEarned} poin loyalty!`, 'success');
                }
                if (data.tierUpgraded) {
                  showToast(`ğŸ‰ Naik ke ${data.newTier}!`, 'success');
                }
              }
            })
            .catch(err => console.warn('CRM sync failed:', err));
        }
      }

      if (newStatus === 'done' && order.tableNumber) {
        const table = tables.find(t => t.number === order.tableNumber);
        if (table) {
          table.status = 'available';
          table.orderId = null;
        }
      }

      saveToStorage();
      renderPOS();
      updateAllStats();
      showToast('Status pesanan diupdate!', 'success');
    }

    // ===== CANCEL ORDER WITH REASON & WA NOTIF =====
    function cancelOrder(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      if (order.status === 'done' || order.status === 'cancelled') {
        showToast('Pesanan ini tidak dapat dibatalkan!', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'cancelOrderModal';
      modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade shadow-2xl border border-red-500/30">
          <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full bg-red-500/20 mx-auto flex items-center justify-center mb-4 border border-red-500/40">
              <span class="text-3xl">ğŸš«</span>
            </div>
            <h3 class="text-xl font-bold text-white">Batalkan Pesanan?</h3>
            <p class="text-sm text-gray-400">Pilih alasan pembatalan untuk notifikasi WA ke pelanggan.</p>
          </div>

          <div class="space-y-3 mb-6">
            <label class="flex items-center gap-3 p-3 rounded-lg bg-surface/50 border border-white/5 hover:bg-surface cursor-pointer group">
              <input type="radio" name="cancelReasonType" value="invalid_proof" class="text-red-500 focus:ring-red-500" checked onchange="toggleCancelOther(false)">
              <div>
                <span class="block text-sm font-bold group-hover:text-red-400 transition-colors">âŒ Bukti Tidak Valid</span>
                <span class="text-xs text-gray-400">Bukti bayar buram/salah</span>
              </div>
            </label>
            
            <label class="flex items-center gap-3 p-3 rounded-lg bg-surface/50 border border-white/5 hover:bg-surface cursor-pointer group">
              <input type="radio" name="cancelReasonType" value="double_order" class="text-red-500 focus:ring-red-500" onchange="toggleCancelOther(false)">
              <div>
                <span class="block text-sm font-bold group-hover:text-red-400 transition-colors">ğŸ”„ Pesanan Ganda</span>
                <span class="text-xs text-gray-400">Duplikasi pesanan</span>
              </div>
            </label>

            <label class="flex items-center gap-3 p-3 rounded-lg bg-surface/50 border border-white/5 hover:bg-surface cursor-pointer group">
              <input type="radio" name="cancelReasonType" value="out_of_stock" class="text-red-500 focus:ring-red-500" onchange="toggleCancelOther(false)">
              <div>
                <span class="block text-sm font-bold group-hover:text-red-400 transition-colors">ğŸ“¦ Stok Habis</span>
                <span class="text-xs text-gray-400">Bahan baku tidak tersedia</span>
              </div>
            </label>

            <label class="flex items-center gap-3 p-3 rounded-lg bg-surface/50 border border-white/5 hover:bg-surface cursor-pointer group">
              <input type="radio" name="cancelReasonType" value="other" class="text-red-500 focus:ring-red-500" onchange="toggleCancelOther(true)">
              <div>
                <span class="block text-sm font-bold group-hover:text-red-400 transition-colors">âœï¸ Lainnya</span>
                <span class="text-xs text-gray-400">Alasan manual</span>
              </div>
            </label>
            
            <div id="cancelReasonOtherContainer" class="hidden animate-fade">
              <textarea id="cancelReasonOther" class="input-field w-full px-4 py-2 rounded-lg text-white text-sm" rows="2" placeholder="Tulis alasan pembatalan..."></textarea>
            </div>
          </div>

          <div class="flex gap-2">
            <button onclick="document.getElementById('cancelOrderModal').remove()" 
              class="flex-1 px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 font-bold transition-colors">
              Batal
            </button>
            <button onclick="confirmCancelOrder('${order.id}')" 
              class="flex-1 px-4 py-3 rounded-xl bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 text-white font-bold shadow-lg shadow-red-900/50 transition-all">
              Proses Batal
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function toggleCancelOther(show) {
      const cont = document.getElementById('cancelReasonOtherContainer');
      if (show) cont.classList.remove('hidden');
      else cont.classList.add('hidden');
    }

    async function confirmCancelOrder(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      const reasonType = document.querySelector('input[name="cancelReasonType"]:checked')?.value;
      const otherReason = document.getElementById('cancelReasonOther')?.value?.trim();
      let finalReason = '';
      let waMessage = '';

      const businessName = businessSettings.name || 'Warkop Santai';

      // Construct Reason and WA Message
      switch (reasonType) {
        case 'invalid_proof':
          finalReason = 'Bukti Pembayaran Tidak Valid';
          waMessage = `Halo ${order.customerName}, pesanan Anda (${order.id}) kami batalkan karena Bukti Pembayaran tidak valid/tidak terbaca. Silakan pesan kembali dengan bukti yang benar.`;
          break;
        case 'double_order':
          finalReason = 'Pesanan Berulang (Double)';
          waMessage = `Halo ${order.customerName}, pesanan Anda (${order.id}) kami batalkan karena terdeteksi pesanan ganda. Mohon cek kembali pesanan Anda sebelumnya.`;
          break;
        case 'out_of_stock':
          finalReason = 'Stok Habis';
          waMessage = `Halo ${order.customerName}, mohon maaf pesanan Anda (${order.id}) kami batalkan karena stok bahan sedang habis. Tim kami akan menghubungi Anda segera.`;
          break;
        case 'other':
          finalReason = otherReason || 'Lainnya';
          waMessage = `Halo ${order.customerName}, mohon maaf pesanan Anda (${order.id}) dibatalkan karena: ${finalReason}. Terima kasih.`;
          break;
      }

      // Close modal
      document.getElementById('cancelOrderModal')?.remove();
      showToast('Memproses pembatalan...', 'info');

      // 1. Send WA Notification
      const phone = order.customerPhone || order.phone;
      if (phone) {
        const fmtPhone = phone.replace(/\D/g, '').replace(/^0/, '62');
        // Open in background tab if possible, or new tab (user must allow popups)
        window.open(`https://wa.me/${fmtPhone}?text=${encodeURIComponent(waMessage + `\n\n- ${businessName}`)}`, '_blank');
      }

      // 2. Update Order Logic
      const oldStatus = order.status;
      order.status = 'cancelled';
      order.cancelledAt = new Date().toISOString();
      order.cancelReason = finalReason;

      // Restore table if needed
      if (order.tableNumber) {
        const table = tables.find(t => t.number === order.tableNumber);
        if (table && table.orderId === order.id) {
          table.status = 'available';
          table.orderId = null;
        }
      }

      try {
        await saveToStorage();

        if (USE_REMOTE_DB) {
          await fetch(`${API_BASE}/api/orders/${orderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY },
            body: JSON.stringify(order)
          });
        }

        renderPOS();
        updateAllStats();
        showToast('Pesanan dibatalkan & notifikasi WA dikirim!', 'success');
      } catch (err) {
        console.error('Error cancelling:', err);
        showToast('Gagal membatalkan: ' + err.message, 'error');
        order.status = oldStatus; // Rollback
      }
    }
    function viewOrderDetail(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      // Build payment proof section
      // Support both Server URL (preferred) and Base64 (fallback)
      const paymentProofUrl = order.paymentProofImage ? `${API_BASE}${order.paymentProofImage}` : (order.paymentProof ? order.paymentProof : null);

      const paymentProofSection = paymentProofUrl ? `
        <div class="border-t border-purple-500/20 pt-3">
          <p class="text-gray-400 text-sm mb-2">ğŸ§¾ Bukti Pembayaran:</p>
          <div class="relative">
            <img src="${paymentProofUrl}" class="w-full max-h-48 object-contain rounded-lg cursor-pointer hover:opacity-80"
              onclick="viewFullImage('${paymentProofUrl}')" title="Klik untuk memperbesar">
            <span class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">Klik untuk zoom</span>
          </div>
        </div>
      ` : (order.paymentMethod && order.paymentMethod !== 'cash' ? `
        <div class="border-t border-purple-500/20 pt-3">
          <p class="text-gray-400 text-sm">ğŸ§¾ Bukti Pembayaran:</p>
          <p class="text-yellow-400 text-sm">Belum diupload</p>
          <button onclick="showUploadPaymentProofModal('${order.id}')" class="mt-2 px-3 py-1 rounded-lg bg-purple-500/20 text-purple-400 text-sm hover:bg-purple-500/30">
            ğŸ“¤ Upload Bukti Bayar
          </button>
        </div>
      ` : '');

      // Payment method badge
      const paymentBadge = order.paymentMethod ? {
        cash: { bg: 'bg-green-500/20 text-green-400', label: 'ğŸ’µ Tunai' },
        qris: { bg: 'bg-purple-500/20 text-purple-400', label: 'ğŸ“± QRIS' },
        bank: { bg: 'bg-blue-500/20 text-blue-400', label: 'ğŸ¦ Transfer' },
        ewallet: { bg: 'bg-orange-500/20 text-orange-400', label: 'ğŸ“² E-Wallet' }
      }[order.paymentMethod] || { bg: 'bg-gray-500/20 text-gray-400', label: order.paymentMethod } : null;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-auto">
          <h3 class="text-xl font-bold mb-4">ğŸ“‹ Detail Pesanan</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-400">ID:</span>
              <span class="font-mono text-sm">${order.id}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Pelanggan:</span>
              <span class="font-bold">${order.customerName}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Waktu:</span>
              <span>${order.date} ${order.time}</span>
            </div>
            ${order.tableNumber ? `
            <div class="flex justify-between">
              <span class="text-gray-400">Meja:</span>
              <span>Meja ${order.tableNumber}</span>
            </div>
            ` : ''}
            ${paymentBadge ? `
            <div class="flex justify-between items-center">
              <span class="text-gray-400">Pembayaran:</span>
              <span class="px-3 py-1 rounded-full text-sm ${paymentBadge.bg}">${paymentBadge.label}</span>
            </div>
            ` : ''}
            <div class="border-t border-purple-500/20 pt-3">
              <p class="text-gray-400 mb-2">Items:</p>
              ${order.items.map(item => `
                <div class="flex justify-between text-sm mb-1">
                  <span>${item.name} x${item.quantity}</span>
                  <span>${formatCurrency(item.price * item.quantity)}</span>
                </div>
              `).join('')}
            </div>
            ${order.notes ? `
            <div class="border-t border-purple-500/20 pt-3">
              <p class="text-gray-400 text-sm">Catatan:</p>
              <p class="text-sm">${order.notes}</p>
            </div>
            ` : ''}
            ${order.totalHPP !== null && order.totalHPP !== undefined ? `
            <div class="border-t border-purple-500/20 pt-3">
              <p class="text-gray-400 text-sm mb-2">Analisis Profitabilitas:</p>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">HPP:</span>
                  <span class="text-red-400">${formatCurrency(order.totalHPP)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Profit:</span>
                  <span class="text-green-400">${formatCurrency(order.profit)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Margin:</span>
                  <span class="text-purple-400">${(order.margin || 0).toFixed(1)}%</span>
                </div>
              </div>
            </div>
            ` : ''}
            ${paymentProofSection}
            <div class="border-t border-purple-500/20 pt-3">
              <div class="flex justify-between text-lg font-bold">
                <span>Total:</span>
                <span class="text-purple-400">${formatCurrency(order.total)}</span>
              </div>
            </div>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="w-full mt-6 btn-primary px-4 py-2 rounded-lg">
            Tutup
          </button>
        </div>
        `;
      document.body.appendChild(modal);
    }

    // View fullscreen image
    function viewFullImage(imageUrl) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[100] cursor-pointer';
      modal.onclick = () => modal.remove();
      modal.innerHTML = `
        < img src = "${imageUrl}" class="max-w-full max-h-full object-contain rounded-lg" >
          <button class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 text-white text-xl hover:bg-white/30">âœ•</button>
      `;
      document.body.appendChild(modal);
    }

    // Upload payment proof modal (POS)
    function showUploadPaymentProofModal(orderId) {
      closeAllModals();
      const modal = document.createElement('div');
      modal.id = 'uploadPaymentProofModal';
      modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full">
          <h3 class="text-xl font-bold mb-4">ğŸ“¤ Upload Bukti Pembayaran</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Metode Pembayaran</label>
              <select id="uploadPaymentMethod" class="input-field w-full px-4 py-2 rounded-lg text-white">
                <option value="qris">ğŸ“± QRIS</option>
                <option value="bank">ğŸ¦ Transfer Bank</option>
                <option value="ewallet">ğŸ“² E-Wallet</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-2">Foto Bukti Bayar</label>
              <input type="file" id="posPaymentProofFile" accept="image/*" class="hidden" onchange="previewPOSPaymentProof(this)">
              <div id="posPaymentProofPreviewContainer" class="border-2 border-dashed border-purple-500/30 rounded-lg p-4 text-center cursor-pointer hover:border-purple-500/50"
                onclick="document.getElementById('posPaymentProofFile').click()">
                <div id="posPaymentProofPreview" class="hidden">
                  <img id="posPaymentProofImg" class="max-h-40 mx-auto rounded-lg mb-2">
                  <p class="text-sm text-green-400">âœ“ Foto dipilih</p>
                </div>
                <div id="posPaymentProofPlaceholder">
                  <p class="text-4xl mb-2">ğŸ“·</p>
                  <p class="text-gray-400">Klik untuk pilih foto</p>
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="closeAllModals()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80 text-gray-400">Batal</button>
              <button onclick="uploadPaymentProof('${orderId}')" class="flex-1 btn-primary px-4 py-2 rounded-lg font-bold">ğŸ“¤ Upload</button>
            </div>
          </div>
        </div>
        `;
      document.body.appendChild(modal);
    }

    function previewPOSPaymentProof(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('posPaymentProofImg').src = e.target.result;
          document.getElementById('posPaymentProofPreview').classList.remove('hidden');
          document.getElementById('posPaymentProofPlaceholder').classList.add('hidden');
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function uploadPaymentProof(orderId) {
      const fileInput = document.getElementById('posPaymentProofFile');
      const paymentMethod = document.getElementById('uploadPaymentMethod').value;

      if (!fileInput.files || !fileInput.files[0]) {
        showToast('Pilih foto bukti bayar!', 'warning');
        return;
      }

      try {
        showToast('Mengupload bukti bayar...', 'info');

        // Step 1: Upload file
        const formData = new FormData();
        formData.append('paymentProof', fileInput.files[0]);

        const uploadRes = await fetch(`${API_BASE} /api/upload / payment - proof`, {
          method: 'POST',
          body: formData
        });

        if (!uploadRes.ok) {
          throw new Error('Upload gagal');
        }

        const uploadData = await uploadRes.json();

        // Step 2: Update order with payment proof URL
        const updateRes = await fetch(`${API_BASE} /api/orders / ${orderId}/payment-proof`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            paymentProofImage: uploadData.url,
            paymentMethod: paymentMethod
          })
        });

        if (!updateRes.ok) {
          throw new Error('Gagal update order');
        }

        // Update local order data
        const order = orders.find(o => o.id === orderId);
        if (order) {
          order.paymentProofImage = uploadData.url;
          order.paymentMethod = paymentMethod;
        }

        closeAllModals();
        showToast('Bukti bayar berhasil diupload!', 'success');
        renderPOS();
        updateAllStats();

      } catch (err) {
        console.error('Upload error:', err);
        showToast('Gagal upload: ' + err.message, 'error');
      }
    }

    // ===== GRAMASI SECTION =====
    function renderGramasi() {
      renderGramasiTable();
      updateGramasiStats();
      populateGramasiProductSelect();
    }

    function populateGramasiProductSelect() {
      const select = document.getElementById('gramasiProduct');
      if (!select) { console.warn('populateGramasiProductSelect: #gramasiProduct not found'); return; }
      safeSet(select, '<option value="">Pilih Produk</option>' +
        menuItems.map(item => `<option value="${item.name}">${item.name}</option>`).join(''));
      initEventListeners();
    }

    function renderGramasiTable() {
      const container = document.getElementById('gramasiTable');
      if (!container) return;

      // Group gramasi by productName and calculate totals
      const grouped = {};
      gramasiData.forEach(item => {
        if (!grouped[item.productName]) {
          grouped[item.productName] = { items: [], totalHPP: 0 };
        }
        grouped[item.productName].items.push(item);
        grouped[item.productName].totalHPP += item.hpp || 0;
      });

      if (Object.keys(grouped).length === 0) {
        container.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">Belum ada data gramasi</td></tr>';
        return;
      }

      const ppnRate = businessSettings.tax || 11;

      container.innerHTML = Object.keys(grouped).map(productName => {
        const data = grouped[productName];
        const totalHPP = data.totalHPP;
        const product = menuItems.find(m => m.name === productName);
        const hargaJual = product ? product.price : 0;
        const ppnAmount = hargaJual * (ppnRate / 100);
        const netProfit = hargaJual - totalHPP - ppnAmount;
        const margin = hargaJual > 0 ? ((netProfit / hargaJual) * 100).toFixed(1) : 0;

        return `
          <tr class="hover:bg-surface/30">
            <td class="px-4 py-3">
              <p class="font-medium">${productName}</p>
              <p class="text-xs text-gray-500">${data.items.length} bahan</p>
            </td>
            <td class="px-4 py-3 text-right text-red-400 font-medium">${formatCurrency(Math.round(totalHPP))}</td>
            <td class="px-4 py-3 text-right text-green-400 font-medium">${formatCurrency(hargaJual)}</td>
            <td class="px-4 py-3 text-right text-yellow-400">${formatCurrency(Math.round(ppnAmount))}</td>
            <td class="px-4 py-3 text-right font-bold ${netProfit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(Math.round(netProfit))}</td>
            <td class="px-4 py-3 text-right font-bold ${margin >= 20 ? 'text-green-400' : margin >= 0 ? 'text-yellow-400' : 'text-red-400'}">${margin}%</td>
            <td class="px-4 py-3 text-center">
              <button onclick="viewGramasiDetail('${productName}')" class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs mr-1" title="Lihat">ğŸ‘ï¸</button>
              <button onclick="editGramasi('${productName}')" class="px-2 py-1 rounded bg-orange-500/20 text-orange-400 text-xs mr-1" title="Edit Resep">âœï¸</button>
              <button onclick="deleteGramasiByProduct('${productName}')" class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs" title="Hapus">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateGramasiStats() {
      // Group and calculate totals
      const grouped = {};
      gramasiData.forEach(item => {
        if (!grouped[item.productName]) {
          grouped[item.productName] = { totalHPP: 0 };
        }
        grouped[item.productName].totalHPP += item.hpp || 0;
      });

      const ppnRate = businessSettings.tax || 11;
      let totalHPP = 0;
      let totalHargaJual = 0;
      let totalProfit = 0;
      let marginSum = 0;
      let count = 0;

      Object.keys(grouped).forEach(productName => {
        const data = grouped[productName];
        const product = menuItems.find(m => m.name === productName);
        const hargaJual = product ? product.price : 0;
        const ppnAmount = hargaJual * (ppnRate / 100);
        const netProfit = hargaJual - data.totalHPP - ppnAmount;
        const margin = hargaJual > 0 ? (netProfit / hargaJual * 100) : 0;

        totalHPP += data.totalHPP;
        totalHargaJual += hargaJual;
        totalProfit += netProfit;
        marginSum += margin;
        count++;
      });

      const avgMargin = count > 0 ? (marginSum / count).toFixed(1) : 0;

      // Update stat cards
      const elHPP = document.getElementById('totalHpp');
      const elPrice = document.getElementById('totalSellingPrice');
      const elProfit = document.getElementById('totalProfit');
      const elMargin = document.getElementById('avgMargin');

      if (elHPP) elHPP.textContent = formatCurrency(Math.round(totalHPP));
      if (elPrice) elPrice.textContent = formatCurrency(totalHargaJual);
      if (elProfit) elProfit.textContent = formatCurrency(Math.round(totalProfit));
      if (elMargin) elMargin.textContent = avgMargin + '%';
    }

    function viewGramasiDetail(productName) {
      const items = gramasiData.filter(g => g.productName === productName);
      const product = menuItems.find(m => m.name === productName);
      const totalHPP = items.reduce((sum, i) => sum + (i.hpp || 0), 0);
      const hargaJual = product ? product.price : 0;
      const ppn = businessSettings.tax || 11;
      const ppnAmount = hargaJual * (ppn / 100);
      const netProfit = hargaJual - totalHPP - ppnAmount;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full">
          <h3 class="text-xl font-bold mb-4">ğŸ“‹ Detail Resep: ${productName}</h3>
          <div class="divide-y divide-purple-500/10 max-h-60 overflow-auto">
            ${items.map(item => `
              <div class="py-3 flex justify-between">
                <div>
                  <p class="font-medium">${item.bahan}</p>
                  <p class="text-xs text-gray-400">${item.amount} ${item.unit}</p>
                </div>
                <p class="text-green-400">${formatCurrency(item.hpp)}</p>
              </div>
            `).join('')}
          </div>
          <div class="border-t border-purple-500/20 mt-4 pt-4 space-y-2 text-sm">
            <div class="flex justify-between"><span>Total HPP:</span><span class="text-red-400">${formatCurrency(totalHPP)}</span></div>
            <div class="flex justify-between"><span>Harga Jual:</span><span class="text-green-400">${formatCurrency(hargaJual)}</span></div>
            <div class="flex justify-between"><span>PPN (${ppn}%):</span><span class="text-yellow-400">${formatCurrency(Math.round(ppnAmount))}</span></div>
            <div class="flex justify-between font-bold"><span>Net Profit:</span><span class="${netProfit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(Math.round(netProfit))}</span></div>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="w-full mt-6 btn-primary px-4 py-2 rounded-lg">Tutup</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function deleteGramasiByProduct(productName) {
      showConfirmModal({
        title: 'Hapus Semua Gramasi?',
        message: `Apakah Anda yakin ingin menghapus semua data resep/gramasi untuk produk <b>${productName}</b>?`,
        confirmText: 'Hapus Semua',
        type: 'danger',
        onConfirm: () => {
          gramasiData = gramasiData.filter(g => g.productName !== productName);
          saveToStorage();
          renderGramasi();
          showToast(`Gramasi "${productName}" berhasil dihapus!`, 'success');
        }
      });
    }

    function filterGramasi() {
      const productName = document.getElementById('gramasiProduct').value;
      renderGramasiList(productName);
    }

    function renderGramasiList(filterProduct = '') {
      // Now redirect to renderGramasiTable (keep for backwards compat)
      renderGramasiTable();
    }

    function showAddGramasiModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.id = 'gramasiModal';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-auto">
          <h3 class="text-xl font-bold mb-4">â• Tambah Resep Gramasi</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">Produk Menu</label>
                <select id="gramasiProduk" class="input-field w-full px-4 py-2 rounded-lg text-white" onchange="updateGramasiCalc()">
                  <option value="">Pilih Produk</option>
                  ${menuItems.map(item => `<option value="${item.id}" data-price="${item.price}">${item.name} (${formatCurrency(item.price)})</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Harga Jual</label>
                <input type="number" id="gramasiHargaJual" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="0" oninput="updateGramasiCalc()">
              </div>
            </div>
            <!-- Multi-Ingredient List -->
            <div class="glass rounded-lg p-3 relative" style="z-index: 100;">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium">Daftar Bahan</span>
                <button onclick="addGramasiRow()" class="text-xs px-3 py-1 rounded-lg bg-purple-500/30 hover:bg-purple-500/50 text-purple-300">+ Tambah Bahan</button>
              </div>
              <div id="gramasiBahanList" class="space-y-2" style="position: relative; z-index: 200;">
                <!-- Rows will be added here -->
              </div>
            </div>
            <!-- Calculation Summary -->
            <div class="glass rounded-lg p-4 bg-gradient-to-r from-green-500/10 to-blue-500/10" style="position: relative; z-index: 1;">
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <p class="text-gray-400">Total HPP</p>
                  <p class="text-xl font-bold text-red-400" id="gramasiTotalHPP">Rp 0</p>
                </div>
                <div>
                  <p class="text-gray-400">Harga Jual</p>
                  <p class="text-xl font-bold text-green-400" id="gramasiHargaDisplay">Rp 0</p>
                </div>
              </div>
              <div class="border-t border-white/10 mt-3 pt-3">
                <div class="grid grid-cols-3 gap-2 text-sm">
                  <div>
                    <p class="text-xs text-gray-500">PPN (${businessSettings.tax || 11}%)</p>
                    <p class="font-medium text-yellow-400" id="gramasiPPN">Rp 0</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">Net Profit</p>
                    <p class="font-bold text-green-400" id="gramasiNetProfit">Rp 0</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">Margin</p>
                    <p class="font-bold text-purple-400" id="gramasiMargin">0%</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveMultiGramasi()" class="flex-1 btn-primary px-4 py-2 rounded-lg">Simpan Resep</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      addGramasiRow(); // Add first row
    }

    let gramasiRowCounter = 0;

    function addGramasiRow() {
      gramasiRowCounter++;
      const container = document.getElementById('gramasiBahanList');
      if (!container) return;

      // Sort ingredients A-Z by nama
      const sortedIngredients = [...ingredients].sort((a, b) => (a.nama || '').localeCompare(b.nama || ''));
      const ingOptions = sortedIngredients.map(ing => {
        const unit = ing.satuan_prod || ing.satuan || ing.satuan_beli || '';
        const modal = ing.harga_modal || ing.harga_beli || 0;
        return `<option value="${ing.id}" data-modal="${modal}" data-unit="${unit}">${ing.nama} (${formatCurrency(Math.round(modal))}/${unit})</option>`;
      }).join('');

      const row = document.createElement('div');
      row.className = 'gramasi-row glass rounded-lg p-3 mb-2';
      row.dataset.row = gramasiRowCounter;
      row.innerHTML = `
        <div class="flex gap-2 items-center">
        <div class="flex-1 relative">
          <input type="text" class="gram-search input-field w-full px-3 py-2 rounded-lg text-white text-sm"
            placeholder="ğŸ” Ketik nama bahan..."
            oninput="filterGramasiDropdown(this, ${gramasiRowCounter})"
            onfocus="showGramasiDropdown(${gramasiRowCounter})"
            autocomplete="off">
            <div class="gram-dropdown absolute z-50 w-full mt-1 max-h-48 overflow-auto glass rounded-lg hidden" id="gramDropdown${gramasiRowCounter}">
              ${sortedIngredients.map(ing => {
        const unit = ing.satuan_prod || ing.satuan || ing.satuan_beli || '';
        const modal = ing.harga_modal || ing.harga_beli || 0;
        return `<div class="gram-option px-3 py-2 hover:bg-purple-500/20 cursor-pointer text-sm" 
                            data-id="${ing.id}" data-modal="${modal}" data-unit="${unit}" data-name="${ing.nama}"
                            onclick="selectGramasiIng(this, ${gramasiRowCounter})">
                          ${ing.nama} <span class="text-green-400">(${formatCurrency(Math.round(modal))}/${unit})</span>
                        </div>`;
      }).join('')}
            </div>
            <input type="hidden" class="gram-ing" id="gramIng${gramasiRowCounter}">
            </div>
            <div class="flex items-center gap-1">
              <input type="number" step="0.01" class="gram-qty input-field w-20 px-3 py-2 rounded-lg text-white text-sm text-right" placeholder="Qty" oninput="updateGramasiCalc()">
                <span class="gram-unit text-xs text-gray-400 w-12" id="gramUnit${gramasiRowCounter}">unit</span>
            </div>
            <span class="gram-cost text-sm font-medium text-green-400 w-24 text-right" id="gramCost${gramasiRowCounter}">Rp 0</span>
            <button onclick="removeGramasiRow(${gramasiRowCounter})" class="text-red-400 hover:text-red-300 px-2">âœ•</button>
        </div>
    `;
      container.appendChild(row);
    }

    function filterGramasiDropdown(input, rowNum) {
      const query = input.value.toLowerCase();
      const dropdown = document.getElementById(`gramDropdown${rowNum}`);
      if (!dropdown) return;

      dropdown.classList.remove('hidden');
      const options = dropdown.querySelectorAll('.gram-option');
      options.forEach(opt => {
        const name = opt.dataset.name?.toLowerCase() || '';
        opt.style.display = name.includes(query) ? 'block' : 'none';
      });
    }

    function showGramasiDropdown(rowNum) {
      const dropdown = document.getElementById(`gramDropdown${rowNum}`);
      if (dropdown) dropdown.classList.remove('hidden');
    }

    function selectGramasiIng(option, rowNum) {
      const id = option.dataset.id;
      const name = option.dataset.name;
      const unit = option.dataset.unit;
      const modal = option.dataset.modal;

      // Set hidden input value
      const ingInput = document.getElementById(`gramIng${rowNum}`);
      if (ingInput) ingInput.value = id;

      // Update search input display
      const row = document.querySelector(`.gramasi-row[data-row="${rowNum}"]`);
      const searchInput = row?.querySelector('.gram-search');
      if (searchInput) searchInput.value = name;

      // Update unit label
      const unitLabel = document.getElementById(`gramUnit${rowNum}`);
      if (unitLabel) unitLabel.textContent = unit;

      // Hide dropdown
      const dropdown = document.getElementById(`gramDropdown${rowNum}`);
      if (dropdown) dropdown.classList.add('hidden');

      updateGramasiCalc();
    }

    function removeGramasiRow(rowNum) {
      const row = document.querySelector(`.gramasi-row[data-row="${rowNum}"]`);
      if (row) {
        row.remove();
        updateGramasiCalc();
      }
    }

    function updateGramasiCalc() {
      let totalHPP = 0;

      // Calculate each row
      document.querySelectorAll('.gramasi-row').forEach(row => {
        const select = row.querySelector('.gram-ing');
        const qtyInput = row.querySelector('.gram-qty');
        const costDisplay = row.querySelector('.gram-cost');

        const ingId = select?.value;
        const qty = parseFloat(qtyInput?.value) || 0;

        if (ingId && qty > 0) {
          const ing = ingredients.find(i => i.id === ingId);
          const modal = ing?.harga_modal || ing?.harga_beli || 0;
          const cost = qty * modal;
          totalHPP += cost;
          if (costDisplay) costDisplay.textContent = formatCurrency(Math.round(cost));
        } else {
          if (costDisplay) costDisplay.textContent = 'Rp 0';
        }
      });

      // Get harga jual
      const produkSelect = document.getElementById('gramasiProduk');
      const hargaJualInput = document.getElementById('gramasiHargaJual');

      let hargaJual = parseFloat(hargaJualInput?.value) || 0;
      if (!hargaJual && produkSelect?.selectedOptions[0]) {
        hargaJual = parseFloat(produkSelect.selectedOptions[0].dataset.price) || 0;
        if (hargaJualInput) hargaJualInput.value = hargaJual;
      }

      // Calculate profit with PPN
      const ppn = businessSettings.tax || 11;
      const ppnAmount = hargaJual * (ppn / 100);
      const netProfit = hargaJual - totalHPP - ppnAmount;
      const margin = hargaJual > 0 ? (netProfit / hargaJual * 100) : 0;

      // Update displays
      const elHPP = document.getElementById('gramasiTotalHPP');
      const elHarga = document.getElementById('gramasiHargaDisplay');
      const elPPN = document.getElementById('gramasiPPN');
      const elProfit = document.getElementById('gramasiNetProfit');
      const elMargin = document.getElementById('gramasiMargin');

      if (elHPP) elHPP.textContent = formatCurrency(Math.round(totalHPP));
      if (elHarga) elHarga.textContent = formatCurrency(hargaJual);
      if (elPPN) elPPN.textContent = formatCurrency(Math.round(ppnAmount));
      if (elProfit) {
        elProfit.textContent = formatCurrency(Math.round(netProfit));
        elProfit.className = `font - bold ${netProfit >= 0 ? 'text-green-400' : 'text-red-400'} `;
      }
      if (elMargin) {
        elMargin.textContent = margin.toFixed(1) + '%';
        elMargin.className = `font - bold ${margin >= 20 ? 'text-green-400' : margin >= 0 ? 'text-yellow-400' : 'text-red-400'} `;
      }
    }

    async function saveMultiGramasi() {
      const produkSelect = document.getElementById('gramasiProduk');
      const menuId = produkSelect?.value;
      const menuItem = menuItems.find(m => m.id === menuId);

      if (!menuId || !menuItem) {
        showToast('Pilih produk menu!', 'warning');
        return;
      }

      const uniqueMap = {};

      document.querySelectorAll('.gramasi-row').forEach(row => {
        const rowNum = row.dataset.row;
        const ingInput = document.getElementById(`gramIng${rowNum}`);
        const qtyInput = row.querySelector('.gram-qty');

        if (ingInput && qtyInput) {
          const ingId = ingInput.value;
          const bahanName = row.querySelector('.gram-search')?.value;
          const amount = parseFloat(qtyInput.value) || 0;

          if (ingId && amount > 0) {
            // Find unit and price from global ingredients to calc HPP
            const ingData = ingredients.find(i => i.id === ingId);
            const unit = document.getElementById(`gramUnit${rowNum}`)?.textContent || (ingData?.satuan_prod || ingData?.satuan || ingData?.satuan_beli || 'unit');

            // Calculate HPP for this item
            let currentHpp = 0;
            if (ingData) {
              currentHpp = amount * (ingData.harga_modal || ingData.harga_beli || 0);
            }

            if (uniqueMap[ingId]) {
              uniqueMap[ingId].amount += amount;
              uniqueMap[ingId].hpp += Math.round(currentHpp);
            } else {
              uniqueMap[ingId] = {
                id: generateId(),
                menuId: menuId,
                productName: menuItem.name,
                ing_id: ingId,
                bahan: bahanName,
                amount: amount,
                unit: unit,
                hpp: Math.round(currentHpp),
                date: getCurrentDate()
              };
            }
          }
        }
      });

      const bahanList = Object.values(uniqueMap);

      if (bahanList.length === 0) {
        showToast('Tambahkan minimal 1 bahan!', 'warning');
        return;
      }

      // âœ… CLOSE MODAL FIRST for better UX
      closeAllModals();
      showToast('Menyimpan resep...', 'info');

      // ğŸ§¹ CLEANUP: Remove any existing recipe for this product (Upsert Logic)
      // This ensures 'Edit' works by overwriting instead of duplicating
      // ğŸ§¹ CLEANUP: Upsert Logic (Remove existing)
      // Filter by ID first (more reliable), then Name (legacy support)
      gramasiData = gramasiData.filter(g => {
        const matchId = g.menuId && g.menuId === menuId;
        const normalize = (s) => (s || '').trim().toLowerCase();
        const matchName = normalize(g.productName || '') === normalize(menuItem.name || '');
        return !(matchId || matchName);
      });

      // Add all to gramasiData with menuId tracking
      bahanList.forEach(item => {
        item.menuId = menuId; // Associate with ID for robust tracking
        gramasiData.push(item);
      });

      // Also update recipes for auto-depletion
      if (typeof recipes === 'object' && !Array.isArray(recipes)) {
        recipes[menuId] = []; // Reset recipe for this menu
        bahanList.forEach(item => {
          recipes[menuId].push({ ing_id: item.ing_id, jumlah: item.amount });
        });
      } else {
        // Fallback if recipes is array structure (depending on implementation)
        // Just rely on gramasiData source of truth
      }

      // ğŸš€ EXPLICIT REMOTE SAVE (Fixing Duplication Bug)
      // We call the PUT endpoint to FORCE replacement of the ingredients list
      if (USE_REMOTE_DB) {
        try {
          const recipePayload = {
            menuId: menuId,
            ingredients: recipes[menuId] // The clean list we just built
          };
          const headers = getAuthHeaders();
          await fetch(`${API_BASE}/api/recipes/${menuId}`, {
            method: 'PUT',
            headers,
            body: JSON.stringify(recipePayload)
          });
          console.log('[RECIPE] PUT update sent to backend');
        } catch (e) {
          console.error('Remote recipe update failed:', e);
        }
      }

      try {
        await saveToStorage();

        // ğŸ”„ UI REFRESH (Fixing UI Lag)
        document.getElementById('gramasiModal')?.classList.add('hidden'); // Close modal immediate
        document.querySelector('.fixed.inset-0.z-50')?.remove(); // Kill switch if dynamic

        // Update Stats & Table
        if (typeof updateGramasiStats === 'function') updateGramasiStats();
        renderGramasi();
        renderGramasiTable();

        showToast('Resep berhasil disimpan!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Gagal menyimpan: ' + err.message, 'error');
      }
    }

    function editGramasi(productName) {
      // 1. Get existing data
      const productGramasi = gramasiData.filter(g => g.productName === productName);
      if (productGramasi.length === 0) return;
      const product = menuItems.find(m => m.name === productName);

      // 2. Open Modal
      showAddGramasiModal();

      // 3. Populate Product Select
      const prodSelect = document.getElementById('gramasiProduk');
      if (prodSelect && product) {
        prodSelect.value = product.id;
        // Trigger generic change event if needed, but manual population is safer
        // prodSelect.dispatchEvent(new Event('change')); 
        // Manually set price display just in case
        const priceDisplay = document.getElementById('gramasiHargaJual');
        if (priceDisplay) priceDisplay.value = product.price;

        // Disable selecting another product to keep context clear
        prodSelect.disabled = true;
      }

      // Update Modal Title
      const modalTitle = document.querySelector('#gramasiModal h3');
      if (modalTitle) modalTitle.innerText = `âœï¸ Edit Resep: ${productName}`;

      // 4. Clear Default Row
      const list = document.getElementById('gramasiBahanList');
      if (list) list.innerHTML = '';

      // 5. Populate Rows
      productGramasi.forEach(g => {
        addGramasiRow();
        const rowNum = gramasiRowCounter; // Global counter from addGramasiRow

        // Populate Ingredient
        const ingInput = document.getElementById(`gramIng${rowNum}`);
        if (ingInput) ingInput.value = ingInput.value = g.ing_id; // Set hidden value

        // Update Search Display
        const searchInput = document.querySelector(`.gramasi-row[data-row="${rowNum}"] .gram-search`);
        if (searchInput) searchInput.value = g.bahan;

        // Populate Qty
        const qtyInput = document.querySelector(`.gramasi-row[data-row="${rowNum}"] .gram-qty`);
        if (qtyInput) {
          qtyInput.value = g.amount;
        }

        // Update Unit Label
        const unitLabel = document.getElementById(`gramUnit${rowNum}`);
        if (unitLabel) unitLabel.textContent = g.unit;

        // Calculate Cost Display (Optional for UX)
        // We trigger updateGramasiCalc() at end, but row-level cost needs manual set or triggering input
      });

      // Recalculate totals
      updateGramasiCalc();
    }

    function saveGramasi() {
      const productName = document.getElementById('newGramasiProduct')?.value;
      const bahan = document.getElementById('newGramasiBahan')?.value;
      const amount = parseFloat(document.getElementById('newGramasiAmount')?.value) || 0;
      const unit = document.getElementById('newGramasiUnit')?.value;
      const hpp = parseFloat(document.getElementById('newGramasiHPP')?.value) || 0;

      if (!productName) {
        showToast('Pilih produk!', 'warning');
        return;
      }

      if (!bahan || !bahan.trim()) {
        showToast('Nama bahan harus diisi!', 'warning');
        return;
      }

      if (amount <= 0) {
        showToast('Gramasi harus lebih dari 0!', 'warning');
        return;
      }

      // âœ… CLOSE MODAL FIRST for better UX
      closeAllModals();
      showToast('Menyimpan data gramasi...', 'info');

      const newGramasi = {
        id: generateId(),
        productName,
        bahan: bahan.trim(),
        amount,
        unit,
        hpp,
        date: getCurrentDate()
      };

      gramasiData.push(newGramasi);

      try {
        saveToStorage();
        renderGramasi();
        showToast('Data gramasi berhasil ditambahkan!', 'success');
      } catch (err) {
        console.error('Error saving gramasi:', err);
        showToast('Gagal menyimpan: ' + err.message, 'error');
      } finally {
        ensureSidebarVisible();
      }
    }

    function filterGramasi() {
      const productName = document.getElementById('gramasiProduct').value;
      renderGramasiList(productName);
    }

    function renderGramasiList(filterProduct = '') {
      const container = document.getElementById('gramasiList');
      if (!container) { console.warn('renderGramasiList: #gramasiList not found'); return; }

      let filtered = gramasiData;
      if (filterProduct) {
        filtered = gramasiData.filter(g => g.productName === filterProduct);
      }

      if (filtered.length === 0) {
        safeSet(container, '<div class="p-8 text-center text-gray-400">Belum ada data gramasi</div>');
        initEventListeners();
        return;
      }

      // Group by product
      const grouped = {};
      filtered.forEach(item => {
        if (!grouped[item.productName]) {
          grouped[item.productName] = [];
        }
        grouped[item.productName].push(item);
      });

      container.innerHTML = Object.keys(grouped).map(productName => {
        const items = grouped[productName];
        const totalHPP = items.reduce((sum, item) => sum + (item.hpp || 0), 0);
        const product = menuItems.find(m => m.name === productName);
        const price = product ? product.price : 0;
        const profit = price - totalHPP;
        const margin = price > 0 ? ((profit / price) * 100).toFixed(1) : 0;

        return `
          <div class="mb-6">
            <div class="bg-gradient-to-r from-purple-500/20 to-blue-500/20 p-4 rounded-t-xl">
              <div class="flex items-center justify-between">
                <div>
                  <h4 class="font-bold text-lg">${productName}</h4>
                  <p class="text-sm text-gray-400">${items.length} bahan</p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-gray-400">Harga Jual</p>
                  <p class="text-lg font-bold text-green-400">${formatCurrency(price)}</p>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2 mt-3">
                <div class="bg-black/20 rounded-lg p-2">
                  <p class="text-xs text-gray-400">Total HPP</p>
                  <p class="text-sm font-bold text-red-400">${formatCurrency(totalHPP)}</p>
                </div>
                <div class="bg-black/20 rounded-lg p-2">
                  <p class="text-xs text-gray-400">Profit</p>
                  <p class="text-sm font-bold text-green-400">${formatCurrency(profit)}</p>
                </div>
                <div class="bg-black/20 rounded-lg p-2">
                  <p class="text-xs text-gray-400">Margin</p>
                  <p class="text-sm font-bold text-purple-400">${margin}%</p>
                </div>
              </div>
            </div>
            <div class="divide-y divide-purple-500/10">
              ${items.map(item => `
                <div class="p-4 flex items-center justify-between hover:bg-surface/30">
                  <div class="flex-1">
                    <p class="font-medium">${item.bahan}</p>
                    <p class="text-sm text-gray-400">${item.amount} ${item.unit}</p>
                    <p class="text-xs text-purple-400">HPP: ${formatCurrency(item.hpp)}</p>
                  </div>
                  <button onclick="deleteGramasi('${item.id}')" class="px-3 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 text-sm">
                    ğŸ—‘ï¸
                  </button>
                </div>
              `).join('')}
            </div>
          </div>
      `;
      }).join('');
    }

    function deleteGramasi(id) {
      showConfirmModal({
        title: 'Hapus Gramasi?',
        message: 'Apakah Andaa ywwaskin ingin menghapus data gramasi ini?',
        confirmText: 'Hapus',
        type: 'danger',
        onConfirm: () => {
          gramasiData = gramasiData.filter(g => g.id !== id);
          saveToStorage();
          renderGramasi();
          showToast('Data gramasi berhasil dihapus!', 'success');
        }
      });
    }

    // ===== INVENTORY SECTION =====
    function renderInventory() {
      try {
        updateInventoryStats();
        renderIngredientTable();
        renderOpnameTable();
        renderStockHistory();
      } catch (err) {
        console.error('Error rendering inventory:', err);
        showToast('Error rendering inventaris (lihat console)', 'error');
      } finally {
        // Always ensure sidebar stays visible after render
        ensureSidebarVisible();
      }
    }

    function renderIngredientTable(filter = '') {
      const container = document.getElementById('ingredientTable');
      if (!container) return;

      let filtered = ingredients || [];
      if (filter) {
        filtered = filtered.filter(i => i && i.nama && i.nama.toLowerCase().includes(filter.toLowerCase()));
      }

      if (filtered.length === 0) {
        container.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-gray-400">Belum ada bahan baku</td></tr>';
        return;
      }

      container.innerHTML = filtered.map(ing => {
        if (!ing) return ''; // Skip undefined items
        try {
          const hargaBeli = ing.harga_beli || 0;
          const stokBeli = ing.stok || 0; // Stok dalam satuan beli
          const nilai = stokBeli * hargaBeli;
          const isLow = stokBeli < (ing.stok_min || 0);
          const satuanBeli = ing.satuan_beli || ing.satuan || '';
          const hargaModal = ing.harga_modal || hargaBeli;
          const satuanProd = ing.satuan_prod || ing.satuan || satuanBeli;
          const isiProd = ing.isi_prod || 1;

          // Calculate production stock (total in production units)
          const stokProd = stokBeli * isiProd;

          // Calculate visual breakdown: whole units + remainder
          const wholeUnits = Math.floor(stokBeli);
          const remainderProd = Math.round((stokBeli - wholeUnits) * isiProd);
          const breakdownText = isiProd > 1 && satuanProd !== satuanBeli
            ? `${wholeUnits} ${satuanBeli}${remainderProd > 0 ? ` + ${remainderProd} ${satuanProd}` : ''} `
            : '';

          return `
            <tr class="${isLow ? 'bg-red-500/10' : ''}">
              <td class="px-4 py-3">
                <p class="font-medium">${ing.nama || 'Tanpa Nama'}</p>
                ${isiProd > 1 ? `<p class="text-xs text-gray-500">1 ${satuanBeli} = ${isiProd} ${satuanProd}</p>` : ''}
              </td>
              <td class="px-4 py-3 text-right">
                <p class="font-medium text-purple-400">${stokProd.toLocaleString('id-ID')} ${satuanProd}</p>
                <p class="text-xs text-gray-400">Stok Produksi</p>
              </td>
              <td class="px-4 py-3 text-right ${isLow ? 'text-red-400 font-bold' : ''}">
                <p>${stokBeli.toLocaleString('id-ID')} ${satuanBeli}</p>
                ${breakdownText ? `<p class="text-xs text-gray-500">(${breakdownText})</p>` : '<p class="text-xs text-gray-400">Stok Beli</p>'}
              </td>
              <td class="px-4 py-3 text-right">${formatCurrency(hargaBeli)}/${satuanBeli}</td>
              <td class="px-4 py-3 text-right text-green-400 font-medium">${formatCurrency(Math.round(hargaModal))}/${satuanProd}</td>
              <td class="px-4 py-3 text-right">${ing.stok_min || 0}</td>
              <td class="px-4 py-3 text-center">
                ${isLow ? '<span class="px-2 py-1 rounded-full bg-red-500/20 text-red-400 text-xs">âš ï¸ Rendah</span>' : '<span class="px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs">âœ“ OK</span>'}
              </td>
              <td class="px-4 py-3 text-center">
                <button onclick="editIngredient('${ing.id}')" class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs mr-1">âœï¸</button>
                <button onclick="addStock('${ing.id}')" class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs mr-1">ğŸ“¥</button>
                <button onclick="deleteIngredient('${ing.id}')" class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs">ğŸ—‘ï¸</button>
              </td>
            </tr>
      `;
        } catch (e) {
          console.error('Error rendering ingredient row:', e, ing);
          return '';
        }
      }).join('');
    }

    function updateInventoryStats() {
      try {
        const totalItems = (ingredients || []).length;
        const lowStock = (ingredients || []).filter(i => {
          const stok = i?.stok ?? 0;
          const min = i?.stok_min ?? 0;
          return stok < min;
        }).length;

        // Safe calculation with default values to prevent NaN
        const assetValue = (ingredients || []).reduce((sum, i) => {
          const stok = parseFloat(i?.stok) || 0;
          const harga = parseFloat(i?.harga_beli) || 0;
          return sum + (stok * harga);
        }, 0);

        const ppn = parseFloat(businessSettings?.tax) || 11;
        const assetWithPPN = assetValue * (1 + ppn / 100);

        const elTotal = document.getElementById('invTotalItems');
        const elLow = document.getElementById('invLowStock');
        const elAsset = document.getElementById('invAssetValue');
        const elPPN = document.getElementById('invAssetPPN');

        if (elTotal) elTotal.textContent = totalItems;
        if (elLow) elLow.textContent = lowStock;
        if (elAsset) elAsset.textContent = formatCurrency(isNaN(assetValue) ? 0 : assetValue);
        if (elPPN) elPPN.textContent = formatCurrency(isNaN(assetWithPPN) ? 0 : Math.round(assetWithPPN));
      } catch (err) {
        console.error('Error in updateInventoryStats:', err);
      }
    }

    function showInventoryTab(tab) {
      document.querySelectorAll('.inv-tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.inv-tab-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-primary');
        btn.classList.add('bg-surface');
      });

      const tabMap = { bahan: 'invTabBahan', opname: 'invTabOpname', riwayat: 'invTabRiwayat' };
      const container = document.getElementById(tabMap[tab]);
      if (container) container.classList.remove('hidden');

      const btn = document.querySelector(`.inv - tab - btn[data - tab="${tab}"]`);
      if (btn) {
        btn.classList.add('active', 'bg-primary');
        btn.classList.remove('bg-surface');
      }

      if (tab === 'opname') renderOpnameTable();
      if (tab === 'riwayat') renderStockHistory();
    }

    function renderIngredientTable(filter = '') {
      const container = document.getElementById('ingredientTable');
      if (!container) return;

      let filtered = ingredients;
      if (filter) {
        filtered = ingredients.filter(i => i.nama?.toLowerCase().includes(filter.toLowerCase()));
      }

      if (filtered.length === 0) {
        container.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">Belum ada bahan baku</td></tr>';
        return;
      }

      container.innerHTML = filtered.map(ing => {
        // Unit info
        const satuanBeli = ing.satuan_beli || ing.satuan || 'unit';
        const satuanProd = ing.satuan_prod || ing.satuan || satuanBeli;
        const isiProd = ing.isi_prod || 1;
        const useKonversi = isiProd > 1 && satuanProd !== satuanBeli;

        // Stock (Dual View)
        const stokBeli = ing.stok || 0;
        const stokProd = stokBeli * isiProd;

        // Prices
        const hargaBeli = ing.harga_beli || 0;
        const hargaModal = ing.harga_modal || (hargaBeli / isiProd) || 0;

        // Moving Average = Nilai Aset / Stok
        const nilaiAset = stokBeli * hargaBeli;
        const hargaRataRata = stokBeli > 0 ? nilaiAset / stokBeli : hargaBeli;

        // Last restock info for Tap-to-Reveal
        const lastRestock = stockHistory
          .filter(h => (h.ingId === ing.id || h.ing_id === ing.id) && h.type === 'restock')
          .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        const lastPrice = lastRestock ? formatCurrency(lastRestock.hargaBeli) : formatCurrency(hargaBeli);
        const lastDate = lastRestock ? lastRestock.date : '-';

        // Status
        const isLow = stokBeli < (ing.stok_min || 0);
        const isNegative = stokBeli < 0;
        const rowId = `row_${ing.id}`;

        return `
          <tr class="${isLow ? 'bg-red-500/10' : ''} hover:bg-surface/30">
            <!-- Kolom 1: Nama Bahan -->
            <td class="px-4 py-3">
              <p class="font-medium">${ing.nama || 'Tanpa Nama'}</p>
              ${useKonversi ? `<p class="text-xs text-gray-500">1 ${satuanBeli} = ${isiProd.toLocaleString('id-ID')} ${satuanProd}</p>` : ''}
            </td>
            <!-- Kolom 2: Stok (Dual View) -->
            <td class="px-4 py-3 text-right ${isNegative ? 'text-red-500 font-extrabold' : (isLow ? 'text-red-400' : '')}">
              <p class="font-bold">${stokBeli.toLocaleString('id-ID', { maximumFractionDigits: 2 })} ${satuanBeli}</p>
              ${useKonversi ? `<p class="text-xs text-purple-400">${stokProd.toLocaleString('id-ID')} ${satuanProd}</p>` : ''}
            </td>
            <!-- Kolom 3: Harga Beli (Tap-to-Reveal) -->
            <td class="px-4 py-3 text-right">
              <div class="relative inline-block">
                <p class="font-medium cursor-pointer" onclick="togglePriceInfo('${rowId}')">
                  ${formatCurrency(Math.round(hargaRataRata))}/${satuanBeli}
                  <span class="text-xs text-blue-400 ml-1">â“˜</span>
                </p>
                <div id="info_${rowId}" class="hidden absolute right-0 top-full mt-1 bg-surface border border-purple-500/30 rounded-lg p-2 text-xs z-20 whitespace-nowrap shadow-lg">
                  <p class="text-gray-400">Harga Terakhir:</p>
                  <p class="text-purple-300 font-medium">${lastPrice} (${lastDate})</p>
                </div>
              </div>
            </td>
            <!-- Kolom 4: Modal/Unit -->
            <td class="px-4 py-3 text-right">
              <p class="font-bold text-green-400">${formatCurrency(Math.round(hargaModal))}/${satuanProd}</p>
            </td>
            <!-- Kolom 5: Nilai Stok -->
            <td class="px-4 py-3 text-right">
              <p class="font-medium">${formatCurrency(Math.round(nilaiAset))}</p>
            </td>
            <!-- Kolom 6: Status -->
            <td class="px-4 py-3 text-center">
              ${isLow
            ? '<span class="px-2 py-1 rounded-full bg-red-500/20 text-red-400 text-xs">âš ï¸ Rendah</span>'
            : '<span class="px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs">âœ“ OK</span>'}
            </td>
            <!-- Kolom 7: Aksi -->
            <td class="px-4 py-3 text-center">
              <button onclick="editIngredient('${ing.id}')" class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs mr-1" title="Edit">âœï¸</button>
              <button onclick="addStock('${ing.id}')" class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs mr-1" title="Restock">ğŸ“¥</button>
              <button onclick="showStockHistoryModal('${ing.id}')" class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs mr-1" title="Riwayat">ğŸ“œ</button>
              <button onclick="deleteIngredient('${ing.id}')" class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs" title="Hapus">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Tap-to-Reveal for price info (auto-hide after 3s)
    function togglePriceInfo(rowId) {
      const info = document.getElementById('info_' + rowId);
      if (!info) return;

      // Hide all other price infos first
      document.querySelectorAll('[id^="info_row_"]').forEach(el => {
        if (el.id !== 'info_' + rowId) el.classList.add('hidden');
      });

      // Toggle current
      info.classList.toggle('hidden');

      // Auto-hide after 3 seconds
      if (!info.classList.contains('hidden')) {
        setTimeout(() => info.classList.add('hidden'), 3000);
      }
    }

    function searchIngredients() {
      const query = document.getElementById('ingredientSearch')?.value || '';
      renderIngredientTable(query);
    }

    function showAddIngredientModal() {
      const sortedUnits = [...customUnits].sort((a, b) => a.localeCompare(b));
      const unitOptions = sortedUnits.map(u => `<option value="${u}">${u}</option>`).join('');
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade max-h-[90vh] overflow-auto">
          <h3 class="text-xl font-bold mb-4">â• Tambah Bahan Baku</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Bahan</label>
              <input type="text" id="ingNama" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Contoh: Susu Kaleng">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">Stok Awal</label>
                <input type="number" id="ingStok" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="0">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Satuan Beli</label>
                <select id="ingSatuanBeli" class="input-field w-full px-4 py-2 rounded-lg text-white" onchange="updateIsiPerLabel()">
                  ${unitOptions}
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">Harga Beli (Rp)</label>
                <input type="number" id="ingHargaBeli" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Harga per satuan beli" oninput="calcModalDasar()">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Stok Minimum</label>
                <input type="number" id="ingMin" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="0">
              </div>
            </div>
            <!-- Checkbox Satuan Sama -->
            <div class="glass rounded-lg p-3">
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="ingSatuanSama" class="w-5 h-5 accent-purple-500" onchange="toggleSatuanSama()">
                <span class="text-sm">Satuan Beli & Produksi Sama</span>
              </label>
              <p class="text-xs text-gray-500 mt-1">Centang jika tidak perlu konversi (Isi per satuan = 1)</p>
            </div>
            <!-- Conversion Fields (Always Visible) -->
            <div id="konversiFields" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-gray-400 mb-1" id="labelIsiPer">Isi per Satuan Beli</label>
                  <input type="number" id="ingIsiProd" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Contoh: 250" value="1" oninput="calcModalDasar()">
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-1">Satuan Produksi</label>
                  <select id="ingSatuanProd" class="input-field w-full px-4 py-2 rounded-lg text-white" onchange="calcModalDasar()">
                    ${unitOptions}
                  </select>
                </div>
              </div>
            </div>
            <!-- Harga Modal Dasar Display -->
            <div class="glass rounded-lg p-3 bg-green-500/10">
              <p class="text-xs text-gray-400">Harga Modal Dasar (untuk Gramasi)</p>
              <p class="text-lg font-bold text-green-400" id="displayModalDasar">Rp 0 / unit</p>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveIngredient()" class="flex-1 btn-primary px-4 py-2 rounded-lg">Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      updateIsiPerLabel();
    }

    function showAddUnitModal() {
      const modal = document.createElement('div');
      modal.id = 'addUnitModal';
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">ğŸ“ Tambah Jenis Satuan</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Satuan Baru</label>
              <input type="text" id="newUnitName" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Contoh: Jerigen, Karung, Botol">
            </div>
            <div class="glass rounded-lg p-3 max-h-40 overflow-auto">
              <p class="text-xs text-gray-400 mb-2">Satuan yang ada: <span class="text-gray-500">(klik âœ• untuk hapus)</span></p>
              <div id="unitListContainer" class="flex flex-wrap gap-1">
                ${[...customUnits].sort().map(u => `
                  <span class="px-2 py-1 rounded bg-purple-500/20 text-xs flex items-center gap-1 group">
                    ${u}
                    <button onclick="deleteUnit('${u}')" class="text-red-400 hover:text-red-300 opacity-50 group-hover:opacity-100 transition-opacity" title="Hapus satuan">âœ•</button>
                  </span>
                `).join('')}
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveNewUnit()" class="flex-1 btn-primary px-4 py-2 rounded-lg">Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function deleteUnit(unitName) {
      // Check if unit is in use by any ingredient
      const inUse = ingredients.some(ing =>
        ing.satuan_beli === unitName ||
        ing.satuan_prod === unitName ||
        ing.satuan === unitName
      );

      if (inUse) {
        showToast(`Satuan "${unitName}" sedang digunakan oleh bahan baku!`, 'warning');
        return;
      }

      showConfirmModal({
        title: 'Hapus Satuan?',
        message: `Apakah Anda yakin ingin menghapus satuan "${unitName}"?`,
        confirmText: 'Hapus',
        type: 'danger',
        onConfirm: async () => {
          customUnits = customUnits.filter(u => u !== unitName);
          await saveToStorage();

          // Re-render the unit list in the modal
          const container = document.getElementById('unitListContainer');
          if (container) {
            container.innerHTML = [...customUnits].sort().map(u => `
              <span class="px-2 py-1 rounded bg-purple-500/20 text-xs flex items-center gap-1 group">
                ${u}
                <button onclick="deleteUnit('${u}')" class="text-red-400 hover:text-red-300 opacity-50 group-hover:opacity-100 transition-opacity" title="Hapus satuan">âœ•</button>
              </span>
            `).join('');
          }

          showToast(`Satuan "${unitName}" berhasil dihapus!`, 'success');
        }
      });
    }

    async function saveNewUnit() {
      const name = document.getElementById('newUnitName')?.value?.trim();
      if (!name) { showToast('Nama satuan harus diisi!', 'warning'); return; }
      if (customUnits.includes(name.toLowerCase()) || customUnits.includes(name)) {
        showToast('Satuan sudah ada!', 'warning'); return;
      }
      customUnits.push(name);
      customUnits.sort((a, b) => a.localeCompare(b));
      await saveToStorage();
      document.querySelector('.fixed')?.remove();
      showToast(`Satuan "${name}" berhasil ditambahkan!`, 'success');
    }

    function updateIsiPerLabel() {
      const satuanBeli = document.getElementById('ingSatuanBeli')?.value || 'Satuan';
      const label = document.getElementById('labelIsiPer');
      if (label) label.textContent = `Isi per ${satuanBeli} `;
      calcModalDasar();
    }

    function toggleSatuanSama() {
      const checked = document.getElementById('ingSatuanSama')?.checked;
      const isiInput = document.getElementById('ingIsiProd');
      const satuanProdSelect = document.getElementById('ingSatuanProd');
      const satuanBeli = document.getElementById('ingSatuanBeli')?.value;

      if (checked) {
        if (isiInput) { isiInput.value = 1; isiInput.disabled = true; }
        if (satuanProdSelect && satuanBeli) {
          satuanProdSelect.value = satuanBeli;
          satuanProdSelect.disabled = true;
        }
      } else {
        if (isiInput) isiInput.disabled = false;
        if (satuanProdSelect) satuanProdSelect.disabled = false;
      }
      calcModalDasar();
    }

    function toggleKonversi() {
      // Legacy function, kept for compatibility
      calcModalDasar();
    }

    function calcModalDasar() {
      const hargaBeli = parseFloat(document.getElementById('ingHargaBeli')?.value) || 0;
      const useKonversi = document.getElementById('ingKonversi')?.checked;
      const isiProd = parseFloat(document.getElementById('ingIsiProd')?.value) || 1;
      const satuanBeli = document.getElementById('ingSatuanBeli')?.value || '';
      const satuanProd = document.getElementById('ingSatuanProd')?.value || satuanBeli;

      let hargaModal = hargaBeli;
      let unitLabel = satuanBeli;

      if (useKonversi && isiProd > 0) {
        hargaModal = hargaBeli / isiProd;
        unitLabel = satuanProd;
      }

      const display = document.getElementById('displayModalDasar');
      if (display) {
        display.textContent = `${formatCurrency(Math.round(hargaModal))} / ${unitLabel}`;
      }
    }

    async function saveIngredient() {
      const nama = document.getElementById('ingNama').value.trim();
      const stok = parseFloat(document.getElementById('ingStok').value) || 0;
      const satuan_beli = document.getElementById('ingSatuanBeli').value;
      const harga_beli = parseFloat(document.getElementById('ingHargaBeli').value) || 0;
      const stok_min = parseFloat(document.getElementById('ingMin').value) || 0;
      const satuanSama = document.getElementById('ingSatuanSama')?.checked || false;
      const isi_prod = parseFloat(document.getElementById('ingIsiProd').value) || 1;
      const satuan_prod = document.getElementById('ingSatuanProd').value || satuan_beli;

      if (!nama) { showToast('Nama bahan harus diisi!', 'warning'); return; }
      if (harga_beli <= 0) { showToast('Harga beli harus diisi!', 'warning'); return; }

      // === LOADING STATE: Disable button instead of closing modal ===
      const btn = document.querySelector('.fixed button[onclick="saveIngredient()"]');
      const restoreBtn = setButtonLoading(btn);

      // Determine if conversion is used (when isi_prod != 1 or satuan differs)
      const use_konversi = !satuanSama && (isi_prod !== 1 || satuan_prod !== satuan_beli);

      // Calculate harga_modal (base cost per production unit)
      const harga_modal = isi_prod > 0 ? (harga_beli / isi_prod) : harga_beli;

      const newIng = {
        id: 'ing_' + generateId(),
        nama,
        stok, // Stok in satuan_beli
        satuan_beli,
        harga_beli,
        stok_min,
        use_konversi,
        isi_prod,
        satuan_prod,
        harga_modal,
        satuan: satuan_prod // production unit for backwards compat
      };

      try {
        ingredients.push(newIng);
        logStockMovement(newIng.id, 'in', stok, 'Stok awal');

        // Call APIs for MongoDB sync
        if (USE_REMOTE_DB) {
          await apiCreateIngredient(newIng);
          const stockEntry = stockHistory[stockHistory.length - 1];
          if (stockEntry) await apiCreateStockHistory(stockEntry);
        }
        await saveToStorage();

        // SUCCESS: Close modal and render
        document.querySelector('.fixed')?.remove();
        renderInventory();
        showToast('Bahan baku berhasil ditambahkan!', 'success');
      } catch (err) {
        // ERROR: Restore button, rollback, show error
        restoreBtn();
        // Rollback the push
        const idx = ingredients.findIndex(i => i.id === newIng.id);
        if (idx > -1) ingredients.splice(idx, 1);
        console.error('Error saving ingredient:', err);
        showToast('Gagal menyimpan: ' + (err?.message || err), 'error');
      }
    }

    // ===== RESTOCK WITH MOVING AVERAGE =====
    let currentRestockId = null;

    function addStock(id) {
      showRestockModal(id);
    }

    function showRestockModal(id) {
      console.log('showRestockModal called with id:', id);
      const ing = ingredients.find(i => i.id === id || i.id === 'ing_' + id);
      console.log('Found ingredient:', ing);
      if (!ing) {
        showToast('Bahan tidak ditemukan!', 'error');
        return;
      }

      currentRestockId = id;
      const satuanBeli = ing.satuan_beli || ing.satuan || 'unit';
      const satuanProd = ing.satuan_prod || ing.satuan || satuanBeli;
      const isiProd = ing.isi_prod || 1;
      const stokProd = (ing.stok || 0) * isiProd;
      const hargaModal = ing.harga_modal || (ing.harga_beli / isiProd) || 0;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.id = 'restockModal';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade max-h-[90vh] overflow-auto">
          <h3 class="text-xl font-bold mb-4">ğŸ“¥ Restock: ${ing.nama}</h3>
          <div class="space-y-4">
            <!-- Current Stock Info -->
            <div class="glass rounded-lg p-4 bg-blue-500/10">
              <p class="text-sm text-gray-400 mb-2">ğŸ“Š Stok Saat Ini</p>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-xs text-gray-500">Stok (Satuan Beli)</p>
                  <p class="font-bold text-blue-400">${(ing.stok || 0).toLocaleString('id-ID')} ${satuanBeli}</p>
                </div>
                <div>
                  <p class="text-xs text-gray-500">Stok (Produksi)</p>
                  <p class="font-bold text-purple-400">${stokProd.toLocaleString('id-ID')} ${satuanProd}</p>
                </div>
              </div>
              <div class="mt-2 pt-2 border-t border-white/10">
                <p class="text-xs text-gray-500">Harga Modal Saat Ini</p>
                <p class="font-bold text-green-400">${formatCurrency(Math.round(hargaModal))} / ${satuanProd}</p>
              </div>
            </div>

            <!-- Restock Input -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">ğŸ“¦ Jumlah Restock</label>
                <input type="number" id="restockQty" class="input-field w-full px-4 py-2 rounded-lg text-white" 
                       placeholder="0" min="0" step="0.01" oninput="calculateRestockPreview()">
                <p class="text-xs text-gray-500 mt-1">${satuanBeli}</p>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">ğŸ’° Harga Beli Baru</label>
                <input type="number" id="restockPrice" class="input-field w-full px-4 py-2 rounded-lg text-white" 
                       placeholder="${ing.harga_beli || 0}" value="${ing.harga_beli || ''}" min="0" oninput="calculateRestockPreview()">
                <p class="text-xs text-gray-500 mt-1">Rp / ${satuanBeli}</p>
              </div>
            </div>

            <!-- Preview Calculation -->
            <div class="glass rounded-lg p-4 bg-gradient-to-r from-green-500/10 to-purple-500/10" id="restockPreview">
              <p class="text-sm font-medium mb-2">ğŸ”„ Preview Perhitungan</p>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <p class="text-xs text-gray-500">Modal Lama</p>
                  <p class="font-medium text-yellow-400" id="previewOldModal">${formatCurrency(Math.round(hargaModal))}/${satuanProd}</p>
                </div>
                <div>
                  <p class="text-xs text-gray-500">Modal Baru</p>
                  <p class="font-bold text-green-400" id="previewNewModal">-</p>
                </div>
              </div>
              <div class="mt-3 pt-3 border-t border-white/10">
                <p class="text-xs text-gray-400" id="previewSummary">Masukkan jumlah dan harga untuk melihat perubahan.</p>
              </div>
            </div>

            <!-- Hidden data -->
            <input type="hidden" id="restockIngId" value="${id}">
            <input type="hidden" id="restockIsiProd" value="${isiProd}">
            <input type="hidden" id="restockSatuanProd" value="${satuanProd}">
            <input type="hidden" id="restockOldStock" value="${ing.stok || 0}">
            <input type="hidden" id="restockOldModal" value="${hargaModal}">
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveRestock()" class="flex-1 btn-primary px-4 py-2 rounded-lg">ğŸ’¾ Simpan Restock</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function calculateRestockPreview() {
      const qty = parseFloat(document.getElementById('restockQty')?.value) || 0;
      const price = parseFloat(document.getElementById('restockPrice')?.value) || 0;
      const isiProd = parseFloat(document.getElementById('restockIsiProd')?.value) || 1;
      const oldStock = parseFloat(document.getElementById('restockOldStock')?.value) || 0;
      const oldModal = parseFloat(document.getElementById('restockOldModal')?.value) || 0;
      const satuanProd = document.getElementById('restockSatuanProd')?.value || 'unit';

      const previewNewModal = document.getElementById('previewNewModal');
      const previewSummary = document.getElementById('previewSummary');

      if (qty <= 0 || price <= 0) {
        if (previewNewModal) previewNewModal.textContent = '-';
        if (previewSummary) previewSummary.textContent = 'Masukkan jumlah dan harga untuk melihat perubahan.';
        return;
      }

      // Calculate new stock in production units
      const oldStockProd = oldStock * isiProd;
      const newStockProd = qty * isiProd;
      const totalStockProd = oldStockProd + newStockProd;

      // Calculate new price per production unit
      const newPricePerProd = price / isiProd;

      // Moving Average: (oldValue + newValue) / totalQty
      const oldValue = oldStockProd * oldModal;
      const newValue = newStockProd * newPricePerProd;
      const newModal = totalStockProd > 0 ? (oldValue + newValue) / totalStockProd : newPricePerProd;

      if (previewNewModal) {
        previewNewModal.textContent = `${formatCurrency(Math.round(newModal))}/${satuanProd}`;
      }

      if (previewSummary) {
        const change = newModal - oldModal;
        const changeText = change >= 0 ? `naik Rp ${Math.abs(Math.round(change))}` : `turun Rp ${Math.abs(Math.round(change))}`;
        previewSummary.innerHTML = `<span class="text-purple-300">Harga modal akan ${changeText} per ${satuanProd}</span>`;
      }
    }

    async function saveRestock() {
      const id = document.getElementById('restockIngId')?.value;
      const qty = parseFloat(document.getElementById('restockQty')?.value) || 0;
      const price = parseFloat(document.getElementById('restockPrice')?.value) || 0;
      const isiProd = parseFloat(document.getElementById('restockIsiProd')?.value) || 1;

      if (!id) { showToast('ID bahan tidak ditemukan!', 'error'); return; }
      if (qty <= 0) { showToast('Jumlah restock harus lebih dari 0!', 'warning'); return; }
      if (price <= 0) { showToast('Harga beli harus lebih dari 0!', 'warning'); return; }

      const ing = ingredients.find(i => i.id === id);
      if (!ing) { showToast('Bahan tidak ditemukan!', 'error'); return; }

      try {
        const oldStock = ing.stok || 0;
        const oldModal = ing.harga_modal || (ing.harga_beli / isiProd) || 0;

        // Calculate new values
        const oldStockProd = oldStock * isiProd;
        const newStockProd = qty * isiProd;
        const totalStockProd = oldStockProd + newStockProd;
        const newPricePerProd = price / isiProd;
        const oldValue = oldStockProd * oldModal;
        const newValue = newStockProd * newPricePerProd;
        const newModal = totalStockProd > 0 ? (oldValue + newValue) / totalStockProd : newPricePerProd;

        // Update ingredient
        ing.stok = oldStock + qty; // Stock in satuan_beli
        ing.harga_modal = newModal;
        ing.harga_beli = price; // Update last purchase price

        // Log to stock history
        const historyEntry = {
          id: generateId(),
          ingId: id,
          ingName: ing.nama,
          date: getCurrentDate(),
          qty: qty,
          hargaBeli: price,
          modalLama: oldModal,
          modalBaru: newModal,
          stokSebelum: oldStock,
          stokSesudah: ing.stok,
          type: 'restock'
        };
        stockHistory.push(historyEntry);

        // Save to storage/API
        if (USE_REMOTE_DB) {
          await apiUpdateIngredient(id, ing);
          await apiCreateStockHistory(historyEntry);
        }
        await saveToStorage();

        // Close modal and refresh
        document.getElementById('restockModal')?.remove();
        renderInventory();
        showToast(`Restock ${ing.nama} berhasil! Modal baru: ${formatCurrency(Math.round(newModal))}`, 'success');
      } catch (err) {
        showToast('Gagal menyimpan restock: ' + err.message, 'error');
      }
    }

    function showStockHistoryModal(id) {
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;

      const history = stockHistory.filter(h => h.ingId === id).sort((a, b) => new Date(b.date) - new Date(a.date));
      const satuanBeli = ing.satuan_beli || ing.satuan || 'unit';
      const satuanProd = ing.satuan_prod || ing.satuan || satuanBeli;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-lg w-full animate-fade max-h-[90vh] overflow-auto">
          <h3 class="text-xl font-bold mb-4">ğŸ“œ Riwayat Restock: ${ing.nama}</h3>
          <div class="space-y-3">
            ${history.length === 0 ? '<p class="text-gray-400 text-center py-4">Belum ada riwayat restock</p>' : history.map(h => `
              <div class="glass rounded-lg p-3 bg-surface/50">
                <div class="flex justify-between items-start mb-2">
                  <span class="text-xs text-gray-400">${h.date}</span>
                  <span class="px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs">${h.type || 'restock'}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div>
                    <p class="text-xs text-gray-500">Jumlah Beli</p>
                    <p class="font-medium">${h.qty} ${satuanBeli}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">Harga Beli</p>
                    <p class="font-medium text-blue-400">${formatCurrency(h.hargaBeli)}/${satuanBeli}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">Modal Lama</p>
                    <p class="text-yellow-400">${formatCurrency(Math.round(h.modalLama))}/${satuanProd}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">Modal Baru</p>
                    <p class="text-green-400 font-bold">${formatCurrency(Math.round(h.modalBaru))}/${satuanProd}</p>
                  </div>
                </div>
                <div class="mt-2 pt-2 border-t border-white/10 text-xs text-gray-400">
                  Stok: ${h.stokSebelum} â†’ ${h.stokSesudah} ${satuanBeli}
                </div>
              </div>
            `).join('')}
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Tutup</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function editIngredient(id) {
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">âœï¸ Edit Bahan Baku</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Bahan</label>
              <input type="text" id="editIngNama" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${ing.nama}">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">Harga Beli/Unit (Rp)</label>
                <input type="number" id="editIngHarga" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${ing.harga_beli}">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Stok Minimum</label>
                <input type="number" id="editIngMin" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${ing.stok_min || 0}">
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="updateIngredient('${id}')" class="flex-1 btn-primary px-4 py-2 rounded-lg">Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function updateIngredient(id) {
      const ing = ingredients.find(i => i.id === id);
      if (!ing) {
        showToast('Bahan tidak ditemukan!', 'error');
        return;
      }

      const nama = document.getElementById('editIngNama')?.value?.trim();
      const harga = parseFloat(document.getElementById('editIngHarga')?.value) || 0;
      const stokMin = parseFloat(document.getElementById('editIngMin')?.value) || 0;

      if (!nama) {
        showToast('Nama bahan harus diisi!', 'warning');
        return;
      }

      // âœ… CLOSE MODAL FIRST for better UX
      closeAllModals();
      showToast('Menyimpan perubahan...', 'info');

      ing.nama = nama;
      ing.harga_beli = harga;
      ing.stok_min = stokMin;

      try {
        await saveToStorage();
        renderInventory();
        showToast('Bahan baku berhasil diupdate!', 'success');
      } catch (err) {
        console.error('Error updating ingredient:', err);
        showToast('Gagal menyimpan: ' + err.message, 'error');
      } finally {
        ensureSidebarVisible();
      }
    }

    // NOTE: addStock function moved to line ~3836 with showRestockModal

    function deleteIngredient(id) {
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;

      showConfirmModal({
        title: 'Hapus Bahan?',
        message: `Apakah Anda yakin ingin menghapus bahan <b>${ing.nama}</b>? Tindakan ini tidak dapat dibatalkan.`,
        confirmText: 'Hapus',
        type: 'danger',
        onConfirm: async () => {
          showToast('Menghapus bahan...', 'info');
          try {
            // Delete from local array
            ingredients = ingredients.filter(i => i.id !== id);

            // Call API to delete from database
            if (USE_REMOTE_DB) {
              try {
                await apiDeleteIngredient(id);
              } catch (apiErr) {
                console.warn('API delete failed, continuing with local delete:', apiErr);
              }
            }

            await saveToStorage();
            renderInventory();
            showToast('Bahan baku berhasil dihapus!', 'success');
          } catch (err) {
            showToast('Gagal menghapus: ' + err.message, 'error');
          }
        }
      });
    }

    function logStockMovement(ing_id, type, qty, note = '') {
      stockHistory.push({
        id: generateId(),
        ing_id,
        type,
        qty,
        note,
        date: getCurrentDate(),
        time: getCurrentTime(),
        timestamp: Date.now()
      });
    }

    // Stock Opname
    function renderOpnameTable() {
      const container = document.getElementById('opnameTable');
      if (!container) return;

      if (ingredients.length === 0) {
        container.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Belum ada bahan baku</td></tr>';
        return;
      }

      container.innerHTML = ingredients.map(ing => {
        const satuanBeli = ing.satuan_beli || ing.satuan || '';
        const satuanProd = ing.satuan_prod || ing.satuan || satuanBeli;
        const isiProd = ing.isi_prod || 1;
        const stokBeli = ing.stok || 0; // Stok is stored in satuan_beli
        const stokProd = stokBeli * isiProd; // Total production units

        // Calculate breakdown for display
        const wholeUnits = Math.floor(stokBeli);
        const remainderProd = Math.round((stokBeli - wholeUnits) * isiProd);
        const breakdownText = isiProd > 1 && satuanProd !== satuanBeli
          ? `(${wholeUnits} ${satuanBeli}${remainderProd > 0 ? ` + ${remainderProd} ${satuanProd}` : ''})`
          : '';

        return `
          <tr>
            <td class="px-4 py-3">
              <p class="font-medium">${ing.nama}</p>
              ${isiProd > 1 ? `<p class="text-xs text-gray-500">1 ${satuanBeli} = ${isiProd} ${satuanProd}</p>` : ''}
            </td>
            <td class="px-4 py-3 text-right">
              <p class="font-medium">${stokBeli.toLocaleString('id-ID', { maximumFractionDigits: 2 })} ${satuanBeli}</p>
              ${breakdownText ? `<p class="text-xs text-gray-500">${breakdownText}</p>` : ''}
              <p class="text-xs text-purple-400">${stokProd.toLocaleString('id-ID')} ${satuanProd}</p>
            </td>
            <td class="px-4 py-3 text-right">
              <input type="number" step="0.01" class="opname-input input-field w-24 px-2 py-1 rounded text-white text-right" 
                     data-id="${ing.id}" data-isi="${isiProd}" data-satuan-beli="${satuanBeli}" 
                     placeholder="${stokBeli}">
              <p class="text-xs text-gray-500 mt-1">${satuanBeli}</p>
            </td>
            <td class="px-4 py-3 text-right opname-diff" data-id="${ing.id}">-</td>
            <td class="px-4 py-3 text-right opname-value" data-id="${ing.id}">-</td>
          </tr>
        `;
      }).join('');

      // Add input listeners for live calculation
      document.querySelectorAll('.opname-input').forEach(input => {
        input.addEventListener('input', calculateOpnameDiff);
      });
    }

    function calculateOpnameDiff(e) {
      const ingId = e.target.dataset.id;
      const ing = ingredients.find(i => i.id === ingId);
      if (!ing) return;

      const fisik = parseFloat(e.target.value) || 0;
      const selisih = fisik - ing.stok;
      const nilaiSelisih = selisih * ing.harga_beli;

      const diffCell = document.querySelector(`.opname-diff[data-id="${ingId}"]`);
      const valueCell = document.querySelector(`.opname-value[data-id="${ingId}"]`);

      if (diffCell) {
        diffCell.textContent = selisih >= 0 ? `+${selisih}` : selisih;
        diffCell.className = `px-4 py-3 text-right opname-diff ${selisih < 0 ? 'text-red-400' : selisih > 0 ? 'text-green-400' : ''}`;
      }
      if (valueCell) {
        valueCell.textContent = formatCurrency(nilaiSelisih);
        valueCell.className = `px-4 py-3 text-right opname-value ${nilaiSelisih < 0 ? 'text-red-400' : nilaiSelisih > 0 ? 'text-green-400' : ''}`;
      }
    }

    async function saveStockOpname() {
      const inputs = document.querySelectorAll('.opname-input');
      let adjustments = 0;

      inputs.forEach(input => {
        const ingId = input.dataset.id;
        const fisik = parseFloat(input.value);
        if (isNaN(fisik)) return;

        const ing = ingredients.find(i => i.id === ingId);
        if (!ing) return;

        const selisih = fisik - ing.stok;
        if (selisih !== 0) {
          logStockMovement(ingId, 'opname', selisih, `Opname: ${ing.stok} â†’ ${fisik}`);
          ing.stok = fisik;
          adjustments++;
        }
      });

      if (adjustments > 0) {
        try {
          await saveToStorage();
          renderInventory();
          showToast(`Stock opname selesai! ${adjustments} item disesuaikan.`, 'success');
        } catch (err) {
          showToast('Gagal menyimpan opname: ' + err.message, 'error');
        }
      } else {
        showToast('Tidak ada perubahan stok.', 'info');
      }
    }

    // Stock History
    function renderStockHistory(filter = 'all') {
      const container = document.getElementById('stockHistoryList');
      if (!container) return;

      let filtered = stockHistory;
      if (filter !== 'all') {
        filtered = stockHistory.filter(h => h.type === filter);
      }

      filtered.sort((a, b) => b.timestamp - a.timestamp);

      if (filtered.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">Belum ada riwayat stok</div>';
        return;
      }

      container.innerHTML = filtered.slice(0, 50).map(h => {
        const ing = ingredients.find(i => i.id === h.ing_id);
        const typeColors = { in: 'text-green-400', out: 'text-red-400', opname: 'text-yellow-400' };
        const typeLabels = { in: 'ğŸ“¥ Masuk', out: 'ğŸ“¤ Keluar', opname: 'ğŸ“ Opname' };
        return `
          <div class="p-4 flex items-center justify-between hover:bg-surface/30">
            <div>
              <p class="font-medium">${ing?.nama || 'Bahan dihapus'}</p>
              <p class="text-xs text-gray-400">${h.date} ${h.time}</p>
              <p class="text-xs text-gray-500">${h.note || '-'}</p>
            </div>
            <div class="text-right">
              <span class="${typeColors[h.type] || ''}">${typeLabels[h.type] || h.type}</span>
              <p class="font-bold ${h.qty >= 0 ? 'text-green-400' : 'text-red-400'}">${h.qty >= 0 ? '+' : ''}${h.qty}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterStockHistory() {
      const filter = document.getElementById('stockHistoryFilter')?.value || 'all';
      renderStockHistory(filter);
    }

    // Auto-depletion: reduce stock when order is completed
    // âœ… FIX: Convert from satuan_prod (gram, ml) to satuan_beli (kg, galon) before deducting
    function depleteStockForOrder(order) {
      order.items.forEach(item => {
        const recipe = recipes[item.id] || [];
        recipe.forEach(r => {
          const ing = ingredients.find(i => i.id === r.ing_id);
          if (ing) {
            // r.jumlah is in satuan_prod (e.g., grams, ml)
            const qtyProduksi = r.jumlah * item.quantity;

            // isi_prod = how many production units in 1 purchase unit
            // e.g., 1 kg = 1000 gram, so isi_prod = 1000
            const isiProd = ing.isi_prod || 1;

            // Convert to satuan_beli (e.g., kg, galon)
            // If recipe uses 200ml and 1 galon = 19000ml, deduct 200/19000 = 0.0105 galon
            const qtyBeli = qtyProduksi / isiProd;

            ing.stok -= qtyBeli;
            logStockMovement(ing.id, 'out', -qtyBeli, `Pesanan: ${order.customerName} (${qtyProduksi} ${ing.satuan_prod || ing.satuan || 'unit'})`);
          }
        });
      });
    }

    // Calculate HPP for a menu item based on its recipe
    // âœ… FIX: Use harga_modal (per production unit) since r.jumlah is in satuan_prod
    function calculateMenuHPP(menuId) {
      const recipe = recipes[menuId] || [];
      return recipe.reduce((sum, r) => {
        const ing = ingredients.find(i => i.id === r.ing_id);
        if (!ing) return sum;

        // harga_modal = cost per production unit (e.g., per gram, per ml)
        // If not set, calculate from harga_beli / isi_prod
        const isiProd = ing.isi_prod || 1;
        const hargaModal = ing.harga_modal || (ing.harga_beli / isiProd) || 0;

        return sum + (hargaModal * r.jumlah);
      }, 0);
    }

    // ===== FINANCE SECTION =====
    function renderFinance() {
      updateFinanceStats();
      renderFinanceList();
    }

    function updateFinanceStats() {
      const cashIn = cashTransactions
        .filter(t => t.type === 'in')
        .reduce((sum, t) => sum + t.amount, 0);

      const cashOut = cashTransactions
        .filter(t => t.type === 'out')
        .reduce((sum, t) => sum + t.amount, 0);

      const balance = cashIn - cashOut;

      document.getElementById('financeCashIn').textContent = formatCurrency(cashIn);
      document.getElementById('financeCashOut').textContent = formatCurrency(cashOut);
      document.getElementById('financeBalance').textContent = formatCurrency(balance);
    }

    function showAddCashModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full">
          <h3 class="text-xl font-bold mb-4">â• Tambah Transaksi Kas</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Tipe</label>
              <select id="newCashType" class="input-field w-full px-4 py-2 rounded-lg text-white">
                <option value="in">Kas Masuk</option>
                <option value="out">Kas Keluar</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Jumlah (Rp)</label>
              <input type="number" id="newCashAmount" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="0">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Kategori</label>
              <select id="newCashCategory" class="input-field w-full px-4 py-2 rounded-lg text-white">
                <option value="sales">Penjualan</option>
                <option value="purchase">Pembelian Bahan</option>
                <option value="salary">Gaji</option>
                <option value="rent">Sewa</option>
                <option value="utility">Utilitas</option>
                <option value="other">Lainnya</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Keterangan</label>
              <textarea id="newCashDesc" class="input-field w-full px-4 py-2 rounded-lg text-white" rows="3" placeholder="Deskripsi transaksi..."></textarea>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">
              Batal
            </button>
            <button onclick="saveCashTransaction()" class="flex-1 btn-primary px-4 py-2 rounded-lg">
              Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveCashTransaction() {
      const type = document.getElementById('newCashType').value;
      const amount = parseFloat(document.getElementById('newCashAmount').value) || 0;
      const category = document.getElementById('newCashCategory').value;
      const description = document.getElementById('newCashDesc').value;

      if (amount <= 0) {
        showToast('Jumlah harus lebih dari 0!', 'warning');
        return;
      }

      if (!description.trim()) {
        showToast('Keterangan harus diisi!', 'warning');
        return;
      }

      const transaction = {
        id: generateId(),
        type,
        amount,
        category,
        description: description.trim(),
        date: getCurrentDate(),
        time: getCurrentTime()
      };

      cashTransactions.push(transaction);
      saveToStorage();
      renderFinance();
      document.querySelector('.fixed')?.remove();
      showToast('Transaksi berhasil ditambahkan!', 'success');
      updateAllStats();
    }

    function filterFinanceList() {
      const filter = document.getElementById('financeFilter').value;
      renderFinanceList(filter);
    }

    function renderFinanceList(filter = 'all') {
      const container = document.getElementById('financeList');
      if (!container) { console.warn('renderFinanceList: #financeList not found'); return; }

      let filtered = cashTransactions;
      if (filter !== 'all') {
        filtered = cashTransactions.filter(t => t.type === filter);
      }

      filtered.sort((a, b) => b.date.localeCompare(a.date));

      if (filtered.length === 0) {
        safeSet(container, '<div class="p-8 text-center text-gray-400">Belum ada transaksi</div>');
        initEventListeners();
        return;
      }

      safeSet(container, filtered.map(transaction => {
        const isIncome = transaction.type === 'in';
        return `
          <div class="p-4 flex items-center gap-4 hover:bg-surface/30">
            <div class="w-12 h-12 rounded-xl ${isIncome ? 'bg-green-500/20' : 'bg-red-500/20'} flex items-center justify-center">
              <span class="text-2xl">${isIncome ? 'ğŸ“¥' : 'ğŸ“¤'}</span>
            </div>
            <div class="flex-1">
              <p class="font-bold">${transaction.description}</p>
              <p class="text-xs text-gray-400">${transaction.date} â€¢ ${transaction.time}</p>
              <p class="text-xs text-purple-400 capitalize">${transaction.category}</p>
            </div>
            <div class="text-right">
              <p class="font-bold ${isIncome ? 'text-green-400' : 'text-red-400'}">
                ${isIncome ? '+' : '-'} ${formatCurrency(transaction.amount)}
              </p>
            </div>
          </div>
        `;
      }).join(''));
      initEventListeners();
    }

    // ===== EMPLOYEE SECTION =====

    // Load employees from server API (avoids localStorage for heavy Base64 data)
    async function loadEmployeesFromServer() {
      if (!USE_REMOTE_DB || !API_BASE) return;

      try {
        const response = await fetch(`${API_BASE}/api/employees`, {
          headers: { 'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY }
        });
        if (response.ok) {
          employees = await response.json();
          console.log(`Loaded ${employees.length} employees from server`);
        }
      } catch (err) {
        console.error('Failed to load employees from server:', err);
      }
    }

    function renderEmployees() {
      const container = document.getElementById('employeeGrid');
      if (!container) { console.warn('renderEmployees: #employeeGrid not found'); return; }

      // Filter active employees only (Soft Delete)
      const activeEmployees = employees.filter(e => e.isActive !== false);

      if (activeEmployees.length === 0) {
        safeSet(container, '<div class="col-span-full p-8 text-center text-gray-400">Belum ada data pegawai</div>');
        initEventListeners();
        return;
      }

      safeSet(container, activeEmployees.map(emp => `
        <div class="glass rounded-xl p-4 card-hover relative group">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl overflow-hidden border-2 border-purple-500/30">
              ${emp.photo ? `<img src="${emp.photo}" class="w-full h-full object-cover">` : 'ğŸ‘¤'}
            </div>
            <div class="flex-1">
              <h4 class="font-bold">${emp.name}</h4>
              <p class="text-xs text-gray-400">${emp.position || emp.role || ''}</p>
              <span class="text-xs px-2 py-0.5 rounded-full ${emp.role === 'admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-green-500/20 text-green-400'}">${emp.role === 'admin' ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ Kasir'}</span>
              ${emp.ktp ? `<button onclick="viewEmployeeKTP('${emp.id}')" class="text-xs text-purple-400 hover:text-purple-300 ml-2">ğŸªª KTP</button>` : ''}
            </div>
          </div>
          <!-- LOGIN CREDENTIALS: Visible for admin to help employees who forget -->
          <div class="bg-surface/50 rounded-lg p-2 mb-3 border border-purple-500/20">
            <p class="text-xs text-gray-500 mb-1">ğŸ” Info Login:</p>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>
                <span class="text-gray-400 text-xs">Username:</span>
                <p class="font-mono text-purple-300">${emp.username || '-'}</p>
              </div>
              <div>
                <span class="text-gray-400 text-xs">${emp.role === 'admin' ? 'Password:' : 'PIN:'}</span>
                <p class="font-mono ${emp.role === 'admin' ? 'text-gray-500' : 'text-yellow-400 font-bold'}">${emp.role === 'admin' ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : (emp.pin || '-')}</p>
              </div>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-gray-400">ğŸ“</span>
              <span>${emp.phone || '-'}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-400">ğŸ’°</span>
              <span class="text-green-400 font-bold">${formatCurrency(emp.salary || 0)}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-400">ğŸ“…</span>
              <span>${emp.joinDate || '-'}</span>
            </div>
          </div>
          <div class="flex gap-2 mt-4">
            <button onclick="editEmployee('${emp.id}')" class="flex-1 px-3 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 text-sm">
              âœï¸ Edit
            </button>
            <button onclick="deleteEmployee('${emp.id}')" class="flex-1 px-3 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 text-sm">
              ğŸ—‘ï¸ Hapus
            </button>
          </div>
        </div>
      `).join(''));
      initEventListeners();
    }

    // View employee KTP in modal
    function viewEmployeeKTP(empId) {
      const emp = employees.find(e => e.id === empId);
      if (!emp || !emp.ktp) {
        showToast('KTP tidak tersedia', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.onclick = function (e) { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="glass rounded-2xl p-4 max-w-2xl w-full animate-fade">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">ğŸªª KTP - ${emp.name}</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">âœ•</button>
          </div>
          <img src="${emp.ktp}" class="w-full rounded-lg">
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showAddEmployeeModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-auto">
          <h3 class="text-xl font-bold mb-4">â• Tambah Pegawai</h3>
          <div class="space-y-4">
            <!-- Foto Profil Upload -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">ğŸ“· Foto Profil</label>
                <div class="flex flex-col items-center">
                  <div id="empPhotoPreview" class="w-20 h-20 rounded-full bg-surface border-2 border-purple-500/30 flex items-center justify-center overflow-hidden mb-2">
                    <span class="text-3xl">ğŸ‘¤</span>
                  </div>
                  <input type="file" id="newEmpPhoto" accept="image/*" class="hidden" onchange="previewEmpPhoto(this, 'empPhotoPreview')">
                  <button type="button" onclick="document.getElementById('newEmpPhoto').click()" 
                    class="px-3 py-1 rounded-lg bg-purple-500/20 text-purple-400 text-xs hover:bg-purple-500/30">
                    Pilih Foto
                  </button>
                </div>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">ğŸªª Foto KTP</label>
                <div class="flex flex-col items-center">
                  <div id="empKtpPreview" class="w-24 h-16 rounded-lg bg-surface border-2 border-purple-500/30 flex items-center justify-center overflow-hidden mb-2">
                    <span class="text-xl">ğŸªª</span>
                  </div>
                  <input type="file" id="newEmpKtp" accept="image/*" class="hidden" onchange="previewEmpPhoto(this, 'empKtpPreview')">
                  <button type="button" onclick="document.getElementById('newEmpKtp').click()" 
                    class="px-3 py-1 rounded-lg bg-purple-500/20 text-purple-400 text-xs hover:bg-purple-500/30">
                    Pilih KTP
                  </button>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Lengkap *</label>
              <input type="text" id="newEmpName" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Nama sesuai KTP"
                oninput="document.getElementById('newEmpUsername').value = this.value.toLowerCase().split(' ')[0].replace(/[^a-z0-9_]/g,'')">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">Posisi/Jabatan *</label>
                <input type="text" id="newEmpPosition" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Contoh: Barista">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">No. Telepon</label>
                <input type="tel" id="newEmpPhone" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="08xxxxxxxxxx">
              </div>
            </div>
            <!-- NEW: Username, PIN & Role for POS Security -->
            <div class="glass rounded-lg p-3 bg-purple-500/10 border border-purple-500/30">
              <p class="text-sm text-purple-300 font-bold mb-3">ğŸ” Login & Keamanan POS</p>
              <div class="mb-3">
                <label class="block text-sm text-gray-400 mb-1">Username (untuk login) *</label>
                <input type="text" id="newEmpUsername" 
                  class="input-field w-full px-4 py-2 rounded-lg text-white lowercase" 
                  placeholder="contoh: budi, kasir1"
                  oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9_]/g,'')">
                <p class="text-xs text-gray-500 mt-1">Huruf kecil, angka, garis bawah saja</p>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-gray-400 mb-1">PIN Login (6 digit) *</label>
                  <input type="text" id="newEmpPin" maxlength="6" 
                    class="input-field w-full px-4 py-2 rounded-lg text-white text-center tracking-widest font-mono" 
                    placeholder="000000" value="${String(Math.floor(100000 + Math.random() * 900000))}"
                    oninput="this.value = this.value.replace(/\\D/g,'').slice(0,6)">
                  <p class="text-xs text-gray-500 mt-1">PIN 6 digit untuk login</p>
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-1">Role/Level *</label>
                  <select id="newEmpRole" class="input-field w-full px-4 py-2 rounded-lg text-white">
                    <option value="kasir">ğŸ‘¤ Kasir</option>
                    <option value="admin">ğŸ‘‘ Admin</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">Admin = akses penuh</p>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">Gaji (Rp)</label>
                <input type="number" id="newEmpSalary" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="0">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Tanggal Bergabung</label>
                <input type="date" id="newEmpDate" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${getCurrentDate()}">
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="closeAllModals()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">
              Batal
            </button>
            <button onclick="saveEmployee()" class="flex-1 btn-primary px-4 py-2 rounded-lg">
              ğŸ’¾ Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Preview image for employee photo/KTP
    function previewEmpPhoto(input, previewId) {
      const file = input.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showToast('File harus berupa gambar!', 'error');
        return;
      }

      if (file.size > 2 * 1024 * 1024) {
        showToast('Ukuran file maksimal 2MB!', 'warning');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const preview = document.getElementById(previewId);
        if (preview) {
          preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
          preview.dataset.base64 = e.target.result;
        }
      };
      reader.readAsDataURL(file);
    }

    async function saveEmployee() {
      const name = document.getElementById('newEmpName')?.value;
      const position = document.getElementById('newEmpPosition')?.value;
      const phone = document.getElementById('newEmpPhone')?.value;
      const salary = parseFloat(document.getElementById('newEmpSalary')?.value) || 0;
      const joinDate = document.getElementById('newEmpDate')?.value;

      // NEW: Get username, PIN and role for POS security
      const username = document.getElementById('newEmpUsername')?.value?.trim()?.toLowerCase();
      const pin = document.getElementById('newEmpPin')?.value;
      const role = document.getElementById('newEmpRole')?.value || 'kasir';

      // Get photo and KTP Base64 from preview elements
      const photoPreview = document.getElementById('empPhotoPreview');
      const ktpPreview = document.getElementById('empKtpPreview');
      const photo = photoPreview?.dataset?.base64 || '';
      const ktp = ktpPreview?.dataset?.base64 || '';

      if (!name?.trim()) {
        showToast('Nama harus diisi!', 'warning');
        return;
      }

      if (!position?.trim()) {
        showToast('Posisi harus diisi!', 'warning');
        return;
      }

      // Username validation
      if (!username) {
        showToast('Username harus diisi!', 'warning');
        return;
      }

      if (username === 'admin') {
        showToast('Username "admin" tidak boleh digunakan!', 'warning');
        return;
      }

      if (employees.some(e => e.username?.toLowerCase() === username)) {
        showToast('Username sudah digunakan pegawai lain!', 'warning');
        return;
      }

      // PIN validation
      if (!pin || pin.length !== 6) {
        showToast('PIN harus 6 digit!', 'warning');
        return;
      }

      // Check PIN uniqueness
      if (employees.some(e => e.pin === pin)) {
        showToast('PIN sudah digunakan pegawai lain!', 'warning');
        return;
      }

      // === LOADING STATE ===
      const btn = document.querySelector('.fixed button[onclick="saveEmployee()"]');
      const restoreBtn = setButtonLoading(btn);

      const newEmployee = {
        id: generateId(),
        name: name.trim(),
        position: position.trim(),
        phone: phone?.trim() || '',
        salary,
        joinDate: joinDate || getCurrentDate(),
        photo,  // Base64 photo string
        ktp,    // Base64 KTP string
        // POS Security fields
        username,
        pin,
        role,
        isActive: true
      };

      // âœ… SERVER-ONLY STORAGE: Send to API, don't save to localStorage
      try {
        if (USE_REMOTE_DB && API_BASE) {
          const response = await fetch(`${API_BASE}/api/employees`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY
            },
            body: JSON.stringify(newEmployee)
          });

          if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(errData.error || `Server error: ${response.status}`);
          }

          // SUCCESS: Close modal
          closeAllModals();
          await loadEmployeesFromServer();
          renderEmployees();
          showToast('Pegawai berhasil ditambahkan!', 'success');
        } else {
          // Fallback: Save to local array only (no Base64 to localStorage)
          closeAllModals();
          employees.push(newEmployee);
          renderEmployees();
          showToast('Pegawai disimpan lokal (mode offline)', 'success');
        }
      } catch (err) {
        restoreBtn(); // Re-enable button on error
        console.error('Error saving employee:', err);
        showToast('Gagal menyimpan: ' + err.message, 'error');
      } finally {
        ensureSidebarVisible();
      }
    }

    function editEmployee(id) {
      const emp = employees.find(e => e.id === id);
      if (!emp) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full">
          <h3 class="text-xl font-bold mb-4">âœï¸ Edit Pegawai</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama Lengkap</label>
              <input type="text" id="editEmpName" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${emp.name}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Posisi/Jabatan</label>
              <input type="text" id="editEmpPosition" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${emp.position}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">No. Telepon</label>
              <input type="tel" id="editEmpPhone" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${emp.phone}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Gaji (Rp)</label>
              <input type="number" id="editEmpSalary" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${emp.salary}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Tanggal Bergabung</label>
              <input type="date" id="editEmpDate" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${emp.joinDate}">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">
              Batal
            </button>
            <button onclick="updateEmployee('${id}')" class="flex-1 btn-primary px-4 py-2 rounded-lg">
              Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function updateEmployee(id) {
      const name = document.getElementById('editEmpName').value;
      const position = document.getElementById('editEmpPosition').value;
      const phone = document.getElementById('editEmpPhone').value;
      const salary = parseFloat(document.getElementById('editEmpSalary').value) || 0;
      const joinDate = document.getElementById('editEmpDate').value;

      if (!name.trim() || !position.trim()) {
        showToast('Data tidak valid!', 'warning');
        return;
      }

      const emp = employees.find(e => e.id === id);
      if (emp) {
        emp.name = name.trim();
        emp.position = position.trim();
        emp.phone = phone.trim();
        emp.salary = salary;
        emp.joinDate = joinDate;

        saveToStorage();
        renderEmployees();
        document.querySelector('.fixed')?.remove();
        showToast('Data pegawai berhasil diupdate!', 'success');
      }
    }

    function deleteEmployee(id) {
      const emp = employees.find(e => e.id === id);
      if (!emp) return;

      showConfirmModal({
        title: 'Hapus Pegawai?',
        message: `Apakah Anda yakin ingin menghapus pegawai <b>${emp.name}</b>? Data yang dihapus tidak dapat dikembalikan secara permanen.`,
        confirmText: 'Ya, Hapus',
        type: 'danger',
        onConfirm: async () => {
          showToast('Menghapus pegawai...', 'info');
          try {
            // Soft Delete: Update server first
            if (USE_REMOTE_DB) {
              await apiUpdateEmployee(id, { ...emp, isActive: false });
            }

            // Update local state: Mark as inactive instead of removing
            employees = employees.map(e => e.id === id ? { ...e, isActive: false } : e);

            saveToStorage();
            renderEmployees();
            showToast('Pegawai berhasil dihapus!', 'success');
          } catch (err) {
            console.error('Error deleting employee:', err);
            showToast('Gagal menghapus: ' + err.message, 'error');
          } finally {
            ensureSidebarVisible();
          }
        }
      });
    }

    // ===== FINANCE SECTION =====
    function renderFinance() {
      updateFinanceStats();
      renderFinanceList();
    }

    function updateFinanceStats() {
      // Calculate cash in/out from cashTransactions AND orders
      let cashIn = 0;
      let cashOut = 0;

      // From manual cash transactions
      cashTransactions.forEach(t => {
        if (t.type === 'in') cashIn += t.amount || 0;
        else cashOut += t.amount || 0;
      });

      // From orders (Sales = Cash In)
      orders.forEach(o => {
        if (o.status !== 'cancelled') {
          cashIn += o.total || 0;
        }
      });

      const balance = cashIn - cashOut;

      document.getElementById('financeCashIn').textContent = formatCurrency(cashIn);
      document.getElementById('financeCashOut').textContent = formatCurrency(cashOut);
      document.getElementById('financeBalance').textContent = formatCurrency(balance);
    }

    function renderFinanceList(filter = 'all') {
      const container = document.getElementById('financeList');
      if (!container) { console.warn('renderFinanceList: #financeList not found'); return; }

      // Merge manual transactions with order-based sales
      let allTransactions = [];

      // Add orders as "Sales" transactions
      orders.forEach(o => {
        if (o.status !== 'cancelled') {
          allTransactions.push({
            id: o.id,
            type: 'in',
            source: 'order',
            description: `Pesanan ${o.customerName || 'Walk-in'} - ${o.id}`,
            amount: o.total || 0,
            date: o.date || '',
            time: o.time || '',
            timestamp: o.timestamp || 0,
            category: 'Sales'
          });
        }
      });

      // Add manual cash transactions
      cashTransactions.forEach(t => {
        allTransactions.push({
          ...t,
          source: 'manual'
        });
      });

      // Sort by timestamp descending
      allTransactions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

      // Apply filter
      if (filter !== 'all') {
        allTransactions = allTransactions.filter(t => t.type === filter);
      }

      if (allTransactions.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">Belum ada transaksi</div>';
        return;
      }

      container.innerHTML = allTransactions.slice(0, 50).map(t => {
        const isIn = t.type === 'in';
        const icon = isIn ? 'ğŸ“¥' : 'ğŸ“¤';
        const colorClass = isIn ? 'text-green-400' : 'text-red-400';
        const signPrefix = isIn ? '+' : '-';
        const isManual = t.source === 'manual';

        return `
          <div class="p-4 flex items-center gap-4 hover:bg-surface/30 group">
            <div class="w-10 h-10 rounded-lg ${isIn ? 'bg-green-500/20' : 'bg-red-500/20'} flex items-center justify-center">
              <span class="text-lg">${icon}</span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-medium truncate">${t.description || t.category || 'Transaksi'}</p>
              <p class="text-xs text-gray-400">${t.date || ''} â€¢ ${t.time || ''}</p>
              <p class="text-xs text-gray-500">${t.category || (isIn ? 'Sales' : 'Expense')}</p>
            </div>
            <div class="text-right">
              <p class="font-bold ${colorClass}">${signPrefix} ${formatCurrency(t.amount)}</p>
            </div>
            ${isManual ? `
              <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="editCashTransaction('${t.id}')" 
                  class="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 flex items-center justify-center text-sm"
                  title="Edit">âœï¸</button>
                <button onclick="deleteCashTransaction('${t.id}')" 
                  class="w-8 h-8 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 flex items-center justify-center text-sm"
                  title="Hapus">ğŸ—‘ï¸</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function filterFinanceList() {
      const filter = document.getElementById('financeFilter')?.value || 'all';
      renderFinanceList(filter);
    }

    function editCashTransaction(id) {
      const tx = cashTransactions.find(t => t.id === id);
      if (!tx) { showToast('Transaksi tidak ditemukan', 'error'); return; }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.id = 'editCashModal';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">âœï¸ Edit Transaksi</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Jenis</label>
              <select id="editTxType" class="input-field w-full px-4 py-2 rounded-lg text-white">
                <option value="in" ${tx.type === 'in' ? 'selected' : ''}>ğŸ“¥ Kas Masuk</option>
                <option value="out" ${tx.type === 'out' ? 'selected' : ''}>ğŸ“¤ Kas Keluar</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Deskripsi</label>
              <input type="text" id="editTxDesc" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${tx.description || ''}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Jumlah (Rp)</label>
              <input type="number" id="editTxAmount" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${tx.amount || 0}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Kategori</label>
              <input type="text" id="editTxCategory" class="input-field w-full px-4 py-2 rounded-lg text-white" value="${tx.category || ''}">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="document.getElementById('editCashModal').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveCashTransactionEdit('${id}')" class="flex-1 btn-primary px-4 py-2 rounded-lg">ğŸ’¾ Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveCashTransactionEdit(id) {
      const type = document.getElementById('editTxType')?.value;
      const description = document.getElementById('editTxDesc')?.value;
      const amount = parseFloat(document.getElementById('editTxAmount')?.value) || 0;
      const category = document.getElementById('editTxCategory')?.value;

      if (amount <= 0) { showToast('Jumlah harus lebih dari 0!', 'warning'); return; }

      // Update local
      const idx = cashTransactions.findIndex(t => t.id === id);
      if (idx !== -1) {
        cashTransactions[idx] = { ...cashTransactions[idx], type, description, amount, category };
      }

      // Update server
      if (USE_REMOTE_DB) {
        try {
          await apiUpdateCash(id, cashTransactions[idx]);
        } catch (e) { console.warn('API update failed:', e); }
      }

      document.getElementById('editCashModal')?.remove();
      saveToStorage();
      renderFinance();
      showToast('Transaksi berhasil diperbarui!', 'success');
    }

    function deleteCashTransaction(id) {
      showConfirmModal({
        title: 'Hapus Transaksi?',
        message: 'Apakah Anda yakin ingin menghapus riwayat transaksi ini?',
        confirmText: 'Hapus',
        type: 'danger',
        onConfirm: () => {
          cashTransactions = cashTransactions.filter(t => t.id !== id);

          if (USE_REMOTE_DB) {
            apiDeleteCash(id).catch(e => console.warn('API delete failed:', e));
          }

          saveToStorage();
          renderFinance();
          showToast('Transaksi berhasil dihapus!', 'success');
        }
      });
    }

    // ===== TABLE MANAGEMENT =====
    function initializeTables() {
      if (tables.length === 0) {
        // Create default tables
        for (let i = 1; i <= 10; i++) {
          tables.push({
            number: i.toString(),
            status: 'available',
            orderId: null
          });
        }
        saveToStorage();
      }
    }

    function renderTables() {
      const container = document.getElementById('adminTableGrid');
      if (!container) { console.warn('renderTables: #adminTableGrid not found'); return; }

      // Sync table status with active orders first
      syncTableStatusWithOrders();

      container.innerHTML = tables.map(table => {
        const statusColors = {
          available: 'bg-green-500/20 border-green-500/50',
          occupied: 'bg-red-500/20 border-red-500/50',
          reserved: 'bg-yellow-500/20 border-yellow-500/50'
        };
        const statusIcons = {
          available: 'âœ…',
          occupied: 'ğŸ”´',
          reserved: 'â°'
        };
        const statusLabels = {
          available: 'Tersedia',
          occupied: 'Terisi',
          reserved: 'Reservasi'
        };

        return `
          <div class="glass rounded-xl p-4 border-2 ${statusColors[table.status]} card-hover text-center relative group">
            <button onclick="deleteTable('${table.number}')" 
              class="absolute top-1 right-1 w-6 h-6 rounded-full bg-red-500/20 text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500/40">
              âœ•
            </button>
            <div class="text-3xl mb-1">${statusIcons[table.status]}</div>
            <h3 class="text-xl font-bold">${table.number}</h3>
            <p class="text-xs text-gray-400 mb-2">${statusLabels[table.status]}</p>
            ${table.status === 'occupied' && table.orderId ? `
              <button onclick="viewTableOrder('${table.orderId}')" class="w-full px-2 py-1 rounded bg-purple-500/20 text-purple-400 hover:bg-purple-500/40 text-xs mb-1">
                ğŸ“‹ Pesanan
              </button>
            ` : ''}
            <button onclick="changeTableStatus('${table.number}')" class="w-full px-2 py-1 rounded bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 text-xs">
              ğŸ”„ Status
            </button>
          </div>
        `;
      }).join('');
    }

    // Sync table status based on active orders
    function syncTableStatusWithOrders() {
      // Reset all tables to available first (except reserved)
      tables.forEach(table => {
        if (table.status !== 'reserved') {
          table.status = 'available';
          table.orderId = null;
        }
      });

      // Check active orders (new or processing) and mark tables as occupied
      orders.forEach(order => {
        if ((order.status === 'new' || order.status === 'processing') && order.tableNumber) {
          const table = tables.find(t => t.number === order.tableNumber.toString());
          if (table) {
            table.status = 'occupied';
            table.orderId = order.id;
          }
        }
      });
    }

    function showAddTableModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">â• Tambah Meja Baru</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nomor/Nama Meja</label>
              <input type="text" id="newTableNumber" class="input-field w-full px-4 py-2 rounded-lg text-white" 
                placeholder="Contoh: 11, VIP-1, Outdoor-A" value="${tables.length + 1}">
              <p class="text-xs text-gray-500 mt-1">Bisa berupa angka atau nama khusus</p>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Status Awal</label>
              <select id="newTableStatus" class="input-field w-full px-4 py-2 rounded-lg text-white">
                <option value="available">âœ… Tersedia</option>
                <option value="reserved">â° Reservasi</option>
              </select>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="closeAllModals()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">
              Batal
            </button>
            <button onclick="saveNewTable()" class="flex-1 btn-primary px-4 py-2 rounded-lg">
              ğŸ’¾ Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveNewTable() {
      const number = document.getElementById('newTableNumber')?.value?.trim();
      const status = document.getElementById('newTableStatus')?.value || 'available';

      if (!number) {
        showToast('Nomor meja harus diisi!', 'warning');
        return;
      }

      // Check if table number already exists
      if (tables.find(t => t.number === number)) {
        showToast('Meja dengan nomor tersebut sudah ada!', 'warning');
        return;
      }

      // Close modal first
      closeAllModals();
      showToast('Menambahkan meja...', 'info');

      try {
        tables.push({
          number,
          status,
          orderId: null
        });
        saveToStorage();
        renderTables();
        showToast(`Meja ${number} berhasil ditambahkan!`, 'success');
      } catch (err) {
        console.error('Error saving table:', err);
        showToast('Gagal menyimpan: ' + err.message, 'error');
      } finally {
        ensureSidebarVisible();
      }
    }

    function deleteTable(tableNumber) {
      const table = tables.find(t => t.number === tableNumber);
      if (!table) return;

      if (table.status === 'occupied') {
        showToast('Tidak bisa menghapus meja yang sedang terisi!', 'warning');
        return;
      }

      showConfirmModal({
        title: 'Hapus Meja?',
        message: `Apakah Anda yakin ingin menghapus <b>Meja ${tableNumber}</b>?`,
        confirmText: 'Hapus',
        type: 'danger',
        onConfirm: () => {
          showToast('Menghapus meja...', 'info');
          try {
            tables = tables.filter(t => t.number !== tableNumber);
            saveToStorage();
            renderTables();
            showToast(`Meja ${tableNumber} berhasil dihapus!`, 'success');
          } catch (err) {
            console.error('Error deleting table:', err);
            showToast('Gagal menghapus: ' + err.message, 'error');
          } finally {
            ensureSidebarVisible();
          }
        }
      });
    }

    function addNewTable() {
      // Redirect to modal
      showAddTableModal();
    }

    function changeTableStatus(tableNumber) {
      const table = tables.find(t => t.number === tableNumber);
      if (!table) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full">
          <h3 class="text-xl font-bold mb-4">ğŸ”„ Ubah Status Meja ${tableNumber}</h3>
          <div class="space-y-3">
            <button onclick="updateTableStatus('${tableNumber}', 'available')" class="w-full px-4 py-3 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/40 flex items-center justify-center gap-2">
              âœ… Tersedia
            </button>
            <button onclick="updateTableStatus('${tableNumber}', 'occupied')" class="w-full px-4 py-3 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 flex items-center justify-center gap-2">
              ğŸ”´ Terisi
            </button>
            <button onclick="updateTableStatus('${tableNumber}', 'reserved')" class="w-full px-4 py-3 rounded-lg bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/40 flex items-center justify-center gap-2">
              â° Reservasi
            </button>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">
            Batal
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function updateTableStatus(tableNumber, newStatus) {
      const table = tables.find(t => t.number === tableNumber);
      if (!table) return;

      if (table.status === 'occupied' && newStatus === 'available') {
        showConfirmModal({
          title: 'Meja Masih Terisi',
          message: `Meja <b>${tableNumber}</b> saat ini memiliki pesanan aktif. Mengubah status ke Tersedia akan memutus kaitan meja dengan pesanan tersebut. Lanjutkan?`,
          confirmText: 'Lanjutkan',
          type: 'warning',
          onConfirm: () => {
            table.orderId = null;
            table.status = newStatus;
            saveToStorage();
            renderTables();
            document.querySelector('.fixed')?.remove();
            showToast('Status meja berhasil diubah!', 'success');
          }
        });
        return;
      }

      table.status = newStatus;
      saveToStorage();
      renderTables();
      document.querySelector('.fixed')?.remove();
      showToast('Status meja berhasil diubah!', 'success');
    }

    function viewTableOrder(orderId) {
      if (orderId) {
        viewOrderDetail(orderId);
      }
    }

    // ===== REPORTS SECTION =====
    // ===== REPORTS SECTION =====
    async function renderReports() {
      // Fetch latest shift data first
      try {
        const serverShifts = await apiCall('/api/shifts');
        if (serverShifts && Array.isArray(serverShifts)) {
          shifts = serverShifts;
          saveToStorage(); // Optional: update local cache
        }
      } catch (e) { console.warn('Failed to fetch shifts:', e); }

      updateReportStats();
      renderSalesChart();
      renderTopProducts();
      renderShiftHistory();
    }

    // Render shift history in reports
    function renderShiftHistory() {
      const container = document.getElementById('shiftHistoryTable');
      if (!container) return;

      if (shifts.length === 0) {
        container.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">Belum ada riwayat shift</td></tr>';
        return;
      }

      // Sort by start time descending
      const sortedShifts = [...shifts].sort((a, b) =>
        new Date(b.startTime) - new Date(a.startTime)
      );

      container.innerHTML = sortedShifts.slice(0, 20).map(shift => {
        const isOpen = shift.status === 'OPEN';
        // Variance logic: negative is BAD (Missing money), positive is OK/Surplus, 0 is perfect.
        // BE CAREFUL: variance calculated as (Actual - Expected). 
        // If variance < 0 (Red), if variance > 0 (Green), if 0 (Green/Neutral)
        const variance = shift.variance || 0;
        const hasVariance = variance !== 0;

        let statusClass = 'bg-gray-500/20 text-gray-400';
        let statusText = shift.status;

        if (isOpen) {
          statusClass = 'bg-blue-500/20 text-blue-400';
          statusText = 'ğŸ”“ BUKA';
        } else {
          if (variance < 0) {
            statusClass = 'bg-red-500/20 text-red-400';
            statusText = 'âŒ SELISIH';
          } else if (variance > 0) {
            statusClass = 'bg-yellow-500/20 text-yellow-400';
            statusText = 'ğŸ’° LEBIH';
          } else {
            statusClass = 'bg-green-500/20 text-green-400';
            statusText = 'âœ… KLOP';
          }
        }

        const dateStr = new Date(shift.startTime).toLocaleString('id-ID', {
          day: '2-digit', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });

        const omzet = (shift.endCash || 0) - (shift.startCash || 0); // Rough estimate if totalSales not stored
        // Better: use expectedCash - startCash if available, or just show start/end

        return `
          <tr class="border-b border-purple-500/10 hover:bg-purple-500/5 transition-colors group">
            <td class="px-4 py-3 text-sm font-medium whitespace-nowrap">${dateStr}</td>
            <td class="px-4 py-3 text-gray-300">
               <div class="flex items-center gap-2">
                 <div class="w-6 h-6 rounded-full bg-surface flex items-center justify-center text-xs">ğŸ‘¤</div>
                 ${shift.employeeName || shift.employeeId}
               </div>
            </td>
            <td class="px-4 py-3 text-right text-gray-400">${formatCurrency(shift.startCash)}</td>
            <td class="px-4 py-3 text-right font-bold text-white">${formatCurrency(shift.expectedCash || 0)}</td>
            <td class="px-4 py-3 text-right text-gray-300">${isOpen ? '-' : formatCurrency(shift.endCash || 0)}</td>
            <td class="px-4 py-3 text-right ${variance < 0 ? 'text-red-400 font-bold' : (variance > 0 ? 'text-green-400' : 'text-gray-500')}">
               ${isOpen ? '-' : formatCurrency(variance)}
            </td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 rounded-full text-xs font-bold ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <div class="flex gap-1 justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="editShiftHistory('${shift.id || shift._id}')" 
                  class="w-7 h-7 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 flex items-center justify-center text-sm"
                  title="Edit">âœï¸</button>
                <button onclick="deleteShiftHistory('${shift.id || shift._id}')" 
                  class="w-7 h-7 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 flex items-center justify-center text-sm"
                  title="Hapus">ğŸ—‘ï¸</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Edit shift history entry
    function editShiftHistory(shiftId) {
      const shift = shifts.find(s => (s.id || s._id) === shiftId);
      if (!shift) { showToast('Shift tidak ditemukan!', 'error'); return; }

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.id = 'editShiftModal';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">âœï¸ Edit Riwayat Shift</h3>
          <p class="text-sm text-gray-400 mb-4">Kasir: ${shift.employeeName || shift.employeeId}</p>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Modal Awal (Rp)</label>
              <input type="number" id="editShiftStartCash" class="input-field w-full px-4 py-2 rounded-lg text-white" 
                value="${shift.startCash || 0}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Uang Fisik Akhir (Rp)</label>
              <input type="number" id="editShiftEndCash" class="input-field w-full px-4 py-2 rounded-lg text-white" 
                value="${shift.endCash || 0}">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Catatan</label>
              <textarea id="editShiftNotes" rows="2" class="input-field w-full px-4 py-2 rounded-lg text-white"
                >${shift.notes || ''}</textarea>
            </div>
          </div>
          
          <div class="flex gap-2 mt-6">
            <button onclick="document.getElementById('editShiftModal').remove()" 
              class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveShiftEdit('${shiftId}')" 
              class="flex-1 btn-primary px-4 py-2 rounded-lg">ğŸ’¾ Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Save shift edit
    async function saveShiftEdit(shiftId) {
      const startCash = parseFloat(document.getElementById('editShiftStartCash')?.value) || 0;
      const endCash = parseFloat(document.getElementById('editShiftEndCash')?.value) || 0;
      const notes = document.getElementById('editShiftNotes')?.value || '';

      // Update local
      const idx = shifts.findIndex(s => (s.id || s._id) === shiftId);
      if (idx !== -1) {
        shifts[idx].startCash = startCash;
        shifts[idx].endCash = endCash;
        shifts[idx].notes = notes;
        // Recalculate variance
        const expected = shifts[idx].expectedCash || startCash;
        shifts[idx].variance = endCash - expected;
      }

      // Update backend
      if (USE_REMOTE_DB) {
        try {
          await fetch(`${API_BASE}/api/shifts/${shiftId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify({ startCash, endCash, notes, variance: shifts[idx]?.variance })
          });
        } catch (e) { console.warn('Failed to update shift on server:', e); }
      }

      document.getElementById('editShiftModal')?.remove();
      saveToStorage();
      renderShiftHistory();
      showToast('Shift berhasil diperbarui!', 'success');
    }

    // Delete shift history entry
    async function deleteShiftHistory(shiftId) {
      showConfirmModal({
        title: 'Hapus Riwayat Shift?',
        message: 'Apakah Anda yakin ingin menghapus riwayat shift ini? Data yang dihapus tidak dapat dikembalikan.',
        confirmText: 'Hapus',
        type: 'danger',
        onConfirm: async () => {
          // Remove from local
          shifts = shifts.filter(s => (s.id || s._id) !== shiftId);

          // Delete from backend
          if (USE_REMOTE_DB) {
            try {
              await fetch(`${API_BASE}/api/shifts/${shiftId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
              });
            } catch (e) { console.warn('Failed to delete shift from server:', e); }
          }

          saveToStorage();
          renderShiftHistory();
          showToast('Riwayat shift berhasil dihapus!', 'success');
        }
      });
    }

    // Export shift report to Excel
    function exportShiftReport() {
      if (typeof XLSX === 'undefined') {
        showToast('Library Excel tidak tersedia! Reload halaman.', 'error');
        return;
      }

      if (shifts.length === 0) {
        showToast('Tidak ada data shift untuk diekspor!', 'warning');
        return;
      }

      const data = shifts.map(s => ({
        'Waktu Mulai': new Date(s.startTime).toLocaleString('id-ID'),
        'Waktu Selesai': s.endTime ? new Date(s.endTime).toLocaleString('id-ID') : 'Masih Buka',
        'Kasir': s.employeeName || s.employeeId,
        'Modal Awal': s.startCash,
        'Total (Sistem)': s.expectedCash || 0,
        'Uang Fisik': s.endCash || 0,
        'Selisih': s.variance || 0,
        'Catatan': s.notes || '',
        'Status': s.status
      }));

      try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Riwayat Shift');
        XLSX.writeFile(wb, `Laporan_Shift_${getCurrentDate()}.xlsx`);
        showToast('Laporan shift berhasil diunduh!', 'success');
      } catch (err) {
        console.error('Error exporting shift report:', err);
        showToast('Gagal mengekspor: ' + err.message, 'error');
      }
    }

    // Export all transactions to Excel
    function exportTransactionsReport() {
      if (typeof XLSX === 'undefined') {
        showToast('Library Excel tidak tersedia!', 'error');
        return;
      }

      if (orders.length === 0) {
        showToast('Tidak ada data transaksi!', 'warning');
        return;
      }

      const data = orders.map(o => ({
        'ID Pesanan': o.id || '',
        'Tanggal': o.date || '',
        'Waktu': o.timestamp ? new Date(o.timestamp).toLocaleTimeString('id-ID') : '',
        'Pelanggan': o.customerName || 'Walk-in',
        'Meja': o.tableNumber || '-',
        'Items': o.items?.map(i => `${i.name} x${i.quantity}`).join(', ') || '',
        'Subtotal': o.subtotal || 0,
        'Pajak': o.tax || 0,
        'Total': o.total || 0,
        'Metode Bayar': o.paymentMethod || 'cash',
        'Status': o.status || 'completed'
      }));

      try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Transaksi');
        XLSX.writeFile(wb, `Laporan_Transaksi_${getCurrentDate()}.xlsx`);
        showToast('Laporan transaksi berhasil diunduh!', 'success');
      } catch (err) {
        console.error('Error exporting transactions:', err);
        showToast('Gagal mengekspor: ' + err.message, 'error');
      }
    }

    function updateReportStats() {
      const today = getCurrentDate();
      const todayOrders = orders.filter(o => o.date === today);
      const todaySales = todayOrders.reduce((sum, o) => sum + o.total, 0);

      const totalOrders = orders.length;
      const totalSales = orders.reduce((sum, o) => sum + o.total, 0);
      const totalProfit = orders.reduce((sum, o) => sum + (o.profit || 0), 0);

      document.getElementById('reportRevenue').textContent = formatCurrency(todaySales);
      document.getElementById('reportOrders').textContent = todayOrders.length;
      document.getElementById('reportTotalProfit').textContent = formatCurrency(totalProfit);

      const maleCount = orders.filter(o => o.gender === 'male').length;
      const femaleCount = orders.filter(o => o.gender === 'female').length;
      document.getElementById('reportMale').textContent = maleCount;
      document.getElementById('reportFemale').textContent = femaleCount;
    }

    function renderSalesChart() {
      const container = document.getElementById('salesChart');
      if (!container) { console.warn('renderSalesChart: #salesChart not found'); return; }

      // Get last 7 days
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
      }

      const salesByDay = days.map(day => {
        const dayOrders = orders.filter(o => o.date === day);
        return dayOrders.reduce((sum, o) => sum + o.total, 0);
      });

      const maxSales = Math.max(...salesByDay, 1);

      container.innerHTML = days.map((day, index) => {
        const height = (salesByDay[index] / maxSales) * 100;
        const dayName = new Date(day).toLocaleDateString('id-ID', { weekday: 'short' });

        return `
          <div class="flex flex-col items-center gap-2">
            <div class="text-xs text-gray-400">${formatCurrency(salesByDay[index])}</div>
            <div class="w-full h-32 bg-surface/30 rounded-lg flex items-end overflow-hidden">
              <div class="w-full bg-gradient-to-t from-purple-500 to-blue-500 transition-all" style="height: ${height}%"></div>
            </div>
            <div class="text-xs text-gray-400">${dayName}</div>
          </div>
        `;
      }).join('');
    }

    function renderTopProducts() {
      const container = document.getElementById('topMenuChart');

      // Count product sales
      const productCount = {};
      orders.forEach(order => {
        order.items.forEach(item => {
          if (!productCount[item.name]) {
            productCount[item.name] = { count: 0, revenue: 0 };
          }
          productCount[item.name].count += item.quantity;
          productCount[item.name].revenue += item.price * item.quantity;
        });
      });

      const sorted = Object.entries(productCount)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 5);

      if (sorted.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">Belum ada data penjualan</div>';
        return;
      }

      container.innerHTML = sorted.map(([name, data], index) => `
        <div class="flex items-center gap-4 p-3 hover:bg-surface/30 rounded-lg">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center font-bold">
            ${index + 1}
          </div>
          <div class="flex-1">
            <p class="font-bold">${name}</p>
            <p class="text-xs text-gray-400">${data.count} terjual</p>
          </div>
          <div class="text-right">
            <p class="font-bold text-purple-400">${formatCurrency(data.revenue)}</p>
          </div>
        </div>
      `).join('');
    }

    function downloadReport() {
      const reportData = {
        generatedAt: new Date().toISOString(),
        summary: {
          totalOrders: orders.length,
          totalSales: orders.reduce((sum, o) => sum + o.total, 0),
          totalProfit: orders.reduce((sum, o) => sum + (o.profit || 0), 0)
        },
        orders: orders,
        menuItems: menuItems,
        employees: employees,
        cashTransactions: cashTransactions
      };

      const dataStr = JSON.stringify(reportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `warkop-report-${getCurrentDate()}.json`;
      link.click();
      URL.revokeObjectURL(url);

      showToast('Laporan berhasil didownload!', 'success');
    }

    // ===== CUSTOMERS SECTION =====
    function renderCustomers() {
      updateCustomerStats();
      renderCustomerList();
    }

    function updateCustomerStats() {
      // Get unique customers from orders
      const uniqueCustomers = new Set(orders.map(o => o.customerName));
      const totalCustomers = uniqueCustomers.size;

      const maleCount = orders.filter(o => o.gender === 'male').length;
      const femaleCount = orders.filter(o => o.gender === 'female').length;

      document.getElementById('totalCustomers').textContent = totalCustomers;
      document.getElementById('activeMembers').textContent = totalCustomers; // Simplified
      document.getElementById('totalPoints').textContent = totalCustomers * 100; // Dummy
      document.getElementById('activeVouchers').textContent = 0; // Dummy
    }

    function renderCustomerList() {
      const container = document.getElementById('customerList');

      // Group orders by customer
      const customerData = {};
      orders.forEach(order => {
        if (!customerData[order.customerName]) {
          customerData[order.customerName] = {
            name: order.customerName,
            gender: order.gender,
            orders: [],
            totalSpent: 0
          };
        }
        customerData[order.customerName].orders.push(order);
        customerData[order.customerName].totalSpent += order.total;
      });

      const customers = Object.values(customerData).sort((a, b) => b.totalSpent - a.totalSpent);

      if (customers.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400">Belum ada data pelanggan</div>';
        return;
      }

      container.innerHTML = customers.map(customer => `
        <div class="p-4 flex items-center gap-4 hover:bg-surface/30">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br ${customer.gender === 'male' ? 'from-blue-500 to-cyan-500' : 'from-pink-500 to-purple-500'} flex items-center justify-center text-2xl">
            ${customer.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}
          </div>
          <div class="flex-1">
            <h4 class="font-bold">${customer.name}</h4>
            <p class="text-xs text-gray-400">${customer.orders.length} pesanan</p>
          </div>
          <div class="text-right">
            <p class="font-bold text-purple-400">${formatCurrency(customer.totalSpent)}</p>
            <p class="text-xs text-gray-400">Total belanja</p>
          </div>
        </div>
      `).join('');
    }

    // ===== SETTINGS SECTION =====
    function renderSettings() {
      populateSettingsForm();
      // Update the remote toggle UI when entering settings
      updateRemoteToggleUI();
    }

    function updateRemoteToggleUI() {
      const el = document.getElementById('useRemoteDbCheckbox');
      if (!el) return;
      el.checked = !!USE_REMOTE_DB;
    }

    function toggleUseRemoteDB() {
      const el = document.getElementById('useRemoteDbCheckbox');
      USE_REMOTE_DB = !!(el && el.checked);
      showToast('Use remote DB set to ' + USE_REMOTE_DB, 'info');
      if (!USE_REMOTE_DB) {
        // clear token for safety
        localStorage.removeItem('warkop_token');
      }
    }

    async function migrateLocalToRemote() {
      try {
        let data = null;
        const stored = localStorage.getItem('warkopData');
        if (stored) {
          data = JSON.parse(stored);
        } else {
          // Build data object from current runtime state
          data = { menuItems, categories, orders, tables, employees, cashTransactions, customers, gramasiData, businessSettings };
        }

        const headers = getAuthHeaders();

        // Try upsert to /data first
        let res = await fetch(`${API_BASE}/api/data`, {
          method: 'POST',
          headers,
          body: JSON.stringify(data)
        });

        if (res.ok) {
          const doc = await res.json();
          if (doc && Object.keys(doc).length > 0) {
            menuItems = doc.menuItems || menuItems;
            categories = doc.categories || categories;
            orders = doc.orders || orders;
            tables = doc.tables || tables;
            employees = doc.employees || employees;
            cashTransactions = doc.cashTransactions || cashTransactions;
            customers = doc.customers || customers;
            gramasiData = doc.gramasiData || gramasiData;
            businessSettings = { ...businessSettings, ...(doc.businessSettings || {}) };
            try { localStorage.setItem('warkopData', JSON.stringify({ menuItems, categories, orders, tables, employees, cashTransactions, customers, gramasiData, businessSettings })); } catch (e) { /* ignore */ }
          }
          showToast('Migrasi berhasil ke remote DB', 'success');
          renderMenuManagement();
          renderCustomerPage();
          return;
        }

        if (res.status === 401 || res.status === 403) {
          showToast('Autentikasi gagal: periksa API key atau login (401/403)', 'error');
          // fallback to migrate endpoint which also accepts API key or JWT
          const res2 = await fetch(`${API_BASE}/api/data/migrate`, { method: 'POST', headers, body: JSON.stringify(data) });
          if (res2.ok) {
            const doc = await res2.json();
            if (doc && doc.doc) {
              const d = doc.doc;
              menuItems = d.menuItems || menuItems;
              categories = d.categories || categories;
              orders = d.orders || orders;
              tables = d.tables || tables;
              employees = d.employees || employees;
              cashTransactions = d.cashTransactions || cashTransactions;
              customers = d.customers || customers;
              gramasiData = d.gramasiData || gramasiData;
              businessSettings = { ...businessSettings, ...(d.businessSettings || {}) };
              localStorage.setItem('warkopData', JSON.stringify({ menuItems, categories, orders, tables, employees, cashTransactions, customers, gramasiData, businessSettings }));
            }
            showToast('Migrasi berhasil via migrate endpoint', 'success');
            renderMenuManagement();
            renderCustomerPage();
            return;
          }
        }

        const text = await res.text();
        showToast('Migrasi gagal: ' + (text || res.status), 'error');
      } catch (err) {
        console.error(err);
        showToast('Error migrasi: ' + err.message, 'error');
      }
    }

    async function syncToCloud() {
      try {
        const stored = localStorage.getItem('warkopData');
        if (!stored) {
          showToast('Tidak ada data lokal untuk disinkronkan', 'info');
          return;
        }
        const data = JSON.parse(stored);
        const headers = getAuthHeaders();

        // Try POST to /data first
        let res = await fetch(`${API_BASE}/api/data`, {
          method: 'POST',
          headers,
          body: JSON.stringify(data)
        });

        if (res.ok) {
          showToast('Sinkronisasi berhasil ke server', 'success');
          const doc = await res.json();
          // Sync state from server
          if (doc && Object.keys(doc).length > 0) {
            menuItems = doc.menuItems || menuItems;
            categories = doc.categories || categories;
            orders = doc.orders || orders;
            tables = doc.tables || tables;
            employees = doc.employees || employees;
            cashTransactions = doc.cashTransactions || cashTransactions;
            customers = doc.customers || customers;
            gramasiData = doc.gramasiData || gramasiData;
            businessSettings = { ...businessSettings, ...(doc.businessSettings || {}) };
            localStorage.setItem('warkopData', JSON.stringify({ menuItems, categories, orders, tables, employees, cashTransactions, customers, gramasiData, businessSettings }));
          }
          renderMenuManagement();
          renderCustomerPage();
          return;
        }

        // If /data failed due to auth, try migrate endpoint (which accepts API key or JWT in our server)
        if (res.status === 401 || res.status === 403) {
          // Authentication error â€” likely invalid API key or missing login
          showToast('Autentikasi gagal: periksa API key atau login (401/403)', 'error');
          const res2 = await fetch(`${API_BASE}/api/data/migrate`, {
            method: 'POST',
            headers,
            body: JSON.stringify(data)
          });
          if (res2.ok) {
            showToast('Sinkronisasi berhasil via migrate endpoint', 'success');
            const doc = await res2.json();
            if (doc && doc.doc) {
              const d = doc.doc;
              menuItems = d.menuItems || menuItems;
              categories = d.categories || categories;
              orders = d.orders || orders;
              tables = d.tables || tables;
              employees = d.employees || employees;
              cashTransactions = d.cashTransactions || cashTransactions;
              customers = d.customers || customers;
              gramasiData = d.gramasiData || gramasiData;
              businessSettings = { ...businessSettings, ...(d.businessSettings || {}) };
              localStorage.setItem('warkopData', JSON.stringify({ menuItems, categories, orders, tables, employees, cashTransactions, customers, gramasiData, businessSettings }));
            }
            renderMenuManagement();
            renderCustomerPage();
            return;
          }
        }

        const text = await res.text();
        showToast('Sinkronisasi gagal: ' + (text || res.status), 'error');
      } catch (err) {
        console.error('Error syncing to cloud:', err);
        showToast('Error sinkronisasi: ' + (err && err.message ? err.message : err), 'error');
      }
    }

    // ===== DANGER ZONE: ADMIN RESET FUNCTIONS =====
    function showResetConfirmModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[100]';
      modal.id = 'resetConfirmModal';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full border-2 border-red-500/50 animate-fade">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">ğŸ’€</span>
            <div>
              <h3 class="text-xl font-bold text-red-400">RESET DATABASE?</h3>
              <p class="text-xs text-gray-400">Aksi ini TIDAK BISA DIUNDO!</p>
            </div>
          </div>
          
          <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 mb-4">
            <p class="text-sm text-red-300">Menu, Pesanan, Bahan, Shift, dan data lain akan DIHAPUS PERMANEN.</p>
            <p class="text-sm text-gray-400 mt-1">Data Pegawai & Akun Login TIDAK dihapus.</p>
          </div>
          
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Master PIN</label>
              <input type="password" id="resetMasterPin" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Masukkan Master PIN">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Ketik: <span class="text-red-400 font-bold">HAPUS SEMUA DATA</span></label>
              <input type="text" id="resetConfirmText" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="HAPUS SEMUA DATA">
            </div>
          </div>
          
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('#resetConfirmModal').remove()" class="flex-1 px-4 py-3 rounded-lg bg-surface hover:bg-surface/80 font-bold">Batal</button>
            <button onclick="doResetDatabase()" class="flex-1 px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold">ğŸ—‘ï¸ RESET</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function doResetDatabase() {
      const pin = document.getElementById('resetMasterPin').value;
      const confirmText = document.getElementById('resetConfirmText').value;

      if (!pin) { showToast('Masukkan Master PIN!', 'error'); return; }
      if (confirmText !== 'HAPUS SEMUA DATA') { showToast('Teks konfirmasi salah!', 'error'); return; }

      try {
        const res = await apiCall('/api/admin/reset', 'POST', { masterPin: pin, confirmText });
        document.getElementById('resetConfirmModal')?.remove();
        showToast(res.message || 'Database berhasil direset!', 'success');

        // Clear local state
        menuItems = [];
        categories = ['kopi', 'minuman', 'makanan', 'snack'];
        orders = [];
        ingredients = [];
        shifts = [];

        // Refresh UI
        renderMenuManagement();
        renderDashboard();
        loadFromStorage();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function deleteCollectionConfirm(collectionName) {
      const names = {
        orders: 'Pesanan', menu: 'Menu', ingredients: 'Bahan Baku', shifts: 'Shift'
      };
      const friendlyName = names[collectionName] || collectionName;

      const pin = prompt(`Masukkan Master PIN untuk menghapus semua ${friendlyName}:`);
      if (!pin) return;

      deleteCollectionExecute(collectionName, pin);
    }

    async function deleteCollectionExecute(collectionName, pin) {
      try {
        const res = await fetch(`${API_BASE}/api/admin/collection/${collectionName}`, {
          method: 'DELETE',
          headers: getAuthHeaders(),
          body: JSON.stringify({ masterPin: pin })
        });

        const json = await res.json();
        if (res.ok) {
          showToast(`Berhasil menghapus ${json.deleted} item dari ${collectionName}`, 'success');

          // Clear local array
          if (collectionName === 'orders') orders = [];
          if (collectionName === 'menu') menuItems = [];
          if (collectionName === 'ingredients') ingredients = [];
          if (collectionName === 'shifts') shifts = [];

          loadFromStorage();
          renderMenuManagement();
        } else {
          showToast(json.error || 'Gagal menghapus', 'error');
        }
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    function populateSettingsForm() {
      document.getElementById('settingBusinessName').value = businessSettings.name;
      document.getElementById('settingTagline').value = businessSettings.tagline;
      document.getElementById('settingPhone').value = businessSettings.phone;
      document.getElementById('settingAddress').value = businessSettings.address;
      document.getElementById('settingOpenTime').value = businessSettings.openTime;
      document.getElementById('settingCloseTime').value = businessSettings.closeTime;
      document.getElementById('settingWifiName').value = businessSettings.wifiName;
      document.getElementById('settingWifiPassword').value = businessSettings.wifiPassword;
      document.getElementById('settingTax').value = businessSettings.tax;
      document.getElementById('settingService').value = businessSettings.service;
      document.getElementById('settingBank').value = businessSettings.bank;
      // Payment fields
      if (document.getElementById('settingBankName')) document.getElementById('settingBankName').value = businessSettings.bankName || '';
      if (document.getElementById('settingBankAccount')) document.getElementById('settingBankAccount').value = businessSettings.bankAccount || '';
      if (document.getElementById('settingEwalletType')) document.getElementById('settingEwalletType').value = businessSettings.ewalletType || '';
      if (document.getElementById('settingEwalletNumber')) document.getElementById('settingEwalletNumber').value = businessSettings.ewalletNumber || '';
      // QRIS preview
      const qrisPreview = document.getElementById('qrisPreview');
      if (qrisPreview && businessSettings.qrisImage) {
        qrisPreview.src = businessSettings.qrisImage;
        qrisPreview.classList.remove('hidden');
      }
      // API key (local storage)
      if (document.getElementById('settingApiKey')) document.getElementById('settingApiKey').value = localStorage.getItem('warkop_api_key') || '';

      // Logo preview
      updateLogoDisplay();
    }

    async function saveSettings() {
      // === LOADING STATE ===
      const btn = document.querySelector('button[onclick="saveSettings()"]');
      const restoreBtn = setButtonLoading(btn);

      businessSettings.name = document.getElementById('settingBusinessName').value;
      businessSettings.tagline = document.getElementById('settingTagline').value;
      businessSettings.phone = document.getElementById('settingPhone').value;
      businessSettings.address = document.getElementById('settingAddress').value;
      businessSettings.openTime = document.getElementById('settingOpenTime').value;
      businessSettings.closeTime = document.getElementById('settingCloseTime').value;
      businessSettings.wifiName = document.getElementById('settingWifiName').value;
      businessSettings.wifiPassword = document.getElementById('settingWifiPassword').value;
      businessSettings.tax = parseFloat(document.getElementById('settingTax').value) || 0;
      businessSettings.service = parseFloat(document.getElementById('settingService').value) || 0;
      businessSettings.bank = document.getElementById('settingBank').value;
      // Payment settings
      businessSettings.bankAccount = document.getElementById('settingBankAccount')?.value || '';
      businessSettings.bankName = document.getElementById('settingBankName')?.value || '';
      businessSettings.ewalletNumber = document.getElementById('settingEwalletNumber')?.value || '';
      businessSettings.ewalletType = document.getElementById('settingEwalletType')?.value || '';

      // Save API key locally and optionally to server if logged in
      if (document.getElementById('settingApiKey')) {
        const apiKeyVal = document.getElementById('settingApiKey').value.trim();
        if (apiKeyVal) localStorage.setItem('warkop_api_key', apiKeyVal); else localStorage.removeItem('warkop_api_key');
        // Try to store API key on server if we have a JWT
        try {
          if (USE_REMOTE_DB && localStorage.getItem('warkop_token')) {
            await fetch(`${API_BASE}/key`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ apiKey: apiKeyVal }) });
          }
        } catch (e) { console.warn('Failed to save API key on server:', e); }
      }

      try {
        await saveToStorage();
        updateBusinessInfo();
        restoreBtn(); // Success - restore button
        showToast('Pengaturan berhasil disimpan!', 'success');
      } catch (err) {
        restoreBtn(); // Error - restore button
        console.error('Error saving settings:', err);
        showToast('Gagal menyimpan pengaturan: ' + (err && err.message ? err.message : err), 'error');
      }
    }

    function uploadLogo() {
      // Use the existing input element defined in HTML
      const input = document.getElementById('logoInput');
      if (!input || !input.files || !input.files[0]) return;

      const file = input.files[0];

      // Validate file size (max 500KB to avoid localStorage issues)
      if (file.size > 500 * 1024) {
        showToast('Ukuran logo maksimal 500KB!', 'warning');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (event) => {
        businessSettings.logo = event.target.result;
        updateLogoDisplay();

        try {
          await saveToStorage();
          document.getElementById('logoStatus').textContent = 'Logo berhasil diupload!';
          showToast('Logo berhasil diupload!', 'success');
        } catch (err) {
          console.error('Error saving logo:', err);
          showToast('Gagal menyimpan logo (mungkin terlalu besar)', 'error');
        }
      };
      reader.readAsDataURL(file);
    }

    function updateLogoDisplay() {
      const container = document.getElementById('logoPreviewContainer');
      if (!container) return;

      if (businessSettings.logo && businessSettings.logo !== 'default') {
        container.innerHTML = `<img src="${businessSettings.logo}" class="w-full h-full object-cover">`;
      } else {
        container.innerHTML = `
          <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" />
          </svg>
        `;
      }

      // Also update customer page header logo
      const customerLogo = document.getElementById('customerHeaderLogo');
      if (customerLogo && businessSettings.logo && businessSettings.logo !== 'default') {
        customerLogo.innerHTML = `<img src="${businessSettings.logo}" class="w-full h-full object-cover rounded-xl">`;
      }
    }

    // Save API key locally (from settings quick button)
    function saveApiKeyToLocal() {
      const el = document.getElementById('settingApiKey');
      if (!el) return;
      const v = el.value.trim();
      if (v) {
        localStorage.setItem('warkop_api_key', v);
        showToast('API key disimpan secara lokal', 'success');
      } else {
        localStorage.removeItem('warkop_api_key');
        showToast('API key dihapus', 'info');
      }
    }

    function uploadQRIS() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (event) => {
            businessSettings.qris = event.target.result;
            businessSettings.qrisImage = event.target.result; // Also save to qrisImage for payment display
            const qrisPreview = document.getElementById('qrisPreview');
            if (qrisPreview) {
              qrisPreview.src = event.target.result;
              qrisPreview.classList.remove('hidden');
            }
            try {
              await saveToStorage();
              showToast('QRIS berhasil diupload!', 'success');
            } catch (err) {
              showToast('Gagal menyimpan QRIS: ' + err.message, 'error');
            }
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function exportData() {
      const data = {
        menuItems,
        categories,
        orders,
        tables,
        employees,
        cashTransactions,
        customers,
        gramasiData,
        businessSettings
      };

      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `warkop-backup-${getCurrentDate()}.json`;
      link.click();
      URL.revokeObjectURL(url);

      showToast('Data berhasil diexport!', 'success');
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);

              menuItems = data.menuItems || [];
              categories = data.categories || ['kopi', 'minuman', 'makanan', 'snack'];
              orders = data.orders || [];
              tables = data.tables || [];
              employees = data.employees || [];
              cashTransactions = data.cashTransactions || [];
              customers = data.customers || [];
              gramasiData = data.gramasiData || [];
              businessSettings = { ...businessSettings, ...(data.businessSettings || {}) };

              saveToStorage();
              updateAllStats();
              renderCustomerPage();
              showToast('Data berhasil diimport!', 'success');
            } catch (err) {
              showToast('Format file tidak valid!', 'error');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function resetData() {
      // Create custom confirmation modal instead of browser confirm
      const modal = document.createElement('div');
      modal.id = 'resetDataModal';
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade">
          <div class="text-center mb-4">
            <div class="w-16 h-16 rounded-full bg-red-500/20 mx-auto flex items-center justify-center mb-4">
              <span class="text-3xl">âš ï¸</span>
            </div>
            <h3 class="text-xl font-bold mb-2">Reset Semua Data?</h3>
            <p class="text-gray-400 text-sm">Apakah Anda yakin ingin mereset semua data?</p>
            <p class="text-xs text-red-400 mt-2 font-medium">âš ï¸ Tindakan ini TIDAK DAPAT dibatalkan!</p>
          </div>
          <div class="flex gap-2">
            <button onclick="document.getElementById('resetDataModal').remove()" 
              class="flex-1 px-4 py-3 rounded-lg bg-surface hover:bg-surface/80 font-medium">
              Batal
            </button>
            <button onclick="confirmResetStep2()" 
              class="flex-1 px-4 py-3 rounded-lg bg-red-500 hover:bg-red-600 font-medium">
              Lanjutkan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmResetStep2() {
      document.getElementById('resetDataModal')?.remove();

      // Second confirmation modal
      const modal = document.createElement('div');
      modal.id = 'resetDataModal2';
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-sm w-full animate-fade border-2 border-red-500/50">
          <div class="text-center mb-4">
            <div class="w-16 h-16 rounded-full bg-red-500/30 mx-auto flex items-center justify-center mb-4">
              <span class="text-3xl">ğŸš¨</span>
            </div>
            <h3 class="text-xl font-bold mb-2 text-red-400">KONFIRMASI TERAKHIR</h3>
            <p class="text-white text-sm font-medium">Semua data akan dihapus permanen:</p>
            <ul class="text-xs text-gray-400 mt-2 text-left list-disc list-inside">
              <li>Menu, kategori, pesanan</li>
              <li>Bahan baku & resep</li>
              <li>Transaksi keuangan</li>
              <li>Data pelanggan & pegawai</li>
            </ul>
          </div>
          <div class="flex gap-2">
            <button onclick="document.getElementById('resetDataModal2').remove()" 
              class="flex-1 px-4 py-3 rounded-lg bg-surface hover:bg-surface/80 font-medium">
              Batal
            </button>
            <button onclick="executeResetData()" 
              class="flex-1 px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 font-bold text-white">
              ğŸ—‘ï¸ HAPUS SEMUA
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function executeResetData() {
      document.getElementById('resetDataModal2')?.remove();

      localStorage.removeItem('warkopData');

      menuItems = [];
      categories = ['kopi', 'minuman', 'makanan', 'snack'];
      orders = [];
      tables = [];
      employees = [];
      cashTransactions = [];
      customers = [];
      gramasiData = [];
      ingredients = [];
      recipes = {};
      stockHistory = [];
      businessSettings = {
        name: 'Warkop Santai',
        tagline: 'Ngopi Enak, Harga Merakyat',
        phone: '',
        address: '',
        openTime: '08:00',
        closeTime: '22:00',
        wifiName: '',
        wifiPassword: '',
        tax: 11,
        service: 5,
        bank: '',
        logo: 'default',
        qris: ''
      };

      initializeTables();
      updateAllStats();
      renderCustomerPage();
      populateSettingsForm();

      showToast('Semua data berhasil direset!', 'success');
    }

    // ===== DASHBOARD SECTION =====
    function renderDashboard() {
      updateDashboardStats();
      renderRecentOrders();
      renderQuickStats();
    }

    function updateDashboardStats() {
      const today = getCurrentDate();
      const todayOrders = orders.filter(o => o.date === today);
      const todaySales = todayOrders.reduce((sum, o) => sum + o.total, 0);

      const newOrdersCount = orders.filter(o => o.status === 'new').length;
      const occupiedTables = tables.filter(t => t.status === 'occupied').length;

      document.getElementById('statRevenue').textContent = formatCurrency(todaySales);
      document.getElementById('statOrders').textContent = todayOrders.length;
      document.getElementById('statTables').textContent = `${occupiedTables}/${tables.length}`;
      document.getElementById('statCustomers').textContent = new Set(orders.map(o => o.customerName)).size;
    }

    function renderRecentOrders() {
      const container = document.getElementById('recentOrders');
      if (!container) { console.warn('renderRecentOrders: #recentOrders not found'); return; }
      const recent = orders.slice(-5).reverse();

      if (recent.length === 0) {
        safeSet(container, '<div class="p-8 text-center text-gray-400">Belum ada pesanan</div>');
        initEventListeners();
        return;
      }

      safeSet(container, recent.map(order => {
        const statusColors = {
          new: 'bg-yellow-500/20 text-yellow-400',
          process: 'bg-blue-500/20 text-blue-400',
          done: 'bg-green-500/20 text-green-400'
        };

        return `
          <div class="p-3 flex items-center justify-between hover:bg-surface/30">
            <div>
              <p class="font-bold text-sm">${order.customerName}</p>
              <p class="text-xs text-gray-400">${order.time}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-purple-400 text-sm">${formatCurrency(order.total)}</p>
              <span class="text-xs px-2 py-1 rounded ${statusColors[order.status]}">${order.status}</span>
            </div>
          </div>
        `;
      }).join(''));
      initEventListeners();
    }

    function renderQuickStats() {
      const totalMenu = menuItems.length;
      const totalEmployees = employees.length;
      const totalTables = tables.length;

      // These stats are shown inline in the dashboard cards already
    }

    function updateAllStats() {
      if (currentSection === 'dashboard') {
        renderDashboard();
      }
      updatePOSStats();
      updateFinanceStats();
      if (currentSection === 'report') {
        renderReports();
      }
      if (currentSection === 'customer') {
        renderCustomers();
      }
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // Remove common overlay/backdrop elements that may block clicks
        ['.modal-backdrop', '.overlay'].forEach(sel => {
          document.querySelectorAll(sel).forEach(el => { console.log('Removing overlay element:', sel, el); el.remove(); });
        });

        // Aggressively remove or disable full-screen transparent elements that cover the viewport
        Array.from(document.querySelectorAll('div')).forEach(el => {
          try {
            const cs = getComputedStyle(el);
            if (!(cs.position === 'fixed' || cs.position === 'absolute')) return;
            if (cs.pointerEvents === 'none' || cs.display === 'none' || cs.visibility === 'hidden') return;
            const rect = el.getBoundingClientRect();
            if (rect.width >= window.innerWidth - 2 && rect.height >= window.innerHeight - 2) {
              console.warn('Removing full-screen blocker:', el);
              el.remove();
            }
          } catch (e) { }
        });

        // debug-pointer-events removed during cleanup
      } catch (err) {
        console.warn('Pre-init overlay cleanup failed:', err);
      }

      init().catch(err => { console.error('Init error:', err); showToast('Error inisialisasi: ' + (err && err.message ? err.message : err), 'error'); });
    });

    // ===== DIGITAL RECEIPT FUNCTIONS =====
    function showDigitalReceipt(order) {
      console.log('showDigitalReceipt called with order:', order);

      const modal = document.getElementById('receiptModal');
      if (!modal) {
        console.error('Receipt modal not found! Creating dynamic modal...');
        showDynamicReceipt(order);
        return;
      }

      try {
        // Populate receipt data with null checks
        const elShopName = document.getElementById('receiptShopName');
        const elTagline = document.getElementById('receiptTagline');
        const elDate = document.getElementById('receiptDate');
        const elTime = document.getElementById('receiptTime');
        const elCustomer = document.getElementById('receiptCustomer');
        const elPhone = document.getElementById('receiptPhone');
        const elTable = document.getElementById('receiptTable');
        const elTotal = document.getElementById('receiptTotal');
        const elOrderId = document.getElementById('receiptOrderId');
        const elPayment = document.getElementById('receiptPayment');
        const elWifiName = document.getElementById('receiptWifiName');
        const elWifiPassword = document.getElementById('receiptWifiPassword');

        if (elShopName) elShopName.textContent = businessSettings.name || 'Warkop Santai';
        if (elTagline) elTagline.textContent = businessSettings.tagline || '';
        if (elDate) elDate.textContent = order.date || '-';
        if (elTime) elTime.textContent = order.time || '-';
        if (elCustomer) elCustomer.textContent = order.customerName || '-';
        if (elPhone) elPhone.textContent = order.phone || '-';
        if (elTable) elTable.textContent = order.tableNumber ? `Meja ${order.tableNumber}` : '-';
        if (elTotal) elTotal.textContent = formatCurrency(order.total || 0);
        if (elOrderId) elOrderId.textContent = `#${order.id}`;

        // Payment method
        const paymentLabels = { cash: 'Tunai', bank: 'Transfer Bank', ewallet: 'e-Wallet', qris: 'QRIS' };
        if (elPayment) elPayment.textContent = paymentLabels[order.paymentMethod] || order.paymentMethod || '-';

        // WiFi info from settings
        if (elWifiName) elWifiName.textContent = businessSettings.wifiName || '(belum diatur)';
        if (elWifiPassword) elWifiPassword.textContent = businessSettings.wifiPassword || '(belum diatur)';

        // Logo
        const logoContainer = document.getElementById('receiptLogo');
        if (logoContainer && businessSettings.logo && businessSettings.logo !== 'default') {
          logoContainer.innerHTML = `<img src="${businessSettings.logo}" class="w-full h-full object-cover">`;
        }

        // Order items
        const itemsContainer = document.getElementById('receiptItems');
        if (itemsContainer && order.items && order.items.length > 0) {
          itemsContainer.innerHTML = order.items.map(item => `
            <tr>
              <td class="py-1 text-left">${item.name}</td>
              <td class="text-center">${item.quantity}</td>
              <td class="text-right">${formatCurrency(item.price)}</td>
              <td class="text-right font-medium">${formatCurrency(item.price * item.quantity)}</td>
            </tr>
          `).join('');
        }

        // Show modal
        modal.classList.remove('hidden');
        console.log('Receipt modal shown successfully');

      } catch (err) {
        console.error('Error showing receipt modal:', err);
        showDynamicReceipt(order);
      }
    }

    // Fallback: Create dynamic receipt modal if HTML modal not found
    function showDynamicReceipt(order) {
      const paymentLabels = { cash: 'Tunai', bank: 'Transfer Bank', ewallet: 'e-Wallet', qris: 'QRIS' };

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
      modal.style.background = 'rgba(0,0,0,0.7)';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-auto animate-fade">
          <div id="dynamicReceiptContent" class="bg-white text-gray-800 rounded-xl p-6">
            <!-- Header -->
            <div class="text-center border-b border-gray-300 pb-4 mb-4">
              <h2 class="text-xl font-bold text-gray-900">${businessSettings.name || 'Warkop Santai'}</h2>
              <p class="text-xs text-gray-500">${businessSettings.tagline || ''}</p>
            </div>
            
            <!-- Customer Info -->
            <div class="border-b border-dashed border-gray-300 pb-3 mb-3 text-sm">
              <div class="flex justify-between"><span class="text-gray-500">Tanggal:</span><span class="font-medium">${order.date || '-'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Waktu:</span><span class="font-medium">${order.time || '-'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Nama:</span><span class="font-medium">${order.customerName || '-'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">No. Telp:</span><span class="font-medium">${order.phone || '-'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Meja:</span><span class="font-medium">${order.tableNumber ? 'Meja ' + order.tableNumber : '-'}</span></div>
            </div>
            
            <!-- Items -->
            <div class="border-b border-dashed border-gray-300 pb-3 mb-3">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-gray-500 text-xs">
                    <th class="text-left py-1">Item</th>
                    <th class="text-center">Qty</th>
                    <th class="text-right">Harga</th>
                    <th class="text-right">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  ${(order.items || []).map(item => `
                    <tr>
                      <td class="py-1 text-left">${item.name}</td>
                      <td class="text-center">${item.quantity}</td>
                      <td class="text-right">${formatCurrency(item.price)}</td>
                      <td class="text-right font-medium">${formatCurrency(item.price * item.quantity)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- Total -->
            <div class="border-b border-gray-300 pb-3 mb-3">
              <div class="flex justify-between text-lg font-bold">
                <span>TOTAL</span>
                <span class="text-purple-600">${formatCurrency(order.total || 0)}</span>
              </div>
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>Metode Bayar:</span>
                <span class="font-medium">${paymentLabels[order.paymentMethod] || order.paymentMethod || '-'}</span>
              </div>
            </div>
            
            <!-- WiFi -->
            <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-3 mb-4">
              <p class="text-xs text-gray-600 mb-1 font-medium">ğŸ“¶ Info WiFi Gratis:</p>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">SSID:</span>
                <span class="font-bold text-purple-700">${businessSettings.wifiName || '(belum diatur)'}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Password:</span>
                <span class="font-bold text-purple-700">${businessSettings.wifiPassword || '(belum diatur)'}</span>
              </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center text-xs text-gray-400">
              <p>Terima kasih atas kunjungan Anda! ğŸ™</p>
              <p class="font-mono mt-1">#${order.id}</p>
            </div>
          </div>
          
          <!-- Actions -->
          <div class="flex gap-2 mt-4">
            <button onclick="downloadDynamicReceipt()" class="flex-1 btn-primary px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
              ğŸ“¥ Download Nota
            </button>
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 rounded-xl bg-surface hover:bg-surface/80 font-medium">
              Tutup
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function downloadDynamicReceipt() {
      const receiptEl = document.getElementById('dynamicReceiptContent');
      if (!receiptEl) {
        showToast('Elemen nota tidak ditemukan', 'error');
        return;
      }

      try {
        showToast('Menyiapkan gambar nota...', 'info');
        const canvas = await html2canvas(receiptEl, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true
        });
        const link = document.createElement('a');
        link.download = `nota-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('Nota berhasil didownload!', 'success');
      } catch (err) {
        console.error('Error generating receipt image:', err);
        showToast('Gagal membuat gambar nota: ' + err.message, 'error');
      }
    }

    function closeReceiptModal() {
      const modal = document.getElementById('receiptModal');
      if (modal) modal.classList.add('hidden');
    }

    async function downloadReceipt() {
      const receiptEl = document.getElementById('receiptContent');
      if (!receiptEl) {
        showToast('Elemen nota tidak ditemukan', 'error');
        return;
      }

      try {
        showToast('Menyiapkan gambar nota...', 'info');
        const canvas = await html2canvas(receiptEl, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true
        });
        const link = document.createElement('a');
        link.download = `nota-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('Nota berhasil didownload!', 'success');
      } catch (err) {
        console.error('Error generating receipt image:', err);
        showToast('Gagal membuat gambar nota: ' + err.message, 'error');
      }
    }

    // ===== SOUND NOTIFICATION FUNCTIONS =====
    let soundNotificationEnabled = false;
    let lastKnownOrderCount = 0;
    // orderPollingInterval already declared in AUTO-REFRESH POLLING section
    const NOTIF_SOUND_KEY = 'admin_notif_sound';
    const DEFAULT_NOTIF_SOUND = '/public/sounds/notif.mp3';

    // Default notification sound - uses file or falls back to Web Audio API beep
    function playDefaultDing() {
      // Try to play the default mp3 file first
      try {
        const audio = new Audio(DEFAULT_NOTIF_SOUND);
        audio.volume = 0.7;
        audio.play().catch(e => {
          console.warn('Cannot play default mp3, using Web Audio API beep:', e);
          playWebAudioBeep();
        });
      } catch (e) {
        console.warn('Error creating audio for default mp3:', e);
        playWebAudioBeep();
      }
    }

    // Fallback Web Audio API beep sound
    function playWebAudioBeep() {
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.5);
      } catch (e) {
        console.warn('Cannot play Web Audio beep:', e);
      }
    }

    function uploadNotifSound(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('audio/')) {
        showToast('File harus berupa audio (.mp3 atau .wav)', 'error');
        return;
      }

      // Max size check (2MB)
      if (file.size > 2 * 1024 * 1024) {
        showToast('Ukuran file terlalu besar (maks 2MB)', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          localStorage.setItem(NOTIF_SOUND_KEY, e.target.result);
          updateNotifSoundStatus();
          showToast('Suara notifikasi berhasil diupload!', 'success');
        } catch (err) {
          console.error('Error saving sound:', err);
          showToast('Gagal menyimpan suara (localStorage penuh?): ' + err.message, 'error');
        }
      };
      reader.onerror = function () {
        showToast('Gagal membaca file audio', 'error');
      };
      reader.readAsDataURL(file);
    }

    function testNotifSound() {
      playNotificationSound();
      showToast('Memutar suara notifikasi...', 'info');
    }

    function removeNotifSound() {
      localStorage.removeItem(NOTIF_SOUND_KEY);
      updateNotifSoundStatus();
      showToast('Suara notifikasi dihapus, akan menggunakan suara default (/public/sounds/notif.mp3)', 'info');
    }

    function updateNotifSoundStatus() {
      const statusEl = document.getElementById('notifSoundStatus');
      if (!statusEl) return;

      const hasSound = localStorage.getItem(NOTIF_SOUND_KEY);
      if (hasSound) {
        statusEl.textContent = 'âœ… Suara notifikasi kustom sudah dikonfigurasi';
        statusEl.className = 'text-xs text-green-400';
      } else {
        statusEl.textContent = 'Status: Menggunakan suara default (/public/sounds/notif.mp3)';
        statusEl.className = 'text-xs text-gray-500';
      }
    }

    function playNotificationSound() {
      // Priority 1: Check custom sound in localStorage
      const customSoundData = localStorage.getItem(NOTIF_SOUND_KEY);

      if (customSoundData) {
        // Use custom uploaded sound
        try {
          // Create NEW Audio instance each time to avoid replay issues
          const audio = new Audio(customSoundData);
          audio.volume = 0.7;
          audio.play().catch(e => {
            console.warn('Cannot play custom sound, falling back to default:', e);
            playDefaultDing();
          });
        } catch (e) {
          console.warn('Error creating custom audio:', e);
          playDefaultDing();
        }
      } else {
        // Priority 2: Use default sound file at /public/sounds/notif.mp3
        playDefaultDing();
      }
    }

    // ===== ORDER POLLING FUNCTIONS =====
    function activateSoundNotification() {
      // This function must be called by user click to bypass browser autoplay policy
      if (soundNotificationEnabled) {
        // Deactivate
        soundNotificationEnabled = false;
        stopOrderPolling();
        updateSoundButtonUI();
        showToast('Notifikasi suara dinonaktifkan', 'info');
        return;
      }

      // Test if we can play audio (user interaction required)
      try {
        playNotificationSound();
        soundNotificationEnabled = true;
        lastKnownOrderCount = orders.length;
        startOrderPolling();
        updateSoundButtonUI();
        showToast('Notifikasi suara diaktifkan! Suara akan berbunyi saat ada pesanan baru.', 'success');
      } catch (e) {
        console.error('Failed to activate sound:', e);
        showToast('Gagal mengaktifkan suara. Coba refresh halaman.', 'error');
      }
    }

    function updateSoundButtonUI() {
      const icon = document.getElementById('soundBtnIcon');
      const text = document.getElementById('soundBtnText');
      const btn = document.getElementById('btnAktifkanSuara');

      if (soundNotificationEnabled) {
        if (icon) icon.textContent = 'ğŸ”Š';
        if (text) text.textContent = 'Suara Aktif âœ“';
        if (btn) {
          btn.classList.remove('bg-green-500/20', 'text-green-400');
          btn.classList.add('bg-purple-500/20', 'text-purple-400');
        }
      } else {
        if (icon) icon.textContent = 'ğŸ”‡';
        if (text) text.textContent = 'Aktifkan Notifikasi Suara';
        if (btn) {
          btn.classList.remove('bg-purple-500/20', 'text-purple-400');
          btn.classList.add('bg-green-500/20', 'text-green-400');
        }
      }
    }

    function startOrderPolling() {
      if (orderPollingInterval) clearInterval(orderPollingInterval);

      // Poll every 5 seconds
      orderPollingInterval = setInterval(() => {
        checkNewOrders();
      }, 5000);

      console.log('Order polling started');
    }

    function stopOrderPolling() {
      if (orderPollingInterval) {
        clearInterval(orderPollingInterval);
        orderPollingInterval = null;
        console.log('Order polling stopped');
      }
    }

    async function checkNewOrders() {
      // Only check if we're in admin mode and POS section
      const adminPage = document.getElementById('adminPage');
      if (!adminPage || adminPage.classList.contains('hidden')) return;
      if (currentSection !== 'pos') return;
      if (!soundNotificationEnabled) return;

      try {
        // If using remote DB, fetch fresh data
        if (USE_REMOTE_DB) {
          const res = await fetch(`${API_BASE}/api/data`, { headers: getAuthHeaders() });
          if (res.ok) {
            const doc = await res.json();
            if (doc && doc.orders) {
              const serverOrderCount = doc.orders.length;

              if (serverOrderCount > lastKnownOrderCount) {
                // New orders detected!
                const newCount = serverOrderCount - lastKnownOrderCount;
                console.log(`${newCount} new order(s) detected!`);

                // Update local data
                orders = doc.orders;

                // Play sound
                playNotificationSound();

                // Re-render POS orders
                renderPOSOrders();
                updatePOSStats();

                showToast(`ğŸ”” ${newCount} pesanan baru masuk!`, 'success');
              }

              lastKnownOrderCount = serverOrderCount;
            }
          }
        } else {
          // Local mode - just check if orders array changed
          const currentCount = orders.length;
          if (currentCount > lastKnownOrderCount) {
            const newCount = currentCount - lastKnownOrderCount;
            playNotificationSound();
            showToast(`ğŸ”” ${newCount} pesanan baru!`, 'success');
            renderPOSOrders();
            updatePOSStats();
          }
          lastKnownOrderCount = currentCount;
        }
      } catch (err) {
        console.warn('Error checking new orders:', err);
      }
    }

    // Modify showSection to handle polling start/stop
    const originalShowSection = showSection;
    window.showSection = function (section) {
      const wasInPOS = currentSection === 'pos';

      // === ROLE CHECK: Admin bypasses ALL shift requirements ===
      const userRole = currentUser?.role || localStorage.getItem('userRole') || '';
      const isAdmin = userRole === 'admin' || userRole === 'Admin';

      // POS requires active shift - check before allowing access (KASIR ONLY)
      if (section === 'pos' && !isAdmin) {
        checkShiftRequired().then(hasShift => {
          if (hasShift) {
            proceedToSection(section, wasInPOS);
          }
          // If no shift, checkShiftRequired shows the modal
        });
        return; // Wait for async check
      }

      // Admin or non-POS section - proceed directly
      proceedToSection(section, wasInPOS);
    };

    function proceedToSection(section, wasInPOS) {
      // Call original function
      originalShowSection(section);

      // Handle polling based on section change
      if (section === 'pos' && soundNotificationEnabled) {
        lastKnownOrderCount = orders.length;
        startOrderPolling();
      } else if (wasInPOS && section !== 'pos') {
        stopOrderPolling();
      }

      // Update sound status in settings if viewing settings
      if (section === 'settings') {
        updateNotifSoundStatus();
      }

      // Initialize CRM when customer section is shown
      if (section === 'customer') {
        initCRM();
      }

      // Load shift report when section is shown
      if (section === 'shiftReport') {
        loadShiftReport();
      }
    };

    // Handle Enter key for login
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const loginModal = document.getElementById('loginModal');
        if (!loginModal.classList.contains('hidden')) {
          doLogin();
        }
      }
    });

    // ===== CRM SYSTEM =====
    let currentCRMTab = 'data';
    let crmCustomers = [];
    let crmLeaderboard = [];
    let crmChurnList = [];
    let loyaltySettings = {
      pointRatio: 10000,
      tierThresholds: { silver: 500000, gold: 2000000 },
      enableLoyalty: true
    };

    // Load customers from API
    async function loadCRMCustomers() {
      try {
        if (USE_REMOTE_DB) {
          const response = await fetch(`${API_BASE}/api/customers`, {
            headers: { 'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY }
          });
          if (response.ok) {
            crmCustomers = await response.json();
          }
        } else {
          crmCustomers = customers || [];
        }
        renderCRMDataTable();
      } catch (err) {
        console.error('Error loading CRM customers:', err);
      }
    }

    // Switch CRM Tab
    function switchCRMTab(tab) {
      currentCRMTab = tab;
      document.querySelectorAll('.crm-tab-btn').forEach(btn => {
        btn.classList.toggle('bg-purple-600', btn.dataset.tab === tab);
        btn.classList.toggle('bg-surface', btn.dataset.tab !== tab);
      });
      document.querySelectorAll('.crm-tab-content').forEach(content => {
        content.classList.toggle('hidden', content.id !== `crmTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      });

      // Load data for specific tab
      if (tab === 'data') loadCRMCustomers();
      if (tab === 'leaderboard') loadLeaderboard();
      if (tab === 'churn') loadChurnAlert();
      if (tab === 'settings') loadLoyaltySettings();
    }

    // Render Data Table
    function renderCRMDataTable() {
      const container = document.getElementById('crmDataTable');
      if (!container) return;

      const searchQuery = document.getElementById('crmSearchInput')?.value?.toLowerCase() || '';
      let filtered = crmCustomers;
      if (searchQuery) {
        filtered = crmCustomers.filter(c =>
          c.name?.toLowerCase().includes(searchQuery) ||
          c.phone?.includes(searchQuery)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">Belum ada data pelanggan</td></tr>';
        return;
      }

      container.innerHTML = filtered.map(c => {
        const tierColors = {
          Bronze: 'bg-amber-500/20 text-amber-400',
          Silver: 'bg-gray-400/20 text-gray-300',
          Gold: 'bg-yellow-500/20 text-yellow-400'
        };
        const isActive = c.lastOrderDate && (new Date() - new Date(c.lastOrderDate)) < 60 * 24 * 60 * 60 * 1000;

        return `
          <tr onclick="showCustomerDetail('${c.id}')" class="hover:bg-surface/50 cursor-pointer transition-colors">
            <td class="px-4 py-3">
              <div class="font-medium">${c.name || '-'}</div>
              ${c.tags?.length ? `<div class="text-xs text-purple-400">${c.tags.slice(0, 2).join(', ')}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-gray-400">${c.phone || '-'}</td>
            <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${tierColors[c.memberTier] || tierColors.Bronze}">${c.memberTier || 'Bronze'}</span></td>
            <td class="px-4 py-3 text-right font-bold text-purple-400">${c.currentPoints || 0}</td>
            <td class="px-4 py-3 text-right text-gray-400">${formatCurrency(c.totalSpend || 0)}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 rounded-full text-xs ${isActive ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">${isActive ? 'Aktif' : 'Pasif'}</span>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Show Customer Detail Modal
    async function showCustomerDetail(customerId) {
      const customer = crmCustomers.find(c => c.id === customerId);
      if (!customer) return;

      // Show loading modal first
      const modal = document.createElement('div');
      modal.id = 'customerDetailModal';
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-2xl w-full animate-fade max-h-[90vh] overflow-auto">
          <div class="text-center py-8">
            <div class="animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mx-auto"></div>
            <p class="text-gray-400 mt-4">Memuat analytics...</p>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Fetch analytics
      let analytics = { topMenus: [], persona: { label: 'Fleksibel', emoji: 'â°' }, recentOrders: [] };
      try {
        if (USE_REMOTE_DB) {
          const response = await fetch(`${API_BASE}/api/customers/${customerId}/analytics`);
          if (response.ok) {
            const data = await response.json();
            analytics = data.analytics;
          }
        }
      } catch (err) {
        console.error('Error loading analytics:', err);
      }

      // Render full modal
      const tierColors = { Bronze: 'bg-amber-500/20 text-amber-400', Silver: 'bg-gray-400/20 text-gray-300', Gold: 'bg-yellow-500/20 text-yellow-400' };

      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-2xl w-full animate-fade max-h-[90vh] overflow-auto">
          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl">ğŸ‘¤</div>
              <div>
                <h3 class="text-xl font-bold">${customer.name}</h3>
                <p class="text-gray-400">${customer.phone || 'No phone'}</p>
                <span class="px-3 py-1 rounded-full text-xs ${tierColors[customer.memberTier] || tierColors.Bronze}">${customer.memberTier || 'Bronze'}</span>
              </div>
            </div>
            <button onclick="document.getElementById('customerDetailModal').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
          </div>
          
          <!-- Stats Row -->
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="glass rounded-xl p-4 text-center">
              <p class="text-2xl font-bold text-green-400">${formatCurrency(customer.totalSpend || 0)}</p>
              <p class="text-xs text-gray-400">Total Belanja</p>
            </div>
            <div class="glass rounded-xl p-4 text-center">
              <p class="text-2xl font-bold text-blue-400">${customer.totalVisits || 0}x</p>
              <p class="text-xs text-gray-400">Kunjungan</p>
            </div>
            <div class="glass rounded-xl p-4 text-center">
              <p class="text-2xl font-bold text-purple-400">${customer.currentPoints || 0}</p>
              <p class="text-xs text-gray-400">Poin</p>
            </div>
          </div>
          
          <!-- Analytics Section -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Persona Badge -->
            <div class="glass rounded-xl p-4">
              <p class="text-xs text-gray-400 mb-2">Persona</p>
              <div class="flex items-center gap-2">
                <span class="text-3xl">${analytics.persona?.emoji || 'â°'}</span>
                <span class="font-bold">${analytics.persona?.label || 'Fleksibel'}</span>
              </div>
              <p class="text-xs text-gray-500 mt-1">${analytics.persona?.desc || ''}</p>
            </div>
            
            <!-- Top Menu -->
            <div class="glass rounded-xl p-4">
              <p class="text-xs text-gray-400 mb-2">Top 3 Menu Favorit</p>
              ${analytics.topMenus?.length ? analytics.topMenus.map((m, i) => `
                <div class="flex items-center justify-between text-sm py-1">
                  <span>${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i]} ${m.menuName}</span>
                  <span class="text-purple-400">${m.count}x</span>
                </div>
              `).join('') : '<p class="text-gray-500 text-sm">Belum ada data</p>'}
            </div>
          </div>
          
          <!-- Tags Section -->
          <div class="glass rounded-xl p-4 mb-6">
            <p class="text-xs text-gray-400 mb-2">Tags</p>
            <div id="customerTags" class="flex flex-wrap gap-2 mb-3">
              ${(customer.tags || []).map(tag => `
                <span class="px-3 py-1 rounded-full bg-purple-500/20 text-purple-400 text-sm flex items-center gap-1">
                  ${tag}
                  <button onclick="removeCustomerTag('${customerId}', '${tag}')" class="hover:text-red-400">&times;</button>
                </span>
              `).join('') || '<span class="text-gray-500 text-sm">Belum ada tag</span>'}
            </div>
            <div class="flex gap-2">
              <input type="text" id="newTagInput" class="input-field flex-1 px-3 py-2 rounded-lg text-white text-sm" placeholder="Tambah tag baru...">
              <button onclick="addCustomerTag('${customerId}')" class="px-4 py-2 rounded-lg bg-purple-500 text-white text-sm">+ Tambah</button>
            </div>
          </div>
          
          <!-- Recent Orders -->
          <div class="glass rounded-xl p-4">
            <p class="text-xs text-gray-400 mb-2">5 Transaksi Terakhir</p>
            ${analytics.recentOrders?.length ? `
              <div class="space-y-2 max-h-40 overflow-auto">
                ${analytics.recentOrders.map(o => `
                  <div class="flex items-center justify-between text-sm p-2 bg-surface/50 rounded-lg">
                    <div>
                      <p class="font-medium">${o.items?.map(i => i.name).slice(0, 2).join(', ') || 'Order'}${o.items?.length > 2 ? '...' : ''}</p>
                      <p class="text-xs text-gray-400">${o.date} ${o.time}</p>
                    </div>
                    <span class="font-bold text-green-400">${formatCurrency(o.total)}</span>
                  </div>
                `).join('')}
              </div>
            ` : '<p class="text-gray-500 text-sm">Belum ada transaksi</p>'}
          </div>
        </div>
      `;
    }

    // Add/Remove Tags
    async function addCustomerTag(customerId) {
      const input = document.getElementById('newTagInput');
      const tag = input?.value?.trim();
      if (!tag) return;

      try {
        if (USE_REMOTE_DB) {
          await fetch(`${API_BASE}/api/customers/${customerId}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY },
            body: JSON.stringify({ tag, action: 'add' })
          });
        }

        const cust = crmCustomers.find(c => c.id === customerId);
        if (cust) {
          if (!cust.tags) cust.tags = [];
          if (!cust.tags.includes(tag)) cust.tags.push(tag);
        }

        input.value = '';
        document.getElementById('customerDetailModal')?.remove();
        showCustomerDetail(customerId);
        showToast('Tag ditambahkan!', 'success');
      } catch (err) {
        showToast('Gagal menambah tag', 'error');
      }
    }

    async function removeCustomerTag(customerId, tag) {
      try {
        if (USE_REMOTE_DB) {
          await fetch(`${API_BASE}/api/customers/${customerId}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY },
            body: JSON.stringify({ tag, action: 'remove' })
          });
        }

        const cust = crmCustomers.find(c => c.id === customerId);
        if (cust && cust.tags) {
          cust.tags = cust.tags.filter(t => t !== tag);
        }

        document.getElementById('customerDetailModal')?.remove();
        showCustomerDetail(customerId);
        showToast('Tag dihapus!', 'success');
      } catch (err) {
        showToast('Gagal menghapus tag', 'error');
      }
    }

    // Leaderboard
    async function loadLeaderboard() {
      const container = document.getElementById('crmLeaderboardTable');
      if (!container) return;

      const by = document.querySelector('input[name="leaderboardBy"]:checked')?.value || 'spending';
      const period = document.querySelector('input[name="leaderboardPeriod"]:checked')?.value || 'alltime';

      container.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><div class="animate-spin w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full mx-auto"></div></td></tr>';

      try {
        if (USE_REMOTE_DB) {
          const response = await fetch(`${API_BASE}/api/customers/leaderboard?by=${by}&period=${period}`);
          if (response.ok) {
            const data = await response.json();
            crmLeaderboard = data.leaderboard || [];
          }
        }
      } catch (err) {
        console.error('Error loading leaderboard:', err);
        crmLeaderboard = [];
      }

      if (crmLeaderboard.length === 0) {
        container.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Belum ada data</td></tr>';
        return;
      }

      const tierColors = { Bronze: 'bg-amber-500/20 text-amber-400', Silver: 'bg-gray-400/20 text-gray-300', Gold: 'bg-yellow-500/20 text-yellow-400' };

      container.innerHTML = crmLeaderboard.map((c, i) => `
        <tr class="hover:bg-surface/50">
          <td class="px-4 py-3 text-center">
            <span class="text-xl">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i] || (i + 1)}</span>
          </td>
          <td class="px-4 py-3 font-medium">${c.name || 'Unknown'}</td>
          <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${tierColors[c.tier] || tierColors.Bronze}">${c.tier || 'Bronze'}</span></td>
          <td class="px-4 py-3 text-right font-bold ${by === 'spending' ? 'text-green-400' : 'text-blue-400'}">
            ${by === 'spending' ? formatCurrency(c.value) : `${c.value}x`}
          </td>
          <td class="px-4 py-3 text-right text-gray-400">${c.phone || '-'}</td>
        </tr>
      `).join('');
    }

    // Churn Alert
    async function loadChurnAlert() {
      const container = document.getElementById('crmChurnTable');
      if (!container) return;

      container.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><div class="animate-spin w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full mx-auto"></div></td></tr>';

      try {
        if (USE_REMOTE_DB) {
          const response = await fetch(`${API_BASE}/api/customers/churn-alert`);
          if (response.ok) {
            crmChurnList = await response.json();
          }
        }
      } catch (err) {
        console.error('Error loading churn alert:', err);
        crmChurnList = [];
      }

      if (crmChurnList.length === 0) {
        container.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-green-400">ğŸ‰ Tidak ada pelanggan berisiko hilang!</td></tr>';
        return;
      }

      container.innerHTML = crmChurnList.map(c => {
        const daysSince = c.lastOrderDate ? Math.floor((new Date() - new Date(c.lastOrderDate)) / (1000 * 60 * 60 * 24)) : 999;
        return `
          <tr class="hover:bg-surface/50">
            <td class="px-4 py-3 font-medium">${c.name}</td>
            <td class="px-4 py-3 text-gray-400">${c.phone || '-'}</td>
            <td class="px-4 py-3 text-red-400">${daysSince} hari lalu</td>
            <td class="px-4 py-3 text-center">${c.totalVisits || 0}x</td>
            <td class="px-4 py-3">
              <button onclick="copyWhatsApp('${c.phone}')" class="px-3 py-1 rounded-lg bg-green-500/20 text-green-400 text-sm hover:bg-green-500/30">
                ğŸ“‹ Copy WA
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function copyWhatsApp(phone) {
      if (!phone) {
        showToast('No phone number', 'warning');
        return;
      }
      const formatted = phone.startsWith('0') ? '62' + phone.slice(1) : phone;
      navigator.clipboard.writeText(formatted);
      showToast('Nomor WA disalin: ' + formatted, 'success');
    }

    // Loyalty Settings
    async function loadLoyaltySettings() {
      try {
        if (USE_REMOTE_DB) {
          const response = await fetch(`${API_BASE}/api/settings`);
          if (response.ok) {
            const settings = await response.json();
            if (settings.loyaltySettings) {
              loyaltySettings = settings.loyaltySettings;
            }
          }
        }
      } catch (err) {
        console.error('Error loading loyalty settings:', err);
      }

      document.getElementById('loyaltyPointRatio').value = loyaltySettings.pointRatio || 10000;
      document.getElementById('loyaltySilverThreshold').value = loyaltySettings.tierThresholds?.silver || 500000;
      document.getElementById('loyaltyGoldThreshold').value = loyaltySettings.tierThresholds?.gold || 2000000;
      document.getElementById('loyaltyEnabled').checked = loyaltySettings.enableLoyalty !== false;
    }

    async function saveLoyaltySettings() {
      const newSettings = {
        pointRatio: parseInt(document.getElementById('loyaltyPointRatio').value) || 10000,
        tierThresholds: {
          silver: parseInt(document.getElementById('loyaltySilverThreshold').value) || 500000,
          gold: parseInt(document.getElementById('loyaltyGoldThreshold').value) || 2000000
        },
        enableLoyalty: document.getElementById('loyaltyEnabled').checked
      };

      try {
        if (USE_REMOTE_DB) {
          const response = await fetch(`${API_BASE}/api/settings`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY },
            body: JSON.stringify({ key: 'businessSettings', loyaltySettings: newSettings })
          });
        }
        loyaltySettings = newSettings;
        showToast('Pengaturan loyalty disimpan!', 'success');
      } catch (err) {
        showToast('Gagal menyimpan', 'error');
      }
    }

    // Add New Customer
    function showAddCustomerModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-md w-full animate-fade">
          <h3 class="text-xl font-bold mb-4">â• Tambah Pelanggan Baru</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Nama *</label>
              <input type="text" id="newCustName" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="Nama pelanggan">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">No. HP</label>
              <input type="tel" id="newCustPhone" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="08xxxxxxxxxx">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Email</label>
              <input type="email" id="newCustEmail" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="email@example.com">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 rounded-lg bg-surface hover:bg-surface/80">Batal</button>
            <button onclick="saveNewCustomer()" class="flex-1 btn-primary px-4 py-2 rounded-lg">Simpan</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveNewCustomer() {
      const name = document.getElementById('newCustName')?.value?.trim();
      const phone = document.getElementById('newCustPhone')?.value?.trim();
      const email = document.getElementById('newCustEmail')?.value?.trim();

      if (!name) {
        showToast('Nama harus diisi!', 'warning');
        return;
      }

      const newCustomer = {
        id: generateId(),
        name,
        phone,
        email,
        memberTier: 'Bronze',
        totalSpend: 0,
        totalVisits: 0,
        currentPoints: 0,
        registeredDate: new Date().toISOString(),
        tags: []
      };

      try {
        if (USE_REMOTE_DB) {
          await fetch(`${API_BASE}/api/customers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Api-Key': businessSettings.apiKey || DEFAULT_API_KEY },
            body: JSON.stringify(newCustomer)
          });
        }

        crmCustomers.unshift(newCustomer);
        customers.push(newCustomer);

        document.querySelector('.fixed')?.remove();
        renderCRMDataTable();
        showToast('Pelanggan berhasil ditambahkan!', 'success');
      } catch (err) {
        showToast('Gagal menyimpan: ' + err.message, 'error');
      }
    }

    // Initialize CRM when customer section is shown
    function initCRM() {
      loadCRMCustomers();
    }

    // ===== FINANCE & SHIFT MODULE =====
    let activeShift = null;
    let shiftCheckedThisSession = false; // Prevent repeated API calls

    // Check if shift is required before using POS
    // ONLY for cashier role - Admin bypasses completely
    async function checkShiftRequired() {
      // === ROLE FILTER: Admin bypasses shift requirement ===
      const userRole = currentUser?.role || localStorage.getItem('userRole') || '';
      if (userRole === 'admin' || userRole === 'Admin') {
        console.log('ğŸ‘‘ Admin user - bypassing shift check');
        return true; // Admin always allowed
      }

      // Skip for local/offline mode
      if (!USE_REMOTE_DB) return true;

      // === PERSISTENCE: If shift already checked and active, skip API call ===
      if (activeShift && activeShift.status === 'OPEN') {
        console.log('âœ… Shift already active in state:', activeShift.employeeName);
        return true;
      }

      // === PERSISTENCE: If already checked this session and no shift, don't re-check ===
      // (user closed modal without opening shift - let them browse other menus)
      if (shiftCheckedThisSession && !activeShift) {
        // Only block if trying to access POS - but allow navigation
        document.getElementById('openShiftModal').classList.remove('hidden');
        return false;
      }

      try {
        const employeeId = currentSession?.employeeId || currentUser?.id || 'default';
        const res = await fetch(`${API_BASE}/api/shift/active?employeeId=${employeeId}`, {
          headers: getAuthHeaders()
        });
        const data = await res.json();

        shiftCheckedThisSession = true; // Mark as checked

        if (data.hasActiveShift) {
          activeShift = data.shift;
          console.log('âœ… Active shift found:', activeShift.employeeName);
          return true;
        } else {
          // No active shift - show modal (only for POS access, not navigation)
          document.getElementById('openShiftModal').classList.remove('hidden');
          return false;
        }
      } catch (err) {
        console.warn('Shift check failed:', err);
        shiftCheckedThisSession = true;
        return true; // Allow POS on error to prevent blocking
      }
    }

    // Start a new shift
    async function doOpenShift() {
      const startCashInput = document.getElementById('shiftStartCash');
      const startCash = parseFloat(startCashInput?.value) || 0;

      if (startCash < 0) {
        showToast('Modal awal tidak boleh negatif!', 'warning');
        return;
      }

      // === LOADING STATE ===
      const btn = document.querySelector('#openShiftModal button[onclick="doOpenShift()"]');
      const restoreBtn = setButtonLoading(btn, 'â³ Membuka...');

      const employeeId = currentSession?.employeeId || currentUser?.id || 'default';
      const employeeName = currentSession?.name || currentUser?.name || currentUser?.username || 'Kasir';

      try {
        const res = await fetch(`${API_BASE}/api/shift/start`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ employeeId, employeeName, startCash })
        });

        const data = await res.json();

        if (data.success) {
          activeShift = data.shift;
          document.getElementById('openShiftModal').classList.add('hidden');
          showToast(`Shift dibuka! Modal awal: ${formatCurrency(startCash)}`, 'success');

          // Clear input
          if (startCashInput) startCashInput.value = '';
        } else {
          restoreBtn(); // Re-enable on error
          showToast(data.error || 'Gagal membuka shift', 'error');
        }
      } catch (err) {
        restoreBtn(); // Re-enable on error
        console.error('Open shift error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    // Show expense modal
    function showExpenseModal() {
      if (!activeShift) {
        showToast('Buka shift terlebih dahulu!', 'warning');
        return;
      }
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDescription').value = '';
      document.getElementById('expenseModal').classList.remove('hidden');
    }

    // Submit expense (petty cash)
    async function submitExpense() {
      const amount = parseFloat(document.getElementById('expenseAmount')?.value) || 0;
      const description = document.getElementById('expenseDescription')?.value?.trim();

      if (amount <= 0) {
        showToast('Jumlah harus lebih dari 0!', 'warning');
        return;
      }
      if (!description) {
        showToast('Keterangan harus diisi!', 'warning');
        return;
      }

      // === LOADING STATE ===
      const btn = document.querySelector('#expenseModal button[onclick="submitExpense()"]');
      const restoreBtn = setButtonLoading(btn);

      try {
        const res = await fetch(`${API_BASE}/api/shift/expense`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            shiftId: activeShift?._id,
            employeeId: currentSession?.employeeId || currentUser?.id,
            employeeName: currentSession?.name || currentUser?.name,
            amount,
            description
          })
        });

        const data = await res.json();

        if (data.success) {
          document.getElementById('expenseModal').classList.add('hidden');
          showToast(`Pengeluaran ${formatCurrency(amount)} berhasil dicatat`, 'success');

          // Update active shift data
          if (activeShift) {
            activeShift.totalCashExpenses = data.newTotalExpenses;
          }
        } else {
          restoreBtn(); // Re-enable on error
          showToast(data.error || 'Gagal mencatat pengeluaran', 'error');
        }
      } catch (err) {
        restoreBtn(); // Re-enable on error
        console.error('Submit expense error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    // Show close shift modal (blind closing)
    function showCloseShiftModal() {
      if (!activeShift) {
        showToast('Tidak ada shift aktif!', 'warning');
        return;
      }
      document.getElementById('blindActualCash').value = '';
      document.getElementById('blindCloseNotes').value = '';
      document.getElementById('closeShiftModal').classList.remove('hidden');
    }

    // Submit blind close
    async function submitBlindClose() {
      const actualCash = parseFloat(document.getElementById('blindActualCash')?.value);
      const notes = document.getElementById('blindCloseNotes')?.value?.trim();

      if (isNaN(actualCash) || actualCash < 0) {
        showToast('Masukkan jumlah uang tunai yang valid!', 'warning');
        return;
      }

      // === PREVENT DOUBLE SUBMIT: Disable button immediately ===
      const submitBtn = document.querySelector('#closeShiftModal button[onclick="submitBlindClose()"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'â³ Memproses...';
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }

      try {
        showToast('Memproses tutup shift...', 'info');

        const res = await fetch(`${API_BASE}/api/shift/close`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            shiftId: activeShift?._id,
            employeeId: currentSession?.employeeId || currentUser?.id,
            actualCash,
            notes
          })
        });

        const data = await res.json();

        if (data.success) {
          document.getElementById('closeShiftModal').classList.add('hidden');
          displayShiftResult(data.report);

          // Clear shift state
          activeShift = null;
          shiftCheckedThisSession = false;
        } else {
          showToast(data.error || 'Gagal menutup shift', 'error');
          // Re-enable button on error
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'ğŸ”’ Tutup Shift';
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }
      } catch (err) {
        console.error('Close shift error:', err);
        showToast('Error: ' + err.message, 'error');
        // Re-enable button on error
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'ğŸ”’ Tutup Shift';
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    }

    // Toggle function for Non-Cash Disclaimer (Tap to Reveal)
    window.toggleNonCashDisclaimer = function (e) {
      e.stopPropagation(); // Stop expansion of details
      const disclaimer = document.getElementById('nonCashDisclaimer');
      if (disclaimer) {
        disclaimer.classList.toggle('hidden');
      }
    };

    // Toggle function for Non-Cash Details
    window.toggleNonCashDetails = function () {
      const el = document.getElementById('nonCashDetails');
      const chevron = document.getElementById('nonCashChevron');
      if (el) {
        el.classList.toggle('hidden');
        if (chevron) {
          if (el.classList.contains('hidden')) chevron.style.transform = 'rotate(0deg)';
          else chevron.style.transform = 'rotate(180deg)';
        }
      }
    };

    // Display shift result after blind close
    function displayShiftResult(report) {
      const { startCash, totalCashSales, totalCashExpenses, expectedCash, actualClosingCash, cashDifference, isWithinTolerance, toleranceAmount } = report;

      // CALCULATION: Total Non-Cash Sales Breakdown
      let nonCashBreakdown = {};
      let totalNonCash = 0;

      if (activeShift && activeShift.startTime) {
        const shiftStart = new Date(activeShift.startTime).getTime();
        const sessionOrders = orders.filter(o =>
          o.status === 'done' &&
          o.paymentMethod !== 'cash' &&
          o.timestamp >= shiftStart
        );

        totalNonCash = sessionOrders.reduce((sum, o) => {
          const method = o.paymentMethod || 'other';
          nonCashBreakdown[method] = (nonCashBreakdown[method] || 0) + (o.total || 0);
          return sum + (o.total || 0);
        }, 0);
      } else if (report.totalNonCashSales) {
        totalNonCash = report.totalNonCashSales;
        // Fallback if detail not available in report object, show specific item based on total if possible or just generic
        if (totalNonCash > 0) nonCashBreakdown['Total'] = totalNonCash;
      }

      // Update icon and titles
      const iconEl = document.getElementById('resultIcon');
      const titleEl = document.getElementById('resultTitle');
      const subtitleEl = document.getElementById('resultSubtitle');

      if (cashDifference === 0) {
        iconEl.innerHTML = '<span class="text-5xl">âœ…</span>';
        iconEl.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bg-green-500/20';
        titleEl.textContent = 'Shift Ditutup - KLOP';
        titleEl.className = 'text-2xl font-bold mb-1 text-green-400';
        subtitleEl.textContent = 'Uang tunai sesuai dengan catatan sistem';
      } else if (isWithinTolerance) {
        iconEl.innerHTML = '<span class="text-5xl">âš ï¸</span>';
        iconEl.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bg-yellow-500/20';
        titleEl.textContent = 'Shift Ditutup - Dalam Toleransi';
        titleEl.className = 'text-2xl font-bold mb-1 text-yellow-400';
        subtitleEl.textContent = `Selisih kecil dalam batas Â±${formatCurrency(toleranceAmount)}`;
      } else {
        iconEl.innerHTML = '<span class="text-5xl">âŒ</span>';
        iconEl.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bg-red-500/20';
        titleEl.textContent = 'Shift Ditutup - ADA SELISIH';
        titleEl.className = 'text-2xl font-bold mb-1 text-red-400';
        subtitleEl.textContent = 'Selisih kas melebihi toleransi sistem';
      }

      // Update values
      document.getElementById('resultStartCash').textContent = formatCurrency(startCash);
      document.getElementById('resultCashSales').textContent = '+' + formatCurrency(totalCashSales);

      // Inject Non-Cash Info with Accordion
      const summaryContainer = document.querySelector('#resultCashSales').closest('.space-y-3');
      if (summaryContainer) {
        summaryContainer.innerHTML = `
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">Modal Awal</span>
          <span class="text-white font-medium">${formatCurrency(startCash)}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">+ Penjualan Tunai</span>
          <span class="text-green-400 font-medium">+${formatCurrency(totalCashSales)}</span>
        </div>
        
        <!-- INFO NON-TUNAI ACCORDION -->
        <div>
          <!-- DISCLAIMER ROW (Hidden by default) -->
          <div id="nonCashDisclaimer" class="hidden text-xs text-yellow-400/80 italic pl-4 py-1 animate-fade border-l-2 border-transparent">
             â„¹ï¸ Hanya display, diabaikan dari pentotalan selisih kas
          </div>

          <div onclick="window.toggleNonCashDetails()" class="flex justify-between text-sm pl-4 border-l-2 border-blue-500/30 my-1 py-2 bg-blue-500/5 rounded-r cursor-pointer hover:bg-blue-500/10 transition-colors select-none group items-center">
            <span class="text-blue-300 flex items-center gap-2">
               <!-- Info Icon (Clickable independent of row) -->
               <div onclick="window.toggleNonCashDisclaimer(event)" class="w-5 h-5 rounded-full hover:bg-blue-500/20 flex items-center justify-center cursor-pointer text-blue-400" title="Info">
                 <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                 </svg>
               </div>
               <span class="">Non-Tunai</span>
               <svg id="nonCashChevron" class="w-4 h-4 transition-transform duration-200 opacity-50 group-hover:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </span>
            <span class="text-blue-400 font-bold">${formatCurrency(totalNonCash)}</span>
          </div>
          <div id="nonCashDetails" class="hidden pl-8 pr-2 space-y-1 mb-2 animate-fade origin-top">
            ${Object.keys(nonCashBreakdown).length > 0 ?
            Object.entries(nonCashBreakdown).map(([method, amount]) => `
                <div class="flex justify-between text-xs text-blue-300/80 border-b border-blue-500/10 pb-1 last:border-0 hover:bg-blue-500/5 px-1 rounded">
                    <span class="capitalize">${method === 'bank' ? 'ğŸ¦ Transfer' : (method === 'qris' ? 'ğŸ“± QRIS' : (method === 'ewallet' ? 'ğŸ“² E-Wallet' : method))}</span>
                    <span class="font-mono">${formatCurrency(amount)}</span>
                </div>
              `).join('') : '<div class="text-xs text-gray-500 italic py-1">Tidak ada rincian</div>'
          }
          </div>
        </div>

        <div class="flex justify-between text-sm">
          <span class="text-gray-400">- Pengeluaran Kas</span>
          <span class="text-red-400 font-medium">-${formatCurrency(totalCashExpenses || 0)}</span>
        </div>
        <hr class="border-gray-700 my-2">
        <div class="flex justify-between font-bold">
          <span class="text-gray-300">Seharusnya (Sistem)</span>
          <span class="text-white">${formatCurrency(expectedCash)}</span>
        </div>
        <div class="flex justify-between font-bold">
          <span class="text-gray-300">Uang Fisik (Input)</span>
          <span class="text-white">${formatCurrency(actualClosingCash)}</span>
        </div>
        <hr class="border-gray-700 my-2">
        <div class="flex justify-between font-bold text-lg">
          <span class="text-gray-300">SELISIH</span>
          <span class="${cashDifference > 0 ? 'text-green-400' : (cashDifference < 0 ? 'text-red-400' : 'text-green-400')}">
            ${cashDifference > 0 ? '+' : ''}${formatCurrency(cashDifference)} ${cashDifference === 0 ? '(Pas)' : (cashDifference > 0 ? '(Surplus)' : '(Kurang)')}
          </span>
        </div>
        `;
      }

      // Tolerance note
      const toleranceNote = document.getElementById('resultToleranceNote');
      if (!isWithinTolerance && cashDifference !== 0) {
        toleranceNote.className = 'mt-4 p-3 rounded-lg bg-red-500/10 border border-red-500/30';
        toleranceNote.innerHTML = '<p class="text-sm text-red-400">âš ï¸ Selisih ini akan dilaporkan ke Admin untuk ditinjau.</p>';
      } else if (isWithinTolerance && cashDifference !== 0) {
        toleranceNote.className = 'mt-4 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30';
        toleranceNote.innerHTML = `<p class="text-sm text-yellow-400">â„¹ï¸ Selisih masih dalam batas toleransi Â±${formatCurrency(toleranceAmount)}.</p>`;
      } else {
        toleranceNote.className = 'hidden';
        toleranceNote.innerHTML = '';
      }

      // Show result modal
      document.getElementById('shiftResultModal').classList.remove('hidden');
    }

    // Close shift result modal with AUTO-LOGOUT and REDIRECT
    function closeShiftResultModal() {
      document.getElementById('shiftResultModal').classList.add('hidden');

      // Show success toast
      showToast('âœ… Shift berhasil ditutup! Anda akan logout otomatis...', 'success');

      // === AUTO-LOGOUT: Clear all authentication tokens ===
      localStorage.removeItem('warkop_token');
      localStorage.removeItem('warkop_user');
      localStorage.removeItem('userRole');
      currentUser = null;
      activeShift = null;
      shiftCheckedThisSession = false;

      // === REDIRECT: Delay 1.5s then redirect to login page ===
      setTimeout(() => {
        // Try to redirect to index.html, or reload current page to show login
        if (window.location.pathname.includes('admin_panel')) {
          window.location.href = window.location.pathname; // Reload same page
        } else {
          window.location.href = 'index.html';
        }
        // Fallback: just reload to reset state
        window.location.reload();
      }, 1500);
    }

    // Shift Report - Load and render shift history for admin
    async function loadShiftReport() {
      if (!USE_REMOTE_DB) {
        document.getElementById('shiftReportTableBody').innerHTML =
          '<tr><td colspan="9" class="p-8 text-center text-gray-400">Mode offline - Laporan shift tidak tersedia</td></tr>';
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/shifts?limit=50`, {
          headers: getAuthHeaders()
        });
        const data = await res.json();

        if (data.success && data.shifts) {
          renderShiftReportTable(data.shifts);
        }
      } catch (err) {
        console.error('Load shift report error:', err);
        showToast('Gagal memuat laporan shift', 'error');
      }
    }

    function renderShiftReportTable(shifts) {
      const tbody = document.getElementById('shiftReportTableBody');
      if (!tbody) return;

      if (!shifts || shifts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-400">Belum ada data shift</td></tr>';
        return;
      }

      tbody.innerHTML = shifts.map(s => {
        const startDate = new Date(s.startTime).toLocaleString('id-ID', {
          day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
        });
        const endDate = s.endTime ? new Date(s.endTime).toLocaleTimeString('id-ID', {
          hour: '2-digit', minute: '2-digit'
        }) : '-';

        const difference = s.cashDifference || 0;
        const hasDiscrepancy = s.hasDiscrepancy;
        const rowClass = hasDiscrepancy ? 'bg-red-500/10 border-red-500/30' : '';
        const diffClass = difference === 0 ? 'text-green-400' : (s.isWithinTolerance ? 'text-yellow-400' : 'text-red-400 font-bold');
        const statusBadge = s.status === 'OPEN'
          ? '<span class="px-2 py-1 rounded-full bg-blue-500/20 text-blue-400 text-xs">AKTIF</span>'
          : hasDiscrepancy
            ? '<span class="px-2 py-1 rounded-full bg-red-500/20 text-red-400 text-xs">SELISIH</span>'
            : s.isWithinTolerance === false
              ? '<span class="px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400 text-xs">TOLERANSI</span>'
              : '<span class="px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs">KLOP</span>';

        return `
          <tr class="border-b border-gray-700/50 hover:bg-gray-800/30 ${rowClass}">
            <td class="px-4 py-3 text-sm">${startDate}</td>
            <td class="px-4 py-3 text-sm">${endDate}</td>
            <td class="px-4 py-3 font-medium">${s.employeeName || '-'}</td>
            <td class="px-4 py-3 text-right">${formatCurrency(s.startCash || 0)}</td>
            <td class="px-4 py-3 text-right text-green-400">+${formatCurrency(s.totalCashSales || 0)}</td>
            <td class="px-4 py-3 text-right text-red-400">-${formatCurrency(s.totalCashExpenses || 0)}</td>
            <td class="px-4 py-3 text-right font-medium">${s.status === 'CLOSED' ? formatCurrency(s.expectedCash || 0) : '-'}</td>
            <td class="px-4 py-3 text-right ${diffClass}">${s.status === 'CLOSED' ? formatCurrency(difference) : '-'}</td>
            <td class="px-4 py-3 text-center">${statusBadge}</td>
          </tr>
        `;
      }).join('');
    }
  </script>
  <!-- Open Shift Modal -->
  <div id="openShiftModal"
    class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] backdrop-blur-sm">
    <div
      class="bg-gray-800 rounded-2xl w-full max-w-md p-8 border border-gray-700 shadow-2xl transform transition-all scale-100">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="text-3xl">â˜•</span>
        </div>
        <h2 class="text-3xl font-bold text-white mb-2">Buka Shift</h2>
        <p class="text-gray-400">Masukkan modal awal untuk memulai shift.</p>
      </div>

      <div class="space-y-6">
        <div>
          <label class="block text-gray-400 text-sm font-medium mb-2">Modal Awal (Cash Float)</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">Rp</span>
            <input type="number" id="shiftStartCash"
              class="w-full bg-gray-900 border border-gray-700 text-white pl-12 pr-4 py-4 rounded-xl focus:ring-2 focus:ring-blue-500 text-xl font-bold"
              placeholder="0">
          </div>
        </div>

        <button onclick="doOpenShift()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/20 transition-all transform hover:scale-[1.02]">
          Buka Toko ğŸš€
        </button>
      </div>
    </div>
  </div>

  <!-- Close Shift Modal - BLIND CLOSE (Security Enhanced) -->
  <!-- IMPORTANT: This modal does NOT show expected cash - kasir must count blindly -->
  <div id="closeShiftModal"
    class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] backdrop-blur-sm">
    <div class="bg-gray-800 rounded-2xl w-full max-w-md p-8 border border-gray-700 shadow-2xl">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="text-3xl">ğŸ”’</span>
        </div>
        <h2 class="text-2xl font-bold text-white mb-1">Tutup Shift</h2>
        <p class="text-gray-400 text-sm">Hitung uang tunai fisik di laci Anda.</p>
      </div>

      <div class="space-y-4">
        <!-- Blind Input - NO EXPECTED CASH SHOWN -->
        <div
          class="glass rounded-xl p-4 bg-gradient-to-br from-purple-900/30 to-blue-900/30 border border-purple-500/20">
          <label class="block text-purple-300 text-sm font-medium mb-2">ğŸ’° Total Uang Tunai Fisik di Laci</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Rp</span>
            <input type="number" id="blindActualCash"
              class="w-full bg-gray-900/80 border-2 border-purple-500/40 text-white pl-12 pr-4 py-4 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-2xl font-bold"
              placeholder="0" min="0">
          </div>
          <p class="text-xs text-gray-500 mt-2">âš ï¸ Pastikan sudah menghitung semua uang tunai termasuk modal awal</p>
        </div>

        <div>
          <label class="block text-gray-400 text-sm font-medium mb-2">ğŸ“ Catatan (Opsional)</label>
          <textarea id="blindCloseNotes"
            class="w-full bg-gray-900 border border-gray-700 text-white px-4 py-2 rounded-lg text-sm" rows="2"
            placeholder="Catatan tambahan..."></textarea>
        </div>

        <div class="flex gap-3 mt-4">
          <button onclick="document.getElementById('closeShiftModal').classList.add('hidden')"
            class="flex-1 px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-bold transition-colors">
            Batal
          </button>
          <button onclick="submitBlindClose()"
            class="flex-1 px-4 py-3 rounded-xl bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold shadow-lg shadow-red-500/30 transition-all">
            ğŸ”’ Tutup Shift
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shift Close Result Modal - Shows AFTER blind submission -->
  <div id="shiftResultModal"
    class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] backdrop-blur-sm">
    <div class="bg-gray-800 rounded-2xl w-full max-w-md p-8 border border-gray-700 shadow-2xl">
      <div class="text-center mb-6">
        <div id="resultIcon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"></div>
        <h2 id="resultTitle" class="text-2xl font-bold mb-1"></h2>
        <p id="resultSubtitle" class="text-gray-400 text-sm"></p>
      </div>

      <div class="space-y-3 bg-gray-900/50 rounded-xl p-4">
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">Modal Awal</span>
          <span id="resultStartCash" class="text-white font-medium"></span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">+ Penjualan Tunai</span>
          <span id="resultCashSales" class="text-green-400 font-medium"></span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">- Pengeluaran Kas</span>
          <span id="resultExpenses" class="text-red-400 font-medium"></span>
        </div>
        <hr class="border-gray-700">
        <div class="flex justify-between font-bold">
          <span class="text-gray-300">Seharusnya (Sistem)</span>
          <span id="resultExpected" class="text-white"></span>
        </div>
        <div class="flex justify-between font-bold">
          <span class="text-gray-300">Uang Fisik (Input)</span>
          <span id="resultActual" class="text-white"></span>
        </div>
        <hr class="border-gray-700">
        <div id="resultDifferenceRow" class="flex justify-between font-bold text-lg">
          <span class="text-gray-300">SELISIH</span>
          <span id="resultDifference" class=""></span>
        </div>
      </div>

      <div class="mt-4 p-3 rounded-lg" id="resultToleranceNote"></div>

      <button onclick="closeShiftResultModal()"
        class="w-full mt-6 px-4 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold transition-colors">
        ğŸšª Selesai & Logout
      </button>
    </div>
  </div>

  <!-- Expense Modal (Kas Keciil) -->
  <div id="expenseModal"
    class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] backdrop-blur-sm">
    <div class="bg-gray-800 rounded-2xl w-full max-w-md p-6 border border-gray-700 shadow-2xl">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-white">ğŸ’¸ Catat Pengeluaran Kas</h2>
        <button onclick="document.getElementById('expenseModal').classList.add('hidden')"
          class="text-gray-400 hover:text-white">âœ•</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-gray-400 text-sm font-medium mb-2">Jumlah (Rp)</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">Rp</span>
            <input type="number" id="expenseAmount"
              class="w-full bg-gray-900 border border-gray-700 text-white pl-12 pr-4 py-3 rounded-xl focus:ring-2 focus:ring-yellow-500 text-lg font-bold"
              placeholder="0" min="0">
          </div>
        </div>

        <div>
          <label class="block text-gray-400 text-sm font-medium mb-2">Keterangan</label>
          <input type="text" id="expenseDescription"
            class="w-full bg-gray-900 border border-gray-700 text-white px-4 py-3 rounded-xl"
            placeholder="Contoh: Beli Es Batu, Beli Tissuee">
        </div>

        <div class="flex gap-3 mt-6">
          <button onclick="document.getElementById('expenseModal').classList.add('hidden')"
            class="flex-1 px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-medium">
            Batal
          </button>
          <button onclick="submitExpense()"
            class="flex-1 px-4 py-3 rounded-xl bg-yellow-600 hover:bg-yellow-700 text-white font-bold">
            ğŸ’¾ Simpann
          </button>
        </div>
      </div>
    </div>
  </div>

</body>

</html>