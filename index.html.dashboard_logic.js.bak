
// ==========================================
// üìä NEW DASHBOARD sasaLOGIIC (Cashier Ops Center)
// ==========================================

let dashboardInterval = null;

function renderDashboard() {
    console.log('Rendering Dashboard (Cashier Ops Center)...');
    // Clear previous interval if any
    if (dashboardInterval) clearInterval(dashboardInterval);

    // Update Stats immediately
    updateDashboardWidgets();

    // Auto-refresh every 30 seconds
    dashboardInterval = setInterval(updateDashboardWidgets, 30000);
}

function updateDashboardWidgets() {
    const today = getCurrentDate(); // "YYYY-MM-DD"

    // 1. Calculate Today's Stats
    const todaysOrders = orders.filter(o => o.date === today && o.status !== 'cancelled');
    const revenue = todaysOrders.reduce((sum, o) => sum + (o.total || 0), 0);
    const customers = new Set(todaysOrders.map(o => o.customerName)).size;

    // Update Scorecards
    safeSetText('statRevenue', formatCurrency(revenue));
    safeSetText('statOrders', todaysOrders.length);
    safeSetText('statCustomers', customers);

    // Update Table Status Count
    const occupied = tables.filter(t => t.status === 'occupied').length;
    safeSetText('statTables', `${occupied}/${tables.length}`);

    // 2. Render Widgets
    renderHourlyChart(todaysOrders);
    renderTopMenuWidget(todaysOrders);
    renderLowStockWidget();
    renderTransactionHistory(todaysOrders);
    renderTableStatus(); // Existing function
}

// --- Widget A: Hourly Traffic Chart ---
function renderHourlyChart(todaysOrders) {
    const ctx = document.getElementById('hourlySalesChart');
    if (!ctx) return;

    // Bucket by hour (00-23)
    const buckets = new Array(24).fill(0);
    todaysOrders.forEach(o => {
        const hour = parseInt(o.time.split(':')[0]);
        if (hour >= 0 && hour < 24) buckets[hour]++;
    });

    // Find max for scaling
    const max = Math.max(...buckets, 5); // Min scale 5

    // Render simple bar chart HTML
    let html = '';
    // Only show active hours (e.g. 08:00 - 22:00) or all? Let's show all for now or compressed.
    // Let's show active range + padding
    const startHour = 8;
    const endHour = 23;

    for (let i = startHour; i <= endHour; i++) {
        const count = buckets[i];
        const height = Math.max((count / max) * 100, 5); // Min 5% height
        const isPeak = count === max && count > 0;
        const colorClass = isPeak ? 'bg-purple-500' : 'bg-purple-500/30';

        html += `
                <div class="flex-1 flex flex-col items-center gap-1 group relative">
                    <div class="w-full ${colorClass} rounded-t-sm transition-all duration-500 group-hover:bg-purple-400" style="height: ${height}%"></div>
                    <span class="text-[10px] text-gray-500 transform -rotate-0">${i}</span>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full mb-1 hidden group-hover:block bg-black/80 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                        Jam ${i}:00 ‚Ä¢ ${count} Order
                    </div>
                </div>
            `;
    }
    ctx.innerHTML = html;
}

// --- Widget B: Top 5 Menu Laris ---
function renderTopMenuWidget(todaysOrders) {
    const container = document.getElementById('topMenuWidget');
    if (!container) return;

    const itemMap = {};
    todaysOrders.forEach(o => {
        o.items.forEach(item => {
            const name = item.name;
            itemMap[name] = (itemMap[name] || 0) + (item.quantity || 1);
        });
    });

    const sorted = Object.entries(itemMap)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 5); // Top 5

    if (sorted.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">Belum ada penjualan hari ini</div>';
        return;
    }

    container.innerHTML = sorted.map(([name, qty], index) => {
        const rank = index + 1;
        const medal = rank === 1 ? 'ü•á' : (rank === 2 ? 'ü•à' : (rank === 3 ? 'ü•â' : `#${rank}`));
        return `
                <div class="flex items-center justify-between p-2 rounded-lg bg-surface/30 hover:bg-surface/50 transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg w-8 text-center">${medal}</span>
                        <span class="text-sm font-medium text-gray-200 truncate max-w-[150px]">${name}</span>
                    </div>
                    <span class="text-xs font-bold bg-purple-500/20 text-purple-300 px-2 py-1 rounded-full">${qty} Terjual</span>
                </div>
            `;
    }).join('');
}

// --- Widget C: Low Stock Alert ---
function renderLowStockWidget() {
    const container = document.getElementById('lowStockWidget');
    if (!container) return;

    // Filter ingredients < min_stock
    const lowStockItems = ingredients.filter(i => {
        const stok = parseFloat(i.stok) || 0;
        const min = parseFloat(i.stok_min) || 10; // Default 10 if not set
        return stok < min;
    }).sort((a, b) => (a.stok || 0) - (b.stok || 0)); // Most critical first

    if (lowStockItems.length === 0) {
        container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-4 text-green-400">
                    <span class="text-2xl mb-1">‚úì</span>
                    <span class="text-sm">Stok Aman</span>
                </div>`;
        return;
    }

    container.innerHTML = lowStockItems.slice(0, 5).map(i => `
            <div class="flex items-center justify-between p-2 rounded bg-red-500/10 border-l-2 border-red-500">
                <span class="text-sm text-gray-300 truncate max-w-[120px]">${i.nama}</span>
                <span class="text-xs font-bold text-red-400">${(i.stok || 0).toLocaleString()} ${i.satuan_beli || 'Unit'}</span>
            </div>
        `).join('') + (lowStockItems.length > 5 ? `<div class="text-center text-xs text-red-400 mt-1 cursor-pointer" onclick="showSection('inventory')">+ ${lowStockItems.length - 5} lainnya</div>` : '');
}

// --- Widget D: Transaction History Panel ---
let currentHistoryFilter = '';
function filterTransactionHistory() {
    const input = document.getElementById('historySearch');
    currentHistoryFilter = input ? input.value.trim().toLowerCase() : '';
    // Re-render
    const today = getCurrentDate();
    const todaysOrders = orders.filter(o => o.date === today && o.status !== 'cancelled');
    renderTransactionHistory(todaysOrders);
}

function renderTransactionHistory(todaysOrders) {
    const container = document.getElementById('todayTransactionTable');
    if (!container) return;

    let data = [...todaysOrders].sort((a, b) => b.timestamp - a.timestamp); // Newest first

    if (currentHistoryFilter) {
        data = data.filter(o =>
            (o.customerName || '').toLowerCase().includes(currentHistoryFilter) ||
            (o.tableNumber || '').toString().includes(currentHistoryFilter)
        );
    }

    if (data.length === 0) {
        container.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">Tidak ada transaksi${currentHistoryFilter ? ' yang cocok' : ''}</td></tr>`;
        return;
    }

    container.innerHTML = data.map(o => {
        const itemsSummary = o.items.map(i => i.name).join(', ');
        const itemsTruncated = itemsSummary.length > 30 ? itemsSummary.substring(0, 30) + '...' : itemsSummary;

        const badgeClass = o.orderType === 'take-away' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400';
        const typeLabel = o.orderType === 'take-away' ? 'ü•° Take Away' : 'üçΩÔ∏è Dine In';

        return `
                <tr class="hover:bg-surface/50 group transition-colors">
                    <td class="px-2 py-3 text-gray-300 font-mono text-xs">${o.time}</td>
                    <td class="px-2 py-3 font-medium text-white">
                        ${o.customerName}
                        ${o.tableNumber ? `<span class="text-xs text-gray-500 block">Meja ${o.tableNumber}</span>` : ''}
                    </td>
                    <td class="px-2 py-3">
                        <span class="px-2 py-0.5 rounded text-[10px] ${badgeClass}">${typeLabel}</span>
                    </td>
                    <td class="px-2 py-3 text-gray-400 text-xs" title="${itemsSummary}">
                        ${itemsTruncated}
                        <div class="text-[10px] text-gray-600">${o.items.length} items</div>
                    </td>
                    <td class="px-2 py-3 text-right font-bold text-green-400">${formatCurrency(o.total)}</td>
                    <td class="px-2 py-3 text-center text-xs text-gray-400 capitalize">${o.paymentMethod || '-'}</td>
                    <td class="px-2 py-3 text-center">
                        <button onclick="printReceipt('${o.id}')" class="p-1.5 rounded bg-gray-700/50 hover:bg-purple-500 text-gray-400 hover:text-white transition-all shadow-sm" title="Print Struk">
                            üñ®Ô∏è
                        </button>
                    </td>
                </tr>
            `;
    }).join('');
}

function safeSetText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}
